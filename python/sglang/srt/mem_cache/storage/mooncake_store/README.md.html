<h1 id="mooncake-as-l3-kv-cache">Mooncake as L3 KV Cache</h1>
<p>This document describes how to use Mooncake as the L3 KV cache for SGLang. For more details about Mooncake, please refer to: https://kvcache-ai.github.io/</p>
<h2 id="install-mooncake">Install Mooncake</h2>
<h3 id="method-1-with-pip">Method 1: with pip</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">pip</span> install mooncake-transfer-engine</span></code></pre></div>
<h3 id="method-2-from-source">Method 2: from source</h3>
<p>Clone Mooncake project:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">git</span> clone https://github.com/kvcache-ai/Mooncake --recursive</span></code></pre></div>
<p>Install dependencies:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="bu">cd</span> Mooncake</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="fu">bash</span> dependencies.sh</span></code></pre></div>
<p>Build the project. For additional build options, please refer to <a href="https://kvcache-ai.github.io/Mooncake/getting_started/build.html">the official guide</a>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="fu">mkdir</span> build</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="bu">cd</span> build</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="fu">cmake</span> ..</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="fu">make</span> -j</span></code></pre></div>
<p>Install Mooncake:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="fu">sudo</span> make install</span></code></pre></div>
<h2 id="use-mooncake">Use Mooncake</h2>
<p>Launch Mooncake master server:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="ex">mooncake_master</span></span></code></pre></div>
<p>Launch Mooncake meta server:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="ex">python</span> -m mooncake.http_metadata_server</span></code></pre></div>
<p>Start the SGLang server with Mooncake enabled. Mooncake configuration can be provided via environment variables. Note that, for optimal performance, the Mooncake backend currently supports only the <code>page_first</code> layout.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="va">MOONCAKE_TE_META_DATA_SERVER=</span><span class="st">&quot;http://127.0.0.1:8080/metadata&quot;</span> <span class="kw">\</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="va">MOONCAKE_GLOBAL_SEGMENT_SIZE=</span>4294967296 <span class="kw">\</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="va">MOONCAKE_PROTOCOL=</span><span class="st">&quot;rdma&quot;</span> <span class="kw">\</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="va">MOONCAKE_DEVICE=</span><span class="st">&quot;erdma_0,erdma_1&quot;</span> <span class="kw">\</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a><span class="va">MOONCAKE_MASTER=</span>127.0.0.1:50051 <span class="kw">\</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="ex">python</span> -m sglang.launch_server <span class="kw">\</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    <span class="ex">--enable-hierarchical-cache</span> <span class="kw">\</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>    <span class="ex">--hicache-storage-backend</span> mooncake<span class="kw">\</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>    <span class="ex">--model-path</span> [model_path]</span></code></pre></div>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.6">
<title>sglang.utils API documentation</title>
<meta name="description" content="Common utilities">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>sglang.utils</code></h1>
</header>
<section id="section-intro">
<p>Common utilities</p>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="sglang.utils.async_stream_and_merge"><code class="name flex">
<span>async def <span class="ident">async_stream_and_merge</span></span>(<span>llm, prompt, sampling_params)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def async_stream_and_merge(llm, prompt, sampling_params):
    &#34;&#34;&#34;
    Streams tokens asynchronously, removes chunk overlaps,
    and yields the cleaned chunk in real time for printing.
    &#34;&#34;&#34;
    final_text = &#34;&#34;
    generator = await llm.async_generate(prompt, sampling_params, stream=True)
    async for chunk in generator:
        chunk_text = chunk[&#34;text&#34;]
        cleaned_chunk = trim_overlap(final_text, chunk_text)
        final_text += cleaned_chunk
        yield cleaned_chunk  # yield the non-overlapping portion</code></pre>
</details>
<div class="desc"><p>Streams tokens asynchronously, removes chunk overlaps,
and yields the cleaned chunk in real time for printing.</p></div>
</dd>
<dt id="sglang.utils.convert_json_schema_to_str"><code class="name flex">
<span>def <span class="ident">convert_json_schema_to_str</span></span>(<span>json_schema: dict | str | Type[pydantic.main.BaseModel]) ‑> str</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def convert_json_schema_to_str(json_schema: Union[dict, str, Type[BaseModel]]) -&gt; str:
    &#34;&#34;&#34;Convert a JSON schema to a string.
    Parameters
    ----------
    json_schema
        The JSON schema.
    Returns
    -------
    str
        The JSON schema converted to a string.
    Raises
    ------
    ValueError
        If the schema is not a dictionary, a string or a Pydantic class.
    &#34;&#34;&#34;
    if isinstance(json_schema, dict):
        schema_str = json.dumps(json_schema)
    elif isinstance(json_schema, str):
        schema_str = json_schema
    elif issubclass(json_schema, BaseModel):
        schema_str = json.dumps(json_schema.model_json_schema())
    else:
        raise ValueError(
            f&#34;Cannot parse schema {json_schema}. The schema must be either &#34;
            + &#34;a Pydantic class, a dictionary or a string that contains the JSON &#34;
            + &#34;schema specification&#34;
        )
    return schema_str</code></pre>
</details>
<div class="desc"><p>Convert a JSON schema to a string.
Parameters</p>
<hr>
<dl>
<dt><strong><code>json_schema</code></strong></dt>
<dd>The JSON schema.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>str</code></dt>
<dd>The JSON schema converted to a string.</dd>
</dl>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ValueError</code></dt>
<dd>If the schema is not a dictionary, a string or a Pydantic class.</dd>
</dl></div>
</dd>
<dt id="sglang.utils.download_and_cache_file"><code class="name flex">
<span>def <span class="ident">download_and_cache_file</span></span>(<span>url: str, filename: str | None = None)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def download_and_cache_file(url: str, filename: Optional[str] = None):
    &#34;&#34;&#34;Read and cache a file from a url.&#34;&#34;&#34;
    if filename is None:
        filename = os.path.join(&#34;/tmp&#34;, url.split(&#34;/&#34;)[-1])

    # Check if the cache file already exists
    if os.path.exists(filename):
        return filename

    print(f&#34;Downloading from {url} to {filename}&#34;)

    # Stream the response to show the progress bar
    response = requests.get(url, stream=True)
    response.raise_for_status()  # Check for request errors

    # Total size of the file in bytes
    total_size = int(response.headers.get(&#34;content-length&#34;, 0))
    chunk_size = 1024  # Download in chunks of 1KB

    # Use tqdm to display the progress bar
    with open(filename, &#34;wb&#34;) as f, tqdm(
        desc=filename,
        total=total_size,
        unit=&#34;B&#34;,
        unit_scale=True,
        unit_divisor=1024,
    ) as bar:
        for chunk in response.iter_content(chunk_size=chunk_size):
            f.write(chunk)
            bar.update(len(chunk))

    return filename</code></pre>
</details>
<div class="desc"><p>Read and cache a file from a url.</p></div>
</dd>
<dt id="sglang.utils.dump_state_text"><code class="name flex">
<span>def <span class="ident">dump_state_text</span></span>(<span>filename: str, states: list, mode: str = 'w')</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def dump_state_text(filename: str, states: list, mode: str = &#34;w&#34;):
    &#34;&#34;&#34;Dump program state in a text file.&#34;&#34;&#34;
    from sglang.lang.interpreter import ProgramState

    with open(filename, mode) as fout:
        for i, s in enumerate(states):
            if isinstance(s, str):
                pass
            elif isinstance(s, ProgramState):
                s = s.text()
            else:
                s = str(s)

            fout.write(
                &#34;=&#34; * 40 + f&#34; {i} &#34; + &#34;=&#34; * 40 + &#34;\n&#34; + s + &#34;\n&#34; + &#34;=&#34; * 80 + &#34;\n\n&#34;
            )</code></pre>
</details>
<div class="desc"><p>Dump program state in a text file.</p></div>
</dd>
<dt id="sglang.utils.encode_frame"><code class="name flex">
<span>def <span class="ident">encode_frame</span></span>(<span>frame)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def encode_frame(frame):
    import cv2  # pip install opencv-python-headless
    from PIL import Image

    # Convert the frame to RGB (OpenCV uses BGR by default)
    frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

    # Convert the frame to PIL Image to easily convert to bytes
    im_pil = Image.fromarray(frame)

    # Convert to bytes
    buffered = BytesIO()

    # frame_format = str(os.getenv(&#39;FRAME_FORMAT&#39;, &#34;JPEG&#34;))

    im_pil.save(buffered, format=&#34;PNG&#34;)

    frame_bytes = buffered.getvalue()

    # Return the bytes of the frame
    return frame_bytes</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sglang.utils.encode_image_base64"><code class="name flex">
<span>def <span class="ident">encode_image_base64</span></span>(<span>image_path: str | bytes)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def encode_image_base64(image_path: Union[str, bytes]):
    &#34;&#34;&#34;Encode an image in base64.&#34;&#34;&#34;
    if isinstance(image_path, str):
        with open(image_path, &#34;rb&#34;) as image_file:
            data = image_file.read()
            return pybase64.b64encode(data).decode(&#34;utf-8&#34;)
    elif isinstance(image_path, bytes):
        return pybase64.b64encode(image_path).decode(&#34;utf-8&#34;)
    else:
        # image_path is PIL.WebPImagePlugin.WebPImageFile
        image = image_path
        buffered = BytesIO()
        image.save(buffered, format=&#34;PNG&#34;)
        return pybase64.b64encode(buffered.getvalue()).decode(&#34;utf-8&#34;)</code></pre>
</details>
<div class="desc"><p>Encode an image in base64.</p></div>
</dd>
<dt id="sglang.utils.encode_video_base64"><code class="name flex">
<span>def <span class="ident">encode_video_base64</span></span>(<span>video_path: str, num_frames: int = 16)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def encode_video_base64(video_path: str, num_frames: int = 16):
    import cv2  # pip install opencv-python-headless

    cap = cv2.VideoCapture(video_path)
    if not cap.isOpened():
        raise IOError(f&#34;Could not open video file:{video_path}&#34;)

    total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
    print(f&#34;target_frames: {num_frames}&#34;)

    frame_indices = np.linspace(0, total_frames - 1, num_frames, dtype=int)

    frames = []
    for _ in range(total_frames):
        ret, frame = cap.read()
        if ret:
            frames.append(frame)
        else:
            # Handle the case where the frame could not be read
            # print(f&#34;Warning: Could not read frame at index {i}.&#34;)
            pass

    cap.release()

    # Safely select frames based on frame_indices, avoiding IndexError
    frames = [frames[i] for i in frame_indices if i &lt; len(frames)]

    # If there are not enough frames, duplicate the last frame until we reach the target
    while len(frames) &lt; num_frames:
        frames.append(frames[-1])

    # Use ThreadPoolExecutor to process and encode frames in parallel
    with ThreadPoolExecutor() as executor:
        encoded_frames = list(executor.map(encode_frame, frames))

    # encoded_frames = list(map(encode_frame, frames))

    # Concatenate all frames bytes
    video_bytes = b&#34;&#34;.join(encoded_frames)

    # Encode the concatenated bytes to base64
    video_base64 = &#34;video:&#34; + pybase64.b64encode(video_bytes).decode(&#34;utf-8&#34;)

    return video_base64</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sglang.utils.execute_once"><code class="name flex">
<span>def <span class="ident">execute_once</span></span>(<span>func)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def execute_once(func):
    has_run = None

    @wraps(func)
    def wrapper(*args, **kwargs):
        nonlocal has_run
        if not has_run:
            func(*args, **kwargs)
            has_run = True

    return wrapper</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sglang.utils.execute_shell_command"><code class="name flex">
<span>def <span class="ident">execute_shell_command</span></span>(<span>command: str) ‑> subprocess.Popen</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def execute_shell_command(command: str) -&gt; subprocess.Popen:
    &#34;&#34;&#34;
    Execute a shell command and return its process handle.
    &#34;&#34;&#34;
    command = command.replace(&#34;\\\n&#34;, &#34; &#34;).replace(&#34;\\&#34;, &#34; &#34;)
    parts = command.split()
    return subprocess.Popen(parts, text=True, stderr=subprocess.STDOUT)</code></pre>
</details>
<div class="desc"><p>Execute a shell command and return its process handle.</p></div>
</dd>
<dt id="sglang.utils.find_printable_text"><code class="name flex">
<span>def <span class="ident">find_printable_text</span></span>(<span>text: str)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def find_printable_text(text: str):
    &#34;&#34;&#34;Returns the longest printable substring of text that contains only entire words.&#34;&#34;&#34;
    # Borrowed from https://github.com/huggingface/transformers/blob/061580c82c2db1de9139528243e105953793f7a2/src/transformers/generation/streamers.py#L99

    # After the symbol for a new line, we flush the cache.
    if text.endswith(&#34;\n&#34;):
        return text
    # If the last token is a CJK character, we print the characters.
    elif len(text) &gt; 0 and _is_chinese_char(ord(text[-1])):
        return text
    # Otherwise if the penultimate token is a CJK character, we print the characters except for the last one.
    elif len(text) &gt; 1 and _is_chinese_char(ord(text[-2])):
        return text[:-1]
    # Otherwise, prints until the last space char (simple heuristic to avoid printing incomplete words,
    # which may change with the subsequent token -- there are probably smarter ways to do this!)
    else:
        return text[: text.rfind(&#34; &#34;) + 1]</code></pre>
</details>
<div class="desc"><p>Returns the longest printable substring of text that contains only entire words.</p></div>
</dd>
<dt id="sglang.utils.get_exception_traceback"><code class="name flex">
<span>def <span class="ident">get_exception_traceback</span></span>(<span>)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_exception_traceback():
    etype, value, tb = sys.exc_info()
    err_str = &#34;&#34;.join(traceback.format_exception(etype, value, tb))
    return err_str</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sglang.utils.http_request"><code class="name flex">
<span>def <span class="ident">http_request</span></span>(<span>url, json=None, stream=False, api_key=None, verify=None, method: str | None = None)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def http_request(
    url,
    json=None,
    stream=False,
    api_key=None,
    verify=None,
    method: Optional[str] = None,
):
    &#34;&#34;&#34;A faster version of requests.post with low-level urllib API.&#34;&#34;&#34;
    headers = {&#34;Content-Type&#34;: &#34;application/json; charset=utf-8&#34;}

    # add the Authorization header if an api key is provided
    if api_key is not None:
        headers[&#34;Authorization&#34;] = f&#34;Bearer {api_key}&#34;

    if stream:
        return requests.post(url, json=json, stream=True, headers=headers)
    else:
        req = urllib.request.Request(url, headers=headers, method=method)
        if json is None:
            data = None
        else:
            data = bytes(dumps(json), encoding=&#34;utf-8&#34;)

        try:
            resp = urllib.request.urlopen(req, data=data, cafile=verify)
            return HttpResponse(resp)
        except urllib.error.HTTPError as e:
            return HttpResponse(e)</code></pre>
</details>
<div class="desc"><p>A faster version of requests.post with low-level urllib API.</p></div>
</dd>
<dt id="sglang.utils.info_once"><code class="name flex">
<span>def <span class="ident">info_once</span></span>(<span>message: str)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@execute_once
def info_once(message: str):
    logger.info(message)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sglang.utils.is_in_ci"><code class="name flex">
<span>def <span class="ident">is_in_ci</span></span>(<span>)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_in_ci():
    from sglang.test.test_utils import is_in_ci

    return is_in_ci()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sglang.utils.is_same_type"><code class="name flex">
<span>def <span class="ident">is_same_type</span></span>(<span>values: list)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_same_type(values: list):
    &#34;&#34;&#34;Return whether the elements in values are of the same type.&#34;&#34;&#34;
    if len(values) &lt;= 1:
        return True
    else:
        t = type(values[0])
        return all(isinstance(v, t) for v in values[1:])</code></pre>
</details>
<div class="desc"><p>Return whether the elements in values are of the same type.</p></div>
</dd>
<dt id="sglang.utils.launch_server_cmd"><code class="name flex">
<span>def <span class="ident">launch_server_cmd</span></span>(<span>command: str, host: str = '0.0.0.0', port: int = None)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def launch_server_cmd(command: str, host: str = &#34;0.0.0.0&#34;, port: int = None):
    &#34;&#34;&#34;
    Launch the server using the given command.
    If no port is specified, a free port is reserved.
    &#34;&#34;&#34;
    if port is None:
        port, lock_socket = reserve_port(host)
    else:
        lock_socket = None

    full_command = f&#34;{command} --port {port}&#34;
    process = execute_shell_command(full_command)

    if lock_socket is not None:
        process_socket_map[process] = lock_socket

    return process, port</code></pre>
</details>
<div class="desc"><p>Launch the server using the given command.
If no port is specified, a free port is reserved.</p></div>
</dd>
<dt id="sglang.utils.print_highlight"><code class="name flex">
<span>def <span class="ident">print_highlight</span></span>(<span>html_content: str)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def print_highlight(html_content: str):
    if is_in_ci():
        html_content = str(html_content).replace(&#34;\n&#34;, &#34;&lt;br&gt;&#34;)
        display(HTML(f&#34;&lt;strong style=&#39;color: #00008B;&#39;&gt;{html_content}&lt;/strong&gt;&#34;))
    else:
        print(html_content)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="sglang.utils.read_jsonl"><code class="name flex">
<span>def <span class="ident">read_jsonl</span></span>(<span>filename: str)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def read_jsonl(filename: str):
    &#34;&#34;&#34;Read a JSONL file.&#34;&#34;&#34;
    with open(filename) as fin:
        for line in fin:
            if line.startswith(&#34;#&#34;):
                continue
            yield json.loads(line)</code></pre>
</details>
<div class="desc"><p>Read a JSONL file.</p></div>
</dd>
<dt id="sglang.utils.release_port"><code class="name flex">
<span>def <span class="ident">release_port</span></span>(<span>lock_socket)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def release_port(lock_socket):
    &#34;&#34;&#34;
    Release the reserved port by closing the lock socket.
    &#34;&#34;&#34;
    try:
        lock_socket.close()
    except Exception as e:
        print(f&#34;Error closing socket: {e}&#34;)</code></pre>
</details>
<div class="desc"><p>Release the reserved port by closing the lock socket.</p></div>
</dd>
<dt id="sglang.utils.reserve_port"><code class="name flex">
<span>def <span class="ident">reserve_port</span></span>(<span>host, start=30000, end=40000)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def reserve_port(host, start=30000, end=40000):
    &#34;&#34;&#34;
    Reserve an available port by trying to bind a socket.
    Returns a tuple (port, lock_socket) where `lock_socket` is kept open to hold the lock.
    &#34;&#34;&#34;
    candidates = list(range(start, end))
    random.shuffle(candidates)

    for port in candidates:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        try:
            # Attempt to bind to the port on localhost
            sock.bind((host, port))
            return port, sock
        except socket.error:
            sock.close()  # Failed to bind, try next port
            continue
    raise RuntimeError(&#34;No free port available.&#34;)</code></pre>
</details>
<div class="desc"><p>Reserve an available port by trying to bind a socket.
Returns a tuple (port, lock_socket) where <code>lock_socket</code> is kept open to hold the lock.</p></div>
</dd>
<dt id="sglang.utils.resolve_obj_by_qualname"><code class="name flex">
<span>def <span class="ident">resolve_obj_by_qualname</span></span>(<span>qualname: str) ‑> Any</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def resolve_obj_by_qualname(qualname: str) -&gt; Any:
    &#34;&#34;&#34;
    Resolve an object by its fully qualified name.
    &#34;&#34;&#34;
    module_name, obj_name = qualname.rsplit(&#34;.&#34;, 1)
    module = importlib.import_module(module_name)
    return getattr(module, obj_name)</code></pre>
</details>
<div class="desc"><p>Resolve an object by its fully qualified name.</p></div>
</dd>
<dt id="sglang.utils.stream_and_merge"><code class="name flex">
<span>def <span class="ident">stream_and_merge</span></span>(<span>llm, prompt, sampling_params)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def stream_and_merge(llm, prompt, sampling_params):
    &#34;&#34;&#34;
    1) Streams the text,
    2) Removes chunk overlaps,
    3) Returns the merged text.
    &#34;&#34;&#34;
    final_text = &#34;&#34;
    for chunk in llm.generate(prompt, sampling_params, stream=True):
        chunk_text = chunk[&#34;text&#34;]
        cleaned_chunk = trim_overlap(final_text, chunk_text)
        final_text += cleaned_chunk
    return final_text</code></pre>
</details>
<div class="desc"><p>1) Streams the text,
2) Removes chunk overlaps,
3) Returns the merged text.</p></div>
</dd>
<dt id="sglang.utils.terminate_process"><code class="name flex">
<span>def <span class="ident">terminate_process</span></span>(<span>process)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def terminate_process(process):
    &#34;&#34;&#34;
    Terminate the process and automatically release the reserved port.
    &#34;&#34;&#34;
    from sglang.srt.utils import kill_process_tree

    kill_process_tree(process.pid)

    lock_socket = process_socket_map.pop(process, None)
    if lock_socket is not None:
        release_port(lock_socket)</code></pre>
</details>
<div class="desc"><p>Terminate the process and automatically release the reserved port.</p></div>
</dd>
<dt id="sglang.utils.trim_overlap"><code class="name flex">
<span>def <span class="ident">trim_overlap</span></span>(<span>existing_text, new_chunk)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def trim_overlap(existing_text, new_chunk):
    &#34;&#34;&#34;
    Finds the largest suffix of &#39;existing_text&#39; that is a prefix of &#39;new_chunk&#39;
    and removes that overlap from the start of &#39;new_chunk&#39;.
    &#34;&#34;&#34;
    max_overlap = 0
    max_possible = min(len(existing_text), len(new_chunk))
    for i in range(max_possible, 0, -1):
        if existing_text.endswith(new_chunk[:i]):
            max_overlap = i
            break
    return new_chunk[max_overlap:]</code></pre>
</details>
<div class="desc"><p>Finds the largest suffix of 'existing_text' that is a prefix of 'new_chunk'
and removes that overlap from the start of 'new_chunk'.</p></div>
</dd>
<dt id="sglang.utils.wait_for_server"><code class="name flex">
<span>def <span class="ident">wait_for_server</span></span>(<span>base_url: str, timeout: int = None) ‑> None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def wait_for_server(base_url: str, timeout: int = None) -&gt; None:
    &#34;&#34;&#34;Wait for the server to be ready by polling the /v1/models endpoint.

    Args:
        base_url: The base URL of the server
        timeout: Maximum time to wait in seconds. None means wait forever.
    &#34;&#34;&#34;
    start_time = time.perf_counter()
    while True:
        try:
            response = requests.get(
                f&#34;{base_url}/v1/models&#34;,
                headers={&#34;Authorization&#34;: &#34;Bearer None&#34;},
            )
            if response.status_code == 200:
                time.sleep(5)
                print_highlight(
                    &#34;&#34;&#34;\n
                    NOTE: Typically, the server runs in a separate terminal.
                    In this notebook, we run the server and notebook code together, so their outputs are combined.
                    To improve clarity, the server logs are displayed in the original black color, while the notebook outputs are highlighted in blue.
                    We are running those notebooks in a CI environment, so the throughput is not representative of the actual performance.
                    &#34;&#34;&#34;
                )
                break

            if timeout and time.perf_counter() - start_time &gt; timeout:
                raise TimeoutError(&#34;Server did not become ready within timeout period&#34;)
        except requests.exceptions.RequestException:
            time.sleep(1)</code></pre>
</details>
<div class="desc"><p>Wait for the server to be ready by polling the /v1/models endpoint.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>base_url</code></strong></dt>
<dd>The base URL of the server</dd>
<dt><strong><code>timeout</code></strong></dt>
<dd>Maximum time to wait in seconds. None means wait forever.</dd>
</dl></div>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="sglang.utils.HttpResponse"><code class="flex name class">
<span>class <span class="ident">HttpResponse</span></span>
<span>(</span><span>resp)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class HttpResponse:
    def __init__(self, resp):
        self.resp = resp

    def json(self):
        return json.loads(self.resp.read())

    @property
    def status_code(self):
        return self.resp.status</code></pre>
</details>
<div class="desc"></div>
<h3>Instance variables</h3>
<dl>
<dt id="sglang.utils.HttpResponse.status_code"><code class="name">prop <span class="ident">status_code</span></code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def status_code(self):
    return self.resp.status</code></pre>
</details>
<div class="desc"></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="sglang.utils.HttpResponse.json"><code class="name flex">
<span>def <span class="ident">json</span></span>(<span>self)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def json(self):
    return json.loads(self.resp.read())</code></pre>
</details>
<div class="desc"></div>
</dd>
</dl>
</dd>
<dt id="sglang.utils.LazyImport"><code class="flex name class">
<span>class <span class="ident">LazyImport</span></span>
<span>(</span><span>module_name: str, class_name: str)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class LazyImport:
    &#34;&#34;&#34;Lazy import to make `import sglang` run faster.&#34;&#34;&#34;

    def __init__(self, module_name: str, class_name: str):
        self.module_name = module_name
        self.class_name = class_name
        self._module = None

    def _load(self):
        if self._module is None:
            module = importlib.import_module(self.module_name)
            self._module = getattr(module, self.class_name)
        return self._module

    def __getattr__(self, name: str):
        module = self._load()
        return getattr(module, name)

    def __call__(self, *args, **kwargs):
        module = self._load()
        return module(*args, **kwargs)</code></pre>
</details>
<div class="desc"><p>Lazy import to make <code>import <a title="sglang" href="index.html">sglang</a></code> run faster.</p></div>
</dd>
<dt id="sglang.utils.TypeBasedDispatcher"><code class="flex name class">
<span>class <span class="ident">TypeBasedDispatcher</span></span>
<span>(</span><span>mapping: List[Tuple[Type, Callable]])</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class TypeBasedDispatcher:
    def __init__(self, mapping: List[Tuple[Type, Callable]]):
        self._mapping = mapping

    def __call__(self, obj: Any):
        for ty, fn in self._mapping:
            if isinstance(obj, ty):
                return fn(obj)
        raise ValueError(f&#34;Invalid object: {obj}&#34;)</code></pre>
</details>
<div class="desc"></div>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="sglang" href="index.html">sglang</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="sglang.utils.async_stream_and_merge" href="#sglang.utils.async_stream_and_merge">async_stream_and_merge</a></code></li>
<li><code><a title="sglang.utils.convert_json_schema_to_str" href="#sglang.utils.convert_json_schema_to_str">convert_json_schema_to_str</a></code></li>
<li><code><a title="sglang.utils.download_and_cache_file" href="#sglang.utils.download_and_cache_file">download_and_cache_file</a></code></li>
<li><code><a title="sglang.utils.dump_state_text" href="#sglang.utils.dump_state_text">dump_state_text</a></code></li>
<li><code><a title="sglang.utils.encode_frame" href="#sglang.utils.encode_frame">encode_frame</a></code></li>
<li><code><a title="sglang.utils.encode_image_base64" href="#sglang.utils.encode_image_base64">encode_image_base64</a></code></li>
<li><code><a title="sglang.utils.encode_video_base64" href="#sglang.utils.encode_video_base64">encode_video_base64</a></code></li>
<li><code><a title="sglang.utils.execute_once" href="#sglang.utils.execute_once">execute_once</a></code></li>
<li><code><a title="sglang.utils.execute_shell_command" href="#sglang.utils.execute_shell_command">execute_shell_command</a></code></li>
<li><code><a title="sglang.utils.find_printable_text" href="#sglang.utils.find_printable_text">find_printable_text</a></code></li>
<li><code><a title="sglang.utils.get_exception_traceback" href="#sglang.utils.get_exception_traceback">get_exception_traceback</a></code></li>
<li><code><a title="sglang.utils.http_request" href="#sglang.utils.http_request">http_request</a></code></li>
<li><code><a title="sglang.utils.info_once" href="#sglang.utils.info_once">info_once</a></code></li>
<li><code><a title="sglang.utils.is_in_ci" href="#sglang.utils.is_in_ci">is_in_ci</a></code></li>
<li><code><a title="sglang.utils.is_same_type" href="#sglang.utils.is_same_type">is_same_type</a></code></li>
<li><code><a title="sglang.utils.launch_server_cmd" href="#sglang.utils.launch_server_cmd">launch_server_cmd</a></code></li>
<li><code><a title="sglang.utils.print_highlight" href="#sglang.utils.print_highlight">print_highlight</a></code></li>
<li><code><a title="sglang.utils.read_jsonl" href="#sglang.utils.read_jsonl">read_jsonl</a></code></li>
<li><code><a title="sglang.utils.release_port" href="#sglang.utils.release_port">release_port</a></code></li>
<li><code><a title="sglang.utils.reserve_port" href="#sglang.utils.reserve_port">reserve_port</a></code></li>
<li><code><a title="sglang.utils.resolve_obj_by_qualname" href="#sglang.utils.resolve_obj_by_qualname">resolve_obj_by_qualname</a></code></li>
<li><code><a title="sglang.utils.stream_and_merge" href="#sglang.utils.stream_and_merge">stream_and_merge</a></code></li>
<li><code><a title="sglang.utils.terminate_process" href="#sglang.utils.terminate_process">terminate_process</a></code></li>
<li><code><a title="sglang.utils.trim_overlap" href="#sglang.utils.trim_overlap">trim_overlap</a></code></li>
<li><code><a title="sglang.utils.wait_for_server" href="#sglang.utils.wait_for_server">wait_for_server</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="sglang.utils.HttpResponse" href="#sglang.utils.HttpResponse">HttpResponse</a></code></h4>
<ul class="">
<li><code><a title="sglang.utils.HttpResponse.json" href="#sglang.utils.HttpResponse.json">json</a></code></li>
<li><code><a title="sglang.utils.HttpResponse.status_code" href="#sglang.utils.HttpResponse.status_code">status_code</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="sglang.utils.LazyImport" href="#sglang.utils.LazyImport">LazyImport</a></code></h4>
</li>
<li>
<h4><code><a title="sglang.utils.TypeBasedDispatcher" href="#sglang.utils.TypeBasedDispatcher">TypeBasedDispatcher</a></code></h4>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>

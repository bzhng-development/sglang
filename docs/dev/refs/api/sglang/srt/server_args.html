<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>sglang.srt.server_args API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../srt.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;sglang.srt</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="class" href="#ServerArgs">ServerArgs</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ServerArgs.__init__">ServerArgs</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.model_path">model_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.tokenizer_path">tokenizer_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.tokenizer_mode">tokenizer_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.skip_tokenizer_init">skip_tokenizer_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.load_format">load_format</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.model_loader_extra_config">model_loader_extra_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.trust_remote_code">trust_remote_code</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.context_length">context_length</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.is_embedding">is_embedding</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_multimodal">enable_multimodal</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.revision">revision</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.model_impl">model_impl</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.host">host</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.port">port</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.skip_server_warmup">skip_server_warmup</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.warmups">warmups</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.nccl_port">nccl_port</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.dtype">dtype</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.quantization">quantization</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.quantization_param_path">quantization_param_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.kv_cache_dtype">kv_cache_dtype</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.mem_fraction_static">mem_fraction_static</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.max_running_requests">max_running_requests</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.max_queued_requests">max_queued_requests</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.max_total_tokens">max_total_tokens</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.chunked_prefill_size">chunked_prefill_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.max_prefill_tokens">max_prefill_tokens</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.schedule_policy">schedule_policy</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.schedule_conservativeness">schedule_conservativeness</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.page_size">page_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hybrid_kvcache_ratio">hybrid_kvcache_ratio</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.swa_full_tokens_ratio">swa_full_tokens_ratio</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_hybrid_swa_memory">disable_hybrid_swa_memory</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.device">device</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.tp_size">tp_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.pp_size">pp_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.max_micro_batch_size">max_micro_batch_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.stream_interval">stream_interval</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.stream_output">stream_output</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.random_seed">random_seed</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.constrained_json_whitespace_pattern">constrained_json_whitespace_pattern</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.watchdog_timeout">watchdog_timeout</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.dist_timeout">dist_timeout</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.download_dir">download_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.base_gpu_id">base_gpu_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.gpu_id_step">gpu_id_step</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.sleep_on_idle">sleep_on_idle</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.log_level">log_level</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.log_level_http">log_level_http</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.log_requests">log_requests</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.log_requests_level">log_requests_level</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.crash_dump_folder">crash_dump_folder</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.show_time_cost">show_time_cost</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_metrics">enable_metrics</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_metrics_for_all_schedulers">enable_metrics_for_all_schedulers</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.bucket_time_to_first_token">bucket_time_to_first_token</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.bucket_inter_token_latency">bucket_inter_token_latency</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.bucket_e2e_request_latency">bucket_e2e_request_latency</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.collect_tokens_histogram">collect_tokens_histogram</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.decode_log_interval">decode_log_interval</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_request_time_stats_logging">enable_request_time_stats_logging</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.kv_events_config">kv_events_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.gc_warning_threshold_secs">gc_warning_threshold_secs</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.api_key">api_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.served_model_name">served_model_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.weight_version">weight_version</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.chat_template">chat_template</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.completion_template">completion_template</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.file_storage_path">file_storage_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_cache_report">enable_cache_report</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.reasoning_parser">reasoning_parser</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.tool_call_parser">tool_call_parser</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.tool_server">tool_server</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.dp_size">dp_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.load_balance_method">load_balance_method</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.dist_init_addr">dist_init_addr</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.nnodes">nnodes</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.node_rank">node_rank</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.json_model_override_args">json_model_override_args</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.preferred_sampling_params">preferred_sampling_params</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_lora">enable_lora</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.max_lora_rank">max_lora_rank</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.lora_target_modules">lora_target_modules</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.lora_paths">lora_paths</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.max_loaded_loras">max_loaded_loras</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.max_loras_per_batch">max_loras_per_batch</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.lora_backend">lora_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.attention_backend">attention_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.decode_attention_backend">decode_attention_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.prefill_attention_backend">prefill_attention_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.sampling_backend">sampling_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.grammar_backend">grammar_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.mm_attention_backend">mm_attention_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.speculative_algorithm">speculative_algorithm</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.speculative_draft_model_path">speculative_draft_model_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.speculative_num_steps">speculative_num_steps</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.speculative_eagle_topk">speculative_eagle_topk</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.speculative_num_draft_tokens">speculative_num_draft_tokens</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.speculative_accept_threshold_single">speculative_accept_threshold_single</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.speculative_accept_threshold_acc">speculative_accept_threshold_acc</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.speculative_token_map">speculative_token_map</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.ep_size">ep_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.moe_a2a_backend">moe_a2a_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.moe_runner_backend">moe_runner_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.flashinfer_mxfp4_moe_precision">flashinfer_mxfp4_moe_precision</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_flashinfer_allreduce_fusion">enable_flashinfer_allreduce_fusion</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.deepep_mode">deepep_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.ep_num_redundant_experts">ep_num_redundant_experts</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.ep_dispatch_algorithm">ep_dispatch_algorithm</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.init_expert_location">init_expert_location</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_eplb">enable_eplb</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.eplb_algorithm">eplb_algorithm</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.eplb_rebalance_num_iterations">eplb_rebalance_num_iterations</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.eplb_rebalance_layers_per_chunk">eplb_rebalance_layers_per_chunk</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.expert_distribution_recorder_mode">expert_distribution_recorder_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.expert_distribution_recorder_buffer_size">expert_distribution_recorder_buffer_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_expert_distribution_metrics">enable_expert_distribution_metrics</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.deepep_config">deepep_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.moe_dense_tp_size">moe_dense_tp_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_hierarchical_cache">enable_hierarchical_cache</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hicache_ratio">hicache_ratio</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hicache_size">hicache_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hicache_write_policy">hicache_write_policy</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hicache_io_backend">hicache_io_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hicache_mem_layout">hicache_mem_layout</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hicache_storage_backend">hicache_storage_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hicache_storage_prefetch_policy">hicache_storage_prefetch_policy</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.hicache_storage_backend_extra_config">hicache_storage_backend_extra_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_double_sparsity">enable_double_sparsity</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.ds_channel_config_path">ds_channel_config_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.ds_heavy_channel_num">ds_heavy_channel_num</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.ds_heavy_token_num">ds_heavy_token_num</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.ds_heavy_channel_type">ds_heavy_channel_type</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.ds_sparse_decode_threshold">ds_sparse_decode_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.cpu_offload_gb">cpu_offload_gb</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.offload_group_size">offload_group_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.offload_num_in_group">offload_num_in_group</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.offload_prefetch_step">offload_prefetch_step</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.offload_mode">offload_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_radix_cache">disable_radix_cache</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.cuda_graph_max_bs">cuda_graph_max_bs</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.cuda_graph_bs">cuda_graph_bs</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_cuda_graph">disable_cuda_graph</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_cuda_graph_padding">disable_cuda_graph_padding</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_profile_cuda_graph">enable_profile_cuda_graph</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_cudagraph_gc">enable_cudagraph_gc</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_nccl_nvls">enable_nccl_nvls</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_symm_mem">enable_symm_mem</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_flashinfer_cutlass_moe_fp4_allgather">disable_flashinfer_cutlass_moe_fp4_allgather</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_tokenizer_batch_encode">enable_tokenizer_batch_encode</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_outlines_disk_cache">disable_outlines_disk_cache</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_custom_all_reduce">disable_custom_all_reduce</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_mscclpp">enable_mscclpp</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_overlap_schedule">disable_overlap_schedule</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_mixed_chunk">enable_mixed_chunk</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_dp_attention">enable_dp_attention</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_dp_lm_head">enable_dp_lm_head</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_two_batch_overlap">enable_two_batch_overlap</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.tbo_token_distribution_threshold">tbo_token_distribution_threshold</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_torch_compile">enable_torch_compile</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.torch_compile_max_bs">torch_compile_max_bs</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.torchao_config">torchao_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_nan_detection">enable_nan_detection</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_p2p_check">enable_p2p_check</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.triton_attention_reduce_in_fp32">triton_attention_reduce_in_fp32</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.triton_attention_num_kv_splits">triton_attention_num_kv_splits</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.num_continuous_decode_steps">num_continuous_decode_steps</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.delete_ckpt_after_loading">delete_ckpt_after_loading</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_memory_saver">enable_memory_saver</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.allow_auto_truncate">allow_auto_truncate</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_custom_logit_processor">enable_custom_logit_processor</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.flashinfer_mla_disable_ragged">flashinfer_mla_disable_ragged</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_shared_experts_fusion">disable_shared_experts_fusion</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_chunked_prefix_cache">disable_chunked_prefix_cache</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disable_fast_image_processor">disable_fast_image_processor</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_return_hidden_states">enable_return_hidden_states</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.scheduler_recv_interval">scheduler_recv_interval</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.debug_tensor_dump_output_folder">debug_tensor_dump_output_folder</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.debug_tensor_dump_input_file">debug_tensor_dump_input_file</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.debug_tensor_dump_inject">debug_tensor_dump_inject</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.debug_tensor_dump_prefill_only">debug_tensor_dump_prefill_only</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disaggregation_mode">disaggregation_mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disaggregation_transfer_backend">disaggregation_transfer_backend</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disaggregation_bootstrap_port">disaggregation_bootstrap_port</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disaggregation_decode_tp">disaggregation_decode_tp</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disaggregation_decode_dp">disaggregation_decode_dp</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disaggregation_prefill_pp">disaggregation_prefill_pp</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.disaggregation_ib_device">disaggregation_ib_device</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.num_reserved_decode_tokens">num_reserved_decode_tokens</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.pdlb_url">pdlb_url</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.custom_weight_loader">custom_weight_loader</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.weight_loader_disable_mmap">weight_loader_disable_mmap</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_pdmux">enable_pdmux</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.sm_group_num">sm_group_num</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_ep_moe">enable_ep_moe</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_deepep_moe">enable_deepep_moe</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_flashinfer_cutlass_moe">enable_flashinfer_cutlass_moe</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_flashinfer_trtllm_moe">enable_flashinfer_trtllm_moe</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_triton_kernel_moe">enable_triton_kernel_moe</a>
                        </li>
                        <li>
                                <a class="variable" href="#ServerArgs.enable_flashinfer_mxfp4_moe">enable_flashinfer_mxfp4_moe</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.add_cli_args">add_cli_args</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.from_cli_args">from_cli_args</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.url">url</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.get_hf_config">get_hf_config</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.check_server_args">check_server_args</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.check_lora_server_args">check_lora_server_args</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.validate_disagg_tp_size">validate_disagg_tp_size</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.model_specific_adjustments">model_specific_adjustments</a>
                        </li>
                        <li>
                                <a class="function" href="#ServerArgs.adjust_mem_fraction_for_vlm">adjust_mem_fraction_for_vlm</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#prepare_server_args">prepare_server_args</a>
            </li>
            <li>
                    <a class="variable" href="#ZMQ_TCP_PORT_DELTA">ZMQ_TCP_PORT_DELTA</a>
            </li>
            <li>
                    <a class="class" href="#PortArgs">PortArgs</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PortArgs.__init__">PortArgs</a>
                        </li>
                        <li>
                                <a class="variable" href="#PortArgs.tokenizer_ipc_name">tokenizer_ipc_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#PortArgs.scheduler_input_ipc_name">scheduler_input_ipc_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#PortArgs.detokenizer_ipc_name">detokenizer_ipc_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#PortArgs.nccl_port">nccl_port</a>
                        </li>
                        <li>
                                <a class="variable" href="#PortArgs.rpc_ipc_name">rpc_ipc_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#PortArgs.metrics_ipc_name">metrics_ipc_name</a>
                        </li>
                        <li>
                                <a class="function" href="#PortArgs.init_new">init_new</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LoRAPathAction">LoRAPathAction</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#DeprecatedAction">DeprecatedAction</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DeprecatedAction.__init__">DeprecatedAction</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#print_deprecated_warning">print_deprecated_warning</a>
            </li>
            <li>
                    <a class="function" href="#auto_choose_speculative_params">auto_choose_speculative_params</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../sglang.html">sglang</a><wbr>.<a href="./../srt.html">srt</a><wbr>.server_args    </h1>

                        <div class="docstring"><p>The arguments of the server.</p>
</div>

                        <input id="mod-server_args-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-server_args-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1"># Copyright 2023-2024 SGLang Team</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="c1"># you may not use this file except in compliance with the License.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="c1"># You may obtain a copy of the License at</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="c1">#</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="c1">#</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="c1"># See the License for the specific language governing permissions and</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="c1"># limitations under the License.</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="c1"># ==============================================================================</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">&quot;&quot;&quot;The arguments of the server.&quot;&quot;&quot;</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sglang.srt.function_call.function_call_parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">FunctionCallParser</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sglang.srt.hf_transformers_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_gguf_file</span><span class="p">,</span> <span class="n">get_config</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sglang.srt.lora.lora_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoRARef</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sglang.srt.reasoning_parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReasoningParser</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sglang.srt.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>    <span class="n">LORA_TARGET_ALL_MODULES</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>    <span class="n">SUPPORTED_LORA_TARGET_MODULES</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>    <span class="n">configure_ipv6</span><span class="p">,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>    <span class="n">get_device</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>    <span class="n">get_device_memory_capacity</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>    <span class="n">is_cuda</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>    <span class="n">is_flashinfer_available</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>    <span class="n">is_hip</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>    <span class="n">is_port_available</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>    <span class="n">is_remote_url</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>    <span class="n">is_sm90_supported</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>    <span class="n">is_sm100_supported</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>    <span class="n">is_triton_kernels_available</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>    <span class="n">is_valid_ipv6_address</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="n">nullable_str</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ServerArgs</span><span class="p">:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="c1"># Model and tokenizer</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>    <span class="n">tokenizer_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>    <span class="n">tokenizer_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>    <span class="n">skip_tokenizer_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>    <span class="n">load_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>    <span class="n">model_loader_extra_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>    <span class="n">trust_remote_code</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>    <span class="n">context_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>    <span class="n">is_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>    <span class="n">enable_multimodal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>    <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="n">model_impl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>    <span class="c1"># HTTP server</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30000</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="n">skip_server_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>    <span class="n">warmups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="n">nccl_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>    <span class="c1"># Quantization and data type</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>    <span class="n">quantization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>    <span class="n">quantization_param_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>    <span class="n">kv_cache_dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>    <span class="c1"># Memory and scheduling</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>    <span class="n">mem_fraction_static</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>    <span class="n">max_running_requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>    <span class="n">max_queued_requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>    <span class="n">max_total_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>    <span class="n">chunked_prefill_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>    <span class="n">max_prefill_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16384</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>    <span class="n">schedule_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fcfs&quot;</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>    <span class="n">schedule_conservativeness</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>    <span class="n">page_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="n">hybrid_kvcache_ratio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>    <span class="n">swa_full_tokens_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>    <span class="n">disable_hybrid_swa_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="c1"># Runtime options</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="n">tp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>    <span class="n">pp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>    <span class="n">max_micro_batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>    <span class="n">stream_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>    <span class="n">stream_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>    <span class="n">constrained_json_whitespace_pattern</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="n">watchdog_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>    <span class="n">dist_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># timeout for torch.distributed</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>    <span class="n">download_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>    <span class="n">base_gpu_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>    <span class="n">gpu_id_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>    <span class="n">sleep_on_idle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="c1"># Logging</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>    <span class="n">log_level_http</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>    <span class="n">log_requests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>    <span class="n">log_requests_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="n">crash_dump_folder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>    <span class="n">show_time_cost</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>    <span class="n">enable_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>    <span class="n">enable_metrics_for_all_schedulers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>    <span class="n">bucket_time_to_first_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>    <span class="n">bucket_inter_token_latency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>    <span class="n">bucket_e2e_request_latency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="n">collect_tokens_histogram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>    <span class="n">decode_log_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>    <span class="n">enable_request_time_stats_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>    <span class="n">kv_events_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="n">gc_warning_threshold_secs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>    <span class="c1"># API related</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>    <span class="n">served_model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>    <span class="n">weight_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>    <span class="n">chat_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>    <span class="n">completion_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>    <span class="n">file_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sglang_storage&quot;</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>    <span class="n">enable_cache_report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>    <span class="n">reasoning_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>    <span class="n">tool_call_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>    <span class="n">tool_server</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>    <span class="c1"># Data parallelism</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>    <span class="n">dp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>    <span class="n">load_balance_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;round_robin&quot;</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>    <span class="c1"># Multi-node distributed serving</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>    <span class="n">dist_init_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>    <span class="n">nnodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>    <span class="n">node_rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>    <span class="c1"># Model override args in JSON</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>    <span class="n">json_model_override_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>    <span class="n">preferred_sampling_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>    <span class="c1"># LoRA</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>    <span class="n">enable_lora</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>    <span class="n">max_lora_rank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>    <span class="n">lora_target_modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>    <span class="n">lora_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">LoRARef</span><span class="p">]]</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>    <span class="n">max_loaded_loras</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>    <span class="n">max_loras_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>    <span class="n">lora_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;triton&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>    <span class="c1"># Kernel backend</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>    <span class="n">attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>    <span class="n">decode_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>    <span class="n">prefill_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>    <span class="n">sampling_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>    <span class="n">grammar_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>    <span class="n">mm_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>    <span class="c1"># Speculative decoding</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>    <span class="n">speculative_algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>    <span class="n">speculative_draft_model_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>    <span class="n">speculative_num_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>    <span class="n">speculative_eagle_topk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>    <span class="n">speculative_num_draft_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>    <span class="n">speculative_accept_threshold_single</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>    <span class="n">speculative_accept_threshold_acc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>    <span class="n">speculative_token_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>    <span class="c1"># Expert parallelism</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>    <span class="n">ep_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>    <span class="n">moe_a2a_backend</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;deepep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>    <span class="n">moe_runner_backend</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>        <span class="s2">&quot;triton_kernel&quot;</span><span class="p">,</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="s2">&quot;flashinfer_trtllm&quot;</span><span class="p">,</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>        <span class="s2">&quot;flashinfer_cutlass&quot;</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>        <span class="s2">&quot;flashinfer_mxfp4&quot;</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>    <span class="n">flashinfer_mxfp4_moe_precision</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>    <span class="n">enable_flashinfer_allreduce_fusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>    <span class="n">deepep_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;low_latency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>    <span class="n">ep_num_redundant_experts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>    <span class="n">ep_dispatch_algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="s2">&quot;dynamic&quot;</span><span class="p">,</span> <span class="s2">&quot;fake&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>    <span class="n">init_expert_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;trivial&quot;</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>    <span class="n">enable_eplb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>    <span class="n">eplb_algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="n">eplb_rebalance_num_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>    <span class="n">eplb_rebalance_layers_per_chunk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>    <span class="n">expert_distribution_recorder_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>        <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="s2">&quot;stat_approx&quot;</span><span class="p">,</span> <span class="s2">&quot;per_pass&quot;</span><span class="p">,</span> <span class="s2">&quot;per_token&quot;</span><span class="p">]</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>    <span class="n">expert_distribution_recorder_buffer_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>    <span class="n">enable_expert_distribution_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>    <span class="n">deepep_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>    <span class="n">moe_dense_tp_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>    <span class="c1"># Hierarchical cache</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>    <span class="n">enable_hierarchical_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>    <span class="n">hicache_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>    <span class="n">hicache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>    <span class="n">hicache_write_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;write_through_selective&quot;</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>    <span class="n">hicache_io_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kernel&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>    <span class="n">hicache_mem_layout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;layer_first&quot;</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>    <span class="n">hicache_storage_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>    <span class="n">hicache_storage_prefetch_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;best_effort&quot;</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>    <span class="n">hicache_storage_backend_extra_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>    <span class="c1"># Double Sparsity</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>    <span class="n">enable_double_sparsity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>    <span class="n">ds_channel_config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>    <span class="n">ds_heavy_channel_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>    <span class="n">ds_heavy_token_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>    <span class="n">ds_heavy_channel_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;qk&quot;</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>    <span class="n">ds_sparse_decode_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>    <span class="c1"># Offloading</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>    <span class="n">cpu_offload_gb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>    <span class="n">offload_group_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>    <span class="n">offload_num_in_group</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>    <span class="n">offload_prefetch_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>    <span class="n">offload_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="c1"># Optimization/debug options</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>    <span class="n">disable_radix_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>    <span class="n">cuda_graph_max_bs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>    <span class="n">cuda_graph_bs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>    <span class="n">disable_cuda_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>    <span class="n">disable_cuda_graph_padding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>    <span class="n">enable_profile_cuda_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>    <span class="n">enable_cudagraph_gc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>    <span class="n">enable_nccl_nvls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>    <span class="n">enable_symm_mem</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>    <span class="n">disable_flashinfer_cutlass_moe_fp4_allgather</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>    <span class="n">enable_tokenizer_batch_encode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>    <span class="n">disable_outlines_disk_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>    <span class="n">disable_custom_all_reduce</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>    <span class="n">enable_mscclpp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>    <span class="n">disable_overlap_schedule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>    <span class="n">enable_mixed_chunk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>    <span class="n">enable_dp_attention</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>    <span class="n">enable_dp_lm_head</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>    <span class="n">enable_two_batch_overlap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>    <span class="n">tbo_token_distribution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.48</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>    <span class="n">enable_torch_compile</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>    <span class="n">torch_compile_max_bs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>    <span class="n">torchao_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>    <span class="n">enable_nan_detection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>    <span class="n">enable_p2p_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>    <span class="n">triton_attention_reduce_in_fp32</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>    <span class="n">triton_attention_num_kv_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>    <span class="n">num_continuous_decode_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>    <span class="n">delete_ckpt_after_loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>    <span class="n">enable_memory_saver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>    <span class="n">allow_auto_truncate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>    <span class="n">enable_custom_logit_processor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>    <span class="n">flashinfer_mla_disable_ragged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>    <span class="n">disable_shared_experts_fusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>    <span class="n">disable_chunked_prefix_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>    <span class="n">disable_fast_image_processor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>    <span class="n">enable_return_hidden_states</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>    <span class="n">scheduler_recv_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>    <span class="c1"># Debug tensor dumps</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>    <span class="n">debug_tensor_dump_output_folder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>    <span class="n">debug_tensor_dump_input_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>    <span class="n">debug_tensor_dump_inject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>    <span class="n">debug_tensor_dump_prefill_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>    <span class="c1"># PD disaggregation: can be &quot;null&quot; (not disaggregated), &quot;prefill&quot; (prefill-only), or &quot;decode&quot; (decode-only)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>    <span class="n">disaggregation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>    <span class="n">disaggregation_transfer_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mooncake&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>    <span class="n">disaggregation_bootstrap_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8998</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>    <span class="n">disaggregation_decode_tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>    <span class="n">disaggregation_decode_dp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>    <span class="n">disaggregation_prefill_pp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>    <span class="n">disaggregation_ib_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>    <span class="n">num_reserved_decode_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>  <span class="c1"># used for decode kv cache offload in PD</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>    <span class="n">pdlb_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>    <span class="c1"># For model weight update</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>    <span class="n">custom_weight_loader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>    <span class="n">weight_loader_disable_mmap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>    <span class="c1"># For PD-Multiplexing</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>    <span class="n">enable_pdmux</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>    <span class="n">sm_group_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>    <span class="c1"># Deprecated arguments</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>    <span class="n">enable_ep_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>    <span class="n">enable_deepep_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>    <span class="n">enable_flashinfer_cutlass_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>    <span class="n">enable_flashinfer_trtllm_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>    <span class="n">enable_triton_kernel_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>    <span class="n">enable_flashinfer_mxfp4_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>        <span class="c1"># Check deprecated arguments</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_ep_moe</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                <span class="s2">&quot;NOTE: --enable-ep-moe is deprecated. Please set `--ep-size` to the same value as `--tp-size` instead.&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_deepep_moe</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_a2a_backend</span> <span class="o">=</span> <span class="s2">&quot;deepep&quot;</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>                <span class="s2">&quot;NOTE: --enable-deepep-moe is deprecated. Please set `--moe-a2a-backend` to &#39;deepep&#39; instead.&quot;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_triton_kernel_moe</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;triton_kernel&quot;</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>                <span class="s2">&quot;NOTE: --enable-triton-kernel-moe is deprecated. Please set `--moe-runner-backend` to &#39;triton_kernel&#39; instead.&quot;</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_cutlass_moe</span><span class="p">:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_cutlass&quot;</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>                <span class="s2">&quot;NOTE: --enable-flashinfer-cutlass-moe is deprecated. Please set `--moe-runner-backend` to &#39;flashinfer_cutlass&#39; instead.&quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_trtllm_moe</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_trtllm&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                <span class="s2">&quot;NOTE: --enable-flashinfer-trtllm-moe is deprecated. Please set `--moe-runner-backend` to &#39;flashinfer_trtllm&#39; instead.&quot;</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>            <span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_mxfp4_moe</span><span class="p">:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_mxfp4&quot;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>                <span class="s2">&quot;NOTE: --enable-flashinfer-mxfp4-moe is deprecated. Please set `--moe-runner-backend` to &#39;flashinfer_mxfp4&#39; instead.&quot;</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>            <span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="c1"># Set missing default values</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">served_model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">served_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_device</span><span class="p">()</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        <span class="n">gpu_mem</span> <span class="o">=</span> <span class="n">get_device_memory_capacity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        <span class="c1"># Set mem fraction static</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>            <span class="k">if</span> <span class="n">gpu_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>                <span class="c1"># GPU memory capacity = model weights + KV cache pool + activations + cuda graph buffers</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                <span class="c1"># mem_fraction_static = (model weights + KV cache pool) / GPU memory capacity.</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                <span class="c1"># We want mem_fraction_static to be as large as possible but still has enough room</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                <span class="c1"># for activations and cuda graph buffers. We use the following heuristic to</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                <span class="c1"># compute the needed size for activations and cuda graph buffers:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                <span class="c1"># - The size of the activation depends on the chunked_prefill_size and model size.</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                <span class="c1"># - The size of cuda graph buffers depends on the cuda graph capture range and model size.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                <span class="c1"># For GPUs with more memory, we use a larger chunked_prefill_size and</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                <span class="c1"># capture more cuda graphs, so they need to reserve more memory.</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                <span class="n">parallel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                <span class="k">if</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                    <span class="c1"># T4, 4080. (chunked_prefill_size 2k, cuda_graph_max_bs 8)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.8</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">35</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                    <span class="c1"># A10, L40, 4090, 5090. (chunked_prefill_size 2k, cuda_graph_max_bs 8)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.8</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                    <span class="c1"># H100, A100. (chunked_prefill_size 8k, cuda_graph_max_bs 160)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mf">9.5</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>                    <span class="c1"># H20. (chunked_prefill_size 8k, cuda_graph_max_bs 256)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">160</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                    <span class="c1"># H200. (chunked_prefill_size 8k, cuda_graph_max_bs 256)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>                    <span class="c1"># B200, MI300. (chunked_prefill_size 16k, cuda_graph_max_bs 512)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                    <span class="c1"># draft model and larger cuda graph buffers</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                    <span class="n">reserved_mem</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                    <span class="n">reserved_mem</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">gpu_mem</span> <span class="o">-</span> <span class="n">reserved_mem</span><span class="p">)</span> <span class="o">/</span> <span class="n">gpu_mem</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="o">=</span> <span class="mf">0.88</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>            <span class="c1"># Lazy init to avoid circular import</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>            <span class="c1"># Multimodal models need more memory for the image processor</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">sglang.srt.configs.model_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelConfig</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>            <span class="n">model_config</span> <span class="o">=</span> <span class="n">ModelConfig</span><span class="o">.</span><span class="n">from_server_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>            <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">is_multimodal</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">adjust_mem_fraction_for_vlm</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="c1"># Set chunked prefill size, which depends on the gpu memory capacity</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>            <span class="k">if</span> <span class="n">gpu_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>                <span class="k">if</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">35</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># A10, L40, 4090</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">160</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># H100, H200, A100, H20</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="mi">8192</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># B200, MI300</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="mi">16384</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="mi">4096</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="c1"># Set cuda graph max batch size</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>            <span class="c1"># Based on detailed statistics, when serving TP1/TP2 models on lower-end GPUs with HBM&lt;25G, you can either disable cuda graph or set `cuda_graph_max_bs` to a very small value to reduce the memory overhead of creating cuda graphs, with almost no impact on performance. However, when serving models with TP4 or TP8, we need to enable cuda graph to maintain high performance. In this case, we can set `cuda_graph_max_bs` to 80 (half of the default value 160) to reduce the memory overhead of creating cuda graphs. Looking at the logs from TP4 serving of qwen2-72b, a value of 80 is sufficient and can reduce the memory overhead of creating cuda graphs on lower-end GPUs compared to the original 160, avoiding OOM issues.</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>            <span class="k">if</span> <span class="n">gpu_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">35</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span> <span class="o">=</span> <span class="mi">80</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="c1"># Set kernel backends for hpu device</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;hpu&quot;</span><span class="p">:</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;torch_native&quot;</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sampling_backend</span> <span class="o">=</span> <span class="s2">&quot;pytorch&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="c1"># Model-specific adjustments</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_specific_adjustments</span><span class="p">()</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="c1"># Set kernel backends</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;intel_amx&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sampling_backend</span> <span class="o">=</span> <span class="s2">&quot;pytorch&quot;</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sampling_backend</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>                <span class="s2">&quot;flashinfer&quot;</span> <span class="k">if</span> <span class="n">is_flashinfer_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;pytorch&quot;</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;torch_native&quot;</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>                <span class="s2">&quot;Cuda graph is disabled because of using torch native attention backend&quot;</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;ascend&quot;</span><span class="p">:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>                <span class="s2">&quot;At this moment Ascend attention backend only supports a page_size of 128, change page_size to 128.&quot;</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">128</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;flashmla&quot;</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;flashmla&quot;</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="p">):</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>                <span class="s2">&quot;FlashMLA only supports a page_size of 64, change page_size to 64.&quot;</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            <span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;cutlass_mla&quot;</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;cutlass_mla&quot;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="p">):</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>                <span class="s2">&quot;Cutlass MLA only supports a page_size of 128, change page_size to 128.&quot;</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>            <span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">128</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mla&quot;</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mla&quot;</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="p">):</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>                    <span class="s2">&quot;TRTLLM MLA backend is only supported on Blackwell GPUs (SM100). Please use a different backend.&quot;</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>                <span class="p">)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>                    <span class="sa">f</span><span class="s2">&quot;TensorRT-LLM MLA only supports page_size of 32 or 64, changing page_size from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">page_size</span><span class="si">}</span><span class="s2"> to 64.&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>                <span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache_dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fp8_e4m3&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">]:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>                    <span class="s2">&quot;TensorRT-LLM MLA backend only supports kv-cache-dtype of fp8_e4m3 or auto.&quot;</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>                <span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefill_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="p">):</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                    <span class="s2">&quot;TRTLLM MHA backend is only supported on Blackwell GPUs (SM100). Please use a different backend.&quot;</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                <span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                    <span class="sa">f</span><span class="s2">&quot;TensorRT-LLM MHA only supports page_size of 16, 32 or 64, changing page_size from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">page_size</span><span class="si">}</span><span class="s2"> to 64.&quot;</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;dual_chunk_flash_attn&quot;</span><span class="p">:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>                <span class="s2">&quot;Mixed chunk, radix cache, and cuda graphs are disabled because of using dual chunk flash attention backend&quot;</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>            <span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_radix_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="c1"># Set page size</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="c1"># AMD-specific Triton attention KV splits default number</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>        <span class="k">if</span> <span class="n">is_hip</span><span class="p">():</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">triton_attention_num_kv_splits</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>        <span class="c1"># Choose grammar backend</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grammar_backend</span> <span class="o">=</span> <span class="s2">&quot;xgrammar&quot;</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="c1"># Data parallelism attention</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_conservativeness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_conservativeness</span> <span class="o">*</span> <span class="mf">0.3</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="p">),</span> <span class="s2">&quot;Please set a dp-size &gt; 1. You can use 1 &lt; dp-size &lt;= tp-size &quot;</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>                <span class="sa">f</span><span class="s2">&quot;DP attention is enabled. The chunked prefill size is adjusted to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span><span class="si">}</span><span class="s2"> to avoid MoE kernel issues. &quot;</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>            <span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_lm_head</span><span class="p">:</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>            <span class="p">),</span> <span class="s2">&quot;Please enable dp attention when setting enable_dp_lm_head. &quot;</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="c1"># MoE kernel</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;flashinfer_cutlass&quot;</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">quantization</span> <span class="o">==</span> <span class="s2">&quot;modelopt_fp4&quot;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="p">),</span> <span class="s2">&quot;modelopt_fp4 quantization is required for Flashinfer MOE&quot;</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="mi">1</span><span class="p">,</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span><span class="p">,</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="p">],</span> <span class="s2">&quot;The expert parallel size must be 1 or the same as the tensor parallel size&quot;</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;flashinfer_trtllm&quot;</span><span class="p">:</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_shared_experts_fusion</span><span class="p">:</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disable_shared_experts_fusion</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                    <span class="s2">&quot;FlashInfer TRTLLM MoE is enabled. --disable-shared-experts-fusion is automatically set.&quot;</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                <span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>        <span class="c1"># DeepEP MoE</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_a2a_backend</span> <span class="o">==</span> <span class="s2">&quot;deepep&quot;</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepep_mode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cuda graph is disabled because deepep_mode=`normal`&quot;</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disable_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                <span class="sa">f</span><span class="s2">&quot;DeepEP MoE is enabled. The expert parallel size is adjusted to be the same as the tensor parallel size[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span><span class="si">}</span><span class="s2">].&quot;</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_eplb</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="o">=</span> <span class="s2">&quot;stat&quot;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                <span class="s2">&quot;EPLB is enabled. The expert_distribution_recorder_mode is automatically set.&quot;</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>            <span class="p">)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_eplb</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_expert_location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ep_dispatch_algorithm</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="p">):</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ep_dispatch_algorithm</span> <span class="o">=</span> <span class="s2">&quot;static&quot;</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_eplb</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_expert_distribution_metrics</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="p">):</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="o">=</span> <span class="s2">&quot;stat&quot;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eplb_rebalance_num_iterations</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="c1"># Pipeline parallelism</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_overlap_schedule</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="s2">&quot;Pipeline parallelism is incompatible with overlap schedule.&quot;</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="c1"># Hicache</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hicache_storage_backend</span> <span class="o">==</span> <span class="s2">&quot;mooncake&quot;</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="c1"># to use mooncake storage backend, the following conditions must be met:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hicache_io_backend</span> <span class="o">=</span> <span class="s2">&quot;kernel&quot;</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hicache_mem_layout</span> <span class="o">=</span> <span class="s2">&quot;page_first&quot;</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="c1"># Speculative Decoding</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="o">==</span> <span class="s2">&quot;NEXTN&quot;</span><span class="p">:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>            <span class="c1"># NEXTN shares the same implementation of EAGLE</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="o">=</span> <span class="s2">&quot;EAGLE&quot;</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;EAGLE&quot;</span><span class="p">,</span> <span class="s2">&quot;EAGLE3&quot;</span><span class="p">):</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_running_requests</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_running_requests</span> <span class="o">=</span> <span class="mi">48</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_overlap_schedule</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                <span class="s2">&quot;Overlap scheduler is disabled because of using &quot;</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                <span class="s2">&quot;eagle speculative decoding.&quot;</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>            <span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                    <span class="s2">&quot;Mixed chunked prefill is disabled because of using &quot;</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>                    <span class="s2">&quot;eagle speculative decoding.&quot;</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>                <span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="n">model_arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hf_config</span><span class="p">()</span><span class="o">.</span><span class="n">architectures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>            <span class="k">if</span> <span class="n">model_arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DeepseekV3ForCausalLM&quot;</span><span class="p">,</span> <span class="s2">&quot;Glm4MoeForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                <span class="c1"># Auto set draft_model_path DeepSeek-V3/R1</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_draft_model_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_draft_model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                        <span class="s2">&quot;DeepSeek MTP does not require setting speculative_draft_model_path.&quot;</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>                    <span class="p">)</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>            <span class="c1"># Auto choose parameters</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_eagle_topk</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                <span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>                <span class="p">(</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_steps</span><span class="p">,</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_eagle_topk</span><span class="p">,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span><span class="p">,</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>                <span class="p">)</span> <span class="o">=</span> <span class="n">auto_choose_speculative_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefill_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>            <span class="p">):</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_eagle_topk</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>                        <span class="s2">&quot;trtllm_mha backend only supports topk = 1 for speculative decoding.&quot;</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>                    <span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">speculative_eagle_topk</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_steps</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>            <span class="p">):</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>                    <span class="s2">&quot;speculative_num_draft_tokens is adjusted to speculative_num_steps + 1 when speculative_eagle_topk == 1&quot;</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>                <span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_steps</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="c1"># The token generated from the verify step is counted.</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>            <span class="c1"># If sepculative_num_steps &gt;= speculative_num_draft_tokens, the additional tokens will definitely be discarded.</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="c1"># assert self.speculative_num_steps &lt; self.speculative_num_draft_tokens</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="c1"># GGUF</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_format</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_format</span> <span class="o">==</span> <span class="s2">&quot;gguf&quot;</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>        <span class="p">)</span> <span class="ow">and</span> <span class="n">check_gguf_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">):</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_format</span> <span class="o">=</span> <span class="s2">&quot;gguf&quot;</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="c1"># Model loading</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>        <span class="k">if</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">):</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_format</span> <span class="o">=</span> <span class="s2">&quot;remote&quot;</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_weight_loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_weight_loader</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="c1"># PD disaggregation</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_mode</span> <span class="o">==</span> <span class="s2">&quot;decode&quot;</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="p">),</span> <span class="s2">&quot;Cannot set --disaggregation-decode-tp for the decode engine.&quot;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="p">),</span> <span class="s2">&quot;Cannot set --disaggregation-decode-dp for the decode engine.&quot;</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_radix_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;KV cache is forced as chunk cache for decode server&quot;</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_mode</span> <span class="o">==</span> <span class="s2">&quot;prefill&quot;</span><span class="p">:</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_prefill_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">validate_disagg_tp_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span><span class="p">)</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cuda graph is disabled for prefill server&quot;</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        <span class="c1"># Propagate env vars</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SGLANG_ENABLE_TORCH_COMPILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>            <span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_torch_compile</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>        <span class="p">)</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>        <span class="c1"># Set env var before grammar backends init</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SGLANG_DISABLE_OUTLINES_DISK_CACHE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>            <span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_outlines_disk_cache</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_hierarchical_cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_radix_cache</span><span class="p">:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                <span class="s2">&quot;The arguments enable-hierarchical-cache and disable-radix-cache are mutually exclusive &quot;</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                <span class="s2">&quot;and cannot be used at the same time. Please use only one of them.&quot;</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_cli_args</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">):</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>        <span class="c1"># Model and tokenizer</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>            <span class="s2">&quot;--model-path&quot;</span><span class="p">,</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>            <span class="s2">&quot;--model&quot;</span><span class="p">,</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the model weights. This can be a local folder or a Hugging Face repo ID.&quot;</span><span class="p">,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="p">)</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>            <span class="s2">&quot;--tokenizer-path&quot;</span><span class="p">,</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tokenizer_path</span><span class="p">,</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the tokenizer.&quot;</span><span class="p">,</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="s2">&quot;--tokenizer-mode&quot;</span><span class="p">,</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tokenizer_mode</span><span class="p">,</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;slow&quot;</span><span class="p">],</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tokenizer mode. &#39;auto&#39; will use the fast &quot;</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>            <span class="s2">&quot;tokenizer if available, and &#39;slow&#39; will &quot;</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>            <span class="s2">&quot;always use the slow tokenizer.&quot;</span><span class="p">,</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>        <span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>            <span class="s2">&quot;--skip-tokenizer-init&quot;</span><span class="p">,</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, skip init tokenizer and pass input_ids in generate request.&quot;</span><span class="p">,</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="p">)</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>            <span class="s2">&quot;--load-format&quot;</span><span class="p">,</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">load_format</span><span class="p">,</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>                <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>                <span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>                <span class="s2">&quot;safetensors&quot;</span><span class="p">,</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>                <span class="s2">&quot;npcache&quot;</span><span class="p">,</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                <span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                <span class="s2">&quot;sharded_state&quot;</span><span class="p">,</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                <span class="s2">&quot;gguf&quot;</span><span class="p">,</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                <span class="s2">&quot;bitsandbytes&quot;</span><span class="p">,</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="s2">&quot;layered&quot;</span><span class="p">,</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                <span class="s2">&quot;remote&quot;</span><span class="p">,</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="p">],</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The format of the model weights to load. &quot;</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="s1">&#39;&quot;auto&quot; will try to load the weights in the safetensors format &#39;</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>            <span class="s2">&quot;and fall back to the pytorch bin format if safetensors format &quot;</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="s2">&quot;is not available. &quot;</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="s1">&#39;&quot;pt&quot; will load the weights in the pytorch bin format. &#39;</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="s1">&#39;&quot;safetensors&quot; will load the weights in the safetensors format. &#39;</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="s1">&#39;&quot;npcache&quot; will load the weights in pytorch format and store &#39;</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="s2">&quot;a numpy cache to speed up the loading. &quot;</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="s1">&#39;&quot;dummy&quot; will initialize the weights with random values, &#39;</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="s2">&quot;which is mainly for profiling.&quot;</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="s1">&#39;&quot;gguf&quot; will load the weights in the gguf format. &#39;</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="s1">&#39;&quot;bitsandbytes&quot; will load the weights using bitsandbytes &#39;</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>            <span class="s2">&quot;quantization.&quot;</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="s1">&#39;&quot;layered&quot; loads weights layer by layer so that one can quantize a &#39;</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>            <span class="s2">&quot;layer before loading another to make the peak memory envelope &quot;</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            <span class="s2">&quot;smaller.&quot;</span><span class="p">,</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>        <span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>            <span class="s2">&quot;--model-loader-extra-config&quot;</span><span class="p">,</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Extra config for model loader. &quot;</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="s2">&quot;This will be passed to the model loader corresponding to the chosen load_format.&quot;</span><span class="p">,</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">model_loader_extra_config</span><span class="p">,</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>            <span class="s2">&quot;--trust-remote-code&quot;</span><span class="p">,</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether or not to allow for custom models defined on the Hub in their own modeling files.&quot;</span><span class="p">,</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="p">)</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>            <span class="s2">&quot;--context-length&quot;</span><span class="p">,</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">context_length</span><span class="p">,</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The model&#39;s maximum context length. Defaults to None (will use the value from the model&#39;s config.json instead).&quot;</span><span class="p">,</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>            <span class="s2">&quot;--is-embedding&quot;</span><span class="p">,</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use a CausalLM as an embedding model.&quot;</span><span class="p">,</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="s2">&quot;--enable-multimodal&quot;</span><span class="p">,</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_multimodal</span><span class="p">,</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable the multimodal functionality for the served model. If the model being served is not multimodal, nothing will happen&quot;</span><span class="p">,</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="s2">&quot;--revision&quot;</span><span class="p">,</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The specific model version to use. It can be a branch &quot;</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>            <span class="s2">&quot;name, a tag name, or a commit id. If unspecified, will use &quot;</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="s2">&quot;the default version.&quot;</span><span class="p">,</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="p">)</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="s2">&quot;--model-impl&quot;</span><span class="p">,</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">model_impl</span><span class="p">,</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which implementation of the model to use.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>            <span class="s1">&#39;* &quot;auto&quot; will try to use the SGLang implementation if it exists &#39;</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="s2">&quot;and fall back to the Transformers implementation if no SGLang &quot;</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            <span class="s2">&quot;implementation is available.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>            <span class="s1">&#39;* &quot;sglang&quot; will use the SGLang model implementation.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>            <span class="s1">&#39;* &quot;transformers&quot; will use the Transformers model &#39;</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            <span class="s2">&quot;implementation.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="p">)</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="c1"># HTTP server</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>            <span class="s2">&quot;--host&quot;</span><span class="p">,</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The host of the HTTP server.&quot;</span><span class="p">,</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="p">)</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>            <span class="s2">&quot;--port&quot;</span><span class="p">,</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The port of the HTTP server.&quot;</span><span class="p">,</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>            <span class="s2">&quot;--skip-server-warmup&quot;</span><span class="p">,</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, skip warmup.&quot;</span><span class="p">,</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="p">)</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="s2">&quot;--warmups&quot;</span><span class="p">,</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify custom warmup functions (csv) to run before server starts eg. --warmups=warmup_name1,warmup_name2 &quot;</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>            <span class="s2">&quot;will run the functions `warmup_name1` and `warmup_name2` specified in warmup.py before the server starts listening for requests&quot;</span><span class="p">,</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>            <span class="s2">&quot;--nccl-port&quot;</span><span class="p">,</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The port for NCCL distributed environment setup. Defaults to a random port.&quot;</span><span class="p">,</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>        <span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="c1"># Quantization and data type</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>            <span class="s2">&quot;--dtype&quot;</span><span class="p">,</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;half&quot;</span><span class="p">,</span> <span class="s2">&quot;float16&quot;</span><span class="p">,</span> <span class="s2">&quot;bfloat16&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">],</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Data type for model weights and activations.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>            <span class="s1">&#39;* &quot;auto&quot; will use FP16 precision for FP32 and FP16 models, and &#39;</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>            <span class="s2">&quot;BF16 precision for BF16 models.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>            <span class="s1">&#39;* &quot;half&quot; for FP16. Recommended for AWQ quantization.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>            <span class="s1">&#39;* &quot;float16&quot; is the same as &quot;half&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>            <span class="s1">&#39;* &quot;bfloat16&quot; for a balance between precision and range.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="s1">&#39;* &quot;float&quot; is shorthand for FP32 precision.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="s1">&#39;* &quot;float32&quot; for FP32 precision.&#39;</span><span class="p">,</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="p">)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>            <span class="s2">&quot;--quantization&quot;</span><span class="p">,</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">quantization</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>                <span class="s2">&quot;awq&quot;</span><span class="p">,</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>                <span class="s2">&quot;fp8&quot;</span><span class="p">,</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                <span class="s2">&quot;gptq&quot;</span><span class="p">,</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                <span class="s2">&quot;marlin&quot;</span><span class="p">,</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>                <span class="s2">&quot;gptq_marlin&quot;</span><span class="p">,</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                <span class="s2">&quot;awq_marlin&quot;</span><span class="p">,</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                <span class="s2">&quot;bitsandbytes&quot;</span><span class="p">,</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                <span class="s2">&quot;gguf&quot;</span><span class="p">,</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                <span class="s2">&quot;modelopt&quot;</span><span class="p">,</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="s2">&quot;modelopt_fp4&quot;</span><span class="p">,</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                <span class="s2">&quot;petit_nvfp4&quot;</span><span class="p">,</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                <span class="s2">&quot;w8a8_int8&quot;</span><span class="p">,</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                <span class="s2">&quot;w8a8_fp8&quot;</span><span class="p">,</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                <span class="s2">&quot;moe_wna16&quot;</span><span class="p">,</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="s2">&quot;qoq&quot;</span><span class="p">,</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>                <span class="s2">&quot;w4afp8&quot;</span><span class="p">,</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                <span class="s2">&quot;mxfp4&quot;</span><span class="p">,</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>            <span class="p">],</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The quantization method.&quot;</span><span class="p">,</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="p">)</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>            <span class="s2">&quot;--quantization-param-path&quot;</span><span class="p">,</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="nb">type</span><span class="o">=</span><span class="n">nullable_str</span><span class="p">,</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the JSON file containing the KV cache &quot;</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>            <span class="s2">&quot;scaling factors. This should generally be supplied, when &quot;</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="s2">&quot;KV cache dtype is FP8. Otherwise, KV cache scaling factors &quot;</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="s2">&quot;default to 1.0, which may cause accuracy issues. &quot;</span><span class="p">,</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="p">)</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>            <span class="s2">&quot;--kv-cache-dtype&quot;</span><span class="p">,</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">kv_cache_dtype</span><span class="p">,</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;fp8_e5m2&quot;</span><span class="p">,</span> <span class="s2">&quot;fp8_e4m3&quot;</span><span class="p">],</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data type for kv cache storage. &quot;auto&quot; will use model data type. &quot;fp8_e5m2&quot; and &quot;fp8_e4m3&quot; is supported for CUDA 11.8+.&#39;</span><span class="p">,</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="p">)</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>        <span class="c1"># Memory and scheduling</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="s2">&quot;--mem-fraction-static&quot;</span><span class="p">,</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">mem_fraction_static</span><span class="p">,</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The fraction of the memory used for static allocation (model weights and KV cache memory pool). Use a smaller value if you see out-of-memory errors.&quot;</span><span class="p">,</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="p">)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="s2">&quot;--max-running-requests&quot;</span><span class="p">,</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_running_requests</span><span class="p">,</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of running requests.&quot;</span><span class="p">,</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>            <span class="s2">&quot;--max-queued-requests&quot;</span><span class="p">,</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_queued_requests</span><span class="p">,</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of queued requests. This option is ignored when using disaggregation-mode.&quot;</span><span class="p">,</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="p">)</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>            <span class="s2">&quot;--max-total-tokens&quot;</span><span class="p">,</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_total_tokens</span><span class="p">,</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in the memory pool. If not specified, it will be automatically calculated based on the memory usage fraction. &quot;</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>            <span class="s2">&quot;This option is typically used for development and debugging purposes.&quot;</span><span class="p">,</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="p">)</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="s2">&quot;--chunked-prefill-size&quot;</span><span class="p">,</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">chunked_prefill_size</span><span class="p">,</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in a chunk for the chunked prefill. Setting this to -1 means disabling chunked prefill.&quot;</span><span class="p">,</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="p">)</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>            <span class="s2">&quot;--max-prefill-tokens&quot;</span><span class="p">,</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_prefill_tokens</span><span class="p">,</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in a prefill batch. The real bound will be the maximum of this value and the model&#39;s maximum context length.&quot;</span><span class="p">,</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="p">)</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>            <span class="s2">&quot;--schedule-policy&quot;</span><span class="p">,</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">schedule_policy</span><span class="p">,</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lpm&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;fcfs&quot;</span><span class="p">,</span> <span class="s2">&quot;dfs-weight&quot;</span><span class="p">,</span> <span class="s2">&quot;lof&quot;</span><span class="p">],</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The scheduling policy of the requests.&quot;</span><span class="p">,</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="p">)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>            <span class="s2">&quot;--schedule-conservativeness&quot;</span><span class="p">,</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">schedule_conservativeness</span><span class="p">,</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How conservative the schedule policy is. A larger value means more conservative scheduling. Use a larger value if you see requests being retracted frequently.&quot;</span><span class="p">,</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="p">)</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>            <span class="s2">&quot;--page-size&quot;</span><span class="p">,</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">page_size</span><span class="p">,</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens in a page.&quot;</span><span class="p">,</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="p">)</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>            <span class="s2">&quot;--hybrid-kvcache-ratio&quot;</span><span class="p">,</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>            <span class="n">const</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hybrid_kvcache_ratio</span><span class="p">,</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                <span class="s2">&quot;Mix ratio in [0,1] between uniform and hybrid kv buffers &quot;</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="s2">&quot;(0.0 = pure uniform: swa_size / full_size = 1)&quot;</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                <span class="s2">&quot;(1.0 = pure hybrid: swa_size / full_size = local_attention_size / context_length)&quot;</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>            <span class="p">),</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="p">)</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>            <span class="s2">&quot;--swa-full-tokens-ratio&quot;</span><span class="p">,</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">swa_full_tokens_ratio</span><span class="p">,</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The ratio of SWA layer KV tokens / full layer KV tokens, regardless of the number of swa:full layers. It should be between 0 and 1. &quot;</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>            <span class="s2">&quot;E.g. 0.5 means if each swa layer has 50 tokens, then each full layer has 100 tokens.&quot;</span><span class="p">,</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="p">)</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            <span class="s2">&quot;--disable-hybrid-swa-memory&quot;</span><span class="p">,</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the hybrid SWA memory.&quot;</span><span class="p">,</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="p">)</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        <span class="c1"># Runtime options</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>            <span class="s2">&quot;--device&quot;</span><span class="p">,</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The device to use (&#39;cuda&#39;, &#39;xpu&#39;, &#39;hpu&#39;, &#39;npu&#39;, &#39;cpu&#39;). Defaults to auto-detection if not specified.&quot;</span><span class="p">,</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>        <span class="p">)</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>            <span class="s2">&quot;--tensor-parallel-size&quot;</span><span class="p">,</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>            <span class="s2">&quot;--tp-size&quot;</span><span class="p">,</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tp_size</span><span class="p">,</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The tensor parallelism size.&quot;</span><span class="p">,</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="p">)</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="s2">&quot;--pipeline-parallel-size&quot;</span><span class="p">,</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>            <span class="s2">&quot;--pp-size&quot;</span><span class="p">,</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">pp_size</span><span class="p">,</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The pipeline parallelism size.&quot;</span><span class="p">,</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>        <span class="p">)</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="s2">&quot;--max-micro-batch-size&quot;</span><span class="p">,</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_micro_batch_size</span><span class="p">,</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum micro batch size in pipeline parallelism.&quot;</span><span class="p">,</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="p">)</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>            <span class="s2">&quot;--stream-interval&quot;</span><span class="p">,</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">stream_interval</span><span class="p">,</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The interval (or buffer size) for streaming in terms of the token length. A smaller value makes streaming smoother, while a larger value makes the throughput higher&quot;</span><span class="p">,</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="p">)</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>            <span class="s2">&quot;--stream-output&quot;</span><span class="p">,</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to output as a sequence of disjoint segments.&quot;</span><span class="p">,</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="p">)</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="s2">&quot;--random-seed&quot;</span><span class="p">,</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The random seed.&quot;</span><span class="p">,</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="p">)</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="s2">&quot;--constrained-json-whitespace-pattern&quot;</span><span class="p">,</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">constrained_json_whitespace_pattern</span><span class="p">,</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(outlines backend only) Regex pattern for syntactic whitespaces allowed in JSON constrained output. For example, to allow the model generate consecutive whitespaces, set the pattern to [</span><span class="se">\n\t</span><span class="s2"> ]*&quot;</span><span class="p">,</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="p">)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            <span class="s2">&quot;--watchdog-timeout&quot;</span><span class="p">,</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">watchdog_timeout</span><span class="p">,</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set watchdog timeout in seconds. If a forward batch takes longer than this, the server will crash to prevent hanging.&quot;</span><span class="p">,</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="p">)</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>            <span class="s2">&quot;--dist-timeout&quot;</span><span class="p">,</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dist_timeout</span><span class="p">,</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set timeout for torch.distributed initialization.&quot;</span><span class="p">,</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>            <span class="s2">&quot;--download-dir&quot;</span><span class="p">,</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">download_dir</span><span class="p">,</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model download directory for huggingface.&quot;</span><span class="p">,</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>        <span class="p">)</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>            <span class="s2">&quot;--base-gpu-id&quot;</span><span class="p">,</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">base_gpu_id</span><span class="p">,</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The base GPU ID to start allocating GPUs from. Useful when running multiple instances on the same machine.&quot;</span><span class="p">,</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        <span class="p">)</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>            <span class="s2">&quot;--gpu-id-step&quot;</span><span class="p">,</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">gpu_id_step</span><span class="p">,</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The delta between consecutive GPU IDs that are used. For example, setting it to 2 will use GPU 0,2,4,...&quot;</span><span class="p">,</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="p">)</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>            <span class="s2">&quot;--sleep-on-idle&quot;</span><span class="p">,</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Reduce CPU usage when sglang is idle.&quot;</span><span class="p">,</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="p">)</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>        <span class="c1"># Logging</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>            <span class="s2">&quot;--log-level&quot;</span><span class="p">,</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_level</span><span class="p">,</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The logging level of all loggers.&quot;</span><span class="p">,</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>        <span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>            <span class="s2">&quot;--log-level-http&quot;</span><span class="p">,</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_level_http</span><span class="p">,</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The logging level of HTTP server. If not set, reuse --log-level by default.&quot;</span><span class="p">,</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>        <span class="p">)</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>            <span class="s2">&quot;--log-requests&quot;</span><span class="p">,</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Log metadata, inputs, outputs of all requests. The verbosity is decided by --log-requests-level&quot;</span><span class="p">,</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>        <span class="p">)</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>            <span class="s2">&quot;--log-requests-level&quot;</span><span class="p">,</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_requests_level</span><span class="p">,</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;0: Log metadata (no sampling parameters). 1: Log metadata and sampling parameters. 2: Log metadata, sampling parameters and partial input/output. 3: Log every input/output.&quot;</span><span class="p">,</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>        <span class="p">)</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>            <span class="s2">&quot;--crash-dump-folder&quot;</span><span class="p">,</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">crash_dump_folder</span><span class="p">,</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Folder path to dump requests from the last 5 min before a crash (if any). If not specified, crash dumping is disabled.&quot;</span><span class="p">,</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>        <span class="p">)</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>            <span class="s2">&quot;--show-time-cost&quot;</span><span class="p">,</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show time cost of custom marks.&quot;</span><span class="p">,</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>        <span class="p">)</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>            <span class="s2">&quot;--enable-metrics&quot;</span><span class="p">,</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable log prometheus metrics.&quot;</span><span class="p">,</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>        <span class="p">)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>            <span class="s2">&quot;--enable-metrics-for-all-schedulers&quot;</span><span class="p">,</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable --enable-metrics-for-all-schedulers when you want schedulers on all TP ranks (not just TP 0) &quot;</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>            <span class="s2">&quot;to record request metrics separately. This is especially useful when dp_attention is enabled, as &quot;</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>            <span class="s2">&quot;otherwise all metrics appear to come from TP 0.&quot;</span><span class="p">,</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>        <span class="p">)</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="s2">&quot;--bucket-time-to-first-token&quot;</span><span class="p">,</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_time_to_first_token</span><span class="p">,</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of time to first token, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="p">)</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>            <span class="s2">&quot;--bucket-inter-token-latency&quot;</span><span class="p">,</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_inter_token_latency</span><span class="p">,</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of inter-token latency, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="p">)</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="s2">&quot;--bucket-e2e-request-latency&quot;</span><span class="p">,</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_e2e_request_latency</span><span class="p">,</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of end-to-end request latency, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>            <span class="s2">&quot;--collect-tokens-histogram&quot;</span><span class="p">,</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">collect_tokens_histogram</span><span class="p">,</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Collect prompt/generation tokens histogram.&quot;</span><span class="p">,</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="p">)</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>            <span class="s2">&quot;--gc-warning-threshold-secs&quot;</span><span class="p">,</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">gc_warning_threshold_secs</span><span class="p">,</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The threshold for long GC warning. If a GC takes longer than this, a warning will be logged. Set to 0 to disable.&quot;</span><span class="p">,</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        <span class="p">)</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>            <span class="s2">&quot;--decode-log-interval&quot;</span><span class="p">,</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">decode_log_interval</span><span class="p">,</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The log interval of decode batch.&quot;</span><span class="p">,</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        <span class="p">)</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>            <span class="s2">&quot;--enable-request-time-stats-logging&quot;</span><span class="p">,</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_request_time_stats_logging</span><span class="p">,</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable per request time stats logging&quot;</span><span class="p">,</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="p">)</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>            <span class="s2">&quot;--kv-events-config&quot;</span><span class="p">,</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Config in json format for NVIDIA dynamo KV event publishing. Publishing will be enabled if this flag is used.&quot;</span><span class="p">,</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="p">)</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>        <span class="c1"># API related</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>            <span class="s2">&quot;--api-key&quot;</span><span class="p">,</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set API key of the server. It is also used in the OpenAI API compatible server.&quot;</span><span class="p">,</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="p">)</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>            <span class="s2">&quot;--served-model-name&quot;</span><span class="p">,</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">served_model_name</span><span class="p">,</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Override the model name returned by the v1/models endpoint in OpenAI API server.&quot;</span><span class="p">,</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="p">)</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>            <span class="s2">&quot;--weight-version&quot;</span><span class="p">,</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">weight_version</span><span class="p">,</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Version identifier for the model weights. Defaults to &#39;default&#39; if not specified.&quot;</span><span class="p">,</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>        <span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>            <span class="s2">&quot;--chat-template&quot;</span><span class="p">,</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">chat_template</span><span class="p">,</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buliltin chat template name or the path of the chat template file. This is only used for OpenAI-compatible API server.&quot;</span><span class="p">,</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="p">)</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>            <span class="s2">&quot;--completion-template&quot;</span><span class="p">,</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">completion_template</span><span class="p">,</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buliltin completion template name or the path of the completion template file. This is only used for OpenAI-compatible API server. only for code completion currently.&quot;</span><span class="p">,</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="p">)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="s2">&quot;--file-storage-path&quot;</span><span class="p">,</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">file_storage_path</span><span class="p">,</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the file storage in backend.&quot;</span><span class="p">,</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>            <span class="s2">&quot;--enable-cache-report&quot;</span><span class="p">,</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Return number of cached tokens in usage.prompt_tokens_details for each openai request.&quot;</span><span class="p">,</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        <span class="p">)</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>            <span class="s2">&quot;--reasoning-parser&quot;</span><span class="p">,</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>            <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ReasoningParser</span><span class="o">.</span><span class="n">DetectorMap</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">reasoning_parser</span><span class="p">,</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Specify the parser for reasoning models, supported parsers are: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ReasoningParser</span><span class="o">.</span><span class="n">DetectorMap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>        <span class="p">)</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>        <span class="n">tool_call_parser_choices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FunctionCallParser</span><span class="o">.</span><span class="n">ToolCallParserEnum</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>            <span class="s2">&quot;--tool-call-parser&quot;</span><span class="p">,</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">tool_call_parser_choices</span><span class="p">,</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tool_call_parser</span><span class="p">,</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Specify the parser for handling tool-call interactions. Options include: </span><span class="si">{</span><span class="n">tool_call_parser_choices</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>        <span class="p">)</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>            <span class="s2">&quot;--tool-server&quot;</span><span class="p">,</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Either &#39;demo&#39; or a comma-separated list of tool server urls to use for the model. If not specified, no tool server will be used.&quot;</span><span class="p">,</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>        <span class="p">)</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>        <span class="c1"># Data parallelism</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>            <span class="s2">&quot;--data-parallel-size&quot;</span><span class="p">,</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>            <span class="s2">&quot;--dp-size&quot;</span><span class="p">,</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dp_size</span><span class="p">,</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The data parallelism size.&quot;</span><span class="p">,</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>        <span class="p">)</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>            <span class="s2">&quot;--load-balance-method&quot;</span><span class="p">,</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">load_balance_method</span><span class="p">,</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The load balancing strategy for data parallelism.&quot;</span><span class="p">,</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>                <span class="s2">&quot;round_robin&quot;</span><span class="p">,</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>                <span class="s2">&quot;shortest_queue&quot;</span><span class="p">,</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>                <span class="s2">&quot;minimum_tokens&quot;</span><span class="p">,</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>            <span class="p">],</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="p">)</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>        <span class="c1"># Multi-node distributed serving</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>            <span class="s2">&quot;--dist-init-addr&quot;</span><span class="p">,</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>            <span class="s2">&quot;--nccl-init-addr&quot;</span><span class="p">,</span>  <span class="c1"># For backward compatibility. This will be removed in the future.</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The host address for initializing distributed backend (e.g., `192.168.0.2:25000`).&quot;</span><span class="p">,</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>        <span class="p">)</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>            <span class="s2">&quot;--nnodes&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">nnodes</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of nodes.&quot;</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>        <span class="p">)</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>            <span class="s2">&quot;--node-rank&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">node_rank</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The node rank.&quot;</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>        <span class="p">)</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>        <span class="c1"># Model override args</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>            <span class="s2">&quot;--json-model-override-args&quot;</span><span class="p">,</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A dictionary in JSON string format used to override default model configurations.&quot;</span><span class="p">,</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">json_model_override_args</span><span class="p">,</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>        <span class="p">)</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="s2">&quot;--preferred-sampling-params&quot;</span><span class="p">,</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;json-formatted sampling settings that will be returned in /get_model_info&quot;</span><span class="p">,</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>        <span class="p">)</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>        <span class="c1"># LoRA</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>            <span class="s2">&quot;--enable-lora&quot;</span><span class="p">,</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_lora</span><span class="p">,</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable LoRA support for the model. This argument is automatically set to True if `--lora-paths` is provided for backward compatibility.&quot;</span><span class="p">,</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>        <span class="p">)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>            <span class="s2">&quot;--max-lora-rank&quot;</span><span class="p">,</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_lora_rank</span><span class="p">,</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum rank of LoRA adapters. If not specified, it will be automatically inferred from the adapters provided in --lora-paths.&quot;</span><span class="p">,</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>        <span class="p">)</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>            <span class="s2">&quot;--lora-target-modules&quot;</span><span class="p">,</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">SUPPORTED_LORA_TARGET_MODULES</span> <span class="o">+</span> <span class="p">[</span><span class="n">LORA_TARGET_ALL_MODULES</span><span class="p">],</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The union set of all target modules where LoRA should be applied. If not specified, &quot;</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>            <span class="s2">&quot;it will be automatically inferred from the adapters provided in --lora-paths. If &#39;all&#39; is specified, &quot;</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>            <span class="s2">&quot;all supported modules will be targeted.&quot;</span><span class="p">,</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>        <span class="p">)</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>            <span class="s2">&quot;--lora-paths&quot;</span><span class="p">,</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>            <span class="n">action</span><span class="o">=</span><span class="n">LoRAPathAction</span><span class="p">,</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The list of LoRA adapters to load. Each adapter must be specified in one of the following formats: &lt;PATH&gt; | &lt;NAME&gt;=&lt;PATH&gt; | JSON with schema {&quot;lora_name&quot;:str,&quot;lora_path&quot;:str,&quot;pinned&quot;:bool}&#39;</span><span class="p">,</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>        <span class="p">)</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>            <span class="s2">&quot;--max-loras-per-batch&quot;</span><span class="p">,</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>            <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum number of adapters for a running batch, include base-only request.&quot;</span><span class="p">,</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        <span class="p">)</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>            <span class="s2">&quot;--max-loaded-loras&quot;</span><span class="p">,</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="p">,</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If specified, it limits the maximum number of LoRA adapters loaded in CPU memory at a time. The value must be greater than or equal to `--max-loras-per-batch`.&quot;</span><span class="p">,</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>        <span class="p">)</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>            <span class="s2">&quot;--lora-backend&quot;</span><span class="p">,</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernel backend for multi-LoRA serving.&quot;</span><span class="p">,</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>        <span class="p">)</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="c1"># Kernel backend</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="n">ATTN_BACKENDS</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>            <span class="c1"># Common</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>            <span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>            <span class="s2">&quot;torch_native&quot;</span><span class="p">,</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>            <span class="c1"># NVIDIA specific</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>            <span class="s2">&quot;cutlass_mla&quot;</span><span class="p">,</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>            <span class="s2">&quot;fa3&quot;</span><span class="p">,</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>            <span class="s2">&quot;flashinfer&quot;</span><span class="p">,</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>            <span class="s2">&quot;flashmla&quot;</span><span class="p">,</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>            <span class="s2">&quot;trtllm_mla&quot;</span><span class="p">,</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>            <span class="s2">&quot;trtllm_mha&quot;</span><span class="p">,</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>            <span class="s2">&quot;dual_chunk_flash_attn&quot;</span><span class="p">,</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>            <span class="c1"># AMD specific</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>            <span class="s2">&quot;aiter&quot;</span><span class="p">,</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            <span class="s2">&quot;wave&quot;</span><span class="p">,</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="c1"># Other platforms</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>            <span class="s2">&quot;intel_amx&quot;</span><span class="p">,</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>            <span class="s2">&quot;ascend&quot;</span><span class="p">,</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>        <span class="p">]</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="s2">&quot;--attention-backend&quot;</span><span class="p">,</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">attention_backend</span><span class="p">,</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for attention layers.&quot;</span><span class="p">,</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="p">)</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="s2">&quot;--prefill-attention-backend&quot;</span><span class="p">,</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">prefill_attention_backend</span><span class="p">,</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for prefill attention layers (have priority over --attention-backend).&quot;</span><span class="p">,</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="p">)</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="s2">&quot;--decode-attention-backend&quot;</span><span class="p">,</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">decode_attention_backend</span><span class="p">,</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for decode attention layers (have priority over --attention-backend).&quot;</span><span class="p">,</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="p">)</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="s2">&quot;--sampling-backend&quot;</span><span class="p">,</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flashinfer&quot;</span><span class="p">,</span> <span class="s2">&quot;pytorch&quot;</span><span class="p">],</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">sampling_backend</span><span class="p">,</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for sampling layers.&quot;</span><span class="p">,</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="p">)</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>            <span class="s2">&quot;--grammar-backend&quot;</span><span class="p">,</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xgrammar&quot;</span><span class="p">,</span> <span class="s2">&quot;outlines&quot;</span><span class="p">,</span> <span class="s2">&quot;llguidance&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">],</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">grammar_backend</span><span class="p">,</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the backend for grammar-guided decoding.&quot;</span><span class="p">,</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>        <span class="p">)</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>            <span class="s2">&quot;--mm-attention-backend&quot;</span><span class="p">,</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sdpa&quot;</span><span class="p">,</span> <span class="s2">&quot;fa3&quot;</span><span class="p">,</span> <span class="s2">&quot;triton_attn&quot;</span><span class="p">],</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">mm_attention_backend</span><span class="p">,</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set multimodal attention backend.&quot;</span><span class="p">,</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="p">)</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="c1"># Speculative decoding</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>            <span class="s2">&quot;--speculative-algorithm&quot;</span><span class="p">,</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EAGLE&quot;</span><span class="p">,</span> <span class="s2">&quot;EAGLE3&quot;</span><span class="p">,</span> <span class="s2">&quot;NEXTN&quot;</span><span class="p">],</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Speculative algorithm.&quot;</span><span class="p">,</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>        <span class="p">)</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>            <span class="s2">&quot;--speculative-draft-model-path&quot;</span><span class="p">,</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the draft model weights. This can be a local folder or a Hugging Face repo ID.&quot;</span><span class="p">,</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="p">)</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>            <span class="s2">&quot;--speculative-num-steps&quot;</span><span class="p">,</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of steps sampled from draft model in Speculative Decoding.&quot;</span><span class="p">,</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_num_steps</span><span class="p">,</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        <span class="p">)</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>            <span class="s2">&quot;--speculative-eagle-topk&quot;</span><span class="p">,</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens sampled from the draft model in eagle2 each step.&quot;</span><span class="p">,</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_eagle_topk</span><span class="p">,</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>        <span class="p">)</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>            <span class="s2">&quot;--speculative-num-draft-tokens&quot;</span><span class="p">,</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens sampled from the draft model in Speculative Decoding.&quot;</span><span class="p">,</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span><span class="p">,</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>        <span class="p">)</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>            <span class="s2">&quot;--speculative-accept-threshold-single&quot;</span><span class="p">,</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Accept a draft token if its probability in the target model is greater than this threshold.&quot;</span><span class="p">,</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_accept_threshold_single</span><span class="p">,</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>        <span class="p">)</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>            <span class="s2">&quot;--speculative-accept-threshold-acc&quot;</span><span class="p">,</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The accept probability of a draft token is raised from its target probability p to min(1, p / threshold_acc).&quot;</span><span class="p">,</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_accept_threshold_acc</span><span class="p">,</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="p">)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>            <span class="s2">&quot;--speculative-token-map&quot;</span><span class="p">,</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the draft model&#39;s small vocab table.&quot;</span><span class="p">,</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_token_map</span><span class="p">,</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>        <span class="p">)</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="c1"># Expert parallelism</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>            <span class="s2">&quot;--expert-parallel-size&quot;</span><span class="p">,</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>            <span class="s2">&quot;--ep-size&quot;</span><span class="p">,</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>            <span class="s2">&quot;--ep&quot;</span><span class="p">,</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_size</span><span class="p">,</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The expert parallelism size.&quot;</span><span class="p">,</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="p">)</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>            <span class="s2">&quot;--moe-a2a-backend&quot;</span><span class="p">,</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;deepep&quot;</span><span class="p">],</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_a2a_backend</span><span class="p">,</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the backend for MoE A2A.&quot;</span><span class="p">,</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>        <span class="p">)</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>            <span class="s2">&quot;--moe-runner-backend&quot;</span><span class="p">,</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>                <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>                <span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>                <span class="s2">&quot;triton_kernel&quot;</span><span class="p">,</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>                <span class="s2">&quot;flashinfer_trtllm&quot;</span><span class="p">,</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>                <span class="s2">&quot;flashinfer_cutlass&quot;</span><span class="p">,</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>                <span class="s2">&quot;flashinfer_mxfp4&quot;</span><span class="p">,</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>            <span class="p">],</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_runner_backend</span><span class="p">,</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the runner backend for MoE.&quot;</span><span class="p">,</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>        <span class="p">)</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>            <span class="s2">&quot;--flashinfer-mxfp4-moe-precision&quot;</span><span class="p">,</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mxfp4&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">],</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">flashinfer_mxfp4_moe_precision</span><span class="p">,</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the computation precision of flashinfer mxfp4 moe&quot;</span><span class="p">,</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>        <span class="p">)</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>            <span class="s2">&quot;--enable-flashinfer-allreduce-fusion&quot;</span><span class="p">,</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable FlashInfer allreduce fusion with Residual RMSNorm.&quot;</span><span class="p">,</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>        <span class="p">)</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>            <span class="s2">&quot;--deepep-mode&quot;</span><span class="p">,</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;low_latency&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">],</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select the mode when enable DeepEP MoE, could be `normal`, `low_latency` or `auto`. Default is `auto`, which means `low_latency` for decode batch and `normal` for prefill batch.&quot;</span><span class="p">,</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>        <span class="p">)</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>            <span class="s2">&quot;--ep-num-redundant-experts&quot;</span><span class="p">,</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_num_redundant_experts</span><span class="p">,</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allocate this number of redundant experts in expert parallel.&quot;</span><span class="p">,</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>        <span class="p">)</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>            <span class="s2">&quot;--ep-dispatch-algorithm&quot;</span><span class="p">,</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_dispatch_algorithm</span><span class="p">,</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The algorithm to choose ranks for redundant experts in expert parallel.&quot;</span><span class="p">,</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>        <span class="p">)</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>            <span class="s2">&quot;--init-expert-location&quot;</span><span class="p">,</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">init_expert_location</span><span class="p">,</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Initial location of EP experts.&quot;</span><span class="p">,</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>        <span class="p">)</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>            <span class="s2">&quot;--enable-eplb&quot;</span><span class="p">,</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable EPLB algorithm&quot;</span><span class="p">,</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>        <span class="p">)</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>            <span class="s2">&quot;--eplb-algorithm&quot;</span><span class="p">,</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_algorithm</span><span class="p">,</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Chosen EPLB algorithm&quot;</span><span class="p">,</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>        <span class="p">)</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>            <span class="s2">&quot;--eplb-rebalance-num-iterations&quot;</span><span class="p">,</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_rebalance_num_iterations</span><span class="p">,</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of iterations to automatically trigger a EPLB re-balance.&quot;</span><span class="p">,</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>        <span class="p">)</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>            <span class="s2">&quot;--eplb-rebalance-layers-per-chunk&quot;</span><span class="p">,</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_rebalance_layers_per_chunk</span><span class="p">,</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers to rebalance per forward pass.&quot;</span><span class="p">,</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>        <span class="p">)</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>            <span class="s2">&quot;--expert-distribution-recorder-mode&quot;</span><span class="p">,</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span><span class="p">,</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mode of expert distribution recorder.&quot;</span><span class="p">,</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>        <span class="p">)</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>            <span class="s2">&quot;--expert-distribution-recorder-buffer-size&quot;</span><span class="p">,</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span><span class="p">,</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Circular buffer size of expert distribution recorder. Set to -1 to denote infinite buffer.&quot;</span><span class="p">,</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>        <span class="p">)</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>            <span class="s2">&quot;--enable-expert-distribution-metrics&quot;</span><span class="p">,</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable logging metrics for expert balancedness&quot;</span><span class="p">,</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>        <span class="p">)</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>            <span class="s2">&quot;--deepep-config&quot;</span><span class="p">,</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">deepep_config</span><span class="p">,</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tuned DeepEP config suitable for your own cluster. It can be either a string with JSON content or a file path.&quot;</span><span class="p">,</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>        <span class="p">)</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>            <span class="s2">&quot;--moe-dense-tp-size&quot;</span><span class="p">,</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_dense_tp_size</span><span class="p">,</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;TP size for MoE dense MLP layers. This flag is useful when, with large TP size, there are errors caused by weights in MLP layers having dimension smaller than the min dimension GEMM supports.&quot;</span><span class="p">,</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="p">)</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="c1"># Hierarchical cache</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>            <span class="s2">&quot;--enable-hierarchical-cache&quot;</span><span class="p">,</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable hierarchical cache&quot;</span><span class="p">,</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>        <span class="p">)</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="s2">&quot;--hicache-ratio&quot;</span><span class="p">,</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_ratio</span><span class="p">,</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The ratio of the size of host KV cache memory pool to the size of device pool.&quot;</span><span class="p">,</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="p">)</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="s2">&quot;--hicache-size&quot;</span><span class="p">,</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_size</span><span class="p">,</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The size of host KV cache memory pool in gigabytes, which will override the hicache_ratio if set.&quot;</span><span class="p">,</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>        <span class="p">)</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>            <span class="s2">&quot;--hicache-write-policy&quot;</span><span class="p">,</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;write_back&quot;</span><span class="p">,</span> <span class="s2">&quot;write_through&quot;</span><span class="p">,</span> <span class="s2">&quot;write_through_selective&quot;</span><span class="p">],</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_write_policy</span><span class="p">,</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The write policy of hierarchical cache.&quot;</span><span class="p">,</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>        <span class="p">)</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>            <span class="s2">&quot;--hicache-io-backend&quot;</span><span class="p">,</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel&quot;</span><span class="p">],</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_io_backend</span><span class="p">,</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The IO backend for KV cache transfer between CPU and GPU&quot;</span><span class="p">,</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>        <span class="p">)</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>            <span class="s2">&quot;--hicache-mem-layout&quot;</span><span class="p">,</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layer_first&quot;</span><span class="p">,</span> <span class="s2">&quot;page_first&quot;</span><span class="p">],</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_mem_layout</span><span class="p">,</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The layout of host memory pool for hierarchical cache.&quot;</span><span class="p">,</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>        <span class="p">)</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>            <span class="s2">&quot;--hicache-storage-backend&quot;</span><span class="p">,</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;mooncake&quot;</span><span class="p">,</span> <span class="s2">&quot;hf3fs&quot;</span><span class="p">,</span> <span class="s2">&quot;nixl&quot;</span><span class="p">],</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_backend</span><span class="p">,</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The storage backend for hierarchical KV cache.&quot;</span><span class="p">,</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>        <span class="p">)</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>            <span class="s2">&quot;--hicache-storage-prefetch-policy&quot;</span><span class="p">,</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;best_effort&quot;</span><span class="p">,</span> <span class="s2">&quot;wait_complete&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">],</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_prefetch_policy</span><span class="p">,</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Control when prefetching from the storage backend should stop.&quot;</span><span class="p">,</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>        <span class="p">)</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>            <span class="s2">&quot;--hicache-storage-backend-extra-config&quot;</span><span class="p">,</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_backend_extra_config</span><span class="p">,</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A dictionary in JSON string format containing extra configuration for the storage backend.&quot;</span><span class="p">,</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>        <span class="p">)</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>        <span class="c1"># Double Sparsity</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>            <span class="s2">&quot;--enable-double-sparsity&quot;</span><span class="p">,</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>        <span class="p">)</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>            <span class="s2">&quot;--ds-channel-config-path&quot;</span><span class="p">,</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_channel_config_path</span><span class="p">,</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the double sparsity channel config&quot;</span><span class="p">,</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>        <span class="p">)</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>            <span class="s2">&quot;--ds-heavy-channel-num&quot;</span><span class="p">,</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_channel_num</span><span class="p">,</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>        <span class="p">)</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>            <span class="s2">&quot;--ds-heavy-token-num&quot;</span><span class="p">,</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_token_num</span><span class="p">,</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of heavy tokens in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>        <span class="p">)</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>            <span class="s2">&quot;--ds-heavy-channel-type&quot;</span><span class="p">,</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_channel_type</span><span class="p">,</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The type of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>        <span class="p">)</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>            <span class="s2">&quot;--ds-sparse-decode-threshold&quot;</span><span class="p">,</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_sparse_decode_threshold</span><span class="p">,</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The type of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>        <span class="p">)</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>        <span class="c1"># Offloading</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>            <span class="s2">&quot;--cpu-offload-gb&quot;</span><span class="p">,</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">cpu_offload_gb</span><span class="p">,</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How many GBs of RAM to reserve for CPU offloading.&quot;</span><span class="p">,</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>        <span class="p">)</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>            <span class="s2">&quot;--offload-group-size&quot;</span><span class="p">,</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_group_size</span><span class="p">,</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers per group in offloading.&quot;</span><span class="p">,</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>        <span class="p">)</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>            <span class="s2">&quot;--offload-num-in-group&quot;</span><span class="p">,</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_num_in_group</span><span class="p">,</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers to be offloaded within a group.&quot;</span><span class="p">,</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>        <span class="p">)</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>            <span class="s2">&quot;--offload-prefetch-step&quot;</span><span class="p">,</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_prefetch_step</span><span class="p">,</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Steps to prefetch in offloading.&quot;</span><span class="p">,</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>        <span class="p">)</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>            <span class="s2">&quot;--offload-mode&quot;</span><span class="p">,</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_mode</span><span class="p">,</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mode of offloading.&quot;</span><span class="p">,</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>        <span class="p">)</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>        <span class="c1"># Optimization/debug options</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>            <span class="s2">&quot;--disable-radix-cache&quot;</span><span class="p">,</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable RadixAttention for prefix caching.&quot;</span><span class="p">,</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>        <span class="p">)</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>            <span class="s2">&quot;--cuda-graph-max-bs&quot;</span><span class="p">,</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span><span class="p">,</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum batch size for cuda graph. It will extend the cuda graph capture batch size to this value.&quot;</span><span class="p">,</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>        <span class="p">)</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>            <span class="s2">&quot;--cuda-graph-bs&quot;</span><span class="p">,</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the list of batch sizes for cuda graph.&quot;</span><span class="p">,</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>        <span class="p">)</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>            <span class="s2">&quot;--disable-cuda-graph&quot;</span><span class="p">,</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable cuda graph.&quot;</span><span class="p">,</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>        <span class="p">)</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>            <span class="s2">&quot;--disable-cuda-graph-padding&quot;</span><span class="p">,</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable cuda graph when padding is needed. Still uses cuda graph when padding is not needed.&quot;</span><span class="p">,</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>        <span class="p">)</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>            <span class="s2">&quot;--enable-profile-cuda-graph&quot;</span><span class="p">,</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable profiling of cuda graph capture.&quot;</span><span class="p">,</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>        <span class="p">)</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>            <span class="s2">&quot;--enable-cudagraph-gc&quot;</span><span class="p">,</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable garbage collection during CUDA graph capture. If disabled (default), GC is frozen during capture to speed up the process.&quot;</span><span class="p">,</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>        <span class="p">)</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>            <span class="s2">&quot;--enable-nccl-nvls&quot;</span><span class="p">,</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable NCCL NVLS for prefill heavy requests when available.&quot;</span><span class="p">,</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>        <span class="p">)</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>            <span class="s2">&quot;--enable-symm-mem&quot;</span><span class="p">,</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable NCCL symmetric memory for fast collectives.&quot;</span><span class="p">,</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>        <span class="p">)</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>            <span class="s2">&quot;--disable-flashinfer-cutlass-moe-fp4-allgather&quot;</span><span class="p">,</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disables quantize before all-gather for flashinfer cutlass moe.&quot;</span><span class="p">,</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>        <span class="p">)</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>            <span class="s2">&quot;--enable-tokenizer-batch-encode&quot;</span><span class="p">,</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable batch tokenization for improved performance when processing multiple text inputs. Do not use with image inputs, pre-tokenized input_ids, or input_embeds.&quot;</span><span class="p">,</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>        <span class="p">)</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>            <span class="s2">&quot;--disable-outlines-disk-cache&quot;</span><span class="p">,</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable disk cache of outlines to avoid possible crashes related to file system or high concurrency.&quot;</span><span class="p">,</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>        <span class="p">)</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>            <span class="s2">&quot;--disable-custom-all-reduce&quot;</span><span class="p">,</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the custom all-reduce kernel and fall back to NCCL.&quot;</span><span class="p">,</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>        <span class="p">)</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>            <span class="s2">&quot;--enable-mscclpp&quot;</span><span class="p">,</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable using mscclpp for small messages for all-reduce kernel and fall back to NCCL.&quot;</span><span class="p">,</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>        <span class="p">)</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>            <span class="s2">&quot;--disable-overlap-schedule&quot;</span><span class="p">,</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the overlap scheduler, which overlaps the CPU scheduler with GPU model worker.&quot;</span><span class="p">,</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>        <span class="p">)</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>            <span class="s2">&quot;--enable-mixed-chunk&quot;</span><span class="p">,</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling mixing prefill and decode in a batch when using chunked prefill.&quot;</span><span class="p">,</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>        <span class="p">)</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>            <span class="s2">&quot;--enable-dp-attention&quot;</span><span class="p">,</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling data parallelism for attention and tensor parallelism for FFN. The dp size should be equal to the tp size. Currently DeepSeek-V2 and Qwen 2/3 MoE models are supported.&quot;</span><span class="p">,</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>        <span class="p">)</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>            <span class="s2">&quot;--enable-dp-lm-head&quot;</span><span class="p">,</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable vocabulary parallel across the attention TP group to avoid all-gather across DP groups, optimizing performance under DP attention.&quot;</span><span class="p">,</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>        <span class="p">)</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>            <span class="s2">&quot;--enable-two-batch-overlap&quot;</span><span class="p">,</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling two micro batches to overlap.&quot;</span><span class="p">,</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>        <span class="p">)</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>            <span class="s2">&quot;--tbo-token-distribution-threshold&quot;</span><span class="p">,</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tbo_token_distribution_threshold</span><span class="p">,</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The threshold of token distribution between two batches in micro-batch-overlap, determines whether to two-batch-overlap or two-chunk-overlap. Set to 0 denote disable two-chunk-overlap.&quot;</span><span class="p">,</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>        <span class="p">)</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>            <span class="s2">&quot;--enable-torch-compile&quot;</span><span class="p">,</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optimize the model with torch.compile. Experimental feature.&quot;</span><span class="p">,</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>        <span class="p">)</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>            <span class="s2">&quot;--torch-compile-max-bs&quot;</span><span class="p">,</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">torch_compile_max_bs</span><span class="p">,</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum batch size when using torch compile.&quot;</span><span class="p">,</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>        <span class="p">)</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>            <span class="s2">&quot;--torchao-config&quot;</span><span class="p">,</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">torchao_config</span><span class="p">,</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optimize the model with torchao. Experimental feature. Current choices are: int8dq, int8wo, int4wo-&lt;group_size&gt;, fp8wo, fp8dq-per_tensor, fp8dq-per_row&quot;</span><span class="p">,</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>        <span class="p">)</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>            <span class="s2">&quot;--enable-nan-detection&quot;</span><span class="p">,</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable the NaN detection for debugging purposes.&quot;</span><span class="p">,</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>        <span class="p">)</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>            <span class="s2">&quot;--enable-p2p-check&quot;</span><span class="p">,</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable P2P check for GPU access, otherwise the p2p access is allowed by default.&quot;</span><span class="p">,</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>        <span class="p">)</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>            <span class="s2">&quot;--triton-attention-reduce-in-fp32&quot;</span><span class="p">,</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cast the intermediate attention results to fp32 to avoid possible crashes related to fp16.&quot;</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>            <span class="s2">&quot;This only affects Triton attention kernels.&quot;</span><span class="p">,</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>        <span class="p">)</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>            <span class="s2">&quot;--triton-attention-num-kv-splits&quot;</span><span class="p">,</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">triton_attention_num_kv_splits</span><span class="p">,</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of KV splits in flash decoding Triton kernel. Larger value is better in longer context scenarios. The default value is 8.&quot;</span><span class="p">,</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>        <span class="p">)</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>            <span class="s2">&quot;--num-continuous-decode-steps&quot;</span><span class="p">,</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">num_continuous_decode_steps</span><span class="p">,</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run multiple continuous decoding steps to reduce scheduling overhead. &quot;</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>            <span class="s2">&quot;This can potentially increase throughput but may also increase time-to-first-token latency. &quot;</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>            <span class="s2">&quot;The default value is 1, meaning only run one decoding step at a time.&quot;</span><span class="p">,</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>        <span class="p">)</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>            <span class="s2">&quot;--delete-ckpt-after-loading&quot;</span><span class="p">,</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Delete the model checkpoint after loading the model.&quot;</span><span class="p">,</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>        <span class="p">)</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>            <span class="s2">&quot;--enable-memory-saver&quot;</span><span class="p">,</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow saving memory using release_memory_occupation and resume_memory_occupation&quot;</span><span class="p">,</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>        <span class="p">)</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>            <span class="s2">&quot;--allow-auto-truncate&quot;</span><span class="p">,</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow automatically truncating requests that exceed the maximum input length instead of returning an error.&quot;</span><span class="p">,</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>        <span class="p">)</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>            <span class="s2">&quot;--enable-custom-logit-processor&quot;</span><span class="p">,</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable users to pass custom logit processors to the server (disabled by default for security)&quot;</span><span class="p">,</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>        <span class="p">)</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>            <span class="s2">&quot;--flashinfer-mla-disable-ragged&quot;</span><span class="p">,</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Not using ragged prefill wrapper when running flashinfer mla&quot;</span><span class="p">,</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>        <span class="p">)</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>            <span class="s2">&quot;--disable-shared-experts-fusion&quot;</span><span class="p">,</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable shared experts fusion optimization for deepseek v3/r1.&quot;</span><span class="p">,</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>        <span class="p">)</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>            <span class="s2">&quot;--disable-chunked-prefix-cache&quot;</span><span class="p">,</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable chunked prefix cache feature for deepseek, which should save overhead for short sequences.&quot;</span><span class="p">,</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>        <span class="p">)</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>            <span class="s2">&quot;--disable-fast-image-processor&quot;</span><span class="p">,</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Adopt base image processor instead of fast image processor.&quot;</span><span class="p">,</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>        <span class="p">)</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>            <span class="s2">&quot;--enable-return-hidden-states&quot;</span><span class="p">,</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable returning hidden states with responses.&quot;</span><span class="p">,</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>        <span class="p">)</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>            <span class="s2">&quot;--scheduler-recv-interval&quot;</span><span class="p">,</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">scheduler_recv_interval</span><span class="p">,</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The interval to poll requests in scheduler. Can be set to &gt;1 to reduce the overhead of this.&quot;</span><span class="p">,</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>        <span class="p">)</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>        <span class="c1"># Debug tensor dumps</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>            <span class="s2">&quot;--debug-tensor-dump-output-folder&quot;</span><span class="p">,</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_output_folder</span><span class="p">,</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output folder for dumping tensors.&quot;</span><span class="p">,</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>        <span class="p">)</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>            <span class="s2">&quot;--debug-tensor-dump-input-file&quot;</span><span class="p">,</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_input_file</span><span class="p">,</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The input filename for dumping tensors&quot;</span><span class="p">,</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>        <span class="p">)</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>            <span class="s2">&quot;--debug-tensor-dump-inject&quot;</span><span class="p">,</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_inject</span><span class="p">,</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Inject the outputs from jax as the input of every layer.&quot;</span><span class="p">,</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>        <span class="p">)</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a>            <span class="s2">&quot;--debug-tensor-dump-prefill-only&quot;</span><span class="p">,</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only dump the tensors for prefill requests (i.e. batch size &gt; 1).&quot;</span><span class="p">,</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>        <span class="p">)</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>        <span class="c1"># PD disaggregation</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>            <span class="s2">&quot;--disaggregation-mode&quot;</span><span class="p">,</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">,</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;prefill&quot;</span><span class="p">,</span> <span class="s2">&quot;decode&quot;</span><span class="p">],</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only used for PD disaggregation. &quot;prefill&quot; for prefill-only server, and &quot;decode&quot; for decode-only server. If not specified, it is not PD disaggregated&#39;</span><span class="p">,</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>        <span class="p">)</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>            <span class="s2">&quot;--disaggregation-transfer-backend&quot;</span><span class="p">,</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_transfer_backend</span><span class="p">,</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mooncake&quot;</span><span class="p">,</span> <span class="s2">&quot;nixl&quot;</span><span class="p">,</span> <span class="s2">&quot;ascend&quot;</span><span class="p">],</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The backend for disaggregation transfer. Default is mooncake.&quot;</span><span class="p">,</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>        <span class="p">)</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>            <span class="s2">&quot;--disaggregation-bootstrap-port&quot;</span><span class="p">,</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_bootstrap_port</span><span class="p">,</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Bootstrap server port on the prefill server. Default is 8998.&quot;</span><span class="p">,</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>        <span class="p">)</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>            <span class="s2">&quot;--disaggregation-decode-tp&quot;</span><span class="p">,</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span><span class="p">,</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Decode tp size. If not set, it matches the tp size of the current engine. This is only set on the prefill server.&quot;</span><span class="p">,</span>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>        <span class="p">)</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>            <span class="s2">&quot;--disaggregation-decode-dp&quot;</span><span class="p">,</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span><span class="p">,</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Decode dp size. If not set, it matches the dp size of the current engine. This is only set on the prefill server.&quot;</span><span class="p">,</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>        <span class="p">)</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>            <span class="s2">&quot;--disaggregation-prefill-pp&quot;</span><span class="p">,</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_prefill_pp</span><span class="p">,</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Prefill pp size. If not set, it is default to 1. This is only set on the decode server.&quot;</span><span class="p">,</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>        <span class="p">)</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>            <span class="s2">&quot;--disaggregation-ib-device&quot;</span><span class="p">,</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_ib_device</span><span class="p">,</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The InfiniBand devices for disaggregation transfer, accepts single device (e.g., --disaggregation-ib-device mlx5_0) &quot;</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>            <span class="s2">&quot;or multiple comma-separated devices (e.g., --disaggregation-ib-device mlx5_0,mlx5_1). &quot;</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>            <span class="s2">&quot;Default is None, which triggers automatic device detection when mooncake backend is enabled.&quot;</span><span class="p">,</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>        <span class="p">)</span>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>            <span class="s2">&quot;--num-reserved-decode-tokens&quot;</span><span class="p">,</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">num_reserved_decode_tokens</span><span class="p">,</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of decode tokens that will have memory reserved when adding new request to the running batch.&quot;</span><span class="p">,</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>        <span class="p">)</span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>            <span class="s2">&quot;--pdlb-url&quot;</span><span class="p">,</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The URL of the PD disaggregation load balancer. If set, the prefill/decode server will register with the load balancer.&quot;</span><span class="p">,</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>        <span class="p">)</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>        <span class="c1"># Custom weight loader</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>            <span class="s2">&quot;--custom-weight-loader&quot;</span><span class="p">,</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The custom dataloader which used to update the model. Should be set with a valid import path, such as my_package.weight_load_func&quot;</span><span class="p">,</span>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>        <span class="p">)</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>            <span class="s2">&quot;--weight-loader-disable-mmap&quot;</span><span class="p">,</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable mmap while loading weight using safetensors.&quot;</span><span class="p">,</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>        <span class="p">)</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>        <span class="c1"># For PD-Multiplexing</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>            <span class="s2">&quot;--enable-pdmux&quot;</span><span class="p">,</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable PD-Multiplexing, PD running on greenctx stream.&quot;</span><span class="p">,</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>        <span class="p">)</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>            <span class="s2">&quot;--sm-group-num&quot;</span><span class="p">,</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">sm_group_num</span><span class="p">,</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of sm partition groups.&quot;</span><span class="p">,</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>        <span class="p">)</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>        <span class="c1"># Deprecated arguments</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>            <span class="s2">&quot;--enable-ep-moe&quot;</span><span class="p">,</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enabling expert parallelism for moe. The ep size is equal to the tp size.&quot;</span><span class="p">,</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>        <span class="p">)</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>            <span class="s2">&quot;--enable-deepep-moe&quot;</span><span class="p">,</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enabling DeepEP MoE implementation for EP MoE.&quot;</span><span class="p">,</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>        <span class="p">)</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>            <span class="s2">&quot;--enable-flashinfer-cutlass-moe&quot;</span><span class="p">,</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer CUTLASS MoE backend for modelopt_fp4 quant on Blackwell. Supports MoE-EP&quot;</span><span class="p">,</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>        <span class="p">)</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>            <span class="s2">&quot;--enable-flashinfer-trtllm-moe&quot;</span><span class="p">,</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer TRTLLM MoE backend on Blackwell. Supports BlockScale FP8 MoE-EP&quot;</span><span class="p">,</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>        <span class="p">)</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>            <span class="s2">&quot;--enable-triton-kernel-moe&quot;</span><span class="p">,</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Use triton moe grouped gemm kernel.&quot;</span><span class="p">,</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>        <span class="p">)</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>            <span class="s2">&quot;--enable-flashinfer-mxfp4-moe&quot;</span><span class="p">,</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer MXFP4 MoE backend for modelopt_fp4 quant on Blackwell.&quot;</span><span class="p">,</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>        <span class="p">)</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_cli_args</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tensor_parallel_size</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">pp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pipeline_parallel_size</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">data_parallel_size</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">expert_parallel_size</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)]</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">})</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>        <span class="k">if</span> <span class="n">is_valid_ipv6_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">):</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;http://[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">]:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_hf_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>        <span class="n">hf_config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>            <span class="n">trust_remote_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>            <span class="n">revision</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a>            <span class="n">model_override_args</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_model_override_args</span><span class="p">),</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a>        <span class="p">)</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a>        <span class="k">return</span> <span class="n">hf_config</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_server_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a>        <span class="c1"># Check parallel size constraints</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a>        <span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tp_size must be divisible by number of nodes&quot;</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disable_overlap_schedule</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>            <span class="p">),</span> <span class="s2">&quot;Pipeline parallelism is not compatible with overlap schedule, speculative decoding, mixed chunked prefill.&quot;</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>        <span class="p">),</span> <span class="s2">&quot;multi-node data parallel is not supported unless dp attention!&quot;</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_gpu_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;base_gpu_id must be non-negative&quot;</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_id_step</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;gpu_id_step must be positive&quot;</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_dense_tp_size</span> <span class="ow">in</span> <span class="p">{</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>            <span class="mi">1</span><span class="p">,</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a>            <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a>        <span class="p">},</span> <span class="s2">&quot;moe_dense_tp_size only support 1 and None currently&quot;</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a>        <span class="c1"># Check LoRA</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_lora_server_args</span><span class="p">()</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a>        <span class="c1"># Check speculative decoding</span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a>                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a>            <span class="p">),</span> <span class="s2">&quot;enable_mixed_chunk is required for speculative decoding&quot;</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>        <span class="c1"># Check chunked prefill</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>        <span class="c1"># Skip validation if chunked prefill is disabled (i.e., size &lt;= 0).</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>            <span class="p">),</span> <span class="s2">&quot;chunked_prefill_size must be divisible by page_size&quot;</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_lora_server_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max_loras_per_batch must be positive&quot;</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>        <span class="c1"># Enable LoRA if any LoRA paths are provided for backward compatibility.</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">:</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>                    <span class="s2">&quot;--enable-lora is set to True because --lora-paths is provided.&quot;</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>                <span class="p">)</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>                    <span class="s2">&quot;--enable-lora is set to False, any provided lora_paths will be ignored.&quot;</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>                <span class="p">)</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span><span class="p">:</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>                <span class="n">lora_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>                <span class="k">for</span> <span class="n">lora_path</span> <span class="ow">in</span> <span class="n">lora_paths</span><span class="p">:</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lora_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a>                        <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span><span class="p">:</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>                            <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a>                            <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>                                <span class="n">lora_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>                            <span class="p">)</span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>                            <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>                                <span class="n">lora_name</span><span class="o">=</span><span class="n">lora_path</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">lora_path</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>                            <span class="p">)</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lora_path</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>                        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>                            <span class="s2">&quot;lora_name&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span> <span class="ow">and</span> <span class="s2">&quot;lora_path&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>                        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;When providing LoRA paths as a list of dict, each dict should contain &#39;lora_name&#39; and &#39;lora_path&#39; keys. Got: </span><span class="si">{</span><span class="n">lora_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>                        <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>                            <span class="n">lora_name</span><span class="o">=</span><span class="n">lora_path</span><span class="p">[</span><span class="s2">&quot;lora_name&quot;</span><span class="p">],</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>                            <span class="n">lora_path</span><span class="o">=</span><span class="n">lora_path</span><span class="p">[</span><span class="s2">&quot;lora_path&quot;</span><span class="p">],</span>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a>                            <span class="n">pinned</span><span class="o">=</span><span class="n">lora_path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pinned&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a>                        <span class="p">)</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>                            <span class="sa">f</span><span class="s2">&quot;Invalid type for item in --lora-paths list: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>                            <span class="s2">&quot;Expected a string or a dictionary.&quot;</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a>                        <span class="p">)</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lora_ref</span><span class="p">)</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>                    <span class="n">LoRARef</span><span class="p">(</span><span class="n">lora_name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>                <span class="p">]</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a>                    <span class="sa">f</span><span class="s2">&quot;Invalid type for --lora-paths: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>                    <span class="s2">&quot;Expected a list or a dictionary.&quot;</span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>                <span class="p">)</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>            <span class="c1"># Expand target modules</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">:</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">)</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>                <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">:</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>                    <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a>                    <span class="p">),</span> <span class="s2">&quot;If &#39;all&#39; is specified in --lora-target-modules, it should be the only module specified.&quot;</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">SUPPORTED_LORA_TARGET_MODULES</span><span class="p">)</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>            <span class="c1"># Ensure sufficient information is provided for LoRA initialization.</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_lora_rank</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>            <span class="p">),</span> <span class="s2">&quot;When no initial --lora-paths is provided, you need to specify both --max-lora-rank and --lora-target-modules for LoRA initialization.&quot;</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>            <span class="c1"># Validate max_loaded_loras</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span><span class="p">,</span> <span class="p">(</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>                    <span class="s2">&quot;max_loaded_loras should be greater than or equal to max_loras_per_batch. &quot;</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>                    <span class="sa">f</span><span class="s2">&quot;max_loaded_loras=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="si">}</span><span class="s2">, max_loras_per_batch=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>                <span class="p">)</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="p">,</span> <span class="p">(</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>                    <span class="s2">&quot;The number of LoRA paths should not exceed max_loaded_loras. &quot;</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>                    <span class="sa">f</span><span class="s2">&quot;max_loaded_loras=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="si">}</span><span class="s2">, lora_paths=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>                <span class="p">)</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_disagg_tp_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">decode_tp</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>        <span class="n">larger_tp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">decode_tp</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">)</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>        <span class="n">smaller_tp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">decode_tp</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">)</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>        <span class="k">assert</span> <span class="n">larger_tp</span> <span class="o">%</span> <span class="n">smaller_tp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>            <span class="s2">&quot;Different tp size is supported only when one tp is multiple of the other. &quot;</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>            <span class="sa">f</span><span class="s2">&quot;decode_tp=</span><span class="si">{</span><span class="n">decode_tp</span><span class="si">}</span><span class="s2">, prefill_tp=</span><span class="si">{</span><span class="n">prefill_tp</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>        <span class="p">)</span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">model_specific_adjustments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a>        <span class="n">hf_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hf_config</span><span class="p">()</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a>        <span class="n">model_arch</span> <span class="o">=</span> <span class="n">hf_config</span><span class="o">.</span><span class="n">architectures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>        <span class="k">if</span> <span class="n">model_arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GptOssForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>                <span class="k">if</span> <span class="n">is_cuda</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>                <span class="k">elif</span> <span class="n">is_cuda</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sm90_supported</span><span class="p">():</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;fa3&quot;</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;triton&quot;</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>            <span class="n">supported_backends</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;triton&quot;</span><span class="p">,</span> <span class="s2">&quot;trtllm_mha&quot;</span><span class="p">,</span> <span class="s2">&quot;fa3&quot;</span><span class="p">]</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>                <span class="sa">f</span><span class="s2">&quot;Use </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span><span class="si">}</span><span class="s2"> as attention backend for GptOssForCausalLM&quot;</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>            <span class="p">)</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">in</span> <span class="n">supported_backends</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a>            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;GptOssForCausalLM requires one of </span><span class="si">{</span><span class="n">supported_backends</span><span class="si">}</span><span class="s2"> attention backend, but got &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>            <span class="k">if</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_allreduce_fusion</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>                        <span class="s2">&quot;Enable FlashInfer AllReduce Fusion on sm100 for GptOssForCausalLM&quot;</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>                    <span class="p">)</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>            <span class="n">quantization_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hf_config</span><span class="p">,</span> <span class="s2">&quot;quantization_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>            <span class="n">is_mxfp4_quant_format</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>                <span class="n">quantization_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>                <span class="ow">and</span> <span class="n">quantization_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quant_method&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mxfp4&quot;</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>            <span class="p">)</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>            <span class="k">if</span> <span class="n">is_sm100_supported</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_mxfp4_quant_format</span><span class="p">:</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_mxfp4&quot;</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>                    <span class="s2">&quot;Detected SM100 and MXFP4 quantization format for GPT-OSS model, enabling FlashInfer MXFP4 MOE kernel.&quot;</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>                <span class="p">)</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;triton_kernel&quot;</span><span class="p">:</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>                    <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>                    <span class="p">),</span> <span class="s2">&quot;Triton kernel MoE is only supported when ep_size == 1&quot;</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>                    <span class="ow">and</span> <span class="n">is_triton_kernels_available</span><span class="p">()</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>                <span class="p">):</span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;triton_kernel&quot;</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a>                        <span class="s2">&quot;Detected GPT-OSS model, enabling triton_kernels MOE kernel.&quot;</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>                    <span class="p">)</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_hybrid_swa_memory</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>            <span class="k">if</span> <span class="n">is_mxfp4_quant_format</span><span class="p">:</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a>                <span class="c1"># use bf16 for mxfp4 triton kernels</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;bfloat16&quot;</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>        <span class="k">elif</span> <span class="s2">&quot;Llama4&quot;</span> <span class="ow">in</span> <span class="n">model_arch</span><span class="p">:</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">in</span> <span class="p">{</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>                <span class="s2">&quot;fa3&quot;</span><span class="p">,</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>                <span class="s2">&quot;aiter&quot;</span><span class="p">,</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>            <span class="p">},</span> <span class="s2">&quot;fa3 or aiter is required for Llama4 model&quot;</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>        <span class="k">elif</span> <span class="n">model_arch</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>            <span class="s2">&quot;Gemma2ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>            <span class="s2">&quot;Gemma3ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a>            <span class="s2">&quot;Gemma3ForConditionalGeneration&quot;</span><span class="p">,</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>            <span class="s2">&quot;Gemma3nForCausalLM&quot;</span><span class="p">,</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a>            <span class="s2">&quot;Gemma3nForConditionalGeneration&quot;</span><span class="p">,</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a>        <span class="p">]:</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>            <span class="c1"># FIXME: https://github.com/sgl-project/sglang/pull/7367 is not compatible with gemma2 model.</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>            <span class="c1"># It failed at this test: https://github.com/sgl-project/sglang/actions/runs/16255155597/job/45890331952#step:4:736</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a>                <span class="sa">f</span><span class="s2">&quot;Disable hybrid SWA memory for </span><span class="si">{</span><span class="n">model_arch</span><span class="si">}</span><span class="s2"> as it is not yet supported.&quot;</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>            <span class="p">)</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_hybrid_swa_memory</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_mem_fraction_for_vlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_config</span><span class="p">):</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>        <span class="n">vision_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">hf_config</span><span class="p">,</span> <span class="s2">&quot;vision_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>        <span class="k">if</span> <span class="n">vision_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>            <span class="k">return</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>        <span class="c1"># roughly reduce the mem_fraction_static base on params of Vit</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>        <span class="n">original_server_arg_mem_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>        <span class="c1"># a base mem_fraction_static factor for regular Vit</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>        <span class="n">base_mem_fraction_reduction_ratio</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>        <span class="n">vit_num_layers</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vision_config</span><span class="p">,</span> <span class="s2">&quot;num_hidden_layers&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>        <span class="n">vit_hidden_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vision_config</span><span class="p">,</span> <span class="s2">&quot;hidden_size&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>        <span class="c1"># baseline ViT params (ViT-L/14)</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>        <span class="n">baseline_vit_layers</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>        <span class="n">baseline_vit_hidden_size</span> <span class="o">=</span> <span class="mi">1024</span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>        <span class="c1"># weight params count</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>        <span class="n">current_complexity_score</span> <span class="o">=</span> <span class="n">vit_num_layers</span> <span class="o">*</span> <span class="p">(</span><span class="n">vit_hidden_size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>        <span class="n">baseline_complexity_score</span> <span class="o">=</span> <span class="n">baseline_vit_layers</span> <span class="o">*</span> <span class="p">(</span><span class="n">baseline_vit_hidden_size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>        <span class="n">complexity_ratio</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>            <span class="n">current_complexity_score</span> <span class="o">/</span> <span class="n">baseline_complexity_score</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>            <span class="k">if</span> <span class="n">baseline_complexity_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>            <span class="k">else</span> <span class="mf">1.0</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>        <span class="p">)</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>        <span class="c1"># every time the complexity grows 100%, adjust final factor for 10%</span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>        <span class="n">sensitivity_scale</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>        <span class="n">dynamic_adjustment_factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">sensitivity_scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">complexity_ratio</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>        <span class="n">dynamic_adjustment_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">dynamic_adjustment_factor</span><span class="p">))</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>        <span class="n">final_overall_factor</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>            <span class="n">base_mem_fraction_reduction_ratio</span> <span class="o">*</span> <span class="n">dynamic_adjustment_factor</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>        <span class="p">)</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>            <span class="n">original_server_arg_mem_fraction</span> <span class="o">*</span> <span class="n">final_overall_factor</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>        <span class="p">)</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a><span class="k">def</span><span class="w"> </span><span class="nf">prepare_server_args</span><span class="p">(</span><span class="n">argv</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ServerArgs</span><span class="p">:</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a><span class="sd">    Prepare the server arguments from the command line arguments.</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a><span class="sd">    Args:</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a><span class="sd">        args: The command line arguments. Typically, it should be `sys.argv[1:]`</span>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a><span class="sd">            to ensure compatibility with `parse_args` when no arguments are passed.</span>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a><span class="sd">    Returns:</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a><span class="sd">        The server arguments.</span>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>    <span class="n">ServerArgs</span><span class="o">.</span><span class="n">add_cli_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>    <span class="n">server_args</span> <span class="o">=</span> <span class="n">ServerArgs</span><span class="o">.</span><span class="n">from_cli_args</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>    <span class="k">return</span> <span class="n">server_args</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a><span class="n">ZMQ_TCP_PORT_DELTA</span> <span class="o">=</span> <span class="mi">233</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PortArgs</span><span class="p">:</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>    <span class="c1"># The ipc filename for tokenizer to receive inputs from detokenizer (zmq)</span>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>    <span class="n">tokenizer_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>    <span class="c1"># The ipc filename for scheduler (rank 0) to receive inputs from tokenizer (zmq)</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>    <span class="n">scheduler_input_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a>    <span class="c1"># The ipc filename for detokenizer to receive inputs from scheduler (zmq)</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>    <span class="n">detokenizer_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>    <span class="c1"># The port for nccl initialization (torch.dist)</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>    <span class="n">nccl_port</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>    <span class="c1"># The ipc filename for rpc call between Engine and Scheduler</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>    <span class="n">rpc_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>    <span class="c1"># The ipc filename for Scheduler to send metrics</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>    <span class="n">metrics_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_new</span><span class="p">(</span><span class="n">server_args</span><span class="p">,</span> <span class="n">dp_rank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PortArgs&quot;</span><span class="p">:</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a>        <span class="k">if</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nccl_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a>            <span class="n">nccl_port</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>                <span class="k">if</span> <span class="n">is_port_available</span><span class="p">(</span><span class="n">nccl_port</span><span class="p">):</span>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>                    <span class="k">break</span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>                <span class="k">if</span> <span class="n">nccl_port</span> <span class="o">&lt;</span> <span class="mi">60000</span><span class="p">:</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a>                    <span class="n">nccl_port</span> <span class="o">+=</span> <span class="mi">42</span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>                    <span class="n">nccl_port</span> <span class="o">-=</span> <span class="mi">43</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a>            <span class="n">nccl_port</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nccl_port</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_args</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>            <span class="c1"># Normal case, use IPC within a single node</span>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a>            <span class="k">return</span> <span class="n">PortArgs</span><span class="p">(</span>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>                <span class="n">tokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>                <span class="n">scheduler_input_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a>                <span class="n">detokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a>                <span class="n">nccl_port</span><span class="o">=</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>                <span class="n">rpc_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>                <span class="n">metrics_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a>            <span class="p">)</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>            <span class="c1"># DP attention. Use TCP + port to handle both single-node and multi-node.</span>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a>            <span class="k">if</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">server_args</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="n">ZMQ_TCP_PORT_DELTA</span><span class="p">)</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a>            <span class="k">elif</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>  <span class="c1"># ipv6 address</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a>                <span class="n">port_num</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="n">configure_ipv6</span><span class="p">(</span><span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="p">)</span>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port_num</span><span class="p">))</span>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">dist_init_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a>            <span class="p">),</span> <span class="s2">&quot;please provide --dist-init-addr as host:port of head node&quot;</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a>            <span class="n">dist_init_host</span><span class="p">,</span> <span class="n">dist_init_port</span> <span class="o">=</span> <span class="n">dist_init_addr</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a>            <span class="n">port_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist_init_port</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a>            <span class="n">detokenizer_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a>            <span class="n">rpc_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>            <span class="n">metrics_ipc_name</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">3</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>            <span class="k">if</span> <span class="n">dp_rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>                <span class="c1"># TokenizerManager to DataParallelController</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>                <span class="n">scheduler_input_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">4</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>                <span class="n">scheduler_input_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dp_rank</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a>            <span class="k">return</span> <span class="n">PortArgs</span><span class="p">(</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a>                <span class="n">tokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>                <span class="n">scheduler_input_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">scheduler_input_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a>                <span class="n">detokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">detokenizer_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a>                <span class="n">nccl_port</span><span class="o">=</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a>                <span class="n">rpc_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">rpc_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>                <span class="n">metrics_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">metrics_ipc_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>            <span class="p">)</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LoRAPathAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a>        <span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a>        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;Expected a list of LoRA paths.&quot;</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a>            <span class="k">for</span> <span class="n">lora_path</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a>                <span class="n">lora_path</span> <span class="o">=</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a>                <span class="k">if</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a>                    <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a>                    <span class="k">assert</span> <span class="s2">&quot;lora_path&quot;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="s2">&quot;lora_name&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">,</span> <span class="p">(</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> looks like a JSON str, &quot;</span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a>                        <span class="s2">&quot;but it does not contain &#39;lora_name&#39; and &#39;lora_path&#39; keys.&quot;</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a>                    <span class="p">)</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a>                    <span class="n">lora_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a>                    <span class="n">lora_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">lora_paths</span><span class="p">)</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DeprecatedAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DeprecatedAction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a>            <span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>        <span class="p">)</span>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="p">)</span>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a><span class="k">def</span><span class="w"> </span><span class="nf">print_deprecated_warning</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[33m</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a><span class="k">def</span><span class="w"> </span><span class="nf">auto_choose_speculative_params</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ServerArgs</span><span class="p">):</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a><span class="sd">    Automatically choose the parameters for speculative decoding.</span>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a><span class="sd">    You can tune them on your own models and prompts with scripts/playground/bench_speculative.py</span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a>    <span class="n">hf_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hf_config</span><span class="p">()</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a>    <span class="n">arch</span> <span class="o">=</span> <span class="n">hf_config</span><span class="o">.</span><span class="n">architectures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a>    <span class="k">if</span> <span class="n">arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LlamaForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a>        <span class="c1"># The default value for llama</span>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a>    <span class="k">elif</span> <span class="n">arch</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>        <span class="s2">&quot;DeepseekV3ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a>        <span class="s2">&quot;DeepseekV2ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a>        <span class="s2">&quot;GptOssForCausalLM&quot;</span><span class="p">,</span>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a>    <span class="p">]:</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a>        <span class="c1"># The default value for deepseek and gpt-oss</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a>    <span class="k">elif</span> <span class="n">arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Grok1ForCausalLM&quot;</span><span class="p">,</span> <span class="s2">&quot;Grok1VForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>        <span class="c1"># The default value for all other models</span>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger <a href="">sglang.srt.server_args</a> (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="ServerArgs">
                            <input id="ServerArgs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclasses.dataclass">@dataclasses.dataclass</div>

    <span class="def">class</span>
    <span class="name">ServerArgs</span>:

                <label class="view-source-button" for="ServerArgs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs-52"><a href="#ServerArgs-52"><span class="linenos">  52</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
</span><span id="ServerArgs-53"><a href="#ServerArgs-53"><span class="linenos">  53</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ServerArgs</span><span class="p">:</span>
</span><span id="ServerArgs-54"><a href="#ServerArgs-54"><span class="linenos">  54</span></a>    <span class="c1"># Model and tokenizer</span>
</span><span id="ServerArgs-55"><a href="#ServerArgs-55"><span class="linenos">  55</span></a>    <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="ServerArgs-56"><a href="#ServerArgs-56"><span class="linenos">  56</span></a>    <span class="n">tokenizer_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-57"><a href="#ServerArgs-57"><span class="linenos">  57</span></a>    <span class="n">tokenizer_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-58"><a href="#ServerArgs-58"><span class="linenos">  58</span></a>    <span class="n">skip_tokenizer_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-59"><a href="#ServerArgs-59"><span class="linenos">  59</span></a>    <span class="n">load_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-60"><a href="#ServerArgs-60"><span class="linenos">  60</span></a>    <span class="n">model_loader_extra_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-61"><a href="#ServerArgs-61"><span class="linenos">  61</span></a>    <span class="n">trust_remote_code</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-62"><a href="#ServerArgs-62"><span class="linenos">  62</span></a>    <span class="n">context_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-63"><a href="#ServerArgs-63"><span class="linenos">  63</span></a>    <span class="n">is_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-64"><a href="#ServerArgs-64"><span class="linenos">  64</span></a>    <span class="n">enable_multimodal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-65"><a href="#ServerArgs-65"><span class="linenos">  65</span></a>    <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-66"><a href="#ServerArgs-66"><span class="linenos">  66</span></a>    <span class="n">model_impl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-67"><a href="#ServerArgs-67"><span class="linenos">  67</span></a>
</span><span id="ServerArgs-68"><a href="#ServerArgs-68"><span class="linenos">  68</span></a>    <span class="c1"># HTTP server</span>
</span><span id="ServerArgs-69"><a href="#ServerArgs-69"><span class="linenos">  69</span></a>    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span id="ServerArgs-70"><a href="#ServerArgs-70"><span class="linenos">  70</span></a>    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30000</span>
</span><span id="ServerArgs-71"><a href="#ServerArgs-71"><span class="linenos">  71</span></a>    <span class="n">skip_server_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-72"><a href="#ServerArgs-72"><span class="linenos">  72</span></a>    <span class="n">warmups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-73"><a href="#ServerArgs-73"><span class="linenos">  73</span></a>    <span class="n">nccl_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-74"><a href="#ServerArgs-74"><span class="linenos">  74</span></a>
</span><span id="ServerArgs-75"><a href="#ServerArgs-75"><span class="linenos">  75</span></a>    <span class="c1"># Quantization and data type</span>
</span><span id="ServerArgs-76"><a href="#ServerArgs-76"><span class="linenos">  76</span></a>    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-77"><a href="#ServerArgs-77"><span class="linenos">  77</span></a>    <span class="n">quantization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-78"><a href="#ServerArgs-78"><span class="linenos">  78</span></a>    <span class="n">quantization_param_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-79"><a href="#ServerArgs-79"><span class="linenos">  79</span></a>    <span class="n">kv_cache_dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-80"><a href="#ServerArgs-80"><span class="linenos">  80</span></a>
</span><span id="ServerArgs-81"><a href="#ServerArgs-81"><span class="linenos">  81</span></a>    <span class="c1"># Memory and scheduling</span>
</span><span id="ServerArgs-82"><a href="#ServerArgs-82"><span class="linenos">  82</span></a>    <span class="n">mem_fraction_static</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-83"><a href="#ServerArgs-83"><span class="linenos">  83</span></a>    <span class="n">max_running_requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-84"><a href="#ServerArgs-84"><span class="linenos">  84</span></a>    <span class="n">max_queued_requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
</span><span id="ServerArgs-85"><a href="#ServerArgs-85"><span class="linenos">  85</span></a>    <span class="n">max_total_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-86"><a href="#ServerArgs-86"><span class="linenos">  86</span></a>    <span class="n">chunked_prefill_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-87"><a href="#ServerArgs-87"><span class="linenos">  87</span></a>    <span class="n">max_prefill_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16384</span>
</span><span id="ServerArgs-88"><a href="#ServerArgs-88"><span class="linenos">  88</span></a>    <span class="n">schedule_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fcfs&quot;</span>
</span><span id="ServerArgs-89"><a href="#ServerArgs-89"><span class="linenos">  89</span></a>    <span class="n">schedule_conservativeness</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ServerArgs-90"><a href="#ServerArgs-90"><span class="linenos">  90</span></a>    <span class="n">page_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-91"><a href="#ServerArgs-91"><span class="linenos">  91</span></a>    <span class="n">hybrid_kvcache_ratio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-92"><a href="#ServerArgs-92"><span class="linenos">  92</span></a>    <span class="n">swa_full_tokens_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
</span><span id="ServerArgs-93"><a href="#ServerArgs-93"><span class="linenos">  93</span></a>    <span class="n">disable_hybrid_swa_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-94"><a href="#ServerArgs-94"><span class="linenos">  94</span></a>
</span><span id="ServerArgs-95"><a href="#ServerArgs-95"><span class="linenos">  95</span></a>    <span class="c1"># Runtime options</span>
</span><span id="ServerArgs-96"><a href="#ServerArgs-96"><span class="linenos">  96</span></a>    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-97"><a href="#ServerArgs-97"><span class="linenos">  97</span></a>    <span class="n">tp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-98"><a href="#ServerArgs-98"><span class="linenos">  98</span></a>    <span class="n">pp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-99"><a href="#ServerArgs-99"><span class="linenos">  99</span></a>    <span class="n">max_micro_batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-100"><a href="#ServerArgs-100"><span class="linenos"> 100</span></a>    <span class="n">stream_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-101"><a href="#ServerArgs-101"><span class="linenos"> 101</span></a>    <span class="n">stream_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-102"><a href="#ServerArgs-102"><span class="linenos"> 102</span></a>    <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-103"><a href="#ServerArgs-103"><span class="linenos"> 103</span></a>    <span class="n">constrained_json_whitespace_pattern</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-104"><a href="#ServerArgs-104"><span class="linenos"> 104</span></a>    <span class="n">watchdog_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">300</span>
</span><span id="ServerArgs-105"><a href="#ServerArgs-105"><span class="linenos"> 105</span></a>    <span class="n">dist_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># timeout for torch.distributed</span>
</span><span id="ServerArgs-106"><a href="#ServerArgs-106"><span class="linenos"> 106</span></a>    <span class="n">download_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-107"><a href="#ServerArgs-107"><span class="linenos"> 107</span></a>    <span class="n">base_gpu_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ServerArgs-108"><a href="#ServerArgs-108"><span class="linenos"> 108</span></a>    <span class="n">gpu_id_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-109"><a href="#ServerArgs-109"><span class="linenos"> 109</span></a>    <span class="n">sleep_on_idle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-110"><a href="#ServerArgs-110"><span class="linenos"> 110</span></a>
</span><span id="ServerArgs-111"><a href="#ServerArgs-111"><span class="linenos"> 111</span></a>    <span class="c1"># Logging</span>
</span><span id="ServerArgs-112"><a href="#ServerArgs-112"><span class="linenos"> 112</span></a>    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>
</span><span id="ServerArgs-113"><a href="#ServerArgs-113"><span class="linenos"> 113</span></a>    <span class="n">log_level_http</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-114"><a href="#ServerArgs-114"><span class="linenos"> 114</span></a>    <span class="n">log_requests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-115"><a href="#ServerArgs-115"><span class="linenos"> 115</span></a>    <span class="n">log_requests_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="ServerArgs-116"><a href="#ServerArgs-116"><span class="linenos"> 116</span></a>    <span class="n">crash_dump_folder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-117"><a href="#ServerArgs-117"><span class="linenos"> 117</span></a>    <span class="n">show_time_cost</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-118"><a href="#ServerArgs-118"><span class="linenos"> 118</span></a>    <span class="n">enable_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-119"><a href="#ServerArgs-119"><span class="linenos"> 119</span></a>    <span class="n">enable_metrics_for_all_schedulers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-120"><a href="#ServerArgs-120"><span class="linenos"> 120</span></a>    <span class="n">bucket_time_to_first_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-121"><a href="#ServerArgs-121"><span class="linenos"> 121</span></a>    <span class="n">bucket_inter_token_latency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-122"><a href="#ServerArgs-122"><span class="linenos"> 122</span></a>    <span class="n">bucket_e2e_request_latency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-123"><a href="#ServerArgs-123"><span class="linenos"> 123</span></a>    <span class="n">collect_tokens_histogram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-124"><a href="#ServerArgs-124"><span class="linenos"> 124</span></a>    <span class="n">decode_log_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="ServerArgs-125"><a href="#ServerArgs-125"><span class="linenos"> 125</span></a>    <span class="n">enable_request_time_stats_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-126"><a href="#ServerArgs-126"><span class="linenos"> 126</span></a>    <span class="n">kv_events_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-127"><a href="#ServerArgs-127"><span class="linenos"> 127</span></a>    <span class="n">gc_warning_threshold_secs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ServerArgs-128"><a href="#ServerArgs-128"><span class="linenos"> 128</span></a>
</span><span id="ServerArgs-129"><a href="#ServerArgs-129"><span class="linenos"> 129</span></a>    <span class="c1"># API related</span>
</span><span id="ServerArgs-130"><a href="#ServerArgs-130"><span class="linenos"> 130</span></a>    <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-131"><a href="#ServerArgs-131"><span class="linenos"> 131</span></a>    <span class="n">served_model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-132"><a href="#ServerArgs-132"><span class="linenos"> 132</span></a>    <span class="n">weight_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="ServerArgs-133"><a href="#ServerArgs-133"><span class="linenos"> 133</span></a>    <span class="n">chat_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-134"><a href="#ServerArgs-134"><span class="linenos"> 134</span></a>    <span class="n">completion_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-135"><a href="#ServerArgs-135"><span class="linenos"> 135</span></a>    <span class="n">file_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sglang_storage&quot;</span>
</span><span id="ServerArgs-136"><a href="#ServerArgs-136"><span class="linenos"> 136</span></a>    <span class="n">enable_cache_report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-137"><a href="#ServerArgs-137"><span class="linenos"> 137</span></a>    <span class="n">reasoning_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-138"><a href="#ServerArgs-138"><span class="linenos"> 138</span></a>    <span class="n">tool_call_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-139"><a href="#ServerArgs-139"><span class="linenos"> 139</span></a>    <span class="n">tool_server</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-140"><a href="#ServerArgs-140"><span class="linenos"> 140</span></a>
</span><span id="ServerArgs-141"><a href="#ServerArgs-141"><span class="linenos"> 141</span></a>    <span class="c1"># Data parallelism</span>
</span><span id="ServerArgs-142"><a href="#ServerArgs-142"><span class="linenos"> 142</span></a>    <span class="n">dp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-143"><a href="#ServerArgs-143"><span class="linenos"> 143</span></a>    <span class="n">load_balance_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;round_robin&quot;</span>
</span><span id="ServerArgs-144"><a href="#ServerArgs-144"><span class="linenos"> 144</span></a>
</span><span id="ServerArgs-145"><a href="#ServerArgs-145"><span class="linenos"> 145</span></a>    <span class="c1"># Multi-node distributed serving</span>
</span><span id="ServerArgs-146"><a href="#ServerArgs-146"><span class="linenos"> 146</span></a>    <span class="n">dist_init_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-147"><a href="#ServerArgs-147"><span class="linenos"> 147</span></a>    <span class="n">nnodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-148"><a href="#ServerArgs-148"><span class="linenos"> 148</span></a>    <span class="n">node_rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ServerArgs-149"><a href="#ServerArgs-149"><span class="linenos"> 149</span></a>
</span><span id="ServerArgs-150"><a href="#ServerArgs-150"><span class="linenos"> 150</span></a>    <span class="c1"># Model override args in JSON</span>
</span><span id="ServerArgs-151"><a href="#ServerArgs-151"><span class="linenos"> 151</span></a>    <span class="n">json_model_override_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-152"><a href="#ServerArgs-152"><span class="linenos"> 152</span></a>    <span class="n">preferred_sampling_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-153"><a href="#ServerArgs-153"><span class="linenos"> 153</span></a>
</span><span id="ServerArgs-154"><a href="#ServerArgs-154"><span class="linenos"> 154</span></a>    <span class="c1"># LoRA</span>
</span><span id="ServerArgs-155"><a href="#ServerArgs-155"><span class="linenos"> 155</span></a>    <span class="n">enable_lora</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-156"><a href="#ServerArgs-156"><span class="linenos"> 156</span></a>    <span class="n">max_lora_rank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-157"><a href="#ServerArgs-157"><span class="linenos"> 157</span></a>    <span class="n">lora_target_modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-158"><a href="#ServerArgs-158"><span class="linenos"> 158</span></a>    <span class="n">lora_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="ServerArgs-159"><a href="#ServerArgs-159"><span class="linenos"> 159</span></a>        <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">LoRARef</span><span class="p">]]</span>
</span><span id="ServerArgs-160"><a href="#ServerArgs-160"><span class="linenos"> 160</span></a>    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-161"><a href="#ServerArgs-161"><span class="linenos"> 161</span></a>    <span class="n">max_loaded_loras</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-162"><a href="#ServerArgs-162"><span class="linenos"> 162</span></a>    <span class="n">max_loras_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="ServerArgs-163"><a href="#ServerArgs-163"><span class="linenos"> 163</span></a>    <span class="n">lora_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;triton&quot;</span>
</span><span id="ServerArgs-164"><a href="#ServerArgs-164"><span class="linenos"> 164</span></a>
</span><span id="ServerArgs-165"><a href="#ServerArgs-165"><span class="linenos"> 165</span></a>    <span class="c1"># Kernel backend</span>
</span><span id="ServerArgs-166"><a href="#ServerArgs-166"><span class="linenos"> 166</span></a>    <span class="n">attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-167"><a href="#ServerArgs-167"><span class="linenos"> 167</span></a>    <span class="n">decode_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-168"><a href="#ServerArgs-168"><span class="linenos"> 168</span></a>    <span class="n">prefill_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-169"><a href="#ServerArgs-169"><span class="linenos"> 169</span></a>    <span class="n">sampling_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-170"><a href="#ServerArgs-170"><span class="linenos"> 170</span></a>    <span class="n">grammar_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-171"><a href="#ServerArgs-171"><span class="linenos"> 171</span></a>    <span class="n">mm_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-172"><a href="#ServerArgs-172"><span class="linenos"> 172</span></a>
</span><span id="ServerArgs-173"><a href="#ServerArgs-173"><span class="linenos"> 173</span></a>    <span class="c1"># Speculative decoding</span>
</span><span id="ServerArgs-174"><a href="#ServerArgs-174"><span class="linenos"> 174</span></a>    <span class="n">speculative_algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-175"><a href="#ServerArgs-175"><span class="linenos"> 175</span></a>    <span class="n">speculative_draft_model_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-176"><a href="#ServerArgs-176"><span class="linenos"> 176</span></a>    <span class="n">speculative_num_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-177"><a href="#ServerArgs-177"><span class="linenos"> 177</span></a>    <span class="n">speculative_eagle_topk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-178"><a href="#ServerArgs-178"><span class="linenos"> 178</span></a>    <span class="n">speculative_num_draft_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-179"><a href="#ServerArgs-179"><span class="linenos"> 179</span></a>    <span class="n">speculative_accept_threshold_single</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ServerArgs-180"><a href="#ServerArgs-180"><span class="linenos"> 180</span></a>    <span class="n">speculative_accept_threshold_acc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ServerArgs-181"><a href="#ServerArgs-181"><span class="linenos"> 181</span></a>    <span class="n">speculative_token_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-182"><a href="#ServerArgs-182"><span class="linenos"> 182</span></a>
</span><span id="ServerArgs-183"><a href="#ServerArgs-183"><span class="linenos"> 183</span></a>    <span class="c1"># Expert parallelism</span>
</span><span id="ServerArgs-184"><a href="#ServerArgs-184"><span class="linenos"> 184</span></a>    <span class="n">ep_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-185"><a href="#ServerArgs-185"><span class="linenos"> 185</span></a>    <span class="n">moe_a2a_backend</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;deepep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
</span><span id="ServerArgs-186"><a href="#ServerArgs-186"><span class="linenos"> 186</span></a>    <span class="n">moe_runner_backend</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
</span><span id="ServerArgs-187"><a href="#ServerArgs-187"><span class="linenos"> 187</span></a>        <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-188"><a href="#ServerArgs-188"><span class="linenos"> 188</span></a>        <span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-189"><a href="#ServerArgs-189"><span class="linenos"> 189</span></a>        <span class="s2">&quot;triton_kernel&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-190"><a href="#ServerArgs-190"><span class="linenos"> 190</span></a>        <span class="s2">&quot;flashinfer_trtllm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-191"><a href="#ServerArgs-191"><span class="linenos"> 191</span></a>        <span class="s2">&quot;flashinfer_cutlass&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-192"><a href="#ServerArgs-192"><span class="linenos"> 192</span></a>        <span class="s2">&quot;flashinfer_mxfp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-193"><a href="#ServerArgs-193"><span class="linenos"> 193</span></a>    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-194"><a href="#ServerArgs-194"><span class="linenos"> 194</span></a>    <span class="n">flashinfer_mxfp4_moe_precision</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span id="ServerArgs-195"><a href="#ServerArgs-195"><span class="linenos"> 195</span></a>    <span class="n">enable_flashinfer_allreduce_fusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-196"><a href="#ServerArgs-196"><span class="linenos"> 196</span></a>    <span class="n">deepep_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;low_latency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-197"><a href="#ServerArgs-197"><span class="linenos"> 197</span></a>    <span class="n">ep_num_redundant_experts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ServerArgs-198"><a href="#ServerArgs-198"><span class="linenos"> 198</span></a>    <span class="n">ep_dispatch_algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="s2">&quot;dynamic&quot;</span><span class="p">,</span> <span class="s2">&quot;fake&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-199"><a href="#ServerArgs-199"><span class="linenos"> 199</span></a>    <span class="n">init_expert_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;trivial&quot;</span>
</span><span id="ServerArgs-200"><a href="#ServerArgs-200"><span class="linenos"> 200</span></a>    <span class="n">enable_eplb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-201"><a href="#ServerArgs-201"><span class="linenos"> 201</span></a>    <span class="n">eplb_algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-202"><a href="#ServerArgs-202"><span class="linenos"> 202</span></a>    <span class="n">eplb_rebalance_num_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="ServerArgs-203"><a href="#ServerArgs-203"><span class="linenos"> 203</span></a>    <span class="n">eplb_rebalance_layers_per_chunk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-204"><a href="#ServerArgs-204"><span class="linenos"> 204</span></a>    <span class="n">expert_distribution_recorder_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="ServerArgs-205"><a href="#ServerArgs-205"><span class="linenos"> 205</span></a>        <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">,</span> <span class="s2">&quot;stat_approx&quot;</span><span class="p">,</span> <span class="s2">&quot;per_pass&quot;</span><span class="p">,</span> <span class="s2">&quot;per_token&quot;</span><span class="p">]</span>
</span><span id="ServerArgs-206"><a href="#ServerArgs-206"><span class="linenos"> 206</span></a>    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-207"><a href="#ServerArgs-207"><span class="linenos"> 207</span></a>    <span class="n">expert_distribution_recorder_buffer_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-208"><a href="#ServerArgs-208"><span class="linenos"> 208</span></a>    <span class="n">enable_expert_distribution_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-209"><a href="#ServerArgs-209"><span class="linenos"> 209</span></a>    <span class="n">deepep_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-210"><a href="#ServerArgs-210"><span class="linenos"> 210</span></a>    <span class="n">moe_dense_tp_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-211"><a href="#ServerArgs-211"><span class="linenos"> 211</span></a>
</span><span id="ServerArgs-212"><a href="#ServerArgs-212"><span class="linenos"> 212</span></a>    <span class="c1"># Hierarchical cache</span>
</span><span id="ServerArgs-213"><a href="#ServerArgs-213"><span class="linenos"> 213</span></a>    <span class="n">enable_hierarchical_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-214"><a href="#ServerArgs-214"><span class="linenos"> 214</span></a>    <span class="n">hicache_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>
</span><span id="ServerArgs-215"><a href="#ServerArgs-215"><span class="linenos"> 215</span></a>    <span class="n">hicache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ServerArgs-216"><a href="#ServerArgs-216"><span class="linenos"> 216</span></a>    <span class="n">hicache_write_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;write_through_selective&quot;</span>
</span><span id="ServerArgs-217"><a href="#ServerArgs-217"><span class="linenos"> 217</span></a>    <span class="n">hicache_io_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kernel&quot;</span>
</span><span id="ServerArgs-218"><a href="#ServerArgs-218"><span class="linenos"> 218</span></a>    <span class="n">hicache_mem_layout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;layer_first&quot;</span>
</span><span id="ServerArgs-219"><a href="#ServerArgs-219"><span class="linenos"> 219</span></a>    <span class="n">hicache_storage_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-220"><a href="#ServerArgs-220"><span class="linenos"> 220</span></a>    <span class="n">hicache_storage_prefetch_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;best_effort&quot;</span>
</span><span id="ServerArgs-221"><a href="#ServerArgs-221"><span class="linenos"> 221</span></a>    <span class="n">hicache_storage_backend_extra_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-222"><a href="#ServerArgs-222"><span class="linenos"> 222</span></a>
</span><span id="ServerArgs-223"><a href="#ServerArgs-223"><span class="linenos"> 223</span></a>    <span class="c1"># Double Sparsity</span>
</span><span id="ServerArgs-224"><a href="#ServerArgs-224"><span class="linenos"> 224</span></a>    <span class="n">enable_double_sparsity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-225"><a href="#ServerArgs-225"><span class="linenos"> 225</span></a>    <span class="n">ds_channel_config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-226"><a href="#ServerArgs-226"><span class="linenos"> 226</span></a>    <span class="n">ds_heavy_channel_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="ServerArgs-227"><a href="#ServerArgs-227"><span class="linenos"> 227</span></a>    <span class="n">ds_heavy_token_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span>
</span><span id="ServerArgs-228"><a href="#ServerArgs-228"><span class="linenos"> 228</span></a>    <span class="n">ds_heavy_channel_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;qk&quot;</span>
</span><span id="ServerArgs-229"><a href="#ServerArgs-229"><span class="linenos"> 229</span></a>    <span class="n">ds_sparse_decode_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span>
</span><span id="ServerArgs-230"><a href="#ServerArgs-230"><span class="linenos"> 230</span></a>
</span><span id="ServerArgs-231"><a href="#ServerArgs-231"><span class="linenos"> 231</span></a>    <span class="c1"># Offloading</span>
</span><span id="ServerArgs-232"><a href="#ServerArgs-232"><span class="linenos"> 232</span></a>    <span class="n">cpu_offload_gb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ServerArgs-233"><a href="#ServerArgs-233"><span class="linenos"> 233</span></a>    <span class="n">offload_group_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="ServerArgs-234"><a href="#ServerArgs-234"><span class="linenos"> 234</span></a>    <span class="n">offload_num_in_group</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-235"><a href="#ServerArgs-235"><span class="linenos"> 235</span></a>    <span class="n">offload_prefetch_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-236"><a href="#ServerArgs-236"><span class="linenos"> 236</span></a>    <span class="n">offload_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="ServerArgs-237"><a href="#ServerArgs-237"><span class="linenos"> 237</span></a>
</span><span id="ServerArgs-238"><a href="#ServerArgs-238"><span class="linenos"> 238</span></a>    <span class="c1"># Optimization/debug options</span>
</span><span id="ServerArgs-239"><a href="#ServerArgs-239"><span class="linenos"> 239</span></a>    <span class="n">disable_radix_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-240"><a href="#ServerArgs-240"><span class="linenos"> 240</span></a>    <span class="n">cuda_graph_max_bs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-241"><a href="#ServerArgs-241"><span class="linenos"> 241</span></a>    <span class="n">cuda_graph_bs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-242"><a href="#ServerArgs-242"><span class="linenos"> 242</span></a>    <span class="n">disable_cuda_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-243"><a href="#ServerArgs-243"><span class="linenos"> 243</span></a>    <span class="n">disable_cuda_graph_padding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-244"><a href="#ServerArgs-244"><span class="linenos"> 244</span></a>    <span class="n">enable_profile_cuda_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-245"><a href="#ServerArgs-245"><span class="linenos"> 245</span></a>    <span class="n">enable_cudagraph_gc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-246"><a href="#ServerArgs-246"><span class="linenos"> 246</span></a>    <span class="n">enable_nccl_nvls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-247"><a href="#ServerArgs-247"><span class="linenos"> 247</span></a>    <span class="n">enable_symm_mem</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-248"><a href="#ServerArgs-248"><span class="linenos"> 248</span></a>    <span class="n">disable_flashinfer_cutlass_moe_fp4_allgather</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-249"><a href="#ServerArgs-249"><span class="linenos"> 249</span></a>    <span class="n">enable_tokenizer_batch_encode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-250"><a href="#ServerArgs-250"><span class="linenos"> 250</span></a>    <span class="n">disable_outlines_disk_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-251"><a href="#ServerArgs-251"><span class="linenos"> 251</span></a>    <span class="n">disable_custom_all_reduce</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-252"><a href="#ServerArgs-252"><span class="linenos"> 252</span></a>    <span class="n">enable_mscclpp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-253"><a href="#ServerArgs-253"><span class="linenos"> 253</span></a>    <span class="n">disable_overlap_schedule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-254"><a href="#ServerArgs-254"><span class="linenos"> 254</span></a>    <span class="n">enable_mixed_chunk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-255"><a href="#ServerArgs-255"><span class="linenos"> 255</span></a>    <span class="n">enable_dp_attention</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-256"><a href="#ServerArgs-256"><span class="linenos"> 256</span></a>    <span class="n">enable_dp_lm_head</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-257"><a href="#ServerArgs-257"><span class="linenos"> 257</span></a>    <span class="n">enable_two_batch_overlap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-258"><a href="#ServerArgs-258"><span class="linenos"> 258</span></a>    <span class="n">tbo_token_distribution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.48</span>
</span><span id="ServerArgs-259"><a href="#ServerArgs-259"><span class="linenos"> 259</span></a>    <span class="n">enable_torch_compile</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-260"><a href="#ServerArgs-260"><span class="linenos"> 260</span></a>    <span class="n">torch_compile_max_bs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="ServerArgs-261"><a href="#ServerArgs-261"><span class="linenos"> 261</span></a>    <span class="n">torchao_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="ServerArgs-262"><a href="#ServerArgs-262"><span class="linenos"> 262</span></a>    <span class="n">enable_nan_detection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-263"><a href="#ServerArgs-263"><span class="linenos"> 263</span></a>    <span class="n">enable_p2p_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-264"><a href="#ServerArgs-264"><span class="linenos"> 264</span></a>    <span class="n">triton_attention_reduce_in_fp32</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-265"><a href="#ServerArgs-265"><span class="linenos"> 265</span></a>    <span class="n">triton_attention_num_kv_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="ServerArgs-266"><a href="#ServerArgs-266"><span class="linenos"> 266</span></a>    <span class="n">num_continuous_decode_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-267"><a href="#ServerArgs-267"><span class="linenos"> 267</span></a>    <span class="n">delete_ckpt_after_loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-268"><a href="#ServerArgs-268"><span class="linenos"> 268</span></a>    <span class="n">enable_memory_saver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-269"><a href="#ServerArgs-269"><span class="linenos"> 269</span></a>    <span class="n">allow_auto_truncate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-270"><a href="#ServerArgs-270"><span class="linenos"> 270</span></a>    <span class="n">enable_custom_logit_processor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-271"><a href="#ServerArgs-271"><span class="linenos"> 271</span></a>    <span class="n">flashinfer_mla_disable_ragged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-272"><a href="#ServerArgs-272"><span class="linenos"> 272</span></a>    <span class="n">disable_shared_experts_fusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-273"><a href="#ServerArgs-273"><span class="linenos"> 273</span></a>    <span class="n">disable_chunked_prefix_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-274"><a href="#ServerArgs-274"><span class="linenos"> 274</span></a>    <span class="n">disable_fast_image_processor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-275"><a href="#ServerArgs-275"><span class="linenos"> 275</span></a>    <span class="n">enable_return_hidden_states</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-276"><a href="#ServerArgs-276"><span class="linenos"> 276</span></a>    <span class="n">scheduler_recv_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-277"><a href="#ServerArgs-277"><span class="linenos"> 277</span></a>
</span><span id="ServerArgs-278"><a href="#ServerArgs-278"><span class="linenos"> 278</span></a>    <span class="c1"># Debug tensor dumps</span>
</span><span id="ServerArgs-279"><a href="#ServerArgs-279"><span class="linenos"> 279</span></a>    <span class="n">debug_tensor_dump_output_folder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-280"><a href="#ServerArgs-280"><span class="linenos"> 280</span></a>    <span class="n">debug_tensor_dump_input_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-281"><a href="#ServerArgs-281"><span class="linenos"> 281</span></a>    <span class="n">debug_tensor_dump_inject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-282"><a href="#ServerArgs-282"><span class="linenos"> 282</span></a>    <span class="n">debug_tensor_dump_prefill_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-283"><a href="#ServerArgs-283"><span class="linenos"> 283</span></a>
</span><span id="ServerArgs-284"><a href="#ServerArgs-284"><span class="linenos"> 284</span></a>    <span class="c1"># PD disaggregation: can be &quot;null&quot; (not disaggregated), &quot;prefill&quot; (prefill-only), or &quot;decode&quot; (decode-only)</span>
</span><span id="ServerArgs-285"><a href="#ServerArgs-285"><span class="linenos"> 285</span></a>    <span class="n">disaggregation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
</span><span id="ServerArgs-286"><a href="#ServerArgs-286"><span class="linenos"> 286</span></a>    <span class="n">disaggregation_transfer_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mooncake&quot;</span>
</span><span id="ServerArgs-287"><a href="#ServerArgs-287"><span class="linenos"> 287</span></a>    <span class="n">disaggregation_bootstrap_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8998</span>
</span><span id="ServerArgs-288"><a href="#ServerArgs-288"><span class="linenos"> 288</span></a>    <span class="n">disaggregation_decode_tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-289"><a href="#ServerArgs-289"><span class="linenos"> 289</span></a>    <span class="n">disaggregation_decode_dp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-290"><a href="#ServerArgs-290"><span class="linenos"> 290</span></a>    <span class="n">disaggregation_prefill_pp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-291"><a href="#ServerArgs-291"><span class="linenos"> 291</span></a>    <span class="n">disaggregation_ib_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-292"><a href="#ServerArgs-292"><span class="linenos"> 292</span></a>    <span class="n">num_reserved_decode_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>  <span class="c1"># used for decode kv cache offload in PD</span>
</span><span id="ServerArgs-293"><a href="#ServerArgs-293"><span class="linenos"> 293</span></a>    <span class="n">pdlb_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-294"><a href="#ServerArgs-294"><span class="linenos"> 294</span></a>
</span><span id="ServerArgs-295"><a href="#ServerArgs-295"><span class="linenos"> 295</span></a>    <span class="c1"># For model weight update</span>
</span><span id="ServerArgs-296"><a href="#ServerArgs-296"><span class="linenos"> 296</span></a>    <span class="n">custom_weight_loader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ServerArgs-297"><a href="#ServerArgs-297"><span class="linenos"> 297</span></a>    <span class="n">weight_loader_disable_mmap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-298"><a href="#ServerArgs-298"><span class="linenos"> 298</span></a>
</span><span id="ServerArgs-299"><a href="#ServerArgs-299"><span class="linenos"> 299</span></a>    <span class="c1"># For PD-Multiplexing</span>
</span><span id="ServerArgs-300"><a href="#ServerArgs-300"><span class="linenos"> 300</span></a>    <span class="n">enable_pdmux</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-301"><a href="#ServerArgs-301"><span class="linenos"> 301</span></a>    <span class="n">sm_group_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="ServerArgs-302"><a href="#ServerArgs-302"><span class="linenos"> 302</span></a>
</span><span id="ServerArgs-303"><a href="#ServerArgs-303"><span class="linenos"> 303</span></a>    <span class="c1"># Deprecated arguments</span>
</span><span id="ServerArgs-304"><a href="#ServerArgs-304"><span class="linenos"> 304</span></a>    <span class="n">enable_ep_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-305"><a href="#ServerArgs-305"><span class="linenos"> 305</span></a>    <span class="n">enable_deepep_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-306"><a href="#ServerArgs-306"><span class="linenos"> 306</span></a>    <span class="n">enable_flashinfer_cutlass_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-307"><a href="#ServerArgs-307"><span class="linenos"> 307</span></a>    <span class="n">enable_flashinfer_trtllm_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-308"><a href="#ServerArgs-308"><span class="linenos"> 308</span></a>    <span class="n">enable_triton_kernel_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-309"><a href="#ServerArgs-309"><span class="linenos"> 309</span></a>    <span class="n">enable_flashinfer_mxfp4_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-310"><a href="#ServerArgs-310"><span class="linenos"> 310</span></a>
</span><span id="ServerArgs-311"><a href="#ServerArgs-311"><span class="linenos"> 311</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs-312"><a href="#ServerArgs-312"><span class="linenos"> 312</span></a>        <span class="c1"># Check deprecated arguments</span>
</span><span id="ServerArgs-313"><a href="#ServerArgs-313"><span class="linenos"> 313</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_ep_moe</span><span class="p">:</span>
</span><span id="ServerArgs-314"><a href="#ServerArgs-314"><span class="linenos"> 314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span>
</span><span id="ServerArgs-315"><a href="#ServerArgs-315"><span class="linenos"> 315</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="ServerArgs-316"><a href="#ServerArgs-316"><span class="linenos"> 316</span></a>                <span class="s2">&quot;NOTE: --enable-ep-moe is deprecated. Please set `--ep-size` to the same value as `--tp-size` instead.&quot;</span>
</span><span id="ServerArgs-317"><a href="#ServerArgs-317"><span class="linenos"> 317</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-318"><a href="#ServerArgs-318"><span class="linenos"> 318</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_deepep_moe</span><span class="p">:</span>
</span><span id="ServerArgs-319"><a href="#ServerArgs-319"><span class="linenos"> 319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_a2a_backend</span> <span class="o">=</span> <span class="s2">&quot;deepep&quot;</span>
</span><span id="ServerArgs-320"><a href="#ServerArgs-320"><span class="linenos"> 320</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="ServerArgs-321"><a href="#ServerArgs-321"><span class="linenos"> 321</span></a>                <span class="s2">&quot;NOTE: --enable-deepep-moe is deprecated. Please set `--moe-a2a-backend` to &#39;deepep&#39; instead.&quot;</span>
</span><span id="ServerArgs-322"><a href="#ServerArgs-322"><span class="linenos"> 322</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-323"><a href="#ServerArgs-323"><span class="linenos"> 323</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_triton_kernel_moe</span><span class="p">:</span>
</span><span id="ServerArgs-324"><a href="#ServerArgs-324"><span class="linenos"> 324</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;triton_kernel&quot;</span>
</span><span id="ServerArgs-325"><a href="#ServerArgs-325"><span class="linenos"> 325</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="ServerArgs-326"><a href="#ServerArgs-326"><span class="linenos"> 326</span></a>                <span class="s2">&quot;NOTE: --enable-triton-kernel-moe is deprecated. Please set `--moe-runner-backend` to &#39;triton_kernel&#39; instead.&quot;</span>
</span><span id="ServerArgs-327"><a href="#ServerArgs-327"><span class="linenos"> 327</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-328"><a href="#ServerArgs-328"><span class="linenos"> 328</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_cutlass_moe</span><span class="p">:</span>
</span><span id="ServerArgs-329"><a href="#ServerArgs-329"><span class="linenos"> 329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_cutlass&quot;</span>
</span><span id="ServerArgs-330"><a href="#ServerArgs-330"><span class="linenos"> 330</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="ServerArgs-331"><a href="#ServerArgs-331"><span class="linenos"> 331</span></a>                <span class="s2">&quot;NOTE: --enable-flashinfer-cutlass-moe is deprecated. Please set `--moe-runner-backend` to &#39;flashinfer_cutlass&#39; instead.&quot;</span>
</span><span id="ServerArgs-332"><a href="#ServerArgs-332"><span class="linenos"> 332</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-333"><a href="#ServerArgs-333"><span class="linenos"> 333</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_trtllm_moe</span><span class="p">:</span>
</span><span id="ServerArgs-334"><a href="#ServerArgs-334"><span class="linenos"> 334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_trtllm&quot;</span>
</span><span id="ServerArgs-335"><a href="#ServerArgs-335"><span class="linenos"> 335</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="ServerArgs-336"><a href="#ServerArgs-336"><span class="linenos"> 336</span></a>                <span class="s2">&quot;NOTE: --enable-flashinfer-trtllm-moe is deprecated. Please set `--moe-runner-backend` to &#39;flashinfer_trtllm&#39; instead.&quot;</span>
</span><span id="ServerArgs-337"><a href="#ServerArgs-337"><span class="linenos"> 337</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-338"><a href="#ServerArgs-338"><span class="linenos"> 338</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_mxfp4_moe</span><span class="p">:</span>
</span><span id="ServerArgs-339"><a href="#ServerArgs-339"><span class="linenos"> 339</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_mxfp4&quot;</span>
</span><span id="ServerArgs-340"><a href="#ServerArgs-340"><span class="linenos"> 340</span></a>            <span class="n">print_deprecated_warning</span><span class="p">(</span>
</span><span id="ServerArgs-341"><a href="#ServerArgs-341"><span class="linenos"> 341</span></a>                <span class="s2">&quot;NOTE: --enable-flashinfer-mxfp4-moe is deprecated. Please set `--moe-runner-backend` to &#39;flashinfer_mxfp4&#39; instead.&quot;</span>
</span><span id="ServerArgs-342"><a href="#ServerArgs-342"><span class="linenos"> 342</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-343"><a href="#ServerArgs-343"><span class="linenos"> 343</span></a>
</span><span id="ServerArgs-344"><a href="#ServerArgs-344"><span class="linenos"> 344</span></a>        <span class="c1"># Set missing default values</span>
</span><span id="ServerArgs-345"><a href="#ServerArgs-345"><span class="linenos"> 345</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-346"><a href="#ServerArgs-346"><span class="linenos"> 346</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
</span><span id="ServerArgs-347"><a href="#ServerArgs-347"><span class="linenos"> 347</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">served_model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-348"><a href="#ServerArgs-348"><span class="linenos"> 348</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">served_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
</span><span id="ServerArgs-349"><a href="#ServerArgs-349"><span class="linenos"> 349</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-350"><a href="#ServerArgs-350"><span class="linenos"> 350</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">get_device</span><span class="p">()</span>
</span><span id="ServerArgs-351"><a href="#ServerArgs-351"><span class="linenos"> 351</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-352"><a href="#ServerArgs-352"><span class="linenos"> 352</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="ServerArgs-353"><a href="#ServerArgs-353"><span class="linenos"> 353</span></a>
</span><span id="ServerArgs-354"><a href="#ServerArgs-354"><span class="linenos"> 354</span></a>        <span class="n">gpu_mem</span> <span class="o">=</span> <span class="n">get_device_memory_capacity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="ServerArgs-355"><a href="#ServerArgs-355"><span class="linenos"> 355</span></a>
</span><span id="ServerArgs-356"><a href="#ServerArgs-356"><span class="linenos"> 356</span></a>        <span class="c1"># Set mem fraction static</span>
</span><span id="ServerArgs-357"><a href="#ServerArgs-357"><span class="linenos"> 357</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-358"><a href="#ServerArgs-358"><span class="linenos"> 358</span></a>            <span class="k">if</span> <span class="n">gpu_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-359"><a href="#ServerArgs-359"><span class="linenos"> 359</span></a>                <span class="c1"># GPU memory capacity = model weights + KV cache pool + activations + cuda graph buffers</span>
</span><span id="ServerArgs-360"><a href="#ServerArgs-360"><span class="linenos"> 360</span></a>                <span class="c1"># mem_fraction_static = (model weights + KV cache pool) / GPU memory capacity.</span>
</span><span id="ServerArgs-361"><a href="#ServerArgs-361"><span class="linenos"> 361</span></a>
</span><span id="ServerArgs-362"><a href="#ServerArgs-362"><span class="linenos"> 362</span></a>                <span class="c1"># We want mem_fraction_static to be as large as possible but still has enough room</span>
</span><span id="ServerArgs-363"><a href="#ServerArgs-363"><span class="linenos"> 363</span></a>                <span class="c1"># for activations and cuda graph buffers. We use the following heuristic to</span>
</span><span id="ServerArgs-364"><a href="#ServerArgs-364"><span class="linenos"> 364</span></a>                <span class="c1"># compute the needed size for activations and cuda graph buffers:</span>
</span><span id="ServerArgs-365"><a href="#ServerArgs-365"><span class="linenos"> 365</span></a>                <span class="c1"># - The size of the activation depends on the chunked_prefill_size and model size.</span>
</span><span id="ServerArgs-366"><a href="#ServerArgs-366"><span class="linenos"> 366</span></a>                <span class="c1"># - The size of cuda graph buffers depends on the cuda graph capture range and model size.</span>
</span><span id="ServerArgs-367"><a href="#ServerArgs-367"><span class="linenos"> 367</span></a>                <span class="c1"># For GPUs with more memory, we use a larger chunked_prefill_size and</span>
</span><span id="ServerArgs-368"><a href="#ServerArgs-368"><span class="linenos"> 368</span></a>                <span class="c1"># capture more cuda graphs, so they need to reserve more memory.</span>
</span><span id="ServerArgs-369"><a href="#ServerArgs-369"><span class="linenos"> 369</span></a>                <span class="n">parallel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span>
</span><span id="ServerArgs-370"><a href="#ServerArgs-370"><span class="linenos"> 370</span></a>
</span><span id="ServerArgs-371"><a href="#ServerArgs-371"><span class="linenos"> 371</span></a>                <span class="k">if</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="ServerArgs-372"><a href="#ServerArgs-372"><span class="linenos"> 372</span></a>                    <span class="c1"># T4, 4080. (chunked_prefill_size 2k, cuda_graph_max_bs 8)</span>
</span><span id="ServerArgs-373"><a href="#ServerArgs-373"><span class="linenos"> 373</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.8</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="ServerArgs-374"><a href="#ServerArgs-374"><span class="linenos"> 374</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">35</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="ServerArgs-375"><a href="#ServerArgs-375"><span class="linenos"> 375</span></a>                    <span class="c1"># A10, L40, 4090, 5090. (chunked_prefill_size 2k, cuda_graph_max_bs 8)</span>
</span><span id="ServerArgs-376"><a href="#ServerArgs-376"><span class="linenos"> 376</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.8</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="ServerArgs-377"><a href="#ServerArgs-377"><span class="linenos"> 377</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="ServerArgs-378"><a href="#ServerArgs-378"><span class="linenos"> 378</span></a>                    <span class="c1"># H100, A100. (chunked_prefill_size 8k, cuda_graph_max_bs 160)</span>
</span><span id="ServerArgs-379"><a href="#ServerArgs-379"><span class="linenos"> 379</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mf">9.5</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="ServerArgs-380"><a href="#ServerArgs-380"><span class="linenos"> 380</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="ServerArgs-381"><a href="#ServerArgs-381"><span class="linenos"> 381</span></a>                    <span class="c1"># H20. (chunked_prefill_size 8k, cuda_graph_max_bs 256)</span>
</span><span id="ServerArgs-382"><a href="#ServerArgs-382"><span class="linenos"> 382</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="ServerArgs-383"><a href="#ServerArgs-383"><span class="linenos"> 383</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">160</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="ServerArgs-384"><a href="#ServerArgs-384"><span class="linenos"> 384</span></a>                    <span class="c1"># H200. (chunked_prefill_size 8k, cuda_graph_max_bs 256)</span>
</span><span id="ServerArgs-385"><a href="#ServerArgs-385"><span class="linenos"> 385</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">parallel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="ServerArgs-386"><a href="#ServerArgs-386"><span class="linenos"> 386</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-387"><a href="#ServerArgs-387"><span class="linenos"> 387</span></a>                    <span class="c1"># B200, MI300. (chunked_prefill_size 16k, cuda_graph_max_bs 512)</span>
</span><span id="ServerArgs-388"><a href="#ServerArgs-388"><span class="linenos"> 388</span></a>                    <span class="n">reserved_mem</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="ServerArgs-389"><a href="#ServerArgs-389"><span class="linenos"> 389</span></a>
</span><span id="ServerArgs-390"><a href="#ServerArgs-390"><span class="linenos"> 390</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-391"><a href="#ServerArgs-391"><span class="linenos"> 391</span></a>                    <span class="c1"># draft model and larger cuda graph buffers</span>
</span><span id="ServerArgs-392"><a href="#ServerArgs-392"><span class="linenos"> 392</span></a>                    <span class="n">reserved_mem</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="ServerArgs-393"><a href="#ServerArgs-393"><span class="linenos"> 393</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="ServerArgs-394"><a href="#ServerArgs-394"><span class="linenos"> 394</span></a>                    <span class="n">reserved_mem</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span>
</span><span id="ServerArgs-395"><a href="#ServerArgs-395"><span class="linenos"> 395</span></a>
</span><span id="ServerArgs-396"><a href="#ServerArgs-396"><span class="linenos"> 396</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">gpu_mem</span> <span class="o">-</span> <span class="n">reserved_mem</span><span class="p">)</span> <span class="o">/</span> <span class="n">gpu_mem</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="ServerArgs-397"><a href="#ServerArgs-397"><span class="linenos"> 397</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-398"><a href="#ServerArgs-398"><span class="linenos"> 398</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="o">=</span> <span class="mf">0.88</span>
</span><span id="ServerArgs-399"><a href="#ServerArgs-399"><span class="linenos"> 399</span></a>
</span><span id="ServerArgs-400"><a href="#ServerArgs-400"><span class="linenos"> 400</span></a>            <span class="c1"># Lazy init to avoid circular import</span>
</span><span id="ServerArgs-401"><a href="#ServerArgs-401"><span class="linenos"> 401</span></a>            <span class="c1"># Multimodal models need more memory for the image processor</span>
</span><span id="ServerArgs-402"><a href="#ServerArgs-402"><span class="linenos"> 402</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">sglang.srt.configs.model_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelConfig</span>
</span><span id="ServerArgs-403"><a href="#ServerArgs-403"><span class="linenos"> 403</span></a>
</span><span id="ServerArgs-404"><a href="#ServerArgs-404"><span class="linenos"> 404</span></a>            <span class="n">model_config</span> <span class="o">=</span> <span class="n">ModelConfig</span><span class="o">.</span><span class="n">from_server_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="ServerArgs-405"><a href="#ServerArgs-405"><span class="linenos"> 405</span></a>            <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">is_multimodal</span><span class="p">:</span>
</span><span id="ServerArgs-406"><a href="#ServerArgs-406"><span class="linenos"> 406</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">adjust_mem_fraction_for_vlm</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
</span><span id="ServerArgs-407"><a href="#ServerArgs-407"><span class="linenos"> 407</span></a>
</span><span id="ServerArgs-408"><a href="#ServerArgs-408"><span class="linenos"> 408</span></a>        <span class="c1"># Set chunked prefill size, which depends on the gpu memory capacity</span>
</span><span id="ServerArgs-409"><a href="#ServerArgs-409"><span class="linenos"> 409</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-410"><a href="#ServerArgs-410"><span class="linenos"> 410</span></a>            <span class="k">if</span> <span class="n">gpu_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-411"><a href="#ServerArgs-411"><span class="linenos"> 411</span></a>                <span class="k">if</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">35</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># A10, L40, 4090</span>
</span><span id="ServerArgs-412"><a href="#ServerArgs-412"><span class="linenos"> 412</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span id="ServerArgs-413"><a href="#ServerArgs-413"><span class="linenos"> 413</span></a>                <span class="k">elif</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">160</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># H100, H200, A100, H20</span>
</span><span id="ServerArgs-414"><a href="#ServerArgs-414"><span class="linenos"> 414</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="mi">8192</span>
</span><span id="ServerArgs-415"><a href="#ServerArgs-415"><span class="linenos"> 415</span></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># B200, MI300</span>
</span><span id="ServerArgs-416"><a href="#ServerArgs-416"><span class="linenos"> 416</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="mi">16384</span>
</span><span id="ServerArgs-417"><a href="#ServerArgs-417"><span class="linenos"> 417</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-418"><a href="#ServerArgs-418"><span class="linenos"> 418</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="mi">4096</span>
</span><span id="ServerArgs-419"><a href="#ServerArgs-419"><span class="linenos"> 419</span></a>
</span><span id="ServerArgs-420"><a href="#ServerArgs-420"><span class="linenos"> 420</span></a>        <span class="c1"># Set cuda graph max batch size</span>
</span><span id="ServerArgs-421"><a href="#ServerArgs-421"><span class="linenos"> 421</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-422"><a href="#ServerArgs-422"><span class="linenos"> 422</span></a>            <span class="c1"># Based on detailed statistics, when serving TP1/TP2 models on lower-end GPUs with HBM&lt;25G, you can either disable cuda graph or set `cuda_graph_max_bs` to a very small value to reduce the memory overhead of creating cuda graphs, with almost no impact on performance. However, when serving models with TP4 or TP8, we need to enable cuda graph to maintain high performance. In this case, we can set `cuda_graph_max_bs` to 80 (half of the default value 160) to reduce the memory overhead of creating cuda graphs. Looking at the logs from TP4 serving of qwen2-72b, a value of 80 is sufficient and can reduce the memory overhead of creating cuda graphs on lower-end GPUs compared to the original 160, avoiding OOM issues.</span>
</span><span id="ServerArgs-423"><a href="#ServerArgs-423"><span class="linenos"> 423</span></a>            <span class="k">if</span> <span class="n">gpu_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gpu_mem</span> <span class="o">&lt;</span> <span class="mi">35</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
</span><span id="ServerArgs-424"><a href="#ServerArgs-424"><span class="linenos"> 424</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ServerArgs-425"><a href="#ServerArgs-425"><span class="linenos"> 425</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="ServerArgs-426"><a href="#ServerArgs-426"><span class="linenos"> 426</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-427"><a href="#ServerArgs-427"><span class="linenos"> 427</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span> <span class="o">=</span> <span class="mi">80</span>
</span><span id="ServerArgs-428"><a href="#ServerArgs-428"><span class="linenos"> 428</span></a>
</span><span id="ServerArgs-429"><a href="#ServerArgs-429"><span class="linenos"> 429</span></a>        <span class="c1"># Set kernel backends for hpu device</span>
</span><span id="ServerArgs-430"><a href="#ServerArgs-430"><span class="linenos"> 430</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;hpu&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-431"><a href="#ServerArgs-431"><span class="linenos"> 431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;torch_native&quot;</span>
</span><span id="ServerArgs-432"><a href="#ServerArgs-432"><span class="linenos"> 432</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sampling_backend</span> <span class="o">=</span> <span class="s2">&quot;pytorch&quot;</span>
</span><span id="ServerArgs-433"><a href="#ServerArgs-433"><span class="linenos"> 433</span></a>
</span><span id="ServerArgs-434"><a href="#ServerArgs-434"><span class="linenos"> 434</span></a>        <span class="c1"># Model-specific adjustments</span>
</span><span id="ServerArgs-435"><a href="#ServerArgs-435"><span class="linenos"> 435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_specific_adjustments</span><span class="p">()</span>
</span><span id="ServerArgs-436"><a href="#ServerArgs-436"><span class="linenos"> 436</span></a>
</span><span id="ServerArgs-437"><a href="#ServerArgs-437"><span class="linenos"> 437</span></a>        <span class="c1"># Set kernel backends</span>
</span><span id="ServerArgs-438"><a href="#ServerArgs-438"><span class="linenos"> 438</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-439"><a href="#ServerArgs-439"><span class="linenos"> 439</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-440"><a href="#ServerArgs-440"><span class="linenos"> 440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;intel_amx&quot;</span>
</span><span id="ServerArgs-441"><a href="#ServerArgs-441"><span class="linenos"> 441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sampling_backend</span> <span class="o">=</span> <span class="s2">&quot;pytorch&quot;</span>
</span><span id="ServerArgs-442"><a href="#ServerArgs-442"><span class="linenos"> 442</span></a>
</span><span id="ServerArgs-443"><a href="#ServerArgs-443"><span class="linenos"> 443</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-444"><a href="#ServerArgs-444"><span class="linenos"> 444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sampling_backend</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs-445"><a href="#ServerArgs-445"><span class="linenos"> 445</span></a>                <span class="s2">&quot;flashinfer&quot;</span> <span class="k">if</span> <span class="n">is_flashinfer_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;pytorch&quot;</span>
</span><span id="ServerArgs-446"><a href="#ServerArgs-446"><span class="linenos"> 446</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-447"><a href="#ServerArgs-447"><span class="linenos"> 447</span></a>
</span><span id="ServerArgs-448"><a href="#ServerArgs-448"><span class="linenos"> 448</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;torch_native&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-449"><a href="#ServerArgs-449"><span class="linenos"> 449</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-450"><a href="#ServerArgs-450"><span class="linenos"> 450</span></a>                <span class="s2">&quot;Cuda graph is disabled because of using torch native attention backend&quot;</span>
</span><span id="ServerArgs-451"><a href="#ServerArgs-451"><span class="linenos"> 451</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-452"><a href="#ServerArgs-452"><span class="linenos"> 452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-453"><a href="#ServerArgs-453"><span class="linenos"> 453</span></a>
</span><span id="ServerArgs-454"><a href="#ServerArgs-454"><span class="linenos"> 454</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;ascend&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-455"><a href="#ServerArgs-455"><span class="linenos"> 455</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-456"><a href="#ServerArgs-456"><span class="linenos"> 456</span></a>                <span class="s2">&quot;At this moment Ascend attention backend only supports a page_size of 128, change page_size to 128.&quot;</span>
</span><span id="ServerArgs-457"><a href="#ServerArgs-457"><span class="linenos"> 457</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-458"><a href="#ServerArgs-458"><span class="linenos"> 458</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">128</span>
</span><span id="ServerArgs-459"><a href="#ServerArgs-459"><span class="linenos"> 459</span></a>
</span><span id="ServerArgs-460"><a href="#ServerArgs-460"><span class="linenos"> 460</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs-461"><a href="#ServerArgs-461"><span class="linenos"> 461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;flashmla&quot;</span>
</span><span id="ServerArgs-462"><a href="#ServerArgs-462"><span class="linenos"> 462</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;flashmla&quot;</span>
</span><span id="ServerArgs-463"><a href="#ServerArgs-463"><span class="linenos"> 463</span></a>        <span class="p">):</span>
</span><span id="ServerArgs-464"><a href="#ServerArgs-464"><span class="linenos"> 464</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-465"><a href="#ServerArgs-465"><span class="linenos"> 465</span></a>                <span class="s2">&quot;FlashMLA only supports a page_size of 64, change page_size to 64.&quot;</span>
</span><span id="ServerArgs-466"><a href="#ServerArgs-466"><span class="linenos"> 466</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-467"><a href="#ServerArgs-467"><span class="linenos"> 467</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="ServerArgs-468"><a href="#ServerArgs-468"><span class="linenos"> 468</span></a>
</span><span id="ServerArgs-469"><a href="#ServerArgs-469"><span class="linenos"> 469</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs-470"><a href="#ServerArgs-470"><span class="linenos"> 470</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;cutlass_mla&quot;</span>
</span><span id="ServerArgs-471"><a href="#ServerArgs-471"><span class="linenos"> 471</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;cutlass_mla&quot;</span>
</span><span id="ServerArgs-472"><a href="#ServerArgs-472"><span class="linenos"> 472</span></a>        <span class="p">):</span>
</span><span id="ServerArgs-473"><a href="#ServerArgs-473"><span class="linenos"> 473</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-474"><a href="#ServerArgs-474"><span class="linenos"> 474</span></a>                <span class="s2">&quot;Cutlass MLA only supports a page_size of 128, change page_size to 128.&quot;</span>
</span><span id="ServerArgs-475"><a href="#ServerArgs-475"><span class="linenos"> 475</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-476"><a href="#ServerArgs-476"><span class="linenos"> 476</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">128</span>
</span><span id="ServerArgs-477"><a href="#ServerArgs-477"><span class="linenos"> 477</span></a>
</span><span id="ServerArgs-478"><a href="#ServerArgs-478"><span class="linenos"> 478</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs-479"><a href="#ServerArgs-479"><span class="linenos"> 479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mla&quot;</span>
</span><span id="ServerArgs-480"><a href="#ServerArgs-480"><span class="linenos"> 480</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mla&quot;</span>
</span><span id="ServerArgs-481"><a href="#ServerArgs-481"><span class="linenos"> 481</span></a>        <span class="p">):</span>
</span><span id="ServerArgs-482"><a href="#ServerArgs-482"><span class="linenos"> 482</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="ServerArgs-483"><a href="#ServerArgs-483"><span class="linenos"> 483</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs-484"><a href="#ServerArgs-484"><span class="linenos"> 484</span></a>                    <span class="s2">&quot;TRTLLM MLA backend is only supported on Blackwell GPUs (SM100). Please use a different backend.&quot;</span>
</span><span id="ServerArgs-485"><a href="#ServerArgs-485"><span class="linenos"> 485</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-486"><a href="#ServerArgs-486"><span class="linenos"> 486</span></a>
</span><span id="ServerArgs-487"><a href="#ServerArgs-487"><span class="linenos"> 487</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]:</span>
</span><span id="ServerArgs-488"><a href="#ServerArgs-488"><span class="linenos"> 488</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-489"><a href="#ServerArgs-489"><span class="linenos"> 489</span></a>                    <span class="sa">f</span><span class="s2">&quot;TensorRT-LLM MLA only supports page_size of 32 or 64, changing page_size from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">page_size</span><span class="si">}</span><span class="s2"> to 64.&quot;</span>
</span><span id="ServerArgs-490"><a href="#ServerArgs-490"><span class="linenos"> 490</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-491"><a href="#ServerArgs-491"><span class="linenos"> 491</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="ServerArgs-492"><a href="#ServerArgs-492"><span class="linenos"> 492</span></a>
</span><span id="ServerArgs-493"><a href="#ServerArgs-493"><span class="linenos"> 493</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache_dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fp8_e4m3&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">]:</span>
</span><span id="ServerArgs-494"><a href="#ServerArgs-494"><span class="linenos"> 494</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs-495"><a href="#ServerArgs-495"><span class="linenos"> 495</span></a>                    <span class="s2">&quot;TensorRT-LLM MLA backend only supports kv-cache-dtype of fp8_e4m3 or auto.&quot;</span>
</span><span id="ServerArgs-496"><a href="#ServerArgs-496"><span class="linenos"> 496</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-497"><a href="#ServerArgs-497"><span class="linenos"> 497</span></a>
</span><span id="ServerArgs-498"><a href="#ServerArgs-498"><span class="linenos"> 498</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs-499"><a href="#ServerArgs-499"><span class="linenos"> 499</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="ServerArgs-500"><a href="#ServerArgs-500"><span class="linenos"> 500</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="ServerArgs-501"><a href="#ServerArgs-501"><span class="linenos"> 501</span></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefill_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="ServerArgs-502"><a href="#ServerArgs-502"><span class="linenos"> 502</span></a>        <span class="p">):</span>
</span><span id="ServerArgs-503"><a href="#ServerArgs-503"><span class="linenos"> 503</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="ServerArgs-504"><a href="#ServerArgs-504"><span class="linenos"> 504</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs-505"><a href="#ServerArgs-505"><span class="linenos"> 505</span></a>                    <span class="s2">&quot;TRTLLM MHA backend is only supported on Blackwell GPUs (SM100). Please use a different backend.&quot;</span>
</span><span id="ServerArgs-506"><a href="#ServerArgs-506"><span class="linenos"> 506</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-507"><a href="#ServerArgs-507"><span class="linenos"> 507</span></a>
</span><span id="ServerArgs-508"><a href="#ServerArgs-508"><span class="linenos"> 508</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]:</span>
</span><span id="ServerArgs-509"><a href="#ServerArgs-509"><span class="linenos"> 509</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-510"><a href="#ServerArgs-510"><span class="linenos"> 510</span></a>                    <span class="sa">f</span><span class="s2">&quot;TensorRT-LLM MHA only supports page_size of 16, 32 or 64, changing page_size from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">page_size</span><span class="si">}</span><span class="s2"> to 64.&quot;</span>
</span><span id="ServerArgs-511"><a href="#ServerArgs-511"><span class="linenos"> 511</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-512"><a href="#ServerArgs-512"><span class="linenos"> 512</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="ServerArgs-513"><a href="#ServerArgs-513"><span class="linenos"> 513</span></a>
</span><span id="ServerArgs-514"><a href="#ServerArgs-514"><span class="linenos"> 514</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;dual_chunk_flash_attn&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-515"><a href="#ServerArgs-515"><span class="linenos"> 515</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-516"><a href="#ServerArgs-516"><span class="linenos"> 516</span></a>                <span class="s2">&quot;Mixed chunk, radix cache, and cuda graphs are disabled because of using dual chunk flash attention backend&quot;</span>
</span><span id="ServerArgs-517"><a href="#ServerArgs-517"><span class="linenos"> 517</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-518"><a href="#ServerArgs-518"><span class="linenos"> 518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-519"><a href="#ServerArgs-519"><span class="linenos"> 519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-520"><a href="#ServerArgs-520"><span class="linenos"> 520</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_radix_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-521"><a href="#ServerArgs-521"><span class="linenos"> 521</span></a>
</span><span id="ServerArgs-522"><a href="#ServerArgs-522"><span class="linenos"> 522</span></a>        <span class="c1"># Set page size</span>
</span><span id="ServerArgs-523"><a href="#ServerArgs-523"><span class="linenos"> 523</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-524"><a href="#ServerArgs-524"><span class="linenos"> 524</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ServerArgs-525"><a href="#ServerArgs-525"><span class="linenos"> 525</span></a>
</span><span id="ServerArgs-526"><a href="#ServerArgs-526"><span class="linenos"> 526</span></a>        <span class="c1"># AMD-specific Triton attention KV splits default number</span>
</span><span id="ServerArgs-527"><a href="#ServerArgs-527"><span class="linenos"> 527</span></a>        <span class="k">if</span> <span class="n">is_hip</span><span class="p">():</span>
</span><span id="ServerArgs-528"><a href="#ServerArgs-528"><span class="linenos"> 528</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">triton_attention_num_kv_splits</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="ServerArgs-529"><a href="#ServerArgs-529"><span class="linenos"> 529</span></a>
</span><span id="ServerArgs-530"><a href="#ServerArgs-530"><span class="linenos"> 530</span></a>        <span class="c1"># Choose grammar backend</span>
</span><span id="ServerArgs-531"><a href="#ServerArgs-531"><span class="linenos"> 531</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-532"><a href="#ServerArgs-532"><span class="linenos"> 532</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grammar_backend</span> <span class="o">=</span> <span class="s2">&quot;xgrammar&quot;</span>
</span><span id="ServerArgs-533"><a href="#ServerArgs-533"><span class="linenos"> 533</span></a>
</span><span id="ServerArgs-534"><a href="#ServerArgs-534"><span class="linenos"> 534</span></a>        <span class="c1"># Data parallelism attention</span>
</span><span id="ServerArgs-535"><a href="#ServerArgs-535"><span class="linenos"> 535</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="ServerArgs-536"><a href="#ServerArgs-536"><span class="linenos"> 536</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_conservativeness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_conservativeness</span> <span class="o">*</span> <span class="mf">0.3</span>
</span><span id="ServerArgs-537"><a href="#ServerArgs-537"><span class="linenos"> 537</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-538"><a href="#ServerArgs-538"><span class="linenos"> 538</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="ServerArgs-539"><a href="#ServerArgs-539"><span class="linenos"> 539</span></a>            <span class="p">),</span> <span class="s2">&quot;Please set a dp-size &gt; 1. You can use 1 &lt; dp-size &lt;= tp-size &quot;</span>
</span><span id="ServerArgs-540"><a href="#ServerArgs-540"><span class="linenos"> 540</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="ServerArgs-541"><a href="#ServerArgs-541"><span class="linenos"> 541</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span>
</span><span id="ServerArgs-542"><a href="#ServerArgs-542"><span class="linenos"> 542</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-543"><a href="#ServerArgs-543"><span class="linenos"> 543</span></a>                <span class="sa">f</span><span class="s2">&quot;DP attention is enabled. The chunked prefill size is adjusted to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span><span class="si">}</span><span class="s2"> to avoid MoE kernel issues. &quot;</span>
</span><span id="ServerArgs-544"><a href="#ServerArgs-544"><span class="linenos"> 544</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-545"><a href="#ServerArgs-545"><span class="linenos"> 545</span></a>
</span><span id="ServerArgs-546"><a href="#ServerArgs-546"><span class="linenos"> 546</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_lm_head</span><span class="p">:</span>
</span><span id="ServerArgs-547"><a href="#ServerArgs-547"><span class="linenos"> 547</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-548"><a href="#ServerArgs-548"><span class="linenos"> 548</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span>
</span><span id="ServerArgs-549"><a href="#ServerArgs-549"><span class="linenos"> 549</span></a>            <span class="p">),</span> <span class="s2">&quot;Please enable dp attention when setting enable_dp_lm_head. &quot;</span>
</span><span id="ServerArgs-550"><a href="#ServerArgs-550"><span class="linenos"> 550</span></a>
</span><span id="ServerArgs-551"><a href="#ServerArgs-551"><span class="linenos"> 551</span></a>        <span class="c1"># MoE kernel</span>
</span><span id="ServerArgs-552"><a href="#ServerArgs-552"><span class="linenos"> 552</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;flashinfer_cutlass&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-553"><a href="#ServerArgs-553"><span class="linenos"> 553</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-554"><a href="#ServerArgs-554"><span class="linenos"> 554</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">quantization</span> <span class="o">==</span> <span class="s2">&quot;modelopt_fp4&quot;</span>
</span><span id="ServerArgs-555"><a href="#ServerArgs-555"><span class="linenos"> 555</span></a>            <span class="p">),</span> <span class="s2">&quot;modelopt_fp4 quantization is required for Flashinfer MOE&quot;</span>
</span><span id="ServerArgs-556"><a href="#ServerArgs-556"><span class="linenos"> 556</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="ServerArgs-557"><a href="#ServerArgs-557"><span class="linenos"> 557</span></a>                <span class="mi">1</span><span class="p">,</span>
</span><span id="ServerArgs-558"><a href="#ServerArgs-558"><span class="linenos"> 558</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span><span class="p">,</span>
</span><span id="ServerArgs-559"><a href="#ServerArgs-559"><span class="linenos"> 559</span></a>            <span class="p">],</span> <span class="s2">&quot;The expert parallel size must be 1 or the same as the tensor parallel size&quot;</span>
</span><span id="ServerArgs-560"><a href="#ServerArgs-560"><span class="linenos"> 560</span></a>
</span><span id="ServerArgs-561"><a href="#ServerArgs-561"><span class="linenos"> 561</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;flashinfer_trtllm&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-562"><a href="#ServerArgs-562"><span class="linenos"> 562</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_shared_experts_fusion</span><span class="p">:</span>
</span><span id="ServerArgs-563"><a href="#ServerArgs-563"><span class="linenos"> 563</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disable_shared_experts_fusion</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-564"><a href="#ServerArgs-564"><span class="linenos"> 564</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-565"><a href="#ServerArgs-565"><span class="linenos"> 565</span></a>                    <span class="s2">&quot;FlashInfer TRTLLM MoE is enabled. --disable-shared-experts-fusion is automatically set.&quot;</span>
</span><span id="ServerArgs-566"><a href="#ServerArgs-566"><span class="linenos"> 566</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-567"><a href="#ServerArgs-567"><span class="linenos"> 567</span></a>
</span><span id="ServerArgs-568"><a href="#ServerArgs-568"><span class="linenos"> 568</span></a>        <span class="c1"># DeepEP MoE</span>
</span><span id="ServerArgs-569"><a href="#ServerArgs-569"><span class="linenos"> 569</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_a2a_backend</span> <span class="o">==</span> <span class="s2">&quot;deepep&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-570"><a href="#ServerArgs-570"><span class="linenos"> 570</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepep_mode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-571"><a href="#ServerArgs-571"><span class="linenos"> 571</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cuda graph is disabled because deepep_mode=`normal`&quot;</span><span class="p">)</span>
</span><span id="ServerArgs-572"><a href="#ServerArgs-572"><span class="linenos"> 572</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disable_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-573"><a href="#ServerArgs-573"><span class="linenos"> 573</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span>
</span><span id="ServerArgs-574"><a href="#ServerArgs-574"><span class="linenos"> 574</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-575"><a href="#ServerArgs-575"><span class="linenos"> 575</span></a>                <span class="sa">f</span><span class="s2">&quot;DeepEP MoE is enabled. The expert parallel size is adjusted to be the same as the tensor parallel size[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span><span class="si">}</span><span class="s2">].&quot;</span>
</span><span id="ServerArgs-576"><a href="#ServerArgs-576"><span class="linenos"> 576</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-577"><a href="#ServerArgs-577"><span class="linenos"> 577</span></a>
</span><span id="ServerArgs-578"><a href="#ServerArgs-578"><span class="linenos"> 578</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_eplb</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ServerArgs-579"><a href="#ServerArgs-579"><span class="linenos"> 579</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="o">=</span> <span class="s2">&quot;stat&quot;</span>
</span><span id="ServerArgs-580"><a href="#ServerArgs-580"><span class="linenos"> 580</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-581"><a href="#ServerArgs-581"><span class="linenos"> 581</span></a>                <span class="s2">&quot;EPLB is enabled. The expert_distribution_recorder_mode is automatically set.&quot;</span>
</span><span id="ServerArgs-582"><a href="#ServerArgs-582"><span class="linenos"> 582</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-583"><a href="#ServerArgs-583"><span class="linenos"> 583</span></a>
</span><span id="ServerArgs-584"><a href="#ServerArgs-584"><span class="linenos"> 584</span></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_eplb</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_expert_location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="ServerArgs-585"><a href="#ServerArgs-585"><span class="linenos"> 585</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ep_dispatch_algorithm</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ServerArgs-586"><a href="#ServerArgs-586"><span class="linenos"> 586</span></a>        <span class="p">):</span>
</span><span id="ServerArgs-587"><a href="#ServerArgs-587"><span class="linenos"> 587</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ep_dispatch_algorithm</span> <span class="o">=</span> <span class="s2">&quot;static&quot;</span>
</span><span id="ServerArgs-588"><a href="#ServerArgs-588"><span class="linenos"> 588</span></a>
</span><span id="ServerArgs-589"><a href="#ServerArgs-589"><span class="linenos"> 589</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_eplb</span><span class="p">:</span>
</span><span id="ServerArgs-590"><a href="#ServerArgs-590"><span class="linenos"> 590</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="ServerArgs-591"><a href="#ServerArgs-591"><span class="linenos"> 591</span></a>
</span><span id="ServerArgs-592"><a href="#ServerArgs-592"><span class="linenos"> 592</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_expert_distribution_metrics</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="ServerArgs-593"><a href="#ServerArgs-593"><span class="linenos"> 593</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ServerArgs-594"><a href="#ServerArgs-594"><span class="linenos"> 594</span></a>        <span class="p">):</span>
</span><span id="ServerArgs-595"><a href="#ServerArgs-595"><span class="linenos"> 595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="o">=</span> <span class="s2">&quot;stat&quot;</span>
</span><span id="ServerArgs-596"><a href="#ServerArgs-596"><span class="linenos"> 596</span></a>
</span><span id="ServerArgs-597"><a href="#ServerArgs-597"><span class="linenos"> 597</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-598"><a href="#ServerArgs-598"><span class="linenos"> 598</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eplb_rebalance_num_iterations</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-599"><a href="#ServerArgs-599"><span class="linenos"> 599</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="ServerArgs-600"><a href="#ServerArgs-600"><span class="linenos"> 600</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-601"><a href="#ServerArgs-601"><span class="linenos"> 601</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="ServerArgs-602"><a href="#ServerArgs-602"><span class="linenos"> 602</span></a>
</span><span id="ServerArgs-603"><a href="#ServerArgs-603"><span class="linenos"> 603</span></a>        <span class="c1"># Pipeline parallelism</span>
</span><span id="ServerArgs-604"><a href="#ServerArgs-604"><span class="linenos"> 604</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ServerArgs-605"><a href="#ServerArgs-605"><span class="linenos"> 605</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_overlap_schedule</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-606"><a href="#ServerArgs-606"><span class="linenos"> 606</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-607"><a href="#ServerArgs-607"><span class="linenos"> 607</span></a>                <span class="s2">&quot;Pipeline parallelism is incompatible with overlap schedule.&quot;</span>
</span><span id="ServerArgs-608"><a href="#ServerArgs-608"><span class="linenos"> 608</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-609"><a href="#ServerArgs-609"><span class="linenos"> 609</span></a>
</span><span id="ServerArgs-610"><a href="#ServerArgs-610"><span class="linenos"> 610</span></a>        <span class="c1"># Hicache</span>
</span><span id="ServerArgs-611"><a href="#ServerArgs-611"><span class="linenos"> 611</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hicache_storage_backend</span> <span class="o">==</span> <span class="s2">&quot;mooncake&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-612"><a href="#ServerArgs-612"><span class="linenos"> 612</span></a>            <span class="c1"># to use mooncake storage backend, the following conditions must be met:</span>
</span><span id="ServerArgs-613"><a href="#ServerArgs-613"><span class="linenos"> 613</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hicache_io_backend</span> <span class="o">=</span> <span class="s2">&quot;kernel&quot;</span>
</span><span id="ServerArgs-614"><a href="#ServerArgs-614"><span class="linenos"> 614</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hicache_mem_layout</span> <span class="o">=</span> <span class="s2">&quot;page_first&quot;</span>
</span><span id="ServerArgs-615"><a href="#ServerArgs-615"><span class="linenos"> 615</span></a>
</span><span id="ServerArgs-616"><a href="#ServerArgs-616"><span class="linenos"> 616</span></a>        <span class="c1"># Speculative Decoding</span>
</span><span id="ServerArgs-617"><a href="#ServerArgs-617"><span class="linenos"> 617</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="o">==</span> <span class="s2">&quot;NEXTN&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-618"><a href="#ServerArgs-618"><span class="linenos"> 618</span></a>            <span class="c1"># NEXTN shares the same implementation of EAGLE</span>
</span><span id="ServerArgs-619"><a href="#ServerArgs-619"><span class="linenos"> 619</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="o">=</span> <span class="s2">&quot;EAGLE&quot;</span>
</span><span id="ServerArgs-620"><a href="#ServerArgs-620"><span class="linenos"> 620</span></a>
</span><span id="ServerArgs-621"><a href="#ServerArgs-621"><span class="linenos"> 621</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;EAGLE&quot;</span><span class="p">,</span> <span class="s2">&quot;EAGLE3&quot;</span><span class="p">):</span>
</span><span id="ServerArgs-622"><a href="#ServerArgs-622"><span class="linenos"> 622</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_running_requests</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-623"><a href="#ServerArgs-623"><span class="linenos"> 623</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_running_requests</span> <span class="o">=</span> <span class="mi">48</span>
</span><span id="ServerArgs-624"><a href="#ServerArgs-624"><span class="linenos"> 624</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_overlap_schedule</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-625"><a href="#ServerArgs-625"><span class="linenos"> 625</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-626"><a href="#ServerArgs-626"><span class="linenos"> 626</span></a>                <span class="s2">&quot;Overlap scheduler is disabled because of using &quot;</span>
</span><span id="ServerArgs-627"><a href="#ServerArgs-627"><span class="linenos"> 627</span></a>                <span class="s2">&quot;eagle speculative decoding.&quot;</span>
</span><span id="ServerArgs-628"><a href="#ServerArgs-628"><span class="linenos"> 628</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-629"><a href="#ServerArgs-629"><span class="linenos"> 629</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span><span class="p">:</span>
</span><span id="ServerArgs-630"><a href="#ServerArgs-630"><span class="linenos"> 630</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ServerArgs-631"><a href="#ServerArgs-631"><span class="linenos"> 631</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-632"><a href="#ServerArgs-632"><span class="linenos"> 632</span></a>                    <span class="s2">&quot;Mixed chunked prefill is disabled because of using &quot;</span>
</span><span id="ServerArgs-633"><a href="#ServerArgs-633"><span class="linenos"> 633</span></a>                    <span class="s2">&quot;eagle speculative decoding.&quot;</span>
</span><span id="ServerArgs-634"><a href="#ServerArgs-634"><span class="linenos"> 634</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-635"><a href="#ServerArgs-635"><span class="linenos"> 635</span></a>
</span><span id="ServerArgs-636"><a href="#ServerArgs-636"><span class="linenos"> 636</span></a>            <span class="n">model_arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hf_config</span><span class="p">()</span><span class="o">.</span><span class="n">architectures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ServerArgs-637"><a href="#ServerArgs-637"><span class="linenos"> 637</span></a>            <span class="k">if</span> <span class="n">model_arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DeepseekV3ForCausalLM&quot;</span><span class="p">,</span> <span class="s2">&quot;Glm4MoeForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="ServerArgs-638"><a href="#ServerArgs-638"><span class="linenos"> 638</span></a>                <span class="c1"># Auto set draft_model_path DeepSeek-V3/R1</span>
</span><span id="ServerArgs-639"><a href="#ServerArgs-639"><span class="linenos"> 639</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_draft_model_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-640"><a href="#ServerArgs-640"><span class="linenos"> 640</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_draft_model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
</span><span id="ServerArgs-641"><a href="#ServerArgs-641"><span class="linenos"> 641</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-642"><a href="#ServerArgs-642"><span class="linenos"> 642</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-643"><a href="#ServerArgs-643"><span class="linenos"> 643</span></a>                        <span class="s2">&quot;DeepSeek MTP does not require setting speculative_draft_model_path.&quot;</span>
</span><span id="ServerArgs-644"><a href="#ServerArgs-644"><span class="linenos"> 644</span></a>                    <span class="p">)</span>
</span><span id="ServerArgs-645"><a href="#ServerArgs-645"><span class="linenos"> 645</span></a>
</span><span id="ServerArgs-646"><a href="#ServerArgs-646"><span class="linenos"> 646</span></a>            <span class="c1"># Auto choose parameters</span>
</span><span id="ServerArgs-647"><a href="#ServerArgs-647"><span class="linenos"> 647</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-648"><a href="#ServerArgs-648"><span class="linenos"> 648</span></a>                <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-649"><a href="#ServerArgs-649"><span class="linenos"> 649</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_eagle_topk</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ServerArgs-650"><a href="#ServerArgs-650"><span class="linenos"> 650</span></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ServerArgs-651"><a href="#ServerArgs-651"><span class="linenos"> 651</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-652"><a href="#ServerArgs-652"><span class="linenos"> 652</span></a>                <span class="p">(</span>
</span><span id="ServerArgs-653"><a href="#ServerArgs-653"><span class="linenos"> 653</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_steps</span><span class="p">,</span>
</span><span id="ServerArgs-654"><a href="#ServerArgs-654"><span class="linenos"> 654</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_eagle_topk</span><span class="p">,</span>
</span><span id="ServerArgs-655"><a href="#ServerArgs-655"><span class="linenos"> 655</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span><span class="p">,</span>
</span><span id="ServerArgs-656"><a href="#ServerArgs-656"><span class="linenos"> 656</span></a>                <span class="p">)</span> <span class="o">=</span> <span class="n">auto_choose_speculative_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="ServerArgs-657"><a href="#ServerArgs-657"><span class="linenos"> 657</span></a>
</span><span id="ServerArgs-658"><a href="#ServerArgs-658"><span class="linenos"> 658</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs-659"><a href="#ServerArgs-659"><span class="linenos"> 659</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="ServerArgs-660"><a href="#ServerArgs-660"><span class="linenos"> 660</span></a>                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="ServerArgs-661"><a href="#ServerArgs-661"><span class="linenos"> 661</span></a>                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefill_attention_backend</span> <span class="o">==</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="ServerArgs-662"><a href="#ServerArgs-662"><span class="linenos"> 662</span></a>            <span class="p">):</span>
</span><span id="ServerArgs-663"><a href="#ServerArgs-663"><span class="linenos"> 663</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_eagle_topk</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ServerArgs-664"><a href="#ServerArgs-664"><span class="linenos"> 664</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs-665"><a href="#ServerArgs-665"><span class="linenos"> 665</span></a>                        <span class="s2">&quot;trtllm_mha backend only supports topk = 1 for speculative decoding.&quot;</span>
</span><span id="ServerArgs-666"><a href="#ServerArgs-666"><span class="linenos"> 666</span></a>                    <span class="p">)</span>
</span><span id="ServerArgs-667"><a href="#ServerArgs-667"><span class="linenos"> 667</span></a>
</span><span id="ServerArgs-668"><a href="#ServerArgs-668"><span class="linenos"> 668</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs-669"><a href="#ServerArgs-669"><span class="linenos"> 669</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">speculative_eagle_topk</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="ServerArgs-670"><a href="#ServerArgs-670"><span class="linenos"> 670</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_steps</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="ServerArgs-671"><a href="#ServerArgs-671"><span class="linenos"> 671</span></a>            <span class="p">):</span>
</span><span id="ServerArgs-672"><a href="#ServerArgs-672"><span class="linenos"> 672</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-673"><a href="#ServerArgs-673"><span class="linenos"> 673</span></a>                    <span class="s2">&quot;speculative_num_draft_tokens is adjusted to speculative_num_steps + 1 when speculative_eagle_topk == 1&quot;</span>
</span><span id="ServerArgs-674"><a href="#ServerArgs-674"><span class="linenos"> 674</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-675"><a href="#ServerArgs-675"><span class="linenos"> 675</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_num_steps</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="ServerArgs-676"><a href="#ServerArgs-676"><span class="linenos"> 676</span></a>
</span><span id="ServerArgs-677"><a href="#ServerArgs-677"><span class="linenos"> 677</span></a>            <span class="c1"># The token generated from the verify step is counted.</span>
</span><span id="ServerArgs-678"><a href="#ServerArgs-678"><span class="linenos"> 678</span></a>            <span class="c1"># If sepculative_num_steps &gt;= speculative_num_draft_tokens, the additional tokens will definitely be discarded.</span>
</span><span id="ServerArgs-679"><a href="#ServerArgs-679"><span class="linenos"> 679</span></a>            <span class="c1"># assert self.speculative_num_steps &lt; self.speculative_num_draft_tokens</span>
</span><span id="ServerArgs-680"><a href="#ServerArgs-680"><span class="linenos"> 680</span></a>
</span><span id="ServerArgs-681"><a href="#ServerArgs-681"><span class="linenos"> 681</span></a>        <span class="c1"># GGUF</span>
</span><span id="ServerArgs-682"><a href="#ServerArgs-682"><span class="linenos"> 682</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs-683"><a href="#ServerArgs-683"><span class="linenos"> 683</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_format</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_format</span> <span class="o">==</span> <span class="s2">&quot;gguf&quot;</span>
</span><span id="ServerArgs-684"><a href="#ServerArgs-684"><span class="linenos"> 684</span></a>        <span class="p">)</span> <span class="ow">and</span> <span class="n">check_gguf_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">):</span>
</span><span id="ServerArgs-685"><a href="#ServerArgs-685"><span class="linenos"> 685</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_format</span> <span class="o">=</span> <span class="s2">&quot;gguf&quot;</span>
</span><span id="ServerArgs-686"><a href="#ServerArgs-686"><span class="linenos"> 686</span></a>
</span><span id="ServerArgs-687"><a href="#ServerArgs-687"><span class="linenos"> 687</span></a>        <span class="c1"># Model loading</span>
</span><span id="ServerArgs-688"><a href="#ServerArgs-688"><span class="linenos"> 688</span></a>        <span class="k">if</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">):</span>
</span><span id="ServerArgs-689"><a href="#ServerArgs-689"><span class="linenos"> 689</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load_format</span> <span class="o">=</span> <span class="s2">&quot;remote&quot;</span>
</span><span id="ServerArgs-690"><a href="#ServerArgs-690"><span class="linenos"> 690</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_weight_loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-691"><a href="#ServerArgs-691"><span class="linenos"> 691</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_weight_loader</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ServerArgs-692"><a href="#ServerArgs-692"><span class="linenos"> 692</span></a>
</span><span id="ServerArgs-693"><a href="#ServerArgs-693"><span class="linenos"> 693</span></a>        <span class="c1"># PD disaggregation</span>
</span><span id="ServerArgs-694"><a href="#ServerArgs-694"><span class="linenos"> 694</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_mode</span> <span class="o">==</span> <span class="s2">&quot;decode&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-695"><a href="#ServerArgs-695"><span class="linenos"> 695</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-696"><a href="#ServerArgs-696"><span class="linenos"> 696</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ServerArgs-697"><a href="#ServerArgs-697"><span class="linenos"> 697</span></a>            <span class="p">),</span> <span class="s2">&quot;Cannot set --disaggregation-decode-tp for the decode engine.&quot;</span>
</span><span id="ServerArgs-698"><a href="#ServerArgs-698"><span class="linenos"> 698</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-699"><a href="#ServerArgs-699"><span class="linenos"> 699</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ServerArgs-700"><a href="#ServerArgs-700"><span class="linenos"> 700</span></a>            <span class="p">),</span> <span class="s2">&quot;Cannot set --disaggregation-decode-dp for the decode engine.&quot;</span>
</span><span id="ServerArgs-701"><a href="#ServerArgs-701"><span class="linenos"> 701</span></a>
</span><span id="ServerArgs-702"><a href="#ServerArgs-702"><span class="linenos"> 702</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_radix_cache</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-703"><a href="#ServerArgs-703"><span class="linenos"> 703</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;KV cache is forced as chunk cache for decode server&quot;</span><span class="p">)</span>
</span><span id="ServerArgs-704"><a href="#ServerArgs-704"><span class="linenos"> 704</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_mode</span> <span class="o">==</span> <span class="s2">&quot;prefill&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-705"><a href="#ServerArgs-705"><span class="linenos"> 705</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-706"><a href="#ServerArgs-706"><span class="linenos"> 706</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span>
</span><span id="ServerArgs-707"><a href="#ServerArgs-707"><span class="linenos"> 707</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-708"><a href="#ServerArgs-708"><span class="linenos"> 708</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span>
</span><span id="ServerArgs-709"><a href="#ServerArgs-709"><span class="linenos"> 709</span></a>
</span><span id="ServerArgs-710"><a href="#ServerArgs-710"><span class="linenos"> 710</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_prefill_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span>
</span><span id="ServerArgs-711"><a href="#ServerArgs-711"><span class="linenos"> 711</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">validate_disagg_tp_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span><span class="p">)</span>
</span><span id="ServerArgs-712"><a href="#ServerArgs-712"><span class="linenos"> 712</span></a>
</span><span id="ServerArgs-713"><a href="#ServerArgs-713"><span class="linenos"> 713</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-714"><a href="#ServerArgs-714"><span class="linenos"> 714</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cuda graph is disabled for prefill server&quot;</span><span class="p">)</span>
</span><span id="ServerArgs-715"><a href="#ServerArgs-715"><span class="linenos"> 715</span></a>
</span><span id="ServerArgs-716"><a href="#ServerArgs-716"><span class="linenos"> 716</span></a>        <span class="c1"># Propagate env vars</span>
</span><span id="ServerArgs-717"><a href="#ServerArgs-717"><span class="linenos"> 717</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SGLANG_ENABLE_TORCH_COMPILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs-718"><a href="#ServerArgs-718"><span class="linenos"> 718</span></a>            <span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_torch_compile</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span>
</span><span id="ServerArgs-719"><a href="#ServerArgs-719"><span class="linenos"> 719</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-720"><a href="#ServerArgs-720"><span class="linenos"> 720</span></a>        <span class="c1"># Set env var before grammar backends init</span>
</span><span id="ServerArgs-721"><a href="#ServerArgs-721"><span class="linenos"> 721</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SGLANG_DISABLE_OUTLINES_DISK_CACHE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs-722"><a href="#ServerArgs-722"><span class="linenos"> 722</span></a>            <span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_outlines_disk_cache</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span>
</span><span id="ServerArgs-723"><a href="#ServerArgs-723"><span class="linenos"> 723</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-724"><a href="#ServerArgs-724"><span class="linenos"> 724</span></a>
</span><span id="ServerArgs-725"><a href="#ServerArgs-725"><span class="linenos"> 725</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_hierarchical_cache</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_radix_cache</span><span class="p">:</span>
</span><span id="ServerArgs-726"><a href="#ServerArgs-726"><span class="linenos"> 726</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs-727"><a href="#ServerArgs-727"><span class="linenos"> 727</span></a>                <span class="s2">&quot;The arguments enable-hierarchical-cache and disable-radix-cache are mutually exclusive &quot;</span>
</span><span id="ServerArgs-728"><a href="#ServerArgs-728"><span class="linenos"> 728</span></a>                <span class="s2">&quot;and cannot be used at the same time. Please use only one of them.&quot;</span>
</span><span id="ServerArgs-729"><a href="#ServerArgs-729"><span class="linenos"> 729</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-730"><a href="#ServerArgs-730"><span class="linenos"> 730</span></a>
</span><span id="ServerArgs-731"><a href="#ServerArgs-731"><span class="linenos"> 731</span></a>    <span class="nd">@staticmethod</span>
</span><span id="ServerArgs-732"><a href="#ServerArgs-732"><span class="linenos"> 732</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_cli_args</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">):</span>
</span><span id="ServerArgs-733"><a href="#ServerArgs-733"><span class="linenos"> 733</span></a>        <span class="c1"># Model and tokenizer</span>
</span><span id="ServerArgs-734"><a href="#ServerArgs-734"><span class="linenos"> 734</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-735"><a href="#ServerArgs-735"><span class="linenos"> 735</span></a>            <span class="s2">&quot;--model-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-736"><a href="#ServerArgs-736"><span class="linenos"> 736</span></a>            <span class="s2">&quot;--model&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-737"><a href="#ServerArgs-737"><span class="linenos"> 737</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-738"><a href="#ServerArgs-738"><span class="linenos"> 738</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the model weights. This can be a local folder or a Hugging Face repo ID.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-739"><a href="#ServerArgs-739"><span class="linenos"> 739</span></a>            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ServerArgs-740"><a href="#ServerArgs-740"><span class="linenos"> 740</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-741"><a href="#ServerArgs-741"><span class="linenos"> 741</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-742"><a href="#ServerArgs-742"><span class="linenos"> 742</span></a>            <span class="s2">&quot;--tokenizer-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-743"><a href="#ServerArgs-743"><span class="linenos"> 743</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-744"><a href="#ServerArgs-744"><span class="linenos"> 744</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tokenizer_path</span><span class="p">,</span>
</span><span id="ServerArgs-745"><a href="#ServerArgs-745"><span class="linenos"> 745</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the tokenizer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-746"><a href="#ServerArgs-746"><span class="linenos"> 746</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-747"><a href="#ServerArgs-747"><span class="linenos"> 747</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-748"><a href="#ServerArgs-748"><span class="linenos"> 748</span></a>            <span class="s2">&quot;--tokenizer-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-749"><a href="#ServerArgs-749"><span class="linenos"> 749</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-750"><a href="#ServerArgs-750"><span class="linenos"> 750</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tokenizer_mode</span><span class="p">,</span>
</span><span id="ServerArgs-751"><a href="#ServerArgs-751"><span class="linenos"> 751</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;slow&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-752"><a href="#ServerArgs-752"><span class="linenos"> 752</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tokenizer mode. &#39;auto&#39; will use the fast &quot;</span>
</span><span id="ServerArgs-753"><a href="#ServerArgs-753"><span class="linenos"> 753</span></a>            <span class="s2">&quot;tokenizer if available, and &#39;slow&#39; will &quot;</span>
</span><span id="ServerArgs-754"><a href="#ServerArgs-754"><span class="linenos"> 754</span></a>            <span class="s2">&quot;always use the slow tokenizer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-755"><a href="#ServerArgs-755"><span class="linenos"> 755</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-756"><a href="#ServerArgs-756"><span class="linenos"> 756</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-757"><a href="#ServerArgs-757"><span class="linenos"> 757</span></a>            <span class="s2">&quot;--skip-tokenizer-init&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-758"><a href="#ServerArgs-758"><span class="linenos"> 758</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-759"><a href="#ServerArgs-759"><span class="linenos"> 759</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, skip init tokenizer and pass input_ids in generate request.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-760"><a href="#ServerArgs-760"><span class="linenos"> 760</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-761"><a href="#ServerArgs-761"><span class="linenos"> 761</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-762"><a href="#ServerArgs-762"><span class="linenos"> 762</span></a>            <span class="s2">&quot;--load-format&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-763"><a href="#ServerArgs-763"><span class="linenos"> 763</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-764"><a href="#ServerArgs-764"><span class="linenos"> 764</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">load_format</span><span class="p">,</span>
</span><span id="ServerArgs-765"><a href="#ServerArgs-765"><span class="linenos"> 765</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="ServerArgs-766"><a href="#ServerArgs-766"><span class="linenos"> 766</span></a>                <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-767"><a href="#ServerArgs-767"><span class="linenos"> 767</span></a>                <span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-768"><a href="#ServerArgs-768"><span class="linenos"> 768</span></a>                <span class="s2">&quot;safetensors&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-769"><a href="#ServerArgs-769"><span class="linenos"> 769</span></a>                <span class="s2">&quot;npcache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-770"><a href="#ServerArgs-770"><span class="linenos"> 770</span></a>                <span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-771"><a href="#ServerArgs-771"><span class="linenos"> 771</span></a>                <span class="s2">&quot;sharded_state&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-772"><a href="#ServerArgs-772"><span class="linenos"> 772</span></a>                <span class="s2">&quot;gguf&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-773"><a href="#ServerArgs-773"><span class="linenos"> 773</span></a>                <span class="s2">&quot;bitsandbytes&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-774"><a href="#ServerArgs-774"><span class="linenos"> 774</span></a>                <span class="s2">&quot;layered&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-775"><a href="#ServerArgs-775"><span class="linenos"> 775</span></a>                <span class="s2">&quot;remote&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-776"><a href="#ServerArgs-776"><span class="linenos"> 776</span></a>            <span class="p">],</span>
</span><span id="ServerArgs-777"><a href="#ServerArgs-777"><span class="linenos"> 777</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The format of the model weights to load. &quot;</span>
</span><span id="ServerArgs-778"><a href="#ServerArgs-778"><span class="linenos"> 778</span></a>            <span class="s1">&#39;&quot;auto&quot; will try to load the weights in the safetensors format &#39;</span>
</span><span id="ServerArgs-779"><a href="#ServerArgs-779"><span class="linenos"> 779</span></a>            <span class="s2">&quot;and fall back to the pytorch bin format if safetensors format &quot;</span>
</span><span id="ServerArgs-780"><a href="#ServerArgs-780"><span class="linenos"> 780</span></a>            <span class="s2">&quot;is not available. &quot;</span>
</span><span id="ServerArgs-781"><a href="#ServerArgs-781"><span class="linenos"> 781</span></a>            <span class="s1">&#39;&quot;pt&quot; will load the weights in the pytorch bin format. &#39;</span>
</span><span id="ServerArgs-782"><a href="#ServerArgs-782"><span class="linenos"> 782</span></a>            <span class="s1">&#39;&quot;safetensors&quot; will load the weights in the safetensors format. &#39;</span>
</span><span id="ServerArgs-783"><a href="#ServerArgs-783"><span class="linenos"> 783</span></a>            <span class="s1">&#39;&quot;npcache&quot; will load the weights in pytorch format and store &#39;</span>
</span><span id="ServerArgs-784"><a href="#ServerArgs-784"><span class="linenos"> 784</span></a>            <span class="s2">&quot;a numpy cache to speed up the loading. &quot;</span>
</span><span id="ServerArgs-785"><a href="#ServerArgs-785"><span class="linenos"> 785</span></a>            <span class="s1">&#39;&quot;dummy&quot; will initialize the weights with random values, &#39;</span>
</span><span id="ServerArgs-786"><a href="#ServerArgs-786"><span class="linenos"> 786</span></a>            <span class="s2">&quot;which is mainly for profiling.&quot;</span>
</span><span id="ServerArgs-787"><a href="#ServerArgs-787"><span class="linenos"> 787</span></a>            <span class="s1">&#39;&quot;gguf&quot; will load the weights in the gguf format. &#39;</span>
</span><span id="ServerArgs-788"><a href="#ServerArgs-788"><span class="linenos"> 788</span></a>            <span class="s1">&#39;&quot;bitsandbytes&quot; will load the weights using bitsandbytes &#39;</span>
</span><span id="ServerArgs-789"><a href="#ServerArgs-789"><span class="linenos"> 789</span></a>            <span class="s2">&quot;quantization.&quot;</span>
</span><span id="ServerArgs-790"><a href="#ServerArgs-790"><span class="linenos"> 790</span></a>            <span class="s1">&#39;&quot;layered&quot; loads weights layer by layer so that one can quantize a &#39;</span>
</span><span id="ServerArgs-791"><a href="#ServerArgs-791"><span class="linenos"> 791</span></a>            <span class="s2">&quot;layer before loading another to make the peak memory envelope &quot;</span>
</span><span id="ServerArgs-792"><a href="#ServerArgs-792"><span class="linenos"> 792</span></a>            <span class="s2">&quot;smaller.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-793"><a href="#ServerArgs-793"><span class="linenos"> 793</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-794"><a href="#ServerArgs-794"><span class="linenos"> 794</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-795"><a href="#ServerArgs-795"><span class="linenos"> 795</span></a>            <span class="s2">&quot;--model-loader-extra-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-796"><a href="#ServerArgs-796"><span class="linenos"> 796</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-797"><a href="#ServerArgs-797"><span class="linenos"> 797</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Extra config for model loader. &quot;</span>
</span><span id="ServerArgs-798"><a href="#ServerArgs-798"><span class="linenos"> 798</span></a>            <span class="s2">&quot;This will be passed to the model loader corresponding to the chosen load_format.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-799"><a href="#ServerArgs-799"><span class="linenos"> 799</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">model_loader_extra_config</span><span class="p">,</span>
</span><span id="ServerArgs-800"><a href="#ServerArgs-800"><span class="linenos"> 800</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-801"><a href="#ServerArgs-801"><span class="linenos"> 801</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-802"><a href="#ServerArgs-802"><span class="linenos"> 802</span></a>            <span class="s2">&quot;--trust-remote-code&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-803"><a href="#ServerArgs-803"><span class="linenos"> 803</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-804"><a href="#ServerArgs-804"><span class="linenos"> 804</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether or not to allow for custom models defined on the Hub in their own modeling files.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-805"><a href="#ServerArgs-805"><span class="linenos"> 805</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-806"><a href="#ServerArgs-806"><span class="linenos"> 806</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-807"><a href="#ServerArgs-807"><span class="linenos"> 807</span></a>            <span class="s2">&quot;--context-length&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-808"><a href="#ServerArgs-808"><span class="linenos"> 808</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-809"><a href="#ServerArgs-809"><span class="linenos"> 809</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">context_length</span><span class="p">,</span>
</span><span id="ServerArgs-810"><a href="#ServerArgs-810"><span class="linenos"> 810</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The model&#39;s maximum context length. Defaults to None (will use the value from the model&#39;s config.json instead).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-811"><a href="#ServerArgs-811"><span class="linenos"> 811</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-812"><a href="#ServerArgs-812"><span class="linenos"> 812</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-813"><a href="#ServerArgs-813"><span class="linenos"> 813</span></a>            <span class="s2">&quot;--is-embedding&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-814"><a href="#ServerArgs-814"><span class="linenos"> 814</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-815"><a href="#ServerArgs-815"><span class="linenos"> 815</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use a CausalLM as an embedding model.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-816"><a href="#ServerArgs-816"><span class="linenos"> 816</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-817"><a href="#ServerArgs-817"><span class="linenos"> 817</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-818"><a href="#ServerArgs-818"><span class="linenos"> 818</span></a>            <span class="s2">&quot;--enable-multimodal&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-819"><a href="#ServerArgs-819"><span class="linenos"> 819</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_multimodal</span><span class="p">,</span>
</span><span id="ServerArgs-820"><a href="#ServerArgs-820"><span class="linenos"> 820</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-821"><a href="#ServerArgs-821"><span class="linenos"> 821</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable the multimodal functionality for the served model. If the model being served is not multimodal, nothing will happen&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-822"><a href="#ServerArgs-822"><span class="linenos"> 822</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-823"><a href="#ServerArgs-823"><span class="linenos"> 823</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-824"><a href="#ServerArgs-824"><span class="linenos"> 824</span></a>            <span class="s2">&quot;--revision&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-825"><a href="#ServerArgs-825"><span class="linenos"> 825</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-826"><a href="#ServerArgs-826"><span class="linenos"> 826</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-827"><a href="#ServerArgs-827"><span class="linenos"> 827</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The specific model version to use. It can be a branch &quot;</span>
</span><span id="ServerArgs-828"><a href="#ServerArgs-828"><span class="linenos"> 828</span></a>            <span class="s2">&quot;name, a tag name, or a commit id. If unspecified, will use &quot;</span>
</span><span id="ServerArgs-829"><a href="#ServerArgs-829"><span class="linenos"> 829</span></a>            <span class="s2">&quot;the default version.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-830"><a href="#ServerArgs-830"><span class="linenos"> 830</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-831"><a href="#ServerArgs-831"><span class="linenos"> 831</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-832"><a href="#ServerArgs-832"><span class="linenos"> 832</span></a>            <span class="s2">&quot;--model-impl&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-833"><a href="#ServerArgs-833"><span class="linenos"> 833</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-834"><a href="#ServerArgs-834"><span class="linenos"> 834</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">model_impl</span><span class="p">,</span>
</span><span id="ServerArgs-835"><a href="#ServerArgs-835"><span class="linenos"> 835</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which implementation of the model to use.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-836"><a href="#ServerArgs-836"><span class="linenos"> 836</span></a>            <span class="s1">&#39;* &quot;auto&quot; will try to use the SGLang implementation if it exists &#39;</span>
</span><span id="ServerArgs-837"><a href="#ServerArgs-837"><span class="linenos"> 837</span></a>            <span class="s2">&quot;and fall back to the Transformers implementation if no SGLang &quot;</span>
</span><span id="ServerArgs-838"><a href="#ServerArgs-838"><span class="linenos"> 838</span></a>            <span class="s2">&quot;implementation is available.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-839"><a href="#ServerArgs-839"><span class="linenos"> 839</span></a>            <span class="s1">&#39;* &quot;sglang&quot; will use the SGLang model implementation.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs-840"><a href="#ServerArgs-840"><span class="linenos"> 840</span></a>            <span class="s1">&#39;* &quot;transformers&quot; will use the Transformers model &#39;</span>
</span><span id="ServerArgs-841"><a href="#ServerArgs-841"><span class="linenos"> 841</span></a>            <span class="s2">&quot;implementation.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-842"><a href="#ServerArgs-842"><span class="linenos"> 842</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-843"><a href="#ServerArgs-843"><span class="linenos"> 843</span></a>
</span><span id="ServerArgs-844"><a href="#ServerArgs-844"><span class="linenos"> 844</span></a>        <span class="c1"># HTTP server</span>
</span><span id="ServerArgs-845"><a href="#ServerArgs-845"><span class="linenos"> 845</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-846"><a href="#ServerArgs-846"><span class="linenos"> 846</span></a>            <span class="s2">&quot;--host&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-847"><a href="#ServerArgs-847"><span class="linenos"> 847</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-848"><a href="#ServerArgs-848"><span class="linenos"> 848</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span id="ServerArgs-849"><a href="#ServerArgs-849"><span class="linenos"> 849</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The host of the HTTP server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-850"><a href="#ServerArgs-850"><span class="linenos"> 850</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-851"><a href="#ServerArgs-851"><span class="linenos"> 851</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-852"><a href="#ServerArgs-852"><span class="linenos"> 852</span></a>            <span class="s2">&quot;--port&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-853"><a href="#ServerArgs-853"><span class="linenos"> 853</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-854"><a href="#ServerArgs-854"><span class="linenos"> 854</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
</span><span id="ServerArgs-855"><a href="#ServerArgs-855"><span class="linenos"> 855</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The port of the HTTP server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-856"><a href="#ServerArgs-856"><span class="linenos"> 856</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-857"><a href="#ServerArgs-857"><span class="linenos"> 857</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-858"><a href="#ServerArgs-858"><span class="linenos"> 858</span></a>            <span class="s2">&quot;--skip-server-warmup&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-859"><a href="#ServerArgs-859"><span class="linenos"> 859</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-860"><a href="#ServerArgs-860"><span class="linenos"> 860</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, skip warmup.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-861"><a href="#ServerArgs-861"><span class="linenos"> 861</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-862"><a href="#ServerArgs-862"><span class="linenos"> 862</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-863"><a href="#ServerArgs-863"><span class="linenos"> 863</span></a>            <span class="s2">&quot;--warmups&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-864"><a href="#ServerArgs-864"><span class="linenos"> 864</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-865"><a href="#ServerArgs-865"><span class="linenos"> 865</span></a>            <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ServerArgs-866"><a href="#ServerArgs-866"><span class="linenos"> 866</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify custom warmup functions (csv) to run before server starts eg. --warmups=warmup_name1,warmup_name2 &quot;</span>
</span><span id="ServerArgs-867"><a href="#ServerArgs-867"><span class="linenos"> 867</span></a>            <span class="s2">&quot;will run the functions `warmup_name1` and `warmup_name2` specified in warmup.py before the server starts listening for requests&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-868"><a href="#ServerArgs-868"><span class="linenos"> 868</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-869"><a href="#ServerArgs-869"><span class="linenos"> 869</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-870"><a href="#ServerArgs-870"><span class="linenos"> 870</span></a>            <span class="s2">&quot;--nccl-port&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-871"><a href="#ServerArgs-871"><span class="linenos"> 871</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-872"><a href="#ServerArgs-872"><span class="linenos"> 872</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="ServerArgs-873"><a href="#ServerArgs-873"><span class="linenos"> 873</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The port for NCCL distributed environment setup. Defaults to a random port.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-874"><a href="#ServerArgs-874"><span class="linenos"> 874</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-875"><a href="#ServerArgs-875"><span class="linenos"> 875</span></a>
</span><span id="ServerArgs-876"><a href="#ServerArgs-876"><span class="linenos"> 876</span></a>        <span class="c1"># Quantization and data type</span>
</span><span id="ServerArgs-877"><a href="#ServerArgs-877"><span class="linenos"> 877</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-878"><a href="#ServerArgs-878"><span class="linenos"> 878</span></a>            <span class="s2">&quot;--dtype&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-879"><a href="#ServerArgs-879"><span class="linenos"> 879</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-880"><a href="#ServerArgs-880"><span class="linenos"> 880</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="ServerArgs-881"><a href="#ServerArgs-881"><span class="linenos"> 881</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;half&quot;</span><span class="p">,</span> <span class="s2">&quot;float16&quot;</span><span class="p">,</span> <span class="s2">&quot;bfloat16&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-882"><a href="#ServerArgs-882"><span class="linenos"> 882</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Data type for model weights and activations.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-883"><a href="#ServerArgs-883"><span class="linenos"> 883</span></a>            <span class="s1">&#39;* &quot;auto&quot; will use FP16 precision for FP32 and FP16 models, and &#39;</span>
</span><span id="ServerArgs-884"><a href="#ServerArgs-884"><span class="linenos"> 884</span></a>            <span class="s2">&quot;BF16 precision for BF16 models.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-885"><a href="#ServerArgs-885"><span class="linenos"> 885</span></a>            <span class="s1">&#39;* &quot;half&quot; for FP16. Recommended for AWQ quantization.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs-886"><a href="#ServerArgs-886"><span class="linenos"> 886</span></a>            <span class="s1">&#39;* &quot;float16&quot; is the same as &quot;half&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs-887"><a href="#ServerArgs-887"><span class="linenos"> 887</span></a>            <span class="s1">&#39;* &quot;bfloat16&quot; for a balance between precision and range.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs-888"><a href="#ServerArgs-888"><span class="linenos"> 888</span></a>            <span class="s1">&#39;* &quot;float&quot; is shorthand for FP32 precision.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs-889"><a href="#ServerArgs-889"><span class="linenos"> 889</span></a>            <span class="s1">&#39;* &quot;float32&quot; for FP32 precision.&#39;</span><span class="p">,</span>
</span><span id="ServerArgs-890"><a href="#ServerArgs-890"><span class="linenos"> 890</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-891"><a href="#ServerArgs-891"><span class="linenos"> 891</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-892"><a href="#ServerArgs-892"><span class="linenos"> 892</span></a>            <span class="s2">&quot;--quantization&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-893"><a href="#ServerArgs-893"><span class="linenos"> 893</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-894"><a href="#ServerArgs-894"><span class="linenos"> 894</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">quantization</span><span class="p">,</span>
</span><span id="ServerArgs-895"><a href="#ServerArgs-895"><span class="linenos"> 895</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="ServerArgs-896"><a href="#ServerArgs-896"><span class="linenos"> 896</span></a>                <span class="s2">&quot;awq&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-897"><a href="#ServerArgs-897"><span class="linenos"> 897</span></a>                <span class="s2">&quot;fp8&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-898"><a href="#ServerArgs-898"><span class="linenos"> 898</span></a>                <span class="s2">&quot;gptq&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-899"><a href="#ServerArgs-899"><span class="linenos"> 899</span></a>                <span class="s2">&quot;marlin&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-900"><a href="#ServerArgs-900"><span class="linenos"> 900</span></a>                <span class="s2">&quot;gptq_marlin&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-901"><a href="#ServerArgs-901"><span class="linenos"> 901</span></a>                <span class="s2">&quot;awq_marlin&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-902"><a href="#ServerArgs-902"><span class="linenos"> 902</span></a>                <span class="s2">&quot;bitsandbytes&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-903"><a href="#ServerArgs-903"><span class="linenos"> 903</span></a>                <span class="s2">&quot;gguf&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-904"><a href="#ServerArgs-904"><span class="linenos"> 904</span></a>                <span class="s2">&quot;modelopt&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-905"><a href="#ServerArgs-905"><span class="linenos"> 905</span></a>                <span class="s2">&quot;modelopt_fp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-906"><a href="#ServerArgs-906"><span class="linenos"> 906</span></a>                <span class="s2">&quot;petit_nvfp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-907"><a href="#ServerArgs-907"><span class="linenos"> 907</span></a>                <span class="s2">&quot;w8a8_int8&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-908"><a href="#ServerArgs-908"><span class="linenos"> 908</span></a>                <span class="s2">&quot;w8a8_fp8&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-909"><a href="#ServerArgs-909"><span class="linenos"> 909</span></a>                <span class="s2">&quot;moe_wna16&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-910"><a href="#ServerArgs-910"><span class="linenos"> 910</span></a>                <span class="s2">&quot;qoq&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-911"><a href="#ServerArgs-911"><span class="linenos"> 911</span></a>                <span class="s2">&quot;w4afp8&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-912"><a href="#ServerArgs-912"><span class="linenos"> 912</span></a>                <span class="s2">&quot;mxfp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-913"><a href="#ServerArgs-913"><span class="linenos"> 913</span></a>            <span class="p">],</span>
</span><span id="ServerArgs-914"><a href="#ServerArgs-914"><span class="linenos"> 914</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The quantization method.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-915"><a href="#ServerArgs-915"><span class="linenos"> 915</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-916"><a href="#ServerArgs-916"><span class="linenos"> 916</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-917"><a href="#ServerArgs-917"><span class="linenos"> 917</span></a>            <span class="s2">&quot;--quantization-param-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-918"><a href="#ServerArgs-918"><span class="linenos"> 918</span></a>            <span class="nb">type</span><span class="o">=</span><span class="n">nullable_str</span><span class="p">,</span>
</span><span id="ServerArgs-919"><a href="#ServerArgs-919"><span class="linenos"> 919</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-920"><a href="#ServerArgs-920"><span class="linenos"> 920</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the JSON file containing the KV cache &quot;</span>
</span><span id="ServerArgs-921"><a href="#ServerArgs-921"><span class="linenos"> 921</span></a>            <span class="s2">&quot;scaling factors. This should generally be supplied, when &quot;</span>
</span><span id="ServerArgs-922"><a href="#ServerArgs-922"><span class="linenos"> 922</span></a>            <span class="s2">&quot;KV cache dtype is FP8. Otherwise, KV cache scaling factors &quot;</span>
</span><span id="ServerArgs-923"><a href="#ServerArgs-923"><span class="linenos"> 923</span></a>            <span class="s2">&quot;default to 1.0, which may cause accuracy issues. &quot;</span><span class="p">,</span>
</span><span id="ServerArgs-924"><a href="#ServerArgs-924"><span class="linenos"> 924</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-925"><a href="#ServerArgs-925"><span class="linenos"> 925</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-926"><a href="#ServerArgs-926"><span class="linenos"> 926</span></a>            <span class="s2">&quot;--kv-cache-dtype&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-927"><a href="#ServerArgs-927"><span class="linenos"> 927</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-928"><a href="#ServerArgs-928"><span class="linenos"> 928</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">kv_cache_dtype</span><span class="p">,</span>
</span><span id="ServerArgs-929"><a href="#ServerArgs-929"><span class="linenos"> 929</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;fp8_e5m2&quot;</span><span class="p">,</span> <span class="s2">&quot;fp8_e4m3&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-930"><a href="#ServerArgs-930"><span class="linenos"> 930</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data type for kv cache storage. &quot;auto&quot; will use model data type. &quot;fp8_e5m2&quot; and &quot;fp8_e4m3&quot; is supported for CUDA 11.8+.&#39;</span><span class="p">,</span>
</span><span id="ServerArgs-931"><a href="#ServerArgs-931"><span class="linenos"> 931</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-932"><a href="#ServerArgs-932"><span class="linenos"> 932</span></a>
</span><span id="ServerArgs-933"><a href="#ServerArgs-933"><span class="linenos"> 933</span></a>        <span class="c1"># Memory and scheduling</span>
</span><span id="ServerArgs-934"><a href="#ServerArgs-934"><span class="linenos"> 934</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-935"><a href="#ServerArgs-935"><span class="linenos"> 935</span></a>            <span class="s2">&quot;--mem-fraction-static&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-936"><a href="#ServerArgs-936"><span class="linenos"> 936</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-937"><a href="#ServerArgs-937"><span class="linenos"> 937</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">mem_fraction_static</span><span class="p">,</span>
</span><span id="ServerArgs-938"><a href="#ServerArgs-938"><span class="linenos"> 938</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The fraction of the memory used for static allocation (model weights and KV cache memory pool). Use a smaller value if you see out-of-memory errors.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-939"><a href="#ServerArgs-939"><span class="linenos"> 939</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-940"><a href="#ServerArgs-940"><span class="linenos"> 940</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-941"><a href="#ServerArgs-941"><span class="linenos"> 941</span></a>            <span class="s2">&quot;--max-running-requests&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-942"><a href="#ServerArgs-942"><span class="linenos"> 942</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-943"><a href="#ServerArgs-943"><span class="linenos"> 943</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_running_requests</span><span class="p">,</span>
</span><span id="ServerArgs-944"><a href="#ServerArgs-944"><span class="linenos"> 944</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of running requests.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-945"><a href="#ServerArgs-945"><span class="linenos"> 945</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-946"><a href="#ServerArgs-946"><span class="linenos"> 946</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-947"><a href="#ServerArgs-947"><span class="linenos"> 947</span></a>            <span class="s2">&quot;--max-queued-requests&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-948"><a href="#ServerArgs-948"><span class="linenos"> 948</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-949"><a href="#ServerArgs-949"><span class="linenos"> 949</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_queued_requests</span><span class="p">,</span>
</span><span id="ServerArgs-950"><a href="#ServerArgs-950"><span class="linenos"> 950</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of queued requests. This option is ignored when using disaggregation-mode.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-951"><a href="#ServerArgs-951"><span class="linenos"> 951</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-952"><a href="#ServerArgs-952"><span class="linenos"> 952</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-953"><a href="#ServerArgs-953"><span class="linenos"> 953</span></a>            <span class="s2">&quot;--max-total-tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-954"><a href="#ServerArgs-954"><span class="linenos"> 954</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-955"><a href="#ServerArgs-955"><span class="linenos"> 955</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_total_tokens</span><span class="p">,</span>
</span><span id="ServerArgs-956"><a href="#ServerArgs-956"><span class="linenos"> 956</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in the memory pool. If not specified, it will be automatically calculated based on the memory usage fraction. &quot;</span>
</span><span id="ServerArgs-957"><a href="#ServerArgs-957"><span class="linenos"> 957</span></a>            <span class="s2">&quot;This option is typically used for development and debugging purposes.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-958"><a href="#ServerArgs-958"><span class="linenos"> 958</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-959"><a href="#ServerArgs-959"><span class="linenos"> 959</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-960"><a href="#ServerArgs-960"><span class="linenos"> 960</span></a>            <span class="s2">&quot;--chunked-prefill-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-961"><a href="#ServerArgs-961"><span class="linenos"> 961</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-962"><a href="#ServerArgs-962"><span class="linenos"> 962</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">chunked_prefill_size</span><span class="p">,</span>
</span><span id="ServerArgs-963"><a href="#ServerArgs-963"><span class="linenos"> 963</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in a chunk for the chunked prefill. Setting this to -1 means disabling chunked prefill.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-964"><a href="#ServerArgs-964"><span class="linenos"> 964</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-965"><a href="#ServerArgs-965"><span class="linenos"> 965</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-966"><a href="#ServerArgs-966"><span class="linenos"> 966</span></a>            <span class="s2">&quot;--max-prefill-tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-967"><a href="#ServerArgs-967"><span class="linenos"> 967</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-968"><a href="#ServerArgs-968"><span class="linenos"> 968</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_prefill_tokens</span><span class="p">,</span>
</span><span id="ServerArgs-969"><a href="#ServerArgs-969"><span class="linenos"> 969</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in a prefill batch. The real bound will be the maximum of this value and the model&#39;s maximum context length.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-970"><a href="#ServerArgs-970"><span class="linenos"> 970</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-971"><a href="#ServerArgs-971"><span class="linenos"> 971</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-972"><a href="#ServerArgs-972"><span class="linenos"> 972</span></a>            <span class="s2">&quot;--schedule-policy&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-973"><a href="#ServerArgs-973"><span class="linenos"> 973</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-974"><a href="#ServerArgs-974"><span class="linenos"> 974</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">schedule_policy</span><span class="p">,</span>
</span><span id="ServerArgs-975"><a href="#ServerArgs-975"><span class="linenos"> 975</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lpm&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;fcfs&quot;</span><span class="p">,</span> <span class="s2">&quot;dfs-weight&quot;</span><span class="p">,</span> <span class="s2">&quot;lof&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-976"><a href="#ServerArgs-976"><span class="linenos"> 976</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The scheduling policy of the requests.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-977"><a href="#ServerArgs-977"><span class="linenos"> 977</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-978"><a href="#ServerArgs-978"><span class="linenos"> 978</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-979"><a href="#ServerArgs-979"><span class="linenos"> 979</span></a>            <span class="s2">&quot;--schedule-conservativeness&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-980"><a href="#ServerArgs-980"><span class="linenos"> 980</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-981"><a href="#ServerArgs-981"><span class="linenos"> 981</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">schedule_conservativeness</span><span class="p">,</span>
</span><span id="ServerArgs-982"><a href="#ServerArgs-982"><span class="linenos"> 982</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How conservative the schedule policy is. A larger value means more conservative scheduling. Use a larger value if you see requests being retracted frequently.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-983"><a href="#ServerArgs-983"><span class="linenos"> 983</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-984"><a href="#ServerArgs-984"><span class="linenos"> 984</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-985"><a href="#ServerArgs-985"><span class="linenos"> 985</span></a>            <span class="s2">&quot;--page-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-986"><a href="#ServerArgs-986"><span class="linenos"> 986</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-987"><a href="#ServerArgs-987"><span class="linenos"> 987</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">page_size</span><span class="p">,</span>
</span><span id="ServerArgs-988"><a href="#ServerArgs-988"><span class="linenos"> 988</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens in a page.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-989"><a href="#ServerArgs-989"><span class="linenos"> 989</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-990"><a href="#ServerArgs-990"><span class="linenos"> 990</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-991"><a href="#ServerArgs-991"><span class="linenos"> 991</span></a>            <span class="s2">&quot;--hybrid-kvcache-ratio&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-992"><a href="#ServerArgs-992"><span class="linenos"> 992</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-993"><a href="#ServerArgs-993"><span class="linenos"> 993</span></a>            <span class="n">const</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="ServerArgs-994"><a href="#ServerArgs-994"><span class="linenos"> 994</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-995"><a href="#ServerArgs-995"><span class="linenos"> 995</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hybrid_kvcache_ratio</span><span class="p">,</span>
</span><span id="ServerArgs-996"><a href="#ServerArgs-996"><span class="linenos"> 996</span></a>            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
</span><span id="ServerArgs-997"><a href="#ServerArgs-997"><span class="linenos"> 997</span></a>                <span class="s2">&quot;Mix ratio in [0,1] between uniform and hybrid kv buffers &quot;</span>
</span><span id="ServerArgs-998"><a href="#ServerArgs-998"><span class="linenos"> 998</span></a>                <span class="s2">&quot;(0.0 = pure uniform: swa_size / full_size = 1)&quot;</span>
</span><span id="ServerArgs-999"><a href="#ServerArgs-999"><span class="linenos"> 999</span></a>                <span class="s2">&quot;(1.0 = pure hybrid: swa_size / full_size = local_attention_size / context_length)&quot;</span>
</span><span id="ServerArgs-1000"><a href="#ServerArgs-1000"><span class="linenos">1000</span></a>            <span class="p">),</span>
</span><span id="ServerArgs-1001"><a href="#ServerArgs-1001"><span class="linenos">1001</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1002"><a href="#ServerArgs-1002"><span class="linenos">1002</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1003"><a href="#ServerArgs-1003"><span class="linenos">1003</span></a>            <span class="s2">&quot;--swa-full-tokens-ratio&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1004"><a href="#ServerArgs-1004"><span class="linenos">1004</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1005"><a href="#ServerArgs-1005"><span class="linenos">1005</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">swa_full_tokens_ratio</span><span class="p">,</span>
</span><span id="ServerArgs-1006"><a href="#ServerArgs-1006"><span class="linenos">1006</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The ratio of SWA layer KV tokens / full layer KV tokens, regardless of the number of swa:full layers. It should be between 0 and 1. &quot;</span>
</span><span id="ServerArgs-1007"><a href="#ServerArgs-1007"><span class="linenos">1007</span></a>            <span class="s2">&quot;E.g. 0.5 means if each swa layer has 50 tokens, then each full layer has 100 tokens.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1008"><a href="#ServerArgs-1008"><span class="linenos">1008</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1009"><a href="#ServerArgs-1009"><span class="linenos">1009</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1010"><a href="#ServerArgs-1010"><span class="linenos">1010</span></a>            <span class="s2">&quot;--disable-hybrid-swa-memory&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1011"><a href="#ServerArgs-1011"><span class="linenos">1011</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1012"><a href="#ServerArgs-1012"><span class="linenos">1012</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the hybrid SWA memory.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1013"><a href="#ServerArgs-1013"><span class="linenos">1013</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1014"><a href="#ServerArgs-1014"><span class="linenos">1014</span></a>
</span><span id="ServerArgs-1015"><a href="#ServerArgs-1015"><span class="linenos">1015</span></a>        <span class="c1"># Runtime options</span>
</span><span id="ServerArgs-1016"><a href="#ServerArgs-1016"><span class="linenos">1016</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1017"><a href="#ServerArgs-1017"><span class="linenos">1017</span></a>            <span class="s2">&quot;--device&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1018"><a href="#ServerArgs-1018"><span class="linenos">1018</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1019"><a href="#ServerArgs-1019"><span class="linenos">1019</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="ServerArgs-1020"><a href="#ServerArgs-1020"><span class="linenos">1020</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The device to use (&#39;cuda&#39;, &#39;xpu&#39;, &#39;hpu&#39;, &#39;npu&#39;, &#39;cpu&#39;). Defaults to auto-detection if not specified.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1021"><a href="#ServerArgs-1021"><span class="linenos">1021</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1022"><a href="#ServerArgs-1022"><span class="linenos">1022</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1023"><a href="#ServerArgs-1023"><span class="linenos">1023</span></a>            <span class="s2">&quot;--tensor-parallel-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1024"><a href="#ServerArgs-1024"><span class="linenos">1024</span></a>            <span class="s2">&quot;--tp-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1025"><a href="#ServerArgs-1025"><span class="linenos">1025</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1026"><a href="#ServerArgs-1026"><span class="linenos">1026</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tp_size</span><span class="p">,</span>
</span><span id="ServerArgs-1027"><a href="#ServerArgs-1027"><span class="linenos">1027</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The tensor parallelism size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1028"><a href="#ServerArgs-1028"><span class="linenos">1028</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1029"><a href="#ServerArgs-1029"><span class="linenos">1029</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1030"><a href="#ServerArgs-1030"><span class="linenos">1030</span></a>            <span class="s2">&quot;--pipeline-parallel-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1031"><a href="#ServerArgs-1031"><span class="linenos">1031</span></a>            <span class="s2">&quot;--pp-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1032"><a href="#ServerArgs-1032"><span class="linenos">1032</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1033"><a href="#ServerArgs-1033"><span class="linenos">1033</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">pp_size</span><span class="p">,</span>
</span><span id="ServerArgs-1034"><a href="#ServerArgs-1034"><span class="linenos">1034</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The pipeline parallelism size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1035"><a href="#ServerArgs-1035"><span class="linenos">1035</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1036"><a href="#ServerArgs-1036"><span class="linenos">1036</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1037"><a href="#ServerArgs-1037"><span class="linenos">1037</span></a>            <span class="s2">&quot;--max-micro-batch-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1038"><a href="#ServerArgs-1038"><span class="linenos">1038</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1039"><a href="#ServerArgs-1039"><span class="linenos">1039</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_micro_batch_size</span><span class="p">,</span>
</span><span id="ServerArgs-1040"><a href="#ServerArgs-1040"><span class="linenos">1040</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum micro batch size in pipeline parallelism.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1041"><a href="#ServerArgs-1041"><span class="linenos">1041</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1042"><a href="#ServerArgs-1042"><span class="linenos">1042</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1043"><a href="#ServerArgs-1043"><span class="linenos">1043</span></a>            <span class="s2">&quot;--stream-interval&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1044"><a href="#ServerArgs-1044"><span class="linenos">1044</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1045"><a href="#ServerArgs-1045"><span class="linenos">1045</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">stream_interval</span><span class="p">,</span>
</span><span id="ServerArgs-1046"><a href="#ServerArgs-1046"><span class="linenos">1046</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The interval (or buffer size) for streaming in terms of the token length. A smaller value makes streaming smoother, while a larger value makes the throughput higher&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1047"><a href="#ServerArgs-1047"><span class="linenos">1047</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1048"><a href="#ServerArgs-1048"><span class="linenos">1048</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1049"><a href="#ServerArgs-1049"><span class="linenos">1049</span></a>            <span class="s2">&quot;--stream-output&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1050"><a href="#ServerArgs-1050"><span class="linenos">1050</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1051"><a href="#ServerArgs-1051"><span class="linenos">1051</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to output as a sequence of disjoint segments.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1052"><a href="#ServerArgs-1052"><span class="linenos">1052</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1053"><a href="#ServerArgs-1053"><span class="linenos">1053</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1054"><a href="#ServerArgs-1054"><span class="linenos">1054</span></a>            <span class="s2">&quot;--random-seed&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1055"><a href="#ServerArgs-1055"><span class="linenos">1055</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1056"><a href="#ServerArgs-1056"><span class="linenos">1056</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
</span><span id="ServerArgs-1057"><a href="#ServerArgs-1057"><span class="linenos">1057</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The random seed.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1058"><a href="#ServerArgs-1058"><span class="linenos">1058</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1059"><a href="#ServerArgs-1059"><span class="linenos">1059</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1060"><a href="#ServerArgs-1060"><span class="linenos">1060</span></a>            <span class="s2">&quot;--constrained-json-whitespace-pattern&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1061"><a href="#ServerArgs-1061"><span class="linenos">1061</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1062"><a href="#ServerArgs-1062"><span class="linenos">1062</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">constrained_json_whitespace_pattern</span><span class="p">,</span>
</span><span id="ServerArgs-1063"><a href="#ServerArgs-1063"><span class="linenos">1063</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(outlines backend only) Regex pattern for syntactic whitespaces allowed in JSON constrained output. For example, to allow the model generate consecutive whitespaces, set the pattern to [</span><span class="se">\n\t</span><span class="s2"> ]*&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1064"><a href="#ServerArgs-1064"><span class="linenos">1064</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1065"><a href="#ServerArgs-1065"><span class="linenos">1065</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1066"><a href="#ServerArgs-1066"><span class="linenos">1066</span></a>            <span class="s2">&quot;--watchdog-timeout&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1067"><a href="#ServerArgs-1067"><span class="linenos">1067</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1068"><a href="#ServerArgs-1068"><span class="linenos">1068</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">watchdog_timeout</span><span class="p">,</span>
</span><span id="ServerArgs-1069"><a href="#ServerArgs-1069"><span class="linenos">1069</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set watchdog timeout in seconds. If a forward batch takes longer than this, the server will crash to prevent hanging.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1070"><a href="#ServerArgs-1070"><span class="linenos">1070</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1071"><a href="#ServerArgs-1071"><span class="linenos">1071</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1072"><a href="#ServerArgs-1072"><span class="linenos">1072</span></a>            <span class="s2">&quot;--dist-timeout&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1073"><a href="#ServerArgs-1073"><span class="linenos">1073</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1074"><a href="#ServerArgs-1074"><span class="linenos">1074</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dist_timeout</span><span class="p">,</span>
</span><span id="ServerArgs-1075"><a href="#ServerArgs-1075"><span class="linenos">1075</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set timeout for torch.distributed initialization.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1076"><a href="#ServerArgs-1076"><span class="linenos">1076</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1077"><a href="#ServerArgs-1077"><span class="linenos">1077</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1078"><a href="#ServerArgs-1078"><span class="linenos">1078</span></a>            <span class="s2">&quot;--download-dir&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1079"><a href="#ServerArgs-1079"><span class="linenos">1079</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1080"><a href="#ServerArgs-1080"><span class="linenos">1080</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">download_dir</span><span class="p">,</span>
</span><span id="ServerArgs-1081"><a href="#ServerArgs-1081"><span class="linenos">1081</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model download directory for huggingface.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1082"><a href="#ServerArgs-1082"><span class="linenos">1082</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1083"><a href="#ServerArgs-1083"><span class="linenos">1083</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1084"><a href="#ServerArgs-1084"><span class="linenos">1084</span></a>            <span class="s2">&quot;--base-gpu-id&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1085"><a href="#ServerArgs-1085"><span class="linenos">1085</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1086"><a href="#ServerArgs-1086"><span class="linenos">1086</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">base_gpu_id</span><span class="p">,</span>
</span><span id="ServerArgs-1087"><a href="#ServerArgs-1087"><span class="linenos">1087</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The base GPU ID to start allocating GPUs from. Useful when running multiple instances on the same machine.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1088"><a href="#ServerArgs-1088"><span class="linenos">1088</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1089"><a href="#ServerArgs-1089"><span class="linenos">1089</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1090"><a href="#ServerArgs-1090"><span class="linenos">1090</span></a>            <span class="s2">&quot;--gpu-id-step&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1091"><a href="#ServerArgs-1091"><span class="linenos">1091</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1092"><a href="#ServerArgs-1092"><span class="linenos">1092</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">gpu_id_step</span><span class="p">,</span>
</span><span id="ServerArgs-1093"><a href="#ServerArgs-1093"><span class="linenos">1093</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The delta between consecutive GPU IDs that are used. For example, setting it to 2 will use GPU 0,2,4,...&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1094"><a href="#ServerArgs-1094"><span class="linenos">1094</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1095"><a href="#ServerArgs-1095"><span class="linenos">1095</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1096"><a href="#ServerArgs-1096"><span class="linenos">1096</span></a>            <span class="s2">&quot;--sleep-on-idle&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1097"><a href="#ServerArgs-1097"><span class="linenos">1097</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1098"><a href="#ServerArgs-1098"><span class="linenos">1098</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Reduce CPU usage when sglang is idle.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1099"><a href="#ServerArgs-1099"><span class="linenos">1099</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1100"><a href="#ServerArgs-1100"><span class="linenos">1100</span></a>
</span><span id="ServerArgs-1101"><a href="#ServerArgs-1101"><span class="linenos">1101</span></a>        <span class="c1"># Logging</span>
</span><span id="ServerArgs-1102"><a href="#ServerArgs-1102"><span class="linenos">1102</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1103"><a href="#ServerArgs-1103"><span class="linenos">1103</span></a>            <span class="s2">&quot;--log-level&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1104"><a href="#ServerArgs-1104"><span class="linenos">1104</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1105"><a href="#ServerArgs-1105"><span class="linenos">1105</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_level</span><span class="p">,</span>
</span><span id="ServerArgs-1106"><a href="#ServerArgs-1106"><span class="linenos">1106</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The logging level of all loggers.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1107"><a href="#ServerArgs-1107"><span class="linenos">1107</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1108"><a href="#ServerArgs-1108"><span class="linenos">1108</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1109"><a href="#ServerArgs-1109"><span class="linenos">1109</span></a>            <span class="s2">&quot;--log-level-http&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1110"><a href="#ServerArgs-1110"><span class="linenos">1110</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1111"><a href="#ServerArgs-1111"><span class="linenos">1111</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_level_http</span><span class="p">,</span>
</span><span id="ServerArgs-1112"><a href="#ServerArgs-1112"><span class="linenos">1112</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The logging level of HTTP server. If not set, reuse --log-level by default.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1113"><a href="#ServerArgs-1113"><span class="linenos">1113</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1114"><a href="#ServerArgs-1114"><span class="linenos">1114</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1115"><a href="#ServerArgs-1115"><span class="linenos">1115</span></a>            <span class="s2">&quot;--log-requests&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1116"><a href="#ServerArgs-1116"><span class="linenos">1116</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1117"><a href="#ServerArgs-1117"><span class="linenos">1117</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Log metadata, inputs, outputs of all requests. The verbosity is decided by --log-requests-level&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1118"><a href="#ServerArgs-1118"><span class="linenos">1118</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1119"><a href="#ServerArgs-1119"><span class="linenos">1119</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1120"><a href="#ServerArgs-1120"><span class="linenos">1120</span></a>            <span class="s2">&quot;--log-requests-level&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1121"><a href="#ServerArgs-1121"><span class="linenos">1121</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1122"><a href="#ServerArgs-1122"><span class="linenos">1122</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_requests_level</span><span class="p">,</span>
</span><span id="ServerArgs-1123"><a href="#ServerArgs-1123"><span class="linenos">1123</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;0: Log metadata (no sampling parameters). 1: Log metadata and sampling parameters. 2: Log metadata, sampling parameters and partial input/output. 3: Log every input/output.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1124"><a href="#ServerArgs-1124"><span class="linenos">1124</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ServerArgs-1125"><a href="#ServerArgs-1125"><span class="linenos">1125</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1126"><a href="#ServerArgs-1126"><span class="linenos">1126</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1127"><a href="#ServerArgs-1127"><span class="linenos">1127</span></a>            <span class="s2">&quot;--crash-dump-folder&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1128"><a href="#ServerArgs-1128"><span class="linenos">1128</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1129"><a href="#ServerArgs-1129"><span class="linenos">1129</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">crash_dump_folder</span><span class="p">,</span>
</span><span id="ServerArgs-1130"><a href="#ServerArgs-1130"><span class="linenos">1130</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Folder path to dump requests from the last 5 min before a crash (if any). If not specified, crash dumping is disabled.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1131"><a href="#ServerArgs-1131"><span class="linenos">1131</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1132"><a href="#ServerArgs-1132"><span class="linenos">1132</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1133"><a href="#ServerArgs-1133"><span class="linenos">1133</span></a>            <span class="s2">&quot;--show-time-cost&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1134"><a href="#ServerArgs-1134"><span class="linenos">1134</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1135"><a href="#ServerArgs-1135"><span class="linenos">1135</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show time cost of custom marks.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1136"><a href="#ServerArgs-1136"><span class="linenos">1136</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1137"><a href="#ServerArgs-1137"><span class="linenos">1137</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1138"><a href="#ServerArgs-1138"><span class="linenos">1138</span></a>            <span class="s2">&quot;--enable-metrics&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1139"><a href="#ServerArgs-1139"><span class="linenos">1139</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1140"><a href="#ServerArgs-1140"><span class="linenos">1140</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable log prometheus metrics.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1141"><a href="#ServerArgs-1141"><span class="linenos">1141</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1142"><a href="#ServerArgs-1142"><span class="linenos">1142</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1143"><a href="#ServerArgs-1143"><span class="linenos">1143</span></a>            <span class="s2">&quot;--enable-metrics-for-all-schedulers&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1144"><a href="#ServerArgs-1144"><span class="linenos">1144</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1145"><a href="#ServerArgs-1145"><span class="linenos">1145</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable --enable-metrics-for-all-schedulers when you want schedulers on all TP ranks (not just TP 0) &quot;</span>
</span><span id="ServerArgs-1146"><a href="#ServerArgs-1146"><span class="linenos">1146</span></a>            <span class="s2">&quot;to record request metrics separately. This is especially useful when dp_attention is enabled, as &quot;</span>
</span><span id="ServerArgs-1147"><a href="#ServerArgs-1147"><span class="linenos">1147</span></a>            <span class="s2">&quot;otherwise all metrics appear to come from TP 0.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1148"><a href="#ServerArgs-1148"><span class="linenos">1148</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1149"><a href="#ServerArgs-1149"><span class="linenos">1149</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1150"><a href="#ServerArgs-1150"><span class="linenos">1150</span></a>            <span class="s2">&quot;--bucket-time-to-first-token&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1151"><a href="#ServerArgs-1151"><span class="linenos">1151</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1152"><a href="#ServerArgs-1152"><span class="linenos">1152</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1153"><a href="#ServerArgs-1153"><span class="linenos">1153</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_time_to_first_token</span><span class="p">,</span>
</span><span id="ServerArgs-1154"><a href="#ServerArgs-1154"><span class="linenos">1154</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of time to first token, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1155"><a href="#ServerArgs-1155"><span class="linenos">1155</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1156"><a href="#ServerArgs-1156"><span class="linenos">1156</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1157"><a href="#ServerArgs-1157"><span class="linenos">1157</span></a>            <span class="s2">&quot;--bucket-inter-token-latency&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1158"><a href="#ServerArgs-1158"><span class="linenos">1158</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1159"><a href="#ServerArgs-1159"><span class="linenos">1159</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1160"><a href="#ServerArgs-1160"><span class="linenos">1160</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_inter_token_latency</span><span class="p">,</span>
</span><span id="ServerArgs-1161"><a href="#ServerArgs-1161"><span class="linenos">1161</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of inter-token latency, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1162"><a href="#ServerArgs-1162"><span class="linenos">1162</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1163"><a href="#ServerArgs-1163"><span class="linenos">1163</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1164"><a href="#ServerArgs-1164"><span class="linenos">1164</span></a>            <span class="s2">&quot;--bucket-e2e-request-latency&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1165"><a href="#ServerArgs-1165"><span class="linenos">1165</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1166"><a href="#ServerArgs-1166"><span class="linenos">1166</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1167"><a href="#ServerArgs-1167"><span class="linenos">1167</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_e2e_request_latency</span><span class="p">,</span>
</span><span id="ServerArgs-1168"><a href="#ServerArgs-1168"><span class="linenos">1168</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of end-to-end request latency, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1169"><a href="#ServerArgs-1169"><span class="linenos">1169</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1170"><a href="#ServerArgs-1170"><span class="linenos">1170</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1171"><a href="#ServerArgs-1171"><span class="linenos">1171</span></a>            <span class="s2">&quot;--collect-tokens-histogram&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1172"><a href="#ServerArgs-1172"><span class="linenos">1172</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1173"><a href="#ServerArgs-1173"><span class="linenos">1173</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">collect_tokens_histogram</span><span class="p">,</span>
</span><span id="ServerArgs-1174"><a href="#ServerArgs-1174"><span class="linenos">1174</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Collect prompt/generation tokens histogram.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1175"><a href="#ServerArgs-1175"><span class="linenos">1175</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1176"><a href="#ServerArgs-1176"><span class="linenos">1176</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1177"><a href="#ServerArgs-1177"><span class="linenos">1177</span></a>            <span class="s2">&quot;--gc-warning-threshold-secs&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1178"><a href="#ServerArgs-1178"><span class="linenos">1178</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1179"><a href="#ServerArgs-1179"><span class="linenos">1179</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">gc_warning_threshold_secs</span><span class="p">,</span>
</span><span id="ServerArgs-1180"><a href="#ServerArgs-1180"><span class="linenos">1180</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The threshold for long GC warning. If a GC takes longer than this, a warning will be logged. Set to 0 to disable.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1181"><a href="#ServerArgs-1181"><span class="linenos">1181</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1182"><a href="#ServerArgs-1182"><span class="linenos">1182</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1183"><a href="#ServerArgs-1183"><span class="linenos">1183</span></a>            <span class="s2">&quot;--decode-log-interval&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1184"><a href="#ServerArgs-1184"><span class="linenos">1184</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1185"><a href="#ServerArgs-1185"><span class="linenos">1185</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">decode_log_interval</span><span class="p">,</span>
</span><span id="ServerArgs-1186"><a href="#ServerArgs-1186"><span class="linenos">1186</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The log interval of decode batch.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1187"><a href="#ServerArgs-1187"><span class="linenos">1187</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1188"><a href="#ServerArgs-1188"><span class="linenos">1188</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1189"><a href="#ServerArgs-1189"><span class="linenos">1189</span></a>            <span class="s2">&quot;--enable-request-time-stats-logging&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1190"><a href="#ServerArgs-1190"><span class="linenos">1190</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1191"><a href="#ServerArgs-1191"><span class="linenos">1191</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_request_time_stats_logging</span><span class="p">,</span>
</span><span id="ServerArgs-1192"><a href="#ServerArgs-1192"><span class="linenos">1192</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable per request time stats logging&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1193"><a href="#ServerArgs-1193"><span class="linenos">1193</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1194"><a href="#ServerArgs-1194"><span class="linenos">1194</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1195"><a href="#ServerArgs-1195"><span class="linenos">1195</span></a>            <span class="s2">&quot;--kv-events-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1196"><a href="#ServerArgs-1196"><span class="linenos">1196</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1197"><a href="#ServerArgs-1197"><span class="linenos">1197</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-1198"><a href="#ServerArgs-1198"><span class="linenos">1198</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Config in json format for NVIDIA dynamo KV event publishing. Publishing will be enabled if this flag is used.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1199"><a href="#ServerArgs-1199"><span class="linenos">1199</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1200"><a href="#ServerArgs-1200"><span class="linenos">1200</span></a>
</span><span id="ServerArgs-1201"><a href="#ServerArgs-1201"><span class="linenos">1201</span></a>        <span class="c1"># API related</span>
</span><span id="ServerArgs-1202"><a href="#ServerArgs-1202"><span class="linenos">1202</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1203"><a href="#ServerArgs-1203"><span class="linenos">1203</span></a>            <span class="s2">&quot;--api-key&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1204"><a href="#ServerArgs-1204"><span class="linenos">1204</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1205"><a href="#ServerArgs-1205"><span class="linenos">1205</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
</span><span id="ServerArgs-1206"><a href="#ServerArgs-1206"><span class="linenos">1206</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set API key of the server. It is also used in the OpenAI API compatible server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1207"><a href="#ServerArgs-1207"><span class="linenos">1207</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1208"><a href="#ServerArgs-1208"><span class="linenos">1208</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1209"><a href="#ServerArgs-1209"><span class="linenos">1209</span></a>            <span class="s2">&quot;--served-model-name&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1210"><a href="#ServerArgs-1210"><span class="linenos">1210</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1211"><a href="#ServerArgs-1211"><span class="linenos">1211</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">served_model_name</span><span class="p">,</span>
</span><span id="ServerArgs-1212"><a href="#ServerArgs-1212"><span class="linenos">1212</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Override the model name returned by the v1/models endpoint in OpenAI API server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1213"><a href="#ServerArgs-1213"><span class="linenos">1213</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1214"><a href="#ServerArgs-1214"><span class="linenos">1214</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1215"><a href="#ServerArgs-1215"><span class="linenos">1215</span></a>            <span class="s2">&quot;--weight-version&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1216"><a href="#ServerArgs-1216"><span class="linenos">1216</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1217"><a href="#ServerArgs-1217"><span class="linenos">1217</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">weight_version</span><span class="p">,</span>
</span><span id="ServerArgs-1218"><a href="#ServerArgs-1218"><span class="linenos">1218</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Version identifier for the model weights. Defaults to &#39;default&#39; if not specified.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1219"><a href="#ServerArgs-1219"><span class="linenos">1219</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1220"><a href="#ServerArgs-1220"><span class="linenos">1220</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1221"><a href="#ServerArgs-1221"><span class="linenos">1221</span></a>            <span class="s2">&quot;--chat-template&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1222"><a href="#ServerArgs-1222"><span class="linenos">1222</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1223"><a href="#ServerArgs-1223"><span class="linenos">1223</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">chat_template</span><span class="p">,</span>
</span><span id="ServerArgs-1224"><a href="#ServerArgs-1224"><span class="linenos">1224</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buliltin chat template name or the path of the chat template file. This is only used for OpenAI-compatible API server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1225"><a href="#ServerArgs-1225"><span class="linenos">1225</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1226"><a href="#ServerArgs-1226"><span class="linenos">1226</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1227"><a href="#ServerArgs-1227"><span class="linenos">1227</span></a>            <span class="s2">&quot;--completion-template&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1228"><a href="#ServerArgs-1228"><span class="linenos">1228</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1229"><a href="#ServerArgs-1229"><span class="linenos">1229</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">completion_template</span><span class="p">,</span>
</span><span id="ServerArgs-1230"><a href="#ServerArgs-1230"><span class="linenos">1230</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buliltin completion template name or the path of the completion template file. This is only used for OpenAI-compatible API server. only for code completion currently.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1231"><a href="#ServerArgs-1231"><span class="linenos">1231</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1232"><a href="#ServerArgs-1232"><span class="linenos">1232</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1233"><a href="#ServerArgs-1233"><span class="linenos">1233</span></a>            <span class="s2">&quot;--file-storage-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1234"><a href="#ServerArgs-1234"><span class="linenos">1234</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1235"><a href="#ServerArgs-1235"><span class="linenos">1235</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">file_storage_path</span><span class="p">,</span>
</span><span id="ServerArgs-1236"><a href="#ServerArgs-1236"><span class="linenos">1236</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the file storage in backend.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1237"><a href="#ServerArgs-1237"><span class="linenos">1237</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1238"><a href="#ServerArgs-1238"><span class="linenos">1238</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1239"><a href="#ServerArgs-1239"><span class="linenos">1239</span></a>            <span class="s2">&quot;--enable-cache-report&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1240"><a href="#ServerArgs-1240"><span class="linenos">1240</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1241"><a href="#ServerArgs-1241"><span class="linenos">1241</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Return number of cached tokens in usage.prompt_tokens_details for each openai request.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1242"><a href="#ServerArgs-1242"><span class="linenos">1242</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1243"><a href="#ServerArgs-1243"><span class="linenos">1243</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1244"><a href="#ServerArgs-1244"><span class="linenos">1244</span></a>            <span class="s2">&quot;--reasoning-parser&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1245"><a href="#ServerArgs-1245"><span class="linenos">1245</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1246"><a href="#ServerArgs-1246"><span class="linenos">1246</span></a>            <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ReasoningParser</span><span class="o">.</span><span class="n">DetectorMap</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
</span><span id="ServerArgs-1247"><a href="#ServerArgs-1247"><span class="linenos">1247</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">reasoning_parser</span><span class="p">,</span>
</span><span id="ServerArgs-1248"><a href="#ServerArgs-1248"><span class="linenos">1248</span></a>            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Specify the parser for reasoning models, supported parsers are: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ReasoningParser</span><span class="o">.</span><span class="n">DetectorMap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1249"><a href="#ServerArgs-1249"><span class="linenos">1249</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1250"><a href="#ServerArgs-1250"><span class="linenos">1250</span></a>        <span class="n">tool_call_parser_choices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FunctionCallParser</span><span class="o">.</span><span class="n">ToolCallParserEnum</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="ServerArgs-1251"><a href="#ServerArgs-1251"><span class="linenos">1251</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1252"><a href="#ServerArgs-1252"><span class="linenos">1252</span></a>            <span class="s2">&quot;--tool-call-parser&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1253"><a href="#ServerArgs-1253"><span class="linenos">1253</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1254"><a href="#ServerArgs-1254"><span class="linenos">1254</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">tool_call_parser_choices</span><span class="p">,</span>
</span><span id="ServerArgs-1255"><a href="#ServerArgs-1255"><span class="linenos">1255</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tool_call_parser</span><span class="p">,</span>
</span><span id="ServerArgs-1256"><a href="#ServerArgs-1256"><span class="linenos">1256</span></a>            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Specify the parser for handling tool-call interactions. Options include: </span><span class="si">{</span><span class="n">tool_call_parser_choices</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1257"><a href="#ServerArgs-1257"><span class="linenos">1257</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1258"><a href="#ServerArgs-1258"><span class="linenos">1258</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1259"><a href="#ServerArgs-1259"><span class="linenos">1259</span></a>            <span class="s2">&quot;--tool-server&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1260"><a href="#ServerArgs-1260"><span class="linenos">1260</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1261"><a href="#ServerArgs-1261"><span class="linenos">1261</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-1262"><a href="#ServerArgs-1262"><span class="linenos">1262</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Either &#39;demo&#39; or a comma-separated list of tool server urls to use for the model. If not specified, no tool server will be used.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1263"><a href="#ServerArgs-1263"><span class="linenos">1263</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1264"><a href="#ServerArgs-1264"><span class="linenos">1264</span></a>
</span><span id="ServerArgs-1265"><a href="#ServerArgs-1265"><span class="linenos">1265</span></a>        <span class="c1"># Data parallelism</span>
</span><span id="ServerArgs-1266"><a href="#ServerArgs-1266"><span class="linenos">1266</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1267"><a href="#ServerArgs-1267"><span class="linenos">1267</span></a>            <span class="s2">&quot;--data-parallel-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1268"><a href="#ServerArgs-1268"><span class="linenos">1268</span></a>            <span class="s2">&quot;--dp-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1269"><a href="#ServerArgs-1269"><span class="linenos">1269</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1270"><a href="#ServerArgs-1270"><span class="linenos">1270</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dp_size</span><span class="p">,</span>
</span><span id="ServerArgs-1271"><a href="#ServerArgs-1271"><span class="linenos">1271</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The data parallelism size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1272"><a href="#ServerArgs-1272"><span class="linenos">1272</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1273"><a href="#ServerArgs-1273"><span class="linenos">1273</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1274"><a href="#ServerArgs-1274"><span class="linenos">1274</span></a>            <span class="s2">&quot;--load-balance-method&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1275"><a href="#ServerArgs-1275"><span class="linenos">1275</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1276"><a href="#ServerArgs-1276"><span class="linenos">1276</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">load_balance_method</span><span class="p">,</span>
</span><span id="ServerArgs-1277"><a href="#ServerArgs-1277"><span class="linenos">1277</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The load balancing strategy for data parallelism.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1278"><a href="#ServerArgs-1278"><span class="linenos">1278</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="ServerArgs-1279"><a href="#ServerArgs-1279"><span class="linenos">1279</span></a>                <span class="s2">&quot;round_robin&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1280"><a href="#ServerArgs-1280"><span class="linenos">1280</span></a>                <span class="s2">&quot;shortest_queue&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1281"><a href="#ServerArgs-1281"><span class="linenos">1281</span></a>                <span class="s2">&quot;minimum_tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1282"><a href="#ServerArgs-1282"><span class="linenos">1282</span></a>            <span class="p">],</span>
</span><span id="ServerArgs-1283"><a href="#ServerArgs-1283"><span class="linenos">1283</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1284"><a href="#ServerArgs-1284"><span class="linenos">1284</span></a>
</span><span id="ServerArgs-1285"><a href="#ServerArgs-1285"><span class="linenos">1285</span></a>        <span class="c1"># Multi-node distributed serving</span>
</span><span id="ServerArgs-1286"><a href="#ServerArgs-1286"><span class="linenos">1286</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1287"><a href="#ServerArgs-1287"><span class="linenos">1287</span></a>            <span class="s2">&quot;--dist-init-addr&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1288"><a href="#ServerArgs-1288"><span class="linenos">1288</span></a>            <span class="s2">&quot;--nccl-init-addr&quot;</span><span class="p">,</span>  <span class="c1"># For backward compatibility. This will be removed in the future.</span>
</span><span id="ServerArgs-1289"><a href="#ServerArgs-1289"><span class="linenos">1289</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1290"><a href="#ServerArgs-1290"><span class="linenos">1290</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The host address for initializing distributed backend (e.g., `192.168.0.2:25000`).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1291"><a href="#ServerArgs-1291"><span class="linenos">1291</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1292"><a href="#ServerArgs-1292"><span class="linenos">1292</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1293"><a href="#ServerArgs-1293"><span class="linenos">1293</span></a>            <span class="s2">&quot;--nnodes&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">nnodes</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of nodes.&quot;</span>
</span><span id="ServerArgs-1294"><a href="#ServerArgs-1294"><span class="linenos">1294</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1295"><a href="#ServerArgs-1295"><span class="linenos">1295</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1296"><a href="#ServerArgs-1296"><span class="linenos">1296</span></a>            <span class="s2">&quot;--node-rank&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">node_rank</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The node rank.&quot;</span>
</span><span id="ServerArgs-1297"><a href="#ServerArgs-1297"><span class="linenos">1297</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1298"><a href="#ServerArgs-1298"><span class="linenos">1298</span></a>
</span><span id="ServerArgs-1299"><a href="#ServerArgs-1299"><span class="linenos">1299</span></a>        <span class="c1"># Model override args</span>
</span><span id="ServerArgs-1300"><a href="#ServerArgs-1300"><span class="linenos">1300</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1301"><a href="#ServerArgs-1301"><span class="linenos">1301</span></a>            <span class="s2">&quot;--json-model-override-args&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1302"><a href="#ServerArgs-1302"><span class="linenos">1302</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1303"><a href="#ServerArgs-1303"><span class="linenos">1303</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A dictionary in JSON string format used to override default model configurations.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1304"><a href="#ServerArgs-1304"><span class="linenos">1304</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">json_model_override_args</span><span class="p">,</span>
</span><span id="ServerArgs-1305"><a href="#ServerArgs-1305"><span class="linenos">1305</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1306"><a href="#ServerArgs-1306"><span class="linenos">1306</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1307"><a href="#ServerArgs-1307"><span class="linenos">1307</span></a>            <span class="s2">&quot;--preferred-sampling-params&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1308"><a href="#ServerArgs-1308"><span class="linenos">1308</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1309"><a href="#ServerArgs-1309"><span class="linenos">1309</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;json-formatted sampling settings that will be returned in /get_model_info&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1310"><a href="#ServerArgs-1310"><span class="linenos">1310</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1311"><a href="#ServerArgs-1311"><span class="linenos">1311</span></a>
</span><span id="ServerArgs-1312"><a href="#ServerArgs-1312"><span class="linenos">1312</span></a>        <span class="c1"># LoRA</span>
</span><span id="ServerArgs-1313"><a href="#ServerArgs-1313"><span class="linenos">1313</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1314"><a href="#ServerArgs-1314"><span class="linenos">1314</span></a>            <span class="s2">&quot;--enable-lora&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1315"><a href="#ServerArgs-1315"><span class="linenos">1315</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_lora</span><span class="p">,</span>
</span><span id="ServerArgs-1316"><a href="#ServerArgs-1316"><span class="linenos">1316</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1317"><a href="#ServerArgs-1317"><span class="linenos">1317</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable LoRA support for the model. This argument is automatically set to True if `--lora-paths` is provided for backward compatibility.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1318"><a href="#ServerArgs-1318"><span class="linenos">1318</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1319"><a href="#ServerArgs-1319"><span class="linenos">1319</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1320"><a href="#ServerArgs-1320"><span class="linenos">1320</span></a>            <span class="s2">&quot;--max-lora-rank&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1321"><a href="#ServerArgs-1321"><span class="linenos">1321</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_lora_rank</span><span class="p">,</span>
</span><span id="ServerArgs-1322"><a href="#ServerArgs-1322"><span class="linenos">1322</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1323"><a href="#ServerArgs-1323"><span class="linenos">1323</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum rank of LoRA adapters. If not specified, it will be automatically inferred from the adapters provided in --lora-paths.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1324"><a href="#ServerArgs-1324"><span class="linenos">1324</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1325"><a href="#ServerArgs-1325"><span class="linenos">1325</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1326"><a href="#ServerArgs-1326"><span class="linenos">1326</span></a>            <span class="s2">&quot;--lora-target-modules&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1327"><a href="#ServerArgs-1327"><span class="linenos">1327</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1328"><a href="#ServerArgs-1328"><span class="linenos">1328</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">SUPPORTED_LORA_TARGET_MODULES</span> <span class="o">+</span> <span class="p">[</span><span class="n">LORA_TARGET_ALL_MODULES</span><span class="p">],</span>
</span><span id="ServerArgs-1329"><a href="#ServerArgs-1329"><span class="linenos">1329</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1330"><a href="#ServerArgs-1330"><span class="linenos">1330</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-1331"><a href="#ServerArgs-1331"><span class="linenos">1331</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The union set of all target modules where LoRA should be applied. If not specified, &quot;</span>
</span><span id="ServerArgs-1332"><a href="#ServerArgs-1332"><span class="linenos">1332</span></a>            <span class="s2">&quot;it will be automatically inferred from the adapters provided in --lora-paths. If &#39;all&#39; is specified, &quot;</span>
</span><span id="ServerArgs-1333"><a href="#ServerArgs-1333"><span class="linenos">1333</span></a>            <span class="s2">&quot;all supported modules will be targeted.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1334"><a href="#ServerArgs-1334"><span class="linenos">1334</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1335"><a href="#ServerArgs-1335"><span class="linenos">1335</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1336"><a href="#ServerArgs-1336"><span class="linenos">1336</span></a>            <span class="s2">&quot;--lora-paths&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1337"><a href="#ServerArgs-1337"><span class="linenos">1337</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1338"><a href="#ServerArgs-1338"><span class="linenos">1338</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1339"><a href="#ServerArgs-1339"><span class="linenos">1339</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-1340"><a href="#ServerArgs-1340"><span class="linenos">1340</span></a>            <span class="n">action</span><span class="o">=</span><span class="n">LoRAPathAction</span><span class="p">,</span>
</span><span id="ServerArgs-1341"><a href="#ServerArgs-1341"><span class="linenos">1341</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The list of LoRA adapters to load. Each adapter must be specified in one of the following formats: &lt;PATH&gt; | &lt;NAME&gt;=&lt;PATH&gt; | JSON with schema {&quot;lora_name&quot;:str,&quot;lora_path&quot;:str,&quot;pinned&quot;:bool}&#39;</span><span class="p">,</span>
</span><span id="ServerArgs-1342"><a href="#ServerArgs-1342"><span class="linenos">1342</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1343"><a href="#ServerArgs-1343"><span class="linenos">1343</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1344"><a href="#ServerArgs-1344"><span class="linenos">1344</span></a>            <span class="s2">&quot;--max-loras-per-batch&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1345"><a href="#ServerArgs-1345"><span class="linenos">1345</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1346"><a href="#ServerArgs-1346"><span class="linenos">1346</span></a>            <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="ServerArgs-1347"><a href="#ServerArgs-1347"><span class="linenos">1347</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum number of adapters for a running batch, include base-only request.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1348"><a href="#ServerArgs-1348"><span class="linenos">1348</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1349"><a href="#ServerArgs-1349"><span class="linenos">1349</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1350"><a href="#ServerArgs-1350"><span class="linenos">1350</span></a>            <span class="s2">&quot;--max-loaded-loras&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1351"><a href="#ServerArgs-1351"><span class="linenos">1351</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1352"><a href="#ServerArgs-1352"><span class="linenos">1352</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="p">,</span>
</span><span id="ServerArgs-1353"><a href="#ServerArgs-1353"><span class="linenos">1353</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If specified, it limits the maximum number of LoRA adapters loaded in CPU memory at a time. The value must be greater than or equal to `--max-loras-per-batch`.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1354"><a href="#ServerArgs-1354"><span class="linenos">1354</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1355"><a href="#ServerArgs-1355"><span class="linenos">1355</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1356"><a href="#ServerArgs-1356"><span class="linenos">1356</span></a>            <span class="s2">&quot;--lora-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1357"><a href="#ServerArgs-1357"><span class="linenos">1357</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1358"><a href="#ServerArgs-1358"><span class="linenos">1358</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1359"><a href="#ServerArgs-1359"><span class="linenos">1359</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernel backend for multi-LoRA serving.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1360"><a href="#ServerArgs-1360"><span class="linenos">1360</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1361"><a href="#ServerArgs-1361"><span class="linenos">1361</span></a>
</span><span id="ServerArgs-1362"><a href="#ServerArgs-1362"><span class="linenos">1362</span></a>        <span class="c1"># Kernel backend</span>
</span><span id="ServerArgs-1363"><a href="#ServerArgs-1363"><span class="linenos">1363</span></a>        <span class="n">ATTN_BACKENDS</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ServerArgs-1364"><a href="#ServerArgs-1364"><span class="linenos">1364</span></a>            <span class="c1"># Common</span>
</span><span id="ServerArgs-1365"><a href="#ServerArgs-1365"><span class="linenos">1365</span></a>            <span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1366"><a href="#ServerArgs-1366"><span class="linenos">1366</span></a>            <span class="s2">&quot;torch_native&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1367"><a href="#ServerArgs-1367"><span class="linenos">1367</span></a>            <span class="c1"># NVIDIA specific</span>
</span><span id="ServerArgs-1368"><a href="#ServerArgs-1368"><span class="linenos">1368</span></a>            <span class="s2">&quot;cutlass_mla&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1369"><a href="#ServerArgs-1369"><span class="linenos">1369</span></a>            <span class="s2">&quot;fa3&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1370"><a href="#ServerArgs-1370"><span class="linenos">1370</span></a>            <span class="s2">&quot;flashinfer&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1371"><a href="#ServerArgs-1371"><span class="linenos">1371</span></a>            <span class="s2">&quot;flashmla&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1372"><a href="#ServerArgs-1372"><span class="linenos">1372</span></a>            <span class="s2">&quot;trtllm_mla&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1373"><a href="#ServerArgs-1373"><span class="linenos">1373</span></a>            <span class="s2">&quot;trtllm_mha&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1374"><a href="#ServerArgs-1374"><span class="linenos">1374</span></a>            <span class="s2">&quot;dual_chunk_flash_attn&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1375"><a href="#ServerArgs-1375"><span class="linenos">1375</span></a>            <span class="c1"># AMD specific</span>
</span><span id="ServerArgs-1376"><a href="#ServerArgs-1376"><span class="linenos">1376</span></a>            <span class="s2">&quot;aiter&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1377"><a href="#ServerArgs-1377"><span class="linenos">1377</span></a>            <span class="s2">&quot;wave&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1378"><a href="#ServerArgs-1378"><span class="linenos">1378</span></a>            <span class="c1"># Other platforms</span>
</span><span id="ServerArgs-1379"><a href="#ServerArgs-1379"><span class="linenos">1379</span></a>            <span class="s2">&quot;intel_amx&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1380"><a href="#ServerArgs-1380"><span class="linenos">1380</span></a>            <span class="s2">&quot;ascend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1381"><a href="#ServerArgs-1381"><span class="linenos">1381</span></a>        <span class="p">]</span>
</span><span id="ServerArgs-1382"><a href="#ServerArgs-1382"><span class="linenos">1382</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1383"><a href="#ServerArgs-1383"><span class="linenos">1383</span></a>            <span class="s2">&quot;--attention-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1384"><a href="#ServerArgs-1384"><span class="linenos">1384</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1385"><a href="#ServerArgs-1385"><span class="linenos">1385</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="ServerArgs-1386"><a href="#ServerArgs-1386"><span class="linenos">1386</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">attention_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1387"><a href="#ServerArgs-1387"><span class="linenos">1387</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for attention layers.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1388"><a href="#ServerArgs-1388"><span class="linenos">1388</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1389"><a href="#ServerArgs-1389"><span class="linenos">1389</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1390"><a href="#ServerArgs-1390"><span class="linenos">1390</span></a>            <span class="s2">&quot;--prefill-attention-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1391"><a href="#ServerArgs-1391"><span class="linenos">1391</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1392"><a href="#ServerArgs-1392"><span class="linenos">1392</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="ServerArgs-1393"><a href="#ServerArgs-1393"><span class="linenos">1393</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">prefill_attention_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1394"><a href="#ServerArgs-1394"><span class="linenos">1394</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for prefill attention layers (have priority over --attention-backend).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1395"><a href="#ServerArgs-1395"><span class="linenos">1395</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1396"><a href="#ServerArgs-1396"><span class="linenos">1396</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1397"><a href="#ServerArgs-1397"><span class="linenos">1397</span></a>            <span class="s2">&quot;--decode-attention-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1398"><a href="#ServerArgs-1398"><span class="linenos">1398</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1399"><a href="#ServerArgs-1399"><span class="linenos">1399</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="ServerArgs-1400"><a href="#ServerArgs-1400"><span class="linenos">1400</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">decode_attention_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1401"><a href="#ServerArgs-1401"><span class="linenos">1401</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for decode attention layers (have priority over --attention-backend).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1402"><a href="#ServerArgs-1402"><span class="linenos">1402</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1403"><a href="#ServerArgs-1403"><span class="linenos">1403</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1404"><a href="#ServerArgs-1404"><span class="linenos">1404</span></a>            <span class="s2">&quot;--sampling-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1405"><a href="#ServerArgs-1405"><span class="linenos">1405</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1406"><a href="#ServerArgs-1406"><span class="linenos">1406</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flashinfer&quot;</span><span class="p">,</span> <span class="s2">&quot;pytorch&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1407"><a href="#ServerArgs-1407"><span class="linenos">1407</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">sampling_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1408"><a href="#ServerArgs-1408"><span class="linenos">1408</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for sampling layers.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1409"><a href="#ServerArgs-1409"><span class="linenos">1409</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1410"><a href="#ServerArgs-1410"><span class="linenos">1410</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1411"><a href="#ServerArgs-1411"><span class="linenos">1411</span></a>            <span class="s2">&quot;--grammar-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1412"><a href="#ServerArgs-1412"><span class="linenos">1412</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1413"><a href="#ServerArgs-1413"><span class="linenos">1413</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xgrammar&quot;</span><span class="p">,</span> <span class="s2">&quot;outlines&quot;</span><span class="p">,</span> <span class="s2">&quot;llguidance&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1414"><a href="#ServerArgs-1414"><span class="linenos">1414</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">grammar_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1415"><a href="#ServerArgs-1415"><span class="linenos">1415</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the backend for grammar-guided decoding.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1416"><a href="#ServerArgs-1416"><span class="linenos">1416</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1417"><a href="#ServerArgs-1417"><span class="linenos">1417</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1418"><a href="#ServerArgs-1418"><span class="linenos">1418</span></a>            <span class="s2">&quot;--mm-attention-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1419"><a href="#ServerArgs-1419"><span class="linenos">1419</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1420"><a href="#ServerArgs-1420"><span class="linenos">1420</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sdpa&quot;</span><span class="p">,</span> <span class="s2">&quot;fa3&quot;</span><span class="p">,</span> <span class="s2">&quot;triton_attn&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1421"><a href="#ServerArgs-1421"><span class="linenos">1421</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">mm_attention_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1422"><a href="#ServerArgs-1422"><span class="linenos">1422</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set multimodal attention backend.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1423"><a href="#ServerArgs-1423"><span class="linenos">1423</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1424"><a href="#ServerArgs-1424"><span class="linenos">1424</span></a>
</span><span id="ServerArgs-1425"><a href="#ServerArgs-1425"><span class="linenos">1425</span></a>        <span class="c1"># Speculative decoding</span>
</span><span id="ServerArgs-1426"><a href="#ServerArgs-1426"><span class="linenos">1426</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1427"><a href="#ServerArgs-1427"><span class="linenos">1427</span></a>            <span class="s2">&quot;--speculative-algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1428"><a href="#ServerArgs-1428"><span class="linenos">1428</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1429"><a href="#ServerArgs-1429"><span class="linenos">1429</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EAGLE&quot;</span><span class="p">,</span> <span class="s2">&quot;EAGLE3&quot;</span><span class="p">,</span> <span class="s2">&quot;NEXTN&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1430"><a href="#ServerArgs-1430"><span class="linenos">1430</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Speculative algorithm.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1431"><a href="#ServerArgs-1431"><span class="linenos">1431</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1432"><a href="#ServerArgs-1432"><span class="linenos">1432</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1433"><a href="#ServerArgs-1433"><span class="linenos">1433</span></a>            <span class="s2">&quot;--speculative-draft-model-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1434"><a href="#ServerArgs-1434"><span class="linenos">1434</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1435"><a href="#ServerArgs-1435"><span class="linenos">1435</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the draft model weights. This can be a local folder or a Hugging Face repo ID.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1436"><a href="#ServerArgs-1436"><span class="linenos">1436</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1437"><a href="#ServerArgs-1437"><span class="linenos">1437</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1438"><a href="#ServerArgs-1438"><span class="linenos">1438</span></a>            <span class="s2">&quot;--speculative-num-steps&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1439"><a href="#ServerArgs-1439"><span class="linenos">1439</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1440"><a href="#ServerArgs-1440"><span class="linenos">1440</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of steps sampled from draft model in Speculative Decoding.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1441"><a href="#ServerArgs-1441"><span class="linenos">1441</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_num_steps</span><span class="p">,</span>
</span><span id="ServerArgs-1442"><a href="#ServerArgs-1442"><span class="linenos">1442</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1443"><a href="#ServerArgs-1443"><span class="linenos">1443</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1444"><a href="#ServerArgs-1444"><span class="linenos">1444</span></a>            <span class="s2">&quot;--speculative-eagle-topk&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1445"><a href="#ServerArgs-1445"><span class="linenos">1445</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1446"><a href="#ServerArgs-1446"><span class="linenos">1446</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens sampled from the draft model in eagle2 each step.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1447"><a href="#ServerArgs-1447"><span class="linenos">1447</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_eagle_topk</span><span class="p">,</span>
</span><span id="ServerArgs-1448"><a href="#ServerArgs-1448"><span class="linenos">1448</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1449"><a href="#ServerArgs-1449"><span class="linenos">1449</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1450"><a href="#ServerArgs-1450"><span class="linenos">1450</span></a>            <span class="s2">&quot;--speculative-num-draft-tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1451"><a href="#ServerArgs-1451"><span class="linenos">1451</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1452"><a href="#ServerArgs-1452"><span class="linenos">1452</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens sampled from the draft model in Speculative Decoding.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1453"><a href="#ServerArgs-1453"><span class="linenos">1453</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span><span class="p">,</span>
</span><span id="ServerArgs-1454"><a href="#ServerArgs-1454"><span class="linenos">1454</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1455"><a href="#ServerArgs-1455"><span class="linenos">1455</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1456"><a href="#ServerArgs-1456"><span class="linenos">1456</span></a>            <span class="s2">&quot;--speculative-accept-threshold-single&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1457"><a href="#ServerArgs-1457"><span class="linenos">1457</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1458"><a href="#ServerArgs-1458"><span class="linenos">1458</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Accept a draft token if its probability in the target model is greater than this threshold.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1459"><a href="#ServerArgs-1459"><span class="linenos">1459</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_accept_threshold_single</span><span class="p">,</span>
</span><span id="ServerArgs-1460"><a href="#ServerArgs-1460"><span class="linenos">1460</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1461"><a href="#ServerArgs-1461"><span class="linenos">1461</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1462"><a href="#ServerArgs-1462"><span class="linenos">1462</span></a>            <span class="s2">&quot;--speculative-accept-threshold-acc&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1463"><a href="#ServerArgs-1463"><span class="linenos">1463</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1464"><a href="#ServerArgs-1464"><span class="linenos">1464</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The accept probability of a draft token is raised from its target probability p to min(1, p / threshold_acc).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1465"><a href="#ServerArgs-1465"><span class="linenos">1465</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_accept_threshold_acc</span><span class="p">,</span>
</span><span id="ServerArgs-1466"><a href="#ServerArgs-1466"><span class="linenos">1466</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1467"><a href="#ServerArgs-1467"><span class="linenos">1467</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1468"><a href="#ServerArgs-1468"><span class="linenos">1468</span></a>            <span class="s2">&quot;--speculative-token-map&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1469"><a href="#ServerArgs-1469"><span class="linenos">1469</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1470"><a href="#ServerArgs-1470"><span class="linenos">1470</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the draft model&#39;s small vocab table.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1471"><a href="#ServerArgs-1471"><span class="linenos">1471</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_token_map</span><span class="p">,</span>
</span><span id="ServerArgs-1472"><a href="#ServerArgs-1472"><span class="linenos">1472</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1473"><a href="#ServerArgs-1473"><span class="linenos">1473</span></a>
</span><span id="ServerArgs-1474"><a href="#ServerArgs-1474"><span class="linenos">1474</span></a>        <span class="c1"># Expert parallelism</span>
</span><span id="ServerArgs-1475"><a href="#ServerArgs-1475"><span class="linenos">1475</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1476"><a href="#ServerArgs-1476"><span class="linenos">1476</span></a>            <span class="s2">&quot;--expert-parallel-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1477"><a href="#ServerArgs-1477"><span class="linenos">1477</span></a>            <span class="s2">&quot;--ep-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1478"><a href="#ServerArgs-1478"><span class="linenos">1478</span></a>            <span class="s2">&quot;--ep&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1479"><a href="#ServerArgs-1479"><span class="linenos">1479</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1480"><a href="#ServerArgs-1480"><span class="linenos">1480</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_size</span><span class="p">,</span>
</span><span id="ServerArgs-1481"><a href="#ServerArgs-1481"><span class="linenos">1481</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The expert parallelism size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1482"><a href="#ServerArgs-1482"><span class="linenos">1482</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1483"><a href="#ServerArgs-1483"><span class="linenos">1483</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1484"><a href="#ServerArgs-1484"><span class="linenos">1484</span></a>            <span class="s2">&quot;--moe-a2a-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1485"><a href="#ServerArgs-1485"><span class="linenos">1485</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1486"><a href="#ServerArgs-1486"><span class="linenos">1486</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;deepep&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1487"><a href="#ServerArgs-1487"><span class="linenos">1487</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_a2a_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1488"><a href="#ServerArgs-1488"><span class="linenos">1488</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the backend for MoE A2A.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1489"><a href="#ServerArgs-1489"><span class="linenos">1489</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1490"><a href="#ServerArgs-1490"><span class="linenos">1490</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1491"><a href="#ServerArgs-1491"><span class="linenos">1491</span></a>            <span class="s2">&quot;--moe-runner-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1492"><a href="#ServerArgs-1492"><span class="linenos">1492</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1493"><a href="#ServerArgs-1493"><span class="linenos">1493</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="ServerArgs-1494"><a href="#ServerArgs-1494"><span class="linenos">1494</span></a>                <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1495"><a href="#ServerArgs-1495"><span class="linenos">1495</span></a>                <span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1496"><a href="#ServerArgs-1496"><span class="linenos">1496</span></a>                <span class="s2">&quot;triton_kernel&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1497"><a href="#ServerArgs-1497"><span class="linenos">1497</span></a>                <span class="s2">&quot;flashinfer_trtllm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1498"><a href="#ServerArgs-1498"><span class="linenos">1498</span></a>                <span class="s2">&quot;flashinfer_cutlass&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1499"><a href="#ServerArgs-1499"><span class="linenos">1499</span></a>                <span class="s2">&quot;flashinfer_mxfp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1500"><a href="#ServerArgs-1500"><span class="linenos">1500</span></a>            <span class="p">],</span>
</span><span id="ServerArgs-1501"><a href="#ServerArgs-1501"><span class="linenos">1501</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_runner_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1502"><a href="#ServerArgs-1502"><span class="linenos">1502</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the runner backend for MoE.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1503"><a href="#ServerArgs-1503"><span class="linenos">1503</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1504"><a href="#ServerArgs-1504"><span class="linenos">1504</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1505"><a href="#ServerArgs-1505"><span class="linenos">1505</span></a>            <span class="s2">&quot;--flashinfer-mxfp4-moe-precision&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1506"><a href="#ServerArgs-1506"><span class="linenos">1506</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1507"><a href="#ServerArgs-1507"><span class="linenos">1507</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mxfp4&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1508"><a href="#ServerArgs-1508"><span class="linenos">1508</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">flashinfer_mxfp4_moe_precision</span><span class="p">,</span>
</span><span id="ServerArgs-1509"><a href="#ServerArgs-1509"><span class="linenos">1509</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the computation precision of flashinfer mxfp4 moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1510"><a href="#ServerArgs-1510"><span class="linenos">1510</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1511"><a href="#ServerArgs-1511"><span class="linenos">1511</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1512"><a href="#ServerArgs-1512"><span class="linenos">1512</span></a>            <span class="s2">&quot;--enable-flashinfer-allreduce-fusion&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1513"><a href="#ServerArgs-1513"><span class="linenos">1513</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1514"><a href="#ServerArgs-1514"><span class="linenos">1514</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable FlashInfer allreduce fusion with Residual RMSNorm.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1515"><a href="#ServerArgs-1515"><span class="linenos">1515</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1516"><a href="#ServerArgs-1516"><span class="linenos">1516</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1517"><a href="#ServerArgs-1517"><span class="linenos">1517</span></a>            <span class="s2">&quot;--deepep-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1518"><a href="#ServerArgs-1518"><span class="linenos">1518</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1519"><a href="#ServerArgs-1519"><span class="linenos">1519</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;low_latency&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1520"><a href="#ServerArgs-1520"><span class="linenos">1520</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1521"><a href="#ServerArgs-1521"><span class="linenos">1521</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select the mode when enable DeepEP MoE, could be `normal`, `low_latency` or `auto`. Default is `auto`, which means `low_latency` for decode batch and `normal` for prefill batch.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1522"><a href="#ServerArgs-1522"><span class="linenos">1522</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1523"><a href="#ServerArgs-1523"><span class="linenos">1523</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1524"><a href="#ServerArgs-1524"><span class="linenos">1524</span></a>            <span class="s2">&quot;--ep-num-redundant-experts&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1525"><a href="#ServerArgs-1525"><span class="linenos">1525</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1526"><a href="#ServerArgs-1526"><span class="linenos">1526</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_num_redundant_experts</span><span class="p">,</span>
</span><span id="ServerArgs-1527"><a href="#ServerArgs-1527"><span class="linenos">1527</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allocate this number of redundant experts in expert parallel.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1528"><a href="#ServerArgs-1528"><span class="linenos">1528</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1529"><a href="#ServerArgs-1529"><span class="linenos">1529</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1530"><a href="#ServerArgs-1530"><span class="linenos">1530</span></a>            <span class="s2">&quot;--ep-dispatch-algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1531"><a href="#ServerArgs-1531"><span class="linenos">1531</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1532"><a href="#ServerArgs-1532"><span class="linenos">1532</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_dispatch_algorithm</span><span class="p">,</span>
</span><span id="ServerArgs-1533"><a href="#ServerArgs-1533"><span class="linenos">1533</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The algorithm to choose ranks for redundant experts in expert parallel.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1534"><a href="#ServerArgs-1534"><span class="linenos">1534</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1535"><a href="#ServerArgs-1535"><span class="linenos">1535</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1536"><a href="#ServerArgs-1536"><span class="linenos">1536</span></a>            <span class="s2">&quot;--init-expert-location&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1537"><a href="#ServerArgs-1537"><span class="linenos">1537</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1538"><a href="#ServerArgs-1538"><span class="linenos">1538</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">init_expert_location</span><span class="p">,</span>
</span><span id="ServerArgs-1539"><a href="#ServerArgs-1539"><span class="linenos">1539</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Initial location of EP experts.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1540"><a href="#ServerArgs-1540"><span class="linenos">1540</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1541"><a href="#ServerArgs-1541"><span class="linenos">1541</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1542"><a href="#ServerArgs-1542"><span class="linenos">1542</span></a>            <span class="s2">&quot;--enable-eplb&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1543"><a href="#ServerArgs-1543"><span class="linenos">1543</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1544"><a href="#ServerArgs-1544"><span class="linenos">1544</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable EPLB algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1545"><a href="#ServerArgs-1545"><span class="linenos">1545</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1546"><a href="#ServerArgs-1546"><span class="linenos">1546</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1547"><a href="#ServerArgs-1547"><span class="linenos">1547</span></a>            <span class="s2">&quot;--eplb-algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1548"><a href="#ServerArgs-1548"><span class="linenos">1548</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1549"><a href="#ServerArgs-1549"><span class="linenos">1549</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_algorithm</span><span class="p">,</span>
</span><span id="ServerArgs-1550"><a href="#ServerArgs-1550"><span class="linenos">1550</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Chosen EPLB algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1551"><a href="#ServerArgs-1551"><span class="linenos">1551</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1552"><a href="#ServerArgs-1552"><span class="linenos">1552</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1553"><a href="#ServerArgs-1553"><span class="linenos">1553</span></a>            <span class="s2">&quot;--eplb-rebalance-num-iterations&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1554"><a href="#ServerArgs-1554"><span class="linenos">1554</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1555"><a href="#ServerArgs-1555"><span class="linenos">1555</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_rebalance_num_iterations</span><span class="p">,</span>
</span><span id="ServerArgs-1556"><a href="#ServerArgs-1556"><span class="linenos">1556</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of iterations to automatically trigger a EPLB re-balance.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1557"><a href="#ServerArgs-1557"><span class="linenos">1557</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1558"><a href="#ServerArgs-1558"><span class="linenos">1558</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1559"><a href="#ServerArgs-1559"><span class="linenos">1559</span></a>            <span class="s2">&quot;--eplb-rebalance-layers-per-chunk&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1560"><a href="#ServerArgs-1560"><span class="linenos">1560</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1561"><a href="#ServerArgs-1561"><span class="linenos">1561</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_rebalance_layers_per_chunk</span><span class="p">,</span>
</span><span id="ServerArgs-1562"><a href="#ServerArgs-1562"><span class="linenos">1562</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers to rebalance per forward pass.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1563"><a href="#ServerArgs-1563"><span class="linenos">1563</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1564"><a href="#ServerArgs-1564"><span class="linenos">1564</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1565"><a href="#ServerArgs-1565"><span class="linenos">1565</span></a>            <span class="s2">&quot;--expert-distribution-recorder-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1566"><a href="#ServerArgs-1566"><span class="linenos">1566</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1567"><a href="#ServerArgs-1567"><span class="linenos">1567</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span><span class="p">,</span>
</span><span id="ServerArgs-1568"><a href="#ServerArgs-1568"><span class="linenos">1568</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mode of expert distribution recorder.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1569"><a href="#ServerArgs-1569"><span class="linenos">1569</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1570"><a href="#ServerArgs-1570"><span class="linenos">1570</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1571"><a href="#ServerArgs-1571"><span class="linenos">1571</span></a>            <span class="s2">&quot;--expert-distribution-recorder-buffer-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1572"><a href="#ServerArgs-1572"><span class="linenos">1572</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1573"><a href="#ServerArgs-1573"><span class="linenos">1573</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span><span class="p">,</span>
</span><span id="ServerArgs-1574"><a href="#ServerArgs-1574"><span class="linenos">1574</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Circular buffer size of expert distribution recorder. Set to -1 to denote infinite buffer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1575"><a href="#ServerArgs-1575"><span class="linenos">1575</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1576"><a href="#ServerArgs-1576"><span class="linenos">1576</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1577"><a href="#ServerArgs-1577"><span class="linenos">1577</span></a>            <span class="s2">&quot;--enable-expert-distribution-metrics&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1578"><a href="#ServerArgs-1578"><span class="linenos">1578</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1579"><a href="#ServerArgs-1579"><span class="linenos">1579</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable logging metrics for expert balancedness&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1580"><a href="#ServerArgs-1580"><span class="linenos">1580</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1581"><a href="#ServerArgs-1581"><span class="linenos">1581</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1582"><a href="#ServerArgs-1582"><span class="linenos">1582</span></a>            <span class="s2">&quot;--deepep-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1583"><a href="#ServerArgs-1583"><span class="linenos">1583</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1584"><a href="#ServerArgs-1584"><span class="linenos">1584</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">deepep_config</span><span class="p">,</span>
</span><span id="ServerArgs-1585"><a href="#ServerArgs-1585"><span class="linenos">1585</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tuned DeepEP config suitable for your own cluster. It can be either a string with JSON content or a file path.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1586"><a href="#ServerArgs-1586"><span class="linenos">1586</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1587"><a href="#ServerArgs-1587"><span class="linenos">1587</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1588"><a href="#ServerArgs-1588"><span class="linenos">1588</span></a>            <span class="s2">&quot;--moe-dense-tp-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1589"><a href="#ServerArgs-1589"><span class="linenos">1589</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1590"><a href="#ServerArgs-1590"><span class="linenos">1590</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_dense_tp_size</span><span class="p">,</span>
</span><span id="ServerArgs-1591"><a href="#ServerArgs-1591"><span class="linenos">1591</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;TP size for MoE dense MLP layers. This flag is useful when, with large TP size, there are errors caused by weights in MLP layers having dimension smaller than the min dimension GEMM supports.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1592"><a href="#ServerArgs-1592"><span class="linenos">1592</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1593"><a href="#ServerArgs-1593"><span class="linenos">1593</span></a>
</span><span id="ServerArgs-1594"><a href="#ServerArgs-1594"><span class="linenos">1594</span></a>        <span class="c1"># Hierarchical cache</span>
</span><span id="ServerArgs-1595"><a href="#ServerArgs-1595"><span class="linenos">1595</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1596"><a href="#ServerArgs-1596"><span class="linenos">1596</span></a>            <span class="s2">&quot;--enable-hierarchical-cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1597"><a href="#ServerArgs-1597"><span class="linenos">1597</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1598"><a href="#ServerArgs-1598"><span class="linenos">1598</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable hierarchical cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1599"><a href="#ServerArgs-1599"><span class="linenos">1599</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1600"><a href="#ServerArgs-1600"><span class="linenos">1600</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1601"><a href="#ServerArgs-1601"><span class="linenos">1601</span></a>            <span class="s2">&quot;--hicache-ratio&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1602"><a href="#ServerArgs-1602"><span class="linenos">1602</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1603"><a href="#ServerArgs-1603"><span class="linenos">1603</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_ratio</span><span class="p">,</span>
</span><span id="ServerArgs-1604"><a href="#ServerArgs-1604"><span class="linenos">1604</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The ratio of the size of host KV cache memory pool to the size of device pool.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1605"><a href="#ServerArgs-1605"><span class="linenos">1605</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1606"><a href="#ServerArgs-1606"><span class="linenos">1606</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1607"><a href="#ServerArgs-1607"><span class="linenos">1607</span></a>            <span class="s2">&quot;--hicache-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1608"><a href="#ServerArgs-1608"><span class="linenos">1608</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1609"><a href="#ServerArgs-1609"><span class="linenos">1609</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_size</span><span class="p">,</span>
</span><span id="ServerArgs-1610"><a href="#ServerArgs-1610"><span class="linenos">1610</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The size of host KV cache memory pool in gigabytes, which will override the hicache_ratio if set.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1611"><a href="#ServerArgs-1611"><span class="linenos">1611</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1612"><a href="#ServerArgs-1612"><span class="linenos">1612</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1613"><a href="#ServerArgs-1613"><span class="linenos">1613</span></a>            <span class="s2">&quot;--hicache-write-policy&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1614"><a href="#ServerArgs-1614"><span class="linenos">1614</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1615"><a href="#ServerArgs-1615"><span class="linenos">1615</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;write_back&quot;</span><span class="p">,</span> <span class="s2">&quot;write_through&quot;</span><span class="p">,</span> <span class="s2">&quot;write_through_selective&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1616"><a href="#ServerArgs-1616"><span class="linenos">1616</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_write_policy</span><span class="p">,</span>
</span><span id="ServerArgs-1617"><a href="#ServerArgs-1617"><span class="linenos">1617</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The write policy of hierarchical cache.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1618"><a href="#ServerArgs-1618"><span class="linenos">1618</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1619"><a href="#ServerArgs-1619"><span class="linenos">1619</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1620"><a href="#ServerArgs-1620"><span class="linenos">1620</span></a>            <span class="s2">&quot;--hicache-io-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1621"><a href="#ServerArgs-1621"><span class="linenos">1621</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1622"><a href="#ServerArgs-1622"><span class="linenos">1622</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1623"><a href="#ServerArgs-1623"><span class="linenos">1623</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_io_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1624"><a href="#ServerArgs-1624"><span class="linenos">1624</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The IO backend for KV cache transfer between CPU and GPU&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1625"><a href="#ServerArgs-1625"><span class="linenos">1625</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1626"><a href="#ServerArgs-1626"><span class="linenos">1626</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1627"><a href="#ServerArgs-1627"><span class="linenos">1627</span></a>            <span class="s2">&quot;--hicache-mem-layout&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1628"><a href="#ServerArgs-1628"><span class="linenos">1628</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1629"><a href="#ServerArgs-1629"><span class="linenos">1629</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layer_first&quot;</span><span class="p">,</span> <span class="s2">&quot;page_first&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1630"><a href="#ServerArgs-1630"><span class="linenos">1630</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_mem_layout</span><span class="p">,</span>
</span><span id="ServerArgs-1631"><a href="#ServerArgs-1631"><span class="linenos">1631</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The layout of host memory pool for hierarchical cache.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1632"><a href="#ServerArgs-1632"><span class="linenos">1632</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1633"><a href="#ServerArgs-1633"><span class="linenos">1633</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1634"><a href="#ServerArgs-1634"><span class="linenos">1634</span></a>            <span class="s2">&quot;--hicache-storage-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1635"><a href="#ServerArgs-1635"><span class="linenos">1635</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1636"><a href="#ServerArgs-1636"><span class="linenos">1636</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;mooncake&quot;</span><span class="p">,</span> <span class="s2">&quot;hf3fs&quot;</span><span class="p">,</span> <span class="s2">&quot;nixl&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1637"><a href="#ServerArgs-1637"><span class="linenos">1637</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1638"><a href="#ServerArgs-1638"><span class="linenos">1638</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The storage backend for hierarchical KV cache.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1639"><a href="#ServerArgs-1639"><span class="linenos">1639</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1640"><a href="#ServerArgs-1640"><span class="linenos">1640</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1641"><a href="#ServerArgs-1641"><span class="linenos">1641</span></a>            <span class="s2">&quot;--hicache-storage-prefetch-policy&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1642"><a href="#ServerArgs-1642"><span class="linenos">1642</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1643"><a href="#ServerArgs-1643"><span class="linenos">1643</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;best_effort&quot;</span><span class="p">,</span> <span class="s2">&quot;wait_complete&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1644"><a href="#ServerArgs-1644"><span class="linenos">1644</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_prefetch_policy</span><span class="p">,</span>
</span><span id="ServerArgs-1645"><a href="#ServerArgs-1645"><span class="linenos">1645</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Control when prefetching from the storage backend should stop.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1646"><a href="#ServerArgs-1646"><span class="linenos">1646</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1647"><a href="#ServerArgs-1647"><span class="linenos">1647</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1648"><a href="#ServerArgs-1648"><span class="linenos">1648</span></a>            <span class="s2">&quot;--hicache-storage-backend-extra-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1649"><a href="#ServerArgs-1649"><span class="linenos">1649</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1650"><a href="#ServerArgs-1650"><span class="linenos">1650</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_backend_extra_config</span><span class="p">,</span>
</span><span id="ServerArgs-1651"><a href="#ServerArgs-1651"><span class="linenos">1651</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A dictionary in JSON string format containing extra configuration for the storage backend.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1652"><a href="#ServerArgs-1652"><span class="linenos">1652</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1653"><a href="#ServerArgs-1653"><span class="linenos">1653</span></a>
</span><span id="ServerArgs-1654"><a href="#ServerArgs-1654"><span class="linenos">1654</span></a>        <span class="c1"># Double Sparsity</span>
</span><span id="ServerArgs-1655"><a href="#ServerArgs-1655"><span class="linenos">1655</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1656"><a href="#ServerArgs-1656"><span class="linenos">1656</span></a>            <span class="s2">&quot;--enable-double-sparsity&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1657"><a href="#ServerArgs-1657"><span class="linenos">1657</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1658"><a href="#ServerArgs-1658"><span class="linenos">1658</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1659"><a href="#ServerArgs-1659"><span class="linenos">1659</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1660"><a href="#ServerArgs-1660"><span class="linenos">1660</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1661"><a href="#ServerArgs-1661"><span class="linenos">1661</span></a>            <span class="s2">&quot;--ds-channel-config-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1662"><a href="#ServerArgs-1662"><span class="linenos">1662</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1663"><a href="#ServerArgs-1663"><span class="linenos">1663</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_channel_config_path</span><span class="p">,</span>
</span><span id="ServerArgs-1664"><a href="#ServerArgs-1664"><span class="linenos">1664</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the double sparsity channel config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1665"><a href="#ServerArgs-1665"><span class="linenos">1665</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1666"><a href="#ServerArgs-1666"><span class="linenos">1666</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1667"><a href="#ServerArgs-1667"><span class="linenos">1667</span></a>            <span class="s2">&quot;--ds-heavy-channel-num&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1668"><a href="#ServerArgs-1668"><span class="linenos">1668</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1669"><a href="#ServerArgs-1669"><span class="linenos">1669</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_channel_num</span><span class="p">,</span>
</span><span id="ServerArgs-1670"><a href="#ServerArgs-1670"><span class="linenos">1670</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1671"><a href="#ServerArgs-1671"><span class="linenos">1671</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1672"><a href="#ServerArgs-1672"><span class="linenos">1672</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1673"><a href="#ServerArgs-1673"><span class="linenos">1673</span></a>            <span class="s2">&quot;--ds-heavy-token-num&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1674"><a href="#ServerArgs-1674"><span class="linenos">1674</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1675"><a href="#ServerArgs-1675"><span class="linenos">1675</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_token_num</span><span class="p">,</span>
</span><span id="ServerArgs-1676"><a href="#ServerArgs-1676"><span class="linenos">1676</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of heavy tokens in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1677"><a href="#ServerArgs-1677"><span class="linenos">1677</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1678"><a href="#ServerArgs-1678"><span class="linenos">1678</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1679"><a href="#ServerArgs-1679"><span class="linenos">1679</span></a>            <span class="s2">&quot;--ds-heavy-channel-type&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1680"><a href="#ServerArgs-1680"><span class="linenos">1680</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1681"><a href="#ServerArgs-1681"><span class="linenos">1681</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_channel_type</span><span class="p">,</span>
</span><span id="ServerArgs-1682"><a href="#ServerArgs-1682"><span class="linenos">1682</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The type of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1683"><a href="#ServerArgs-1683"><span class="linenos">1683</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1684"><a href="#ServerArgs-1684"><span class="linenos">1684</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1685"><a href="#ServerArgs-1685"><span class="linenos">1685</span></a>            <span class="s2">&quot;--ds-sparse-decode-threshold&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1686"><a href="#ServerArgs-1686"><span class="linenos">1686</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1687"><a href="#ServerArgs-1687"><span class="linenos">1687</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_sparse_decode_threshold</span><span class="p">,</span>
</span><span id="ServerArgs-1688"><a href="#ServerArgs-1688"><span class="linenos">1688</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The type of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1689"><a href="#ServerArgs-1689"><span class="linenos">1689</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1690"><a href="#ServerArgs-1690"><span class="linenos">1690</span></a>
</span><span id="ServerArgs-1691"><a href="#ServerArgs-1691"><span class="linenos">1691</span></a>        <span class="c1"># Offloading</span>
</span><span id="ServerArgs-1692"><a href="#ServerArgs-1692"><span class="linenos">1692</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1693"><a href="#ServerArgs-1693"><span class="linenos">1693</span></a>            <span class="s2">&quot;--cpu-offload-gb&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1694"><a href="#ServerArgs-1694"><span class="linenos">1694</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1695"><a href="#ServerArgs-1695"><span class="linenos">1695</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">cpu_offload_gb</span><span class="p">,</span>
</span><span id="ServerArgs-1696"><a href="#ServerArgs-1696"><span class="linenos">1696</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How many GBs of RAM to reserve for CPU offloading.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1697"><a href="#ServerArgs-1697"><span class="linenos">1697</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1698"><a href="#ServerArgs-1698"><span class="linenos">1698</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1699"><a href="#ServerArgs-1699"><span class="linenos">1699</span></a>            <span class="s2">&quot;--offload-group-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1700"><a href="#ServerArgs-1700"><span class="linenos">1700</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1701"><a href="#ServerArgs-1701"><span class="linenos">1701</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_group_size</span><span class="p">,</span>
</span><span id="ServerArgs-1702"><a href="#ServerArgs-1702"><span class="linenos">1702</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers per group in offloading.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1703"><a href="#ServerArgs-1703"><span class="linenos">1703</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1704"><a href="#ServerArgs-1704"><span class="linenos">1704</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1705"><a href="#ServerArgs-1705"><span class="linenos">1705</span></a>            <span class="s2">&quot;--offload-num-in-group&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1706"><a href="#ServerArgs-1706"><span class="linenos">1706</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1707"><a href="#ServerArgs-1707"><span class="linenos">1707</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_num_in_group</span><span class="p">,</span>
</span><span id="ServerArgs-1708"><a href="#ServerArgs-1708"><span class="linenos">1708</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers to be offloaded within a group.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1709"><a href="#ServerArgs-1709"><span class="linenos">1709</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1710"><a href="#ServerArgs-1710"><span class="linenos">1710</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1711"><a href="#ServerArgs-1711"><span class="linenos">1711</span></a>            <span class="s2">&quot;--offload-prefetch-step&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1712"><a href="#ServerArgs-1712"><span class="linenos">1712</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1713"><a href="#ServerArgs-1713"><span class="linenos">1713</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_prefetch_step</span><span class="p">,</span>
</span><span id="ServerArgs-1714"><a href="#ServerArgs-1714"><span class="linenos">1714</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Steps to prefetch in offloading.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1715"><a href="#ServerArgs-1715"><span class="linenos">1715</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1716"><a href="#ServerArgs-1716"><span class="linenos">1716</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1717"><a href="#ServerArgs-1717"><span class="linenos">1717</span></a>            <span class="s2">&quot;--offload-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1718"><a href="#ServerArgs-1718"><span class="linenos">1718</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1719"><a href="#ServerArgs-1719"><span class="linenos">1719</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_mode</span><span class="p">,</span>
</span><span id="ServerArgs-1720"><a href="#ServerArgs-1720"><span class="linenos">1720</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mode of offloading.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1721"><a href="#ServerArgs-1721"><span class="linenos">1721</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1722"><a href="#ServerArgs-1722"><span class="linenos">1722</span></a>
</span><span id="ServerArgs-1723"><a href="#ServerArgs-1723"><span class="linenos">1723</span></a>        <span class="c1"># Optimization/debug options</span>
</span><span id="ServerArgs-1724"><a href="#ServerArgs-1724"><span class="linenos">1724</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1725"><a href="#ServerArgs-1725"><span class="linenos">1725</span></a>            <span class="s2">&quot;--disable-radix-cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1726"><a href="#ServerArgs-1726"><span class="linenos">1726</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1727"><a href="#ServerArgs-1727"><span class="linenos">1727</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable RadixAttention for prefix caching.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1728"><a href="#ServerArgs-1728"><span class="linenos">1728</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1729"><a href="#ServerArgs-1729"><span class="linenos">1729</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1730"><a href="#ServerArgs-1730"><span class="linenos">1730</span></a>            <span class="s2">&quot;--cuda-graph-max-bs&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1731"><a href="#ServerArgs-1731"><span class="linenos">1731</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1732"><a href="#ServerArgs-1732"><span class="linenos">1732</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span><span class="p">,</span>
</span><span id="ServerArgs-1733"><a href="#ServerArgs-1733"><span class="linenos">1733</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum batch size for cuda graph. It will extend the cuda graph capture batch size to this value.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1734"><a href="#ServerArgs-1734"><span class="linenos">1734</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1735"><a href="#ServerArgs-1735"><span class="linenos">1735</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1736"><a href="#ServerArgs-1736"><span class="linenos">1736</span></a>            <span class="s2">&quot;--cuda-graph-bs&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1737"><a href="#ServerArgs-1737"><span class="linenos">1737</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1738"><a href="#ServerArgs-1738"><span class="linenos">1738</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1739"><a href="#ServerArgs-1739"><span class="linenos">1739</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the list of batch sizes for cuda graph.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1740"><a href="#ServerArgs-1740"><span class="linenos">1740</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1741"><a href="#ServerArgs-1741"><span class="linenos">1741</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1742"><a href="#ServerArgs-1742"><span class="linenos">1742</span></a>            <span class="s2">&quot;--disable-cuda-graph&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1743"><a href="#ServerArgs-1743"><span class="linenos">1743</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1744"><a href="#ServerArgs-1744"><span class="linenos">1744</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable cuda graph.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1745"><a href="#ServerArgs-1745"><span class="linenos">1745</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1746"><a href="#ServerArgs-1746"><span class="linenos">1746</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1747"><a href="#ServerArgs-1747"><span class="linenos">1747</span></a>            <span class="s2">&quot;--disable-cuda-graph-padding&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1748"><a href="#ServerArgs-1748"><span class="linenos">1748</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1749"><a href="#ServerArgs-1749"><span class="linenos">1749</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable cuda graph when padding is needed. Still uses cuda graph when padding is not needed.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1750"><a href="#ServerArgs-1750"><span class="linenos">1750</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1751"><a href="#ServerArgs-1751"><span class="linenos">1751</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1752"><a href="#ServerArgs-1752"><span class="linenos">1752</span></a>            <span class="s2">&quot;--enable-profile-cuda-graph&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1753"><a href="#ServerArgs-1753"><span class="linenos">1753</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1754"><a href="#ServerArgs-1754"><span class="linenos">1754</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable profiling of cuda graph capture.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1755"><a href="#ServerArgs-1755"><span class="linenos">1755</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1756"><a href="#ServerArgs-1756"><span class="linenos">1756</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1757"><a href="#ServerArgs-1757"><span class="linenos">1757</span></a>            <span class="s2">&quot;--enable-cudagraph-gc&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1758"><a href="#ServerArgs-1758"><span class="linenos">1758</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1759"><a href="#ServerArgs-1759"><span class="linenos">1759</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable garbage collection during CUDA graph capture. If disabled (default), GC is frozen during capture to speed up the process.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1760"><a href="#ServerArgs-1760"><span class="linenos">1760</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1761"><a href="#ServerArgs-1761"><span class="linenos">1761</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1762"><a href="#ServerArgs-1762"><span class="linenos">1762</span></a>            <span class="s2">&quot;--enable-nccl-nvls&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1763"><a href="#ServerArgs-1763"><span class="linenos">1763</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1764"><a href="#ServerArgs-1764"><span class="linenos">1764</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable NCCL NVLS for prefill heavy requests when available.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1765"><a href="#ServerArgs-1765"><span class="linenos">1765</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1766"><a href="#ServerArgs-1766"><span class="linenos">1766</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1767"><a href="#ServerArgs-1767"><span class="linenos">1767</span></a>            <span class="s2">&quot;--enable-symm-mem&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1768"><a href="#ServerArgs-1768"><span class="linenos">1768</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1769"><a href="#ServerArgs-1769"><span class="linenos">1769</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable NCCL symmetric memory for fast collectives.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1770"><a href="#ServerArgs-1770"><span class="linenos">1770</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1771"><a href="#ServerArgs-1771"><span class="linenos">1771</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1772"><a href="#ServerArgs-1772"><span class="linenos">1772</span></a>            <span class="s2">&quot;--disable-flashinfer-cutlass-moe-fp4-allgather&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1773"><a href="#ServerArgs-1773"><span class="linenos">1773</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1774"><a href="#ServerArgs-1774"><span class="linenos">1774</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disables quantize before all-gather for flashinfer cutlass moe.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1775"><a href="#ServerArgs-1775"><span class="linenos">1775</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1776"><a href="#ServerArgs-1776"><span class="linenos">1776</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1777"><a href="#ServerArgs-1777"><span class="linenos">1777</span></a>            <span class="s2">&quot;--enable-tokenizer-batch-encode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1778"><a href="#ServerArgs-1778"><span class="linenos">1778</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1779"><a href="#ServerArgs-1779"><span class="linenos">1779</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable batch tokenization for improved performance when processing multiple text inputs. Do not use with image inputs, pre-tokenized input_ids, or input_embeds.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1780"><a href="#ServerArgs-1780"><span class="linenos">1780</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1781"><a href="#ServerArgs-1781"><span class="linenos">1781</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1782"><a href="#ServerArgs-1782"><span class="linenos">1782</span></a>            <span class="s2">&quot;--disable-outlines-disk-cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1783"><a href="#ServerArgs-1783"><span class="linenos">1783</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1784"><a href="#ServerArgs-1784"><span class="linenos">1784</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable disk cache of outlines to avoid possible crashes related to file system or high concurrency.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1785"><a href="#ServerArgs-1785"><span class="linenos">1785</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1786"><a href="#ServerArgs-1786"><span class="linenos">1786</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1787"><a href="#ServerArgs-1787"><span class="linenos">1787</span></a>            <span class="s2">&quot;--disable-custom-all-reduce&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1788"><a href="#ServerArgs-1788"><span class="linenos">1788</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1789"><a href="#ServerArgs-1789"><span class="linenos">1789</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the custom all-reduce kernel and fall back to NCCL.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1790"><a href="#ServerArgs-1790"><span class="linenos">1790</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1791"><a href="#ServerArgs-1791"><span class="linenos">1791</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1792"><a href="#ServerArgs-1792"><span class="linenos">1792</span></a>            <span class="s2">&quot;--enable-mscclpp&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1793"><a href="#ServerArgs-1793"><span class="linenos">1793</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1794"><a href="#ServerArgs-1794"><span class="linenos">1794</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable using mscclpp for small messages for all-reduce kernel and fall back to NCCL.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1795"><a href="#ServerArgs-1795"><span class="linenos">1795</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1796"><a href="#ServerArgs-1796"><span class="linenos">1796</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1797"><a href="#ServerArgs-1797"><span class="linenos">1797</span></a>            <span class="s2">&quot;--disable-overlap-schedule&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1798"><a href="#ServerArgs-1798"><span class="linenos">1798</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1799"><a href="#ServerArgs-1799"><span class="linenos">1799</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the overlap scheduler, which overlaps the CPU scheduler with GPU model worker.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1800"><a href="#ServerArgs-1800"><span class="linenos">1800</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1801"><a href="#ServerArgs-1801"><span class="linenos">1801</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1802"><a href="#ServerArgs-1802"><span class="linenos">1802</span></a>            <span class="s2">&quot;--enable-mixed-chunk&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1803"><a href="#ServerArgs-1803"><span class="linenos">1803</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1804"><a href="#ServerArgs-1804"><span class="linenos">1804</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling mixing prefill and decode in a batch when using chunked prefill.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1805"><a href="#ServerArgs-1805"><span class="linenos">1805</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1806"><a href="#ServerArgs-1806"><span class="linenos">1806</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1807"><a href="#ServerArgs-1807"><span class="linenos">1807</span></a>            <span class="s2">&quot;--enable-dp-attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1808"><a href="#ServerArgs-1808"><span class="linenos">1808</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1809"><a href="#ServerArgs-1809"><span class="linenos">1809</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling data parallelism for attention and tensor parallelism for FFN. The dp size should be equal to the tp size. Currently DeepSeek-V2 and Qwen 2/3 MoE models are supported.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1810"><a href="#ServerArgs-1810"><span class="linenos">1810</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1811"><a href="#ServerArgs-1811"><span class="linenos">1811</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1812"><a href="#ServerArgs-1812"><span class="linenos">1812</span></a>            <span class="s2">&quot;--enable-dp-lm-head&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1813"><a href="#ServerArgs-1813"><span class="linenos">1813</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1814"><a href="#ServerArgs-1814"><span class="linenos">1814</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable vocabulary parallel across the attention TP group to avoid all-gather across DP groups, optimizing performance under DP attention.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1815"><a href="#ServerArgs-1815"><span class="linenos">1815</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1816"><a href="#ServerArgs-1816"><span class="linenos">1816</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1817"><a href="#ServerArgs-1817"><span class="linenos">1817</span></a>            <span class="s2">&quot;--enable-two-batch-overlap&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1818"><a href="#ServerArgs-1818"><span class="linenos">1818</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1819"><a href="#ServerArgs-1819"><span class="linenos">1819</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling two micro batches to overlap.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1820"><a href="#ServerArgs-1820"><span class="linenos">1820</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1821"><a href="#ServerArgs-1821"><span class="linenos">1821</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1822"><a href="#ServerArgs-1822"><span class="linenos">1822</span></a>            <span class="s2">&quot;--tbo-token-distribution-threshold&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1823"><a href="#ServerArgs-1823"><span class="linenos">1823</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs-1824"><a href="#ServerArgs-1824"><span class="linenos">1824</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tbo_token_distribution_threshold</span><span class="p">,</span>
</span><span id="ServerArgs-1825"><a href="#ServerArgs-1825"><span class="linenos">1825</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The threshold of token distribution between two batches in micro-batch-overlap, determines whether to two-batch-overlap or two-chunk-overlap. Set to 0 denote disable two-chunk-overlap.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1826"><a href="#ServerArgs-1826"><span class="linenos">1826</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1827"><a href="#ServerArgs-1827"><span class="linenos">1827</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1828"><a href="#ServerArgs-1828"><span class="linenos">1828</span></a>            <span class="s2">&quot;--enable-torch-compile&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1829"><a href="#ServerArgs-1829"><span class="linenos">1829</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1830"><a href="#ServerArgs-1830"><span class="linenos">1830</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optimize the model with torch.compile. Experimental feature.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1831"><a href="#ServerArgs-1831"><span class="linenos">1831</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1832"><a href="#ServerArgs-1832"><span class="linenos">1832</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1833"><a href="#ServerArgs-1833"><span class="linenos">1833</span></a>            <span class="s2">&quot;--torch-compile-max-bs&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1834"><a href="#ServerArgs-1834"><span class="linenos">1834</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1835"><a href="#ServerArgs-1835"><span class="linenos">1835</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">torch_compile_max_bs</span><span class="p">,</span>
</span><span id="ServerArgs-1836"><a href="#ServerArgs-1836"><span class="linenos">1836</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum batch size when using torch compile.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1837"><a href="#ServerArgs-1837"><span class="linenos">1837</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1838"><a href="#ServerArgs-1838"><span class="linenos">1838</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1839"><a href="#ServerArgs-1839"><span class="linenos">1839</span></a>            <span class="s2">&quot;--torchao-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1840"><a href="#ServerArgs-1840"><span class="linenos">1840</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1841"><a href="#ServerArgs-1841"><span class="linenos">1841</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">torchao_config</span><span class="p">,</span>
</span><span id="ServerArgs-1842"><a href="#ServerArgs-1842"><span class="linenos">1842</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optimize the model with torchao. Experimental feature. Current choices are: int8dq, int8wo, int4wo-&lt;group_size&gt;, fp8wo, fp8dq-per_tensor, fp8dq-per_row&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1843"><a href="#ServerArgs-1843"><span class="linenos">1843</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1844"><a href="#ServerArgs-1844"><span class="linenos">1844</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1845"><a href="#ServerArgs-1845"><span class="linenos">1845</span></a>            <span class="s2">&quot;--enable-nan-detection&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1846"><a href="#ServerArgs-1846"><span class="linenos">1846</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1847"><a href="#ServerArgs-1847"><span class="linenos">1847</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable the NaN detection for debugging purposes.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1848"><a href="#ServerArgs-1848"><span class="linenos">1848</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1849"><a href="#ServerArgs-1849"><span class="linenos">1849</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1850"><a href="#ServerArgs-1850"><span class="linenos">1850</span></a>            <span class="s2">&quot;--enable-p2p-check&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1851"><a href="#ServerArgs-1851"><span class="linenos">1851</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1852"><a href="#ServerArgs-1852"><span class="linenos">1852</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable P2P check for GPU access, otherwise the p2p access is allowed by default.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1853"><a href="#ServerArgs-1853"><span class="linenos">1853</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1854"><a href="#ServerArgs-1854"><span class="linenos">1854</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1855"><a href="#ServerArgs-1855"><span class="linenos">1855</span></a>            <span class="s2">&quot;--triton-attention-reduce-in-fp32&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1856"><a href="#ServerArgs-1856"><span class="linenos">1856</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1857"><a href="#ServerArgs-1857"><span class="linenos">1857</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cast the intermediate attention results to fp32 to avoid possible crashes related to fp16.&quot;</span>
</span><span id="ServerArgs-1858"><a href="#ServerArgs-1858"><span class="linenos">1858</span></a>            <span class="s2">&quot;This only affects Triton attention kernels.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1859"><a href="#ServerArgs-1859"><span class="linenos">1859</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1860"><a href="#ServerArgs-1860"><span class="linenos">1860</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1861"><a href="#ServerArgs-1861"><span class="linenos">1861</span></a>            <span class="s2">&quot;--triton-attention-num-kv-splits&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1862"><a href="#ServerArgs-1862"><span class="linenos">1862</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1863"><a href="#ServerArgs-1863"><span class="linenos">1863</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">triton_attention_num_kv_splits</span><span class="p">,</span>
</span><span id="ServerArgs-1864"><a href="#ServerArgs-1864"><span class="linenos">1864</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of KV splits in flash decoding Triton kernel. Larger value is better in longer context scenarios. The default value is 8.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1865"><a href="#ServerArgs-1865"><span class="linenos">1865</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1866"><a href="#ServerArgs-1866"><span class="linenos">1866</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1867"><a href="#ServerArgs-1867"><span class="linenos">1867</span></a>            <span class="s2">&quot;--num-continuous-decode-steps&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1868"><a href="#ServerArgs-1868"><span class="linenos">1868</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1869"><a href="#ServerArgs-1869"><span class="linenos">1869</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">num_continuous_decode_steps</span><span class="p">,</span>
</span><span id="ServerArgs-1870"><a href="#ServerArgs-1870"><span class="linenos">1870</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run multiple continuous decoding steps to reduce scheduling overhead. &quot;</span>
</span><span id="ServerArgs-1871"><a href="#ServerArgs-1871"><span class="linenos">1871</span></a>            <span class="s2">&quot;This can potentially increase throughput but may also increase time-to-first-token latency. &quot;</span>
</span><span id="ServerArgs-1872"><a href="#ServerArgs-1872"><span class="linenos">1872</span></a>            <span class="s2">&quot;The default value is 1, meaning only run one decoding step at a time.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1873"><a href="#ServerArgs-1873"><span class="linenos">1873</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1874"><a href="#ServerArgs-1874"><span class="linenos">1874</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1875"><a href="#ServerArgs-1875"><span class="linenos">1875</span></a>            <span class="s2">&quot;--delete-ckpt-after-loading&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1876"><a href="#ServerArgs-1876"><span class="linenos">1876</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1877"><a href="#ServerArgs-1877"><span class="linenos">1877</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Delete the model checkpoint after loading the model.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1878"><a href="#ServerArgs-1878"><span class="linenos">1878</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1879"><a href="#ServerArgs-1879"><span class="linenos">1879</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1880"><a href="#ServerArgs-1880"><span class="linenos">1880</span></a>            <span class="s2">&quot;--enable-memory-saver&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1881"><a href="#ServerArgs-1881"><span class="linenos">1881</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1882"><a href="#ServerArgs-1882"><span class="linenos">1882</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow saving memory using release_memory_occupation and resume_memory_occupation&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1883"><a href="#ServerArgs-1883"><span class="linenos">1883</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1884"><a href="#ServerArgs-1884"><span class="linenos">1884</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1885"><a href="#ServerArgs-1885"><span class="linenos">1885</span></a>            <span class="s2">&quot;--allow-auto-truncate&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1886"><a href="#ServerArgs-1886"><span class="linenos">1886</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1887"><a href="#ServerArgs-1887"><span class="linenos">1887</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow automatically truncating requests that exceed the maximum input length instead of returning an error.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1888"><a href="#ServerArgs-1888"><span class="linenos">1888</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1889"><a href="#ServerArgs-1889"><span class="linenos">1889</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1890"><a href="#ServerArgs-1890"><span class="linenos">1890</span></a>            <span class="s2">&quot;--enable-custom-logit-processor&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1891"><a href="#ServerArgs-1891"><span class="linenos">1891</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1892"><a href="#ServerArgs-1892"><span class="linenos">1892</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable users to pass custom logit processors to the server (disabled by default for security)&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1893"><a href="#ServerArgs-1893"><span class="linenos">1893</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1894"><a href="#ServerArgs-1894"><span class="linenos">1894</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1895"><a href="#ServerArgs-1895"><span class="linenos">1895</span></a>            <span class="s2">&quot;--flashinfer-mla-disable-ragged&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1896"><a href="#ServerArgs-1896"><span class="linenos">1896</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1897"><a href="#ServerArgs-1897"><span class="linenos">1897</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Not using ragged prefill wrapper when running flashinfer mla&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1898"><a href="#ServerArgs-1898"><span class="linenos">1898</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1899"><a href="#ServerArgs-1899"><span class="linenos">1899</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1900"><a href="#ServerArgs-1900"><span class="linenos">1900</span></a>            <span class="s2">&quot;--disable-shared-experts-fusion&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1901"><a href="#ServerArgs-1901"><span class="linenos">1901</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1902"><a href="#ServerArgs-1902"><span class="linenos">1902</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable shared experts fusion optimization for deepseek v3/r1.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1903"><a href="#ServerArgs-1903"><span class="linenos">1903</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1904"><a href="#ServerArgs-1904"><span class="linenos">1904</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1905"><a href="#ServerArgs-1905"><span class="linenos">1905</span></a>            <span class="s2">&quot;--disable-chunked-prefix-cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1906"><a href="#ServerArgs-1906"><span class="linenos">1906</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1907"><a href="#ServerArgs-1907"><span class="linenos">1907</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable chunked prefix cache feature for deepseek, which should save overhead for short sequences.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1908"><a href="#ServerArgs-1908"><span class="linenos">1908</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1909"><a href="#ServerArgs-1909"><span class="linenos">1909</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1910"><a href="#ServerArgs-1910"><span class="linenos">1910</span></a>            <span class="s2">&quot;--disable-fast-image-processor&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1911"><a href="#ServerArgs-1911"><span class="linenos">1911</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1912"><a href="#ServerArgs-1912"><span class="linenos">1912</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Adopt base image processor instead of fast image processor.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1913"><a href="#ServerArgs-1913"><span class="linenos">1913</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1914"><a href="#ServerArgs-1914"><span class="linenos">1914</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1915"><a href="#ServerArgs-1915"><span class="linenos">1915</span></a>            <span class="s2">&quot;--enable-return-hidden-states&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1916"><a href="#ServerArgs-1916"><span class="linenos">1916</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1917"><a href="#ServerArgs-1917"><span class="linenos">1917</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable returning hidden states with responses.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1918"><a href="#ServerArgs-1918"><span class="linenos">1918</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1919"><a href="#ServerArgs-1919"><span class="linenos">1919</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1920"><a href="#ServerArgs-1920"><span class="linenos">1920</span></a>            <span class="s2">&quot;--scheduler-recv-interval&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1921"><a href="#ServerArgs-1921"><span class="linenos">1921</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1922"><a href="#ServerArgs-1922"><span class="linenos">1922</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">scheduler_recv_interval</span><span class="p">,</span>
</span><span id="ServerArgs-1923"><a href="#ServerArgs-1923"><span class="linenos">1923</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The interval to poll requests in scheduler. Can be set to &gt;1 to reduce the overhead of this.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1924"><a href="#ServerArgs-1924"><span class="linenos">1924</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1925"><a href="#ServerArgs-1925"><span class="linenos">1925</span></a>
</span><span id="ServerArgs-1926"><a href="#ServerArgs-1926"><span class="linenos">1926</span></a>        <span class="c1"># Debug tensor dumps</span>
</span><span id="ServerArgs-1927"><a href="#ServerArgs-1927"><span class="linenos">1927</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1928"><a href="#ServerArgs-1928"><span class="linenos">1928</span></a>            <span class="s2">&quot;--debug-tensor-dump-output-folder&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1929"><a href="#ServerArgs-1929"><span class="linenos">1929</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1930"><a href="#ServerArgs-1930"><span class="linenos">1930</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_output_folder</span><span class="p">,</span>
</span><span id="ServerArgs-1931"><a href="#ServerArgs-1931"><span class="linenos">1931</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output folder for dumping tensors.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1932"><a href="#ServerArgs-1932"><span class="linenos">1932</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1933"><a href="#ServerArgs-1933"><span class="linenos">1933</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1934"><a href="#ServerArgs-1934"><span class="linenos">1934</span></a>            <span class="s2">&quot;--debug-tensor-dump-input-file&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1935"><a href="#ServerArgs-1935"><span class="linenos">1935</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1936"><a href="#ServerArgs-1936"><span class="linenos">1936</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_input_file</span><span class="p">,</span>
</span><span id="ServerArgs-1937"><a href="#ServerArgs-1937"><span class="linenos">1937</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The input filename for dumping tensors&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1938"><a href="#ServerArgs-1938"><span class="linenos">1938</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1939"><a href="#ServerArgs-1939"><span class="linenos">1939</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1940"><a href="#ServerArgs-1940"><span class="linenos">1940</span></a>            <span class="s2">&quot;--debug-tensor-dump-inject&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1941"><a href="#ServerArgs-1941"><span class="linenos">1941</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1942"><a href="#ServerArgs-1942"><span class="linenos">1942</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_inject</span><span class="p">,</span>
</span><span id="ServerArgs-1943"><a href="#ServerArgs-1943"><span class="linenos">1943</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Inject the outputs from jax as the input of every layer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1944"><a href="#ServerArgs-1944"><span class="linenos">1944</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1945"><a href="#ServerArgs-1945"><span class="linenos">1945</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1946"><a href="#ServerArgs-1946"><span class="linenos">1946</span></a>            <span class="s2">&quot;--debug-tensor-dump-prefill-only&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1947"><a href="#ServerArgs-1947"><span class="linenos">1947</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1948"><a href="#ServerArgs-1948"><span class="linenos">1948</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only dump the tensors for prefill requests (i.e. batch size &gt; 1).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1949"><a href="#ServerArgs-1949"><span class="linenos">1949</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1950"><a href="#ServerArgs-1950"><span class="linenos">1950</span></a>
</span><span id="ServerArgs-1951"><a href="#ServerArgs-1951"><span class="linenos">1951</span></a>        <span class="c1"># PD disaggregation</span>
</span><span id="ServerArgs-1952"><a href="#ServerArgs-1952"><span class="linenos">1952</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1953"><a href="#ServerArgs-1953"><span class="linenos">1953</span></a>            <span class="s2">&quot;--disaggregation-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1954"><a href="#ServerArgs-1954"><span class="linenos">1954</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1955"><a href="#ServerArgs-1955"><span class="linenos">1955</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1956"><a href="#ServerArgs-1956"><span class="linenos">1956</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;prefill&quot;</span><span class="p">,</span> <span class="s2">&quot;decode&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1957"><a href="#ServerArgs-1957"><span class="linenos">1957</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only used for PD disaggregation. &quot;prefill&quot; for prefill-only server, and &quot;decode&quot; for decode-only server. If not specified, it is not PD disaggregated&#39;</span><span class="p">,</span>
</span><span id="ServerArgs-1958"><a href="#ServerArgs-1958"><span class="linenos">1958</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1959"><a href="#ServerArgs-1959"><span class="linenos">1959</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1960"><a href="#ServerArgs-1960"><span class="linenos">1960</span></a>            <span class="s2">&quot;--disaggregation-transfer-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1961"><a href="#ServerArgs-1961"><span class="linenos">1961</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1962"><a href="#ServerArgs-1962"><span class="linenos">1962</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_transfer_backend</span><span class="p">,</span>
</span><span id="ServerArgs-1963"><a href="#ServerArgs-1963"><span class="linenos">1963</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mooncake&quot;</span><span class="p">,</span> <span class="s2">&quot;nixl&quot;</span><span class="p">,</span> <span class="s2">&quot;ascend&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-1964"><a href="#ServerArgs-1964"><span class="linenos">1964</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The backend for disaggregation transfer. Default is mooncake.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1965"><a href="#ServerArgs-1965"><span class="linenos">1965</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1966"><a href="#ServerArgs-1966"><span class="linenos">1966</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1967"><a href="#ServerArgs-1967"><span class="linenos">1967</span></a>            <span class="s2">&quot;--disaggregation-bootstrap-port&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1968"><a href="#ServerArgs-1968"><span class="linenos">1968</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1969"><a href="#ServerArgs-1969"><span class="linenos">1969</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_bootstrap_port</span><span class="p">,</span>
</span><span id="ServerArgs-1970"><a href="#ServerArgs-1970"><span class="linenos">1970</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Bootstrap server port on the prefill server. Default is 8998.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1971"><a href="#ServerArgs-1971"><span class="linenos">1971</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1972"><a href="#ServerArgs-1972"><span class="linenos">1972</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1973"><a href="#ServerArgs-1973"><span class="linenos">1973</span></a>            <span class="s2">&quot;--disaggregation-decode-tp&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1974"><a href="#ServerArgs-1974"><span class="linenos">1974</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1975"><a href="#ServerArgs-1975"><span class="linenos">1975</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span><span class="p">,</span>
</span><span id="ServerArgs-1976"><a href="#ServerArgs-1976"><span class="linenos">1976</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Decode tp size. If not set, it matches the tp size of the current engine. This is only set on the prefill server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1977"><a href="#ServerArgs-1977"><span class="linenos">1977</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1978"><a href="#ServerArgs-1978"><span class="linenos">1978</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1979"><a href="#ServerArgs-1979"><span class="linenos">1979</span></a>            <span class="s2">&quot;--disaggregation-decode-dp&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1980"><a href="#ServerArgs-1980"><span class="linenos">1980</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1981"><a href="#ServerArgs-1981"><span class="linenos">1981</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span><span class="p">,</span>
</span><span id="ServerArgs-1982"><a href="#ServerArgs-1982"><span class="linenos">1982</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Decode dp size. If not set, it matches the dp size of the current engine. This is only set on the prefill server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1983"><a href="#ServerArgs-1983"><span class="linenos">1983</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1984"><a href="#ServerArgs-1984"><span class="linenos">1984</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1985"><a href="#ServerArgs-1985"><span class="linenos">1985</span></a>            <span class="s2">&quot;--disaggregation-prefill-pp&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1986"><a href="#ServerArgs-1986"><span class="linenos">1986</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-1987"><a href="#ServerArgs-1987"><span class="linenos">1987</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_prefill_pp</span><span class="p">,</span>
</span><span id="ServerArgs-1988"><a href="#ServerArgs-1988"><span class="linenos">1988</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Prefill pp size. If not set, it is default to 1. This is only set on the decode server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1989"><a href="#ServerArgs-1989"><span class="linenos">1989</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1990"><a href="#ServerArgs-1990"><span class="linenos">1990</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1991"><a href="#ServerArgs-1991"><span class="linenos">1991</span></a>            <span class="s2">&quot;--disaggregation-ib-device&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1992"><a href="#ServerArgs-1992"><span class="linenos">1992</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-1993"><a href="#ServerArgs-1993"><span class="linenos">1993</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_ib_device</span><span class="p">,</span>
</span><span id="ServerArgs-1994"><a href="#ServerArgs-1994"><span class="linenos">1994</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The InfiniBand devices for disaggregation transfer, accepts single device (e.g., --disaggregation-ib-device mlx5_0) &quot;</span>
</span><span id="ServerArgs-1995"><a href="#ServerArgs-1995"><span class="linenos">1995</span></a>            <span class="s2">&quot;or multiple comma-separated devices (e.g., --disaggregation-ib-device mlx5_0,mlx5_1). &quot;</span>
</span><span id="ServerArgs-1996"><a href="#ServerArgs-1996"><span class="linenos">1996</span></a>            <span class="s2">&quot;Default is None, which triggers automatic device detection when mooncake backend is enabled.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-1997"><a href="#ServerArgs-1997"><span class="linenos">1997</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-1998"><a href="#ServerArgs-1998"><span class="linenos">1998</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-1999"><a href="#ServerArgs-1999"><span class="linenos">1999</span></a>            <span class="s2">&quot;--num-reserved-decode-tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2000"><a href="#ServerArgs-2000"><span class="linenos">2000</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-2001"><a href="#ServerArgs-2001"><span class="linenos">2001</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">num_reserved_decode_tokens</span><span class="p">,</span>
</span><span id="ServerArgs-2002"><a href="#ServerArgs-2002"><span class="linenos">2002</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of decode tokens that will have memory reserved when adding new request to the running batch.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2003"><a href="#ServerArgs-2003"><span class="linenos">2003</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2004"><a href="#ServerArgs-2004"><span class="linenos">2004</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2005"><a href="#ServerArgs-2005"><span class="linenos">2005</span></a>            <span class="s2">&quot;--pdlb-url&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2006"><a href="#ServerArgs-2006"><span class="linenos">2006</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-2007"><a href="#ServerArgs-2007"><span class="linenos">2007</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-2008"><a href="#ServerArgs-2008"><span class="linenos">2008</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The URL of the PD disaggregation load balancer. If set, the prefill/decode server will register with the load balancer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2009"><a href="#ServerArgs-2009"><span class="linenos">2009</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2010"><a href="#ServerArgs-2010"><span class="linenos">2010</span></a>
</span><span id="ServerArgs-2011"><a href="#ServerArgs-2011"><span class="linenos">2011</span></a>        <span class="c1"># Custom weight loader</span>
</span><span id="ServerArgs-2012"><a href="#ServerArgs-2012"><span class="linenos">2012</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2013"><a href="#ServerArgs-2013"><span class="linenos">2013</span></a>            <span class="s2">&quot;--custom-weight-loader&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2014"><a href="#ServerArgs-2014"><span class="linenos">2014</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs-2015"><a href="#ServerArgs-2015"><span class="linenos">2015</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2016"><a href="#ServerArgs-2016"><span class="linenos">2016</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-2017"><a href="#ServerArgs-2017"><span class="linenos">2017</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The custom dataloader which used to update the model. Should be set with a valid import path, such as my_package.weight_load_func&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2018"><a href="#ServerArgs-2018"><span class="linenos">2018</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2019"><a href="#ServerArgs-2019"><span class="linenos">2019</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2020"><a href="#ServerArgs-2020"><span class="linenos">2020</span></a>            <span class="s2">&quot;--weight-loader-disable-mmap&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2021"><a href="#ServerArgs-2021"><span class="linenos">2021</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2022"><a href="#ServerArgs-2022"><span class="linenos">2022</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable mmap while loading weight using safetensors.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2023"><a href="#ServerArgs-2023"><span class="linenos">2023</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2024"><a href="#ServerArgs-2024"><span class="linenos">2024</span></a>
</span><span id="ServerArgs-2025"><a href="#ServerArgs-2025"><span class="linenos">2025</span></a>        <span class="c1"># For PD-Multiplexing</span>
</span><span id="ServerArgs-2026"><a href="#ServerArgs-2026"><span class="linenos">2026</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2027"><a href="#ServerArgs-2027"><span class="linenos">2027</span></a>            <span class="s2">&quot;--enable-pdmux&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2028"><a href="#ServerArgs-2028"><span class="linenos">2028</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2029"><a href="#ServerArgs-2029"><span class="linenos">2029</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable PD-Multiplexing, PD running on greenctx stream.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2030"><a href="#ServerArgs-2030"><span class="linenos">2030</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2031"><a href="#ServerArgs-2031"><span class="linenos">2031</span></a>
</span><span id="ServerArgs-2032"><a href="#ServerArgs-2032"><span class="linenos">2032</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2033"><a href="#ServerArgs-2033"><span class="linenos">2033</span></a>            <span class="s2">&quot;--sm-group-num&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2034"><a href="#ServerArgs-2034"><span class="linenos">2034</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs-2035"><a href="#ServerArgs-2035"><span class="linenos">2035</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">sm_group_num</span><span class="p">,</span>
</span><span id="ServerArgs-2036"><a href="#ServerArgs-2036"><span class="linenos">2036</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of sm partition groups.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2037"><a href="#ServerArgs-2037"><span class="linenos">2037</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2038"><a href="#ServerArgs-2038"><span class="linenos">2038</span></a>
</span><span id="ServerArgs-2039"><a href="#ServerArgs-2039"><span class="linenos">2039</span></a>        <span class="c1"># Deprecated arguments</span>
</span><span id="ServerArgs-2040"><a href="#ServerArgs-2040"><span class="linenos">2040</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2041"><a href="#ServerArgs-2041"><span class="linenos">2041</span></a>            <span class="s2">&quot;--enable-ep-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2042"><a href="#ServerArgs-2042"><span class="linenos">2042</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2043"><a href="#ServerArgs-2043"><span class="linenos">2043</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enabling expert parallelism for moe. The ep size is equal to the tp size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2044"><a href="#ServerArgs-2044"><span class="linenos">2044</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2045"><a href="#ServerArgs-2045"><span class="linenos">2045</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2046"><a href="#ServerArgs-2046"><span class="linenos">2046</span></a>            <span class="s2">&quot;--enable-deepep-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2047"><a href="#ServerArgs-2047"><span class="linenos">2047</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2048"><a href="#ServerArgs-2048"><span class="linenos">2048</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enabling DeepEP MoE implementation for EP MoE.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2049"><a href="#ServerArgs-2049"><span class="linenos">2049</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2050"><a href="#ServerArgs-2050"><span class="linenos">2050</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2051"><a href="#ServerArgs-2051"><span class="linenos">2051</span></a>            <span class="s2">&quot;--enable-flashinfer-cutlass-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2052"><a href="#ServerArgs-2052"><span class="linenos">2052</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2053"><a href="#ServerArgs-2053"><span class="linenos">2053</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer CUTLASS MoE backend for modelopt_fp4 quant on Blackwell. Supports MoE-EP&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2054"><a href="#ServerArgs-2054"><span class="linenos">2054</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2055"><a href="#ServerArgs-2055"><span class="linenos">2055</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2056"><a href="#ServerArgs-2056"><span class="linenos">2056</span></a>            <span class="s2">&quot;--enable-flashinfer-trtllm-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2057"><a href="#ServerArgs-2057"><span class="linenos">2057</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2058"><a href="#ServerArgs-2058"><span class="linenos">2058</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer TRTLLM MoE backend on Blackwell. Supports BlockScale FP8 MoE-EP&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2059"><a href="#ServerArgs-2059"><span class="linenos">2059</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2060"><a href="#ServerArgs-2060"><span class="linenos">2060</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2061"><a href="#ServerArgs-2061"><span class="linenos">2061</span></a>            <span class="s2">&quot;--enable-triton-kernel-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2062"><a href="#ServerArgs-2062"><span class="linenos">2062</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2063"><a href="#ServerArgs-2063"><span class="linenos">2063</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Use triton moe grouped gemm kernel.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2064"><a href="#ServerArgs-2064"><span class="linenos">2064</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2065"><a href="#ServerArgs-2065"><span class="linenos">2065</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs-2066"><a href="#ServerArgs-2066"><span class="linenos">2066</span></a>            <span class="s2">&quot;--enable-flashinfer-mxfp4-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2067"><a href="#ServerArgs-2067"><span class="linenos">2067</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2068"><a href="#ServerArgs-2068"><span class="linenos">2068</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer MXFP4 MoE backend for modelopt_fp4 quant on Blackwell.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2069"><a href="#ServerArgs-2069"><span class="linenos">2069</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2070"><a href="#ServerArgs-2070"><span class="linenos">2070</span></a>
</span><span id="ServerArgs-2071"><a href="#ServerArgs-2071"><span class="linenos">2071</span></a>    <span class="nd">@classmethod</span>
</span><span id="ServerArgs-2072"><a href="#ServerArgs-2072"><span class="linenos">2072</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_cli_args</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>
</span><span id="ServerArgs-2073"><a href="#ServerArgs-2073"><span class="linenos">2073</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tensor_parallel_size</span>
</span><span id="ServerArgs-2074"><a href="#ServerArgs-2074"><span class="linenos">2074</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">pp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pipeline_parallel_size</span>
</span><span id="ServerArgs-2075"><a href="#ServerArgs-2075"><span class="linenos">2075</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">data_parallel_size</span>
</span><span id="ServerArgs-2076"><a href="#ServerArgs-2076"><span class="linenos">2076</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">expert_parallel_size</span>
</span><span id="ServerArgs-2077"><a href="#ServerArgs-2077"><span class="linenos">2077</span></a>        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)]</span>
</span><span id="ServerArgs-2078"><a href="#ServerArgs-2078"><span class="linenos">2078</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">})</span>
</span><span id="ServerArgs-2079"><a href="#ServerArgs-2079"><span class="linenos">2079</span></a>
</span><span id="ServerArgs-2080"><a href="#ServerArgs-2080"><span class="linenos">2080</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs-2081"><a href="#ServerArgs-2081"><span class="linenos">2081</span></a>        <span class="k">if</span> <span class="n">is_valid_ipv6_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">):</span>
</span><span id="ServerArgs-2082"><a href="#ServerArgs-2082"><span class="linenos">2082</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;http://[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">]:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-2083"><a href="#ServerArgs-2083"><span class="linenos">2083</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-2084"><a href="#ServerArgs-2084"><span class="linenos">2084</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-2085"><a href="#ServerArgs-2085"><span class="linenos">2085</span></a>
</span><span id="ServerArgs-2086"><a href="#ServerArgs-2086"><span class="linenos">2086</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_hf_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs-2087"><a href="#ServerArgs-2087"><span class="linenos">2087</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ServerArgs-2088"><a href="#ServerArgs-2088"><span class="linenos">2088</span></a>        <span class="n">hf_config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span>
</span><span id="ServerArgs-2089"><a href="#ServerArgs-2089"><span class="linenos">2089</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span>
</span><span id="ServerArgs-2090"><a href="#ServerArgs-2090"><span class="linenos">2090</span></a>            <span class="n">trust_remote_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
</span><span id="ServerArgs-2091"><a href="#ServerArgs-2091"><span class="linenos">2091</span></a>            <span class="n">revision</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span>
</span><span id="ServerArgs-2092"><a href="#ServerArgs-2092"><span class="linenos">2092</span></a>            <span class="n">model_override_args</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_model_override_args</span><span class="p">),</span>
</span><span id="ServerArgs-2093"><a href="#ServerArgs-2093"><span class="linenos">2093</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ServerArgs-2094"><a href="#ServerArgs-2094"><span class="linenos">2094</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2095"><a href="#ServerArgs-2095"><span class="linenos">2095</span></a>        <span class="k">return</span> <span class="n">hf_config</span>
</span><span id="ServerArgs-2096"><a href="#ServerArgs-2096"><span class="linenos">2096</span></a>
</span><span id="ServerArgs-2097"><a href="#ServerArgs-2097"><span class="linenos">2097</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_server_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs-2098"><a href="#ServerArgs-2098"><span class="linenos">2098</span></a>        <span class="c1"># Check parallel size constraints</span>
</span><span id="ServerArgs-2099"><a href="#ServerArgs-2099"><span class="linenos">2099</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-2100"><a href="#ServerArgs-2100"><span class="linenos">2100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span>
</span><span id="ServerArgs-2101"><a href="#ServerArgs-2101"><span class="linenos">2101</span></a>        <span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tp_size must be divisible by number of nodes&quot;</span>
</span><span id="ServerArgs-2102"><a href="#ServerArgs-2102"><span class="linenos">2102</span></a>
</span><span id="ServerArgs-2103"><a href="#ServerArgs-2103"><span class="linenos">2103</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ServerArgs-2104"><a href="#ServerArgs-2104"><span class="linenos">2104</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-2105"><a href="#ServerArgs-2105"><span class="linenos">2105</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disable_overlap_schedule</span>
</span><span id="ServerArgs-2106"><a href="#ServerArgs-2106"><span class="linenos">2106</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ServerArgs-2107"><a href="#ServerArgs-2107"><span class="linenos">2107</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span>
</span><span id="ServerArgs-2108"><a href="#ServerArgs-2108"><span class="linenos">2108</span></a>            <span class="p">),</span> <span class="s2">&quot;Pipeline parallelism is not compatible with overlap schedule, speculative decoding, mixed chunked prefill.&quot;</span>
</span><span id="ServerArgs-2109"><a href="#ServerArgs-2109"><span class="linenos">2109</span></a>
</span><span id="ServerArgs-2110"><a href="#ServerArgs-2110"><span class="linenos">2110</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="ServerArgs-2111"><a href="#ServerArgs-2111"><span class="linenos">2111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span>
</span><span id="ServerArgs-2112"><a href="#ServerArgs-2112"><span class="linenos">2112</span></a>        <span class="p">),</span> <span class="s2">&quot;multi-node data parallel is not supported unless dp attention!&quot;</span>
</span><span id="ServerArgs-2113"><a href="#ServerArgs-2113"><span class="linenos">2113</span></a>
</span><span id="ServerArgs-2114"><a href="#ServerArgs-2114"><span class="linenos">2114</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_gpu_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;base_gpu_id must be non-negative&quot;</span>
</span><span id="ServerArgs-2115"><a href="#ServerArgs-2115"><span class="linenos">2115</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_id_step</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;gpu_id_step must be positive&quot;</span>
</span><span id="ServerArgs-2116"><a href="#ServerArgs-2116"><span class="linenos">2116</span></a>
</span><span id="ServerArgs-2117"><a href="#ServerArgs-2117"><span class="linenos">2117</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_dense_tp_size</span> <span class="ow">in</span> <span class="p">{</span>
</span><span id="ServerArgs-2118"><a href="#ServerArgs-2118"><span class="linenos">2118</span></a>            <span class="mi">1</span><span class="p">,</span>
</span><span id="ServerArgs-2119"><a href="#ServerArgs-2119"><span class="linenos">2119</span></a>            <span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs-2120"><a href="#ServerArgs-2120"><span class="linenos">2120</span></a>        <span class="p">},</span> <span class="s2">&quot;moe_dense_tp_size only support 1 and None currently&quot;</span>
</span><span id="ServerArgs-2121"><a href="#ServerArgs-2121"><span class="linenos">2121</span></a>
</span><span id="ServerArgs-2122"><a href="#ServerArgs-2122"><span class="linenos">2122</span></a>        <span class="c1"># Check LoRA</span>
</span><span id="ServerArgs-2123"><a href="#ServerArgs-2123"><span class="linenos">2123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_lora_server_args</span><span class="p">()</span>
</span><span id="ServerArgs-2124"><a href="#ServerArgs-2124"><span class="linenos">2124</span></a>
</span><span id="ServerArgs-2125"><a href="#ServerArgs-2125"><span class="linenos">2125</span></a>        <span class="c1"># Check speculative decoding</span>
</span><span id="ServerArgs-2126"><a href="#ServerArgs-2126"><span class="linenos">2126</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-2127"><a href="#ServerArgs-2127"><span class="linenos">2127</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-2128"><a href="#ServerArgs-2128"><span class="linenos">2128</span></a>                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span>
</span><span id="ServerArgs-2129"><a href="#ServerArgs-2129"><span class="linenos">2129</span></a>            <span class="p">),</span> <span class="s2">&quot;enable_mixed_chunk is required for speculative decoding&quot;</span>
</span><span id="ServerArgs-2130"><a href="#ServerArgs-2130"><span class="linenos">2130</span></a>
</span><span id="ServerArgs-2131"><a href="#ServerArgs-2131"><span class="linenos">2131</span></a>        <span class="c1"># Check chunked prefill</span>
</span><span id="ServerArgs-2132"><a href="#ServerArgs-2132"><span class="linenos">2132</span></a>        <span class="c1"># Skip validation if chunked prefill is disabled (i.e., size &lt;= 0).</span>
</span><span id="ServerArgs-2133"><a href="#ServerArgs-2133"><span class="linenos">2133</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ServerArgs-2134"><a href="#ServerArgs-2134"><span class="linenos">2134</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-2135"><a href="#ServerArgs-2135"><span class="linenos">2135</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="ServerArgs-2136"><a href="#ServerArgs-2136"><span class="linenos">2136</span></a>            <span class="p">),</span> <span class="s2">&quot;chunked_prefill_size must be divisible by page_size&quot;</span>
</span><span id="ServerArgs-2137"><a href="#ServerArgs-2137"><span class="linenos">2137</span></a>
</span><span id="ServerArgs-2138"><a href="#ServerArgs-2138"><span class="linenos">2138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_lora_server_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs-2139"><a href="#ServerArgs-2139"><span class="linenos">2139</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max_loras_per_batch must be positive&quot;</span>
</span><span id="ServerArgs-2140"><a href="#ServerArgs-2140"><span class="linenos">2140</span></a>
</span><span id="ServerArgs-2141"><a href="#ServerArgs-2141"><span class="linenos">2141</span></a>        <span class="c1"># Enable LoRA if any LoRA paths are provided for backward compatibility.</span>
</span><span id="ServerArgs-2142"><a href="#ServerArgs-2142"><span class="linenos">2142</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">:</span>
</span><span id="ServerArgs-2143"><a href="#ServerArgs-2143"><span class="linenos">2143</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-2144"><a href="#ServerArgs-2144"><span class="linenos">2144</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-2145"><a href="#ServerArgs-2145"><span class="linenos">2145</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-2146"><a href="#ServerArgs-2146"><span class="linenos">2146</span></a>                    <span class="s2">&quot;--enable-lora is set to True because --lora-paths is provided.&quot;</span>
</span><span id="ServerArgs-2147"><a href="#ServerArgs-2147"><span class="linenos">2147</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-2148"><a href="#ServerArgs-2148"><span class="linenos">2148</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="ServerArgs-2149"><a href="#ServerArgs-2149"><span class="linenos">2149</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-2150"><a href="#ServerArgs-2150"><span class="linenos">2150</span></a>                    <span class="s2">&quot;--enable-lora is set to False, any provided lora_paths will be ignored.&quot;</span>
</span><span id="ServerArgs-2151"><a href="#ServerArgs-2151"><span class="linenos">2151</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-2152"><a href="#ServerArgs-2152"><span class="linenos">2152</span></a>
</span><span id="ServerArgs-2153"><a href="#ServerArgs-2153"><span class="linenos">2153</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span><span class="p">:</span>
</span><span id="ServerArgs-2154"><a href="#ServerArgs-2154"><span class="linenos">2154</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ServerArgs-2155"><a href="#ServerArgs-2155"><span class="linenos">2155</span></a>                <span class="n">lora_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span>
</span><span id="ServerArgs-2156"><a href="#ServerArgs-2156"><span class="linenos">2156</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ServerArgs-2157"><a href="#ServerArgs-2157"><span class="linenos">2157</span></a>                <span class="k">for</span> <span class="n">lora_path</span> <span class="ow">in</span> <span class="n">lora_paths</span><span class="p">:</span>
</span><span id="ServerArgs-2158"><a href="#ServerArgs-2158"><span class="linenos">2158</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lora_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ServerArgs-2159"><a href="#ServerArgs-2159"><span class="linenos">2159</span></a>                        <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span><span class="p">:</span>
</span><span id="ServerArgs-2160"><a href="#ServerArgs-2160"><span class="linenos">2160</span></a>                            <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ServerArgs-2161"><a href="#ServerArgs-2161"><span class="linenos">2161</span></a>                            <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="ServerArgs-2162"><a href="#ServerArgs-2162"><span class="linenos">2162</span></a>                                <span class="n">lora_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ServerArgs-2163"><a href="#ServerArgs-2163"><span class="linenos">2163</span></a>                            <span class="p">)</span>
</span><span id="ServerArgs-2164"><a href="#ServerArgs-2164"><span class="linenos">2164</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-2165"><a href="#ServerArgs-2165"><span class="linenos">2165</span></a>                            <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="ServerArgs-2166"><a href="#ServerArgs-2166"><span class="linenos">2166</span></a>                                <span class="n">lora_name</span><span class="o">=</span><span class="n">lora_path</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">lora_path</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ServerArgs-2167"><a href="#ServerArgs-2167"><span class="linenos">2167</span></a>                            <span class="p">)</span>
</span><span id="ServerArgs-2168"><a href="#ServerArgs-2168"><span class="linenos">2168</span></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lora_path</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="ServerArgs-2169"><a href="#ServerArgs-2169"><span class="linenos">2169</span></a>                        <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-2170"><a href="#ServerArgs-2170"><span class="linenos">2170</span></a>                            <span class="s2">&quot;lora_name&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span> <span class="ow">and</span> <span class="s2">&quot;lora_path&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span>
</span><span id="ServerArgs-2171"><a href="#ServerArgs-2171"><span class="linenos">2171</span></a>                        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;When providing LoRA paths as a list of dict, each dict should contain &#39;lora_name&#39; and &#39;lora_path&#39; keys. Got: </span><span class="si">{</span><span class="n">lora_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-2172"><a href="#ServerArgs-2172"><span class="linenos">2172</span></a>                        <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="ServerArgs-2173"><a href="#ServerArgs-2173"><span class="linenos">2173</span></a>                            <span class="n">lora_name</span><span class="o">=</span><span class="n">lora_path</span><span class="p">[</span><span class="s2">&quot;lora_name&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-2174"><a href="#ServerArgs-2174"><span class="linenos">2174</span></a>                            <span class="n">lora_path</span><span class="o">=</span><span class="n">lora_path</span><span class="p">[</span><span class="s2">&quot;lora_path&quot;</span><span class="p">],</span>
</span><span id="ServerArgs-2175"><a href="#ServerArgs-2175"><span class="linenos">2175</span></a>                            <span class="n">pinned</span><span class="o">=</span><span class="n">lora_path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pinned&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="ServerArgs-2176"><a href="#ServerArgs-2176"><span class="linenos">2176</span></a>                        <span class="p">)</span>
</span><span id="ServerArgs-2177"><a href="#ServerArgs-2177"><span class="linenos">2177</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-2178"><a href="#ServerArgs-2178"><span class="linenos">2178</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs-2179"><a href="#ServerArgs-2179"><span class="linenos">2179</span></a>                            <span class="sa">f</span><span class="s2">&quot;Invalid type for item in --lora-paths list: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
</span><span id="ServerArgs-2180"><a href="#ServerArgs-2180"><span class="linenos">2180</span></a>                            <span class="s2">&quot;Expected a string or a dictionary.&quot;</span>
</span><span id="ServerArgs-2181"><a href="#ServerArgs-2181"><span class="linenos">2181</span></a>                        <span class="p">)</span>
</span><span id="ServerArgs-2182"><a href="#ServerArgs-2182"><span class="linenos">2182</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lora_ref</span><span class="p">)</span>
</span><span id="ServerArgs-2183"><a href="#ServerArgs-2183"><span class="linenos">2183</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="ServerArgs-2184"><a href="#ServerArgs-2184"><span class="linenos">2184</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ServerArgs-2185"><a href="#ServerArgs-2185"><span class="linenos">2185</span></a>                    <span class="n">LoRARef</span><span class="p">(</span><span class="n">lora_name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ServerArgs-2186"><a href="#ServerArgs-2186"><span class="linenos">2186</span></a>                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="ServerArgs-2187"><a href="#ServerArgs-2187"><span class="linenos">2187</span></a>                <span class="p">]</span>
</span><span id="ServerArgs-2188"><a href="#ServerArgs-2188"><span class="linenos">2188</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-2189"><a href="#ServerArgs-2189"><span class="linenos">2189</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ServerArgs-2190"><a href="#ServerArgs-2190"><span class="linenos">2190</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-2191"><a href="#ServerArgs-2191"><span class="linenos">2191</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs-2192"><a href="#ServerArgs-2192"><span class="linenos">2192</span></a>                    <span class="sa">f</span><span class="s2">&quot;Invalid type for --lora-paths: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
</span><span id="ServerArgs-2193"><a href="#ServerArgs-2193"><span class="linenos">2193</span></a>                    <span class="s2">&quot;Expected a list or a dictionary.&quot;</span>
</span><span id="ServerArgs-2194"><a href="#ServerArgs-2194"><span class="linenos">2194</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-2195"><a href="#ServerArgs-2195"><span class="linenos">2195</span></a>
</span><span id="ServerArgs-2196"><a href="#ServerArgs-2196"><span class="linenos">2196</span></a>            <span class="c1"># Expand target modules</span>
</span><span id="ServerArgs-2197"><a href="#ServerArgs-2197"><span class="linenos">2197</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">:</span>
</span><span id="ServerArgs-2198"><a href="#ServerArgs-2198"><span class="linenos">2198</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">)</span>
</span><span id="ServerArgs-2199"><a href="#ServerArgs-2199"><span class="linenos">2199</span></a>                <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">:</span>
</span><span id="ServerArgs-2200"><a href="#ServerArgs-2200"><span class="linenos">2200</span></a>                    <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-2201"><a href="#ServerArgs-2201"><span class="linenos">2201</span></a>                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="ServerArgs-2202"><a href="#ServerArgs-2202"><span class="linenos">2202</span></a>                    <span class="p">),</span> <span class="s2">&quot;If &#39;all&#39; is specified in --lora-target-modules, it should be the only module specified.&quot;</span>
</span><span id="ServerArgs-2203"><a href="#ServerArgs-2203"><span class="linenos">2203</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">SUPPORTED_LORA_TARGET_MODULES</span><span class="p">)</span>
</span><span id="ServerArgs-2204"><a href="#ServerArgs-2204"><span class="linenos">2204</span></a>
</span><span id="ServerArgs-2205"><a href="#ServerArgs-2205"><span class="linenos">2205</span></a>            <span class="c1"># Ensure sufficient information is provided for LoRA initialization.</span>
</span><span id="ServerArgs-2206"><a href="#ServerArgs-2206"><span class="linenos">2206</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="ServerArgs-2207"><a href="#ServerArgs-2207"><span class="linenos">2207</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_lora_rank</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span>
</span><span id="ServerArgs-2208"><a href="#ServerArgs-2208"><span class="linenos">2208</span></a>            <span class="p">),</span> <span class="s2">&quot;When no initial --lora-paths is provided, you need to specify both --max-lora-rank and --lora-target-modules for LoRA initialization.&quot;</span>
</span><span id="ServerArgs-2209"><a href="#ServerArgs-2209"><span class="linenos">2209</span></a>
</span><span id="ServerArgs-2210"><a href="#ServerArgs-2210"><span class="linenos">2210</span></a>            <span class="c1"># Validate max_loaded_loras</span>
</span><span id="ServerArgs-2211"><a href="#ServerArgs-2211"><span class="linenos">2211</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-2212"><a href="#ServerArgs-2212"><span class="linenos">2212</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span><span class="p">,</span> <span class="p">(</span>
</span><span id="ServerArgs-2213"><a href="#ServerArgs-2213"><span class="linenos">2213</span></a>                    <span class="s2">&quot;max_loaded_loras should be greater than or equal to max_loras_per_batch. &quot;</span>
</span><span id="ServerArgs-2214"><a href="#ServerArgs-2214"><span class="linenos">2214</span></a>                    <span class="sa">f</span><span class="s2">&quot;max_loaded_loras=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="si">}</span><span class="s2">, max_loras_per_batch=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-2215"><a href="#ServerArgs-2215"><span class="linenos">2215</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-2216"><a href="#ServerArgs-2216"><span class="linenos">2216</span></a>                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="p">,</span> <span class="p">(</span>
</span><span id="ServerArgs-2217"><a href="#ServerArgs-2217"><span class="linenos">2217</span></a>                    <span class="s2">&quot;The number of LoRA paths should not exceed max_loaded_loras. &quot;</span>
</span><span id="ServerArgs-2218"><a href="#ServerArgs-2218"><span class="linenos">2218</span></a>                    <span class="sa">f</span><span class="s2">&quot;max_loaded_loras=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="si">}</span><span class="s2">, lora_paths=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-2219"><a href="#ServerArgs-2219"><span class="linenos">2219</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-2220"><a href="#ServerArgs-2220"><span class="linenos">2220</span></a>
</span><span id="ServerArgs-2221"><a href="#ServerArgs-2221"><span class="linenos">2221</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_disagg_tp_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">decode_tp</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="ServerArgs-2222"><a href="#ServerArgs-2222"><span class="linenos">2222</span></a>        <span class="n">larger_tp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">decode_tp</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">)</span>
</span><span id="ServerArgs-2223"><a href="#ServerArgs-2223"><span class="linenos">2223</span></a>        <span class="n">smaller_tp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">decode_tp</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">)</span>
</span><span id="ServerArgs-2224"><a href="#ServerArgs-2224"><span class="linenos">2224</span></a>        <span class="k">assert</span> <span class="n">larger_tp</span> <span class="o">%</span> <span class="n">smaller_tp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
</span><span id="ServerArgs-2225"><a href="#ServerArgs-2225"><span class="linenos">2225</span></a>            <span class="s2">&quot;Different tp size is supported only when one tp is multiple of the other. &quot;</span>
</span><span id="ServerArgs-2226"><a href="#ServerArgs-2226"><span class="linenos">2226</span></a>            <span class="sa">f</span><span class="s2">&quot;decode_tp=</span><span class="si">{</span><span class="n">decode_tp</span><span class="si">}</span><span class="s2">, prefill_tp=</span><span class="si">{</span><span class="n">prefill_tp</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs-2227"><a href="#ServerArgs-2227"><span class="linenos">2227</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2228"><a href="#ServerArgs-2228"><span class="linenos">2228</span></a>
</span><span id="ServerArgs-2229"><a href="#ServerArgs-2229"><span class="linenos">2229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">model_specific_adjustments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs-2230"><a href="#ServerArgs-2230"><span class="linenos">2230</span></a>        <span class="n">hf_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hf_config</span><span class="p">()</span>
</span><span id="ServerArgs-2231"><a href="#ServerArgs-2231"><span class="linenos">2231</span></a>        <span class="n">model_arch</span> <span class="o">=</span> <span class="n">hf_config</span><span class="o">.</span><span class="n">architectures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ServerArgs-2232"><a href="#ServerArgs-2232"><span class="linenos">2232</span></a>        <span class="k">if</span> <span class="n">model_arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GptOssForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="ServerArgs-2233"><a href="#ServerArgs-2233"><span class="linenos">2233</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-2234"><a href="#ServerArgs-2234"><span class="linenos">2234</span></a>                <span class="k">if</span> <span class="n">is_cuda</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="ServerArgs-2235"><a href="#ServerArgs-2235"><span class="linenos">2235</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="ServerArgs-2236"><a href="#ServerArgs-2236"><span class="linenos">2236</span></a>                <span class="k">elif</span> <span class="n">is_cuda</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sm90_supported</span><span class="p">():</span>
</span><span id="ServerArgs-2237"><a href="#ServerArgs-2237"><span class="linenos">2237</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;fa3&quot;</span>
</span><span id="ServerArgs-2238"><a href="#ServerArgs-2238"><span class="linenos">2238</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-2239"><a href="#ServerArgs-2239"><span class="linenos">2239</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;triton&quot;</span>
</span><span id="ServerArgs-2240"><a href="#ServerArgs-2240"><span class="linenos">2240</span></a>            <span class="n">supported_backends</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;triton&quot;</span><span class="p">,</span> <span class="s2">&quot;trtllm_mha&quot;</span><span class="p">,</span> <span class="s2">&quot;fa3&quot;</span><span class="p">]</span>
</span><span id="ServerArgs-2241"><a href="#ServerArgs-2241"><span class="linenos">2241</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="ServerArgs-2242"><a href="#ServerArgs-2242"><span class="linenos">2242</span></a>                <span class="sa">f</span><span class="s2">&quot;Use </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span><span class="si">}</span><span class="s2"> as attention backend for GptOssForCausalLM&quot;</span>
</span><span id="ServerArgs-2243"><a href="#ServerArgs-2243"><span class="linenos">2243</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-2244"><a href="#ServerArgs-2244"><span class="linenos">2244</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-2245"><a href="#ServerArgs-2245"><span class="linenos">2245</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">in</span> <span class="n">supported_backends</span>
</span><span id="ServerArgs-2246"><a href="#ServerArgs-2246"><span class="linenos">2246</span></a>            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;GptOssForCausalLM requires one of </span><span class="si">{</span><span class="n">supported_backends</span><span class="si">}</span><span class="s2"> attention backend, but got &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="ServerArgs-2247"><a href="#ServerArgs-2247"><span class="linenos">2247</span></a>
</span><span id="ServerArgs-2248"><a href="#ServerArgs-2248"><span class="linenos">2248</span></a>            <span class="k">if</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="ServerArgs-2249"><a href="#ServerArgs-2249"><span class="linenos">2249</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="ServerArgs-2250"><a href="#ServerArgs-2250"><span class="linenos">2250</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_allreduce_fusion</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-2251"><a href="#ServerArgs-2251"><span class="linenos">2251</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="ServerArgs-2252"><a href="#ServerArgs-2252"><span class="linenos">2252</span></a>                        <span class="s2">&quot;Enable FlashInfer AllReduce Fusion on sm100 for GptOssForCausalLM&quot;</span>
</span><span id="ServerArgs-2253"><a href="#ServerArgs-2253"><span class="linenos">2253</span></a>                    <span class="p">)</span>
</span><span id="ServerArgs-2254"><a href="#ServerArgs-2254"><span class="linenos">2254</span></a>            <span class="n">quantization_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hf_config</span><span class="p">,</span> <span class="s2">&quot;quantization_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ServerArgs-2255"><a href="#ServerArgs-2255"><span class="linenos">2255</span></a>            <span class="n">is_mxfp4_quant_format</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs-2256"><a href="#ServerArgs-2256"><span class="linenos">2256</span></a>                <span class="n">quantization_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="ServerArgs-2257"><a href="#ServerArgs-2257"><span class="linenos">2257</span></a>                <span class="ow">and</span> <span class="n">quantization_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quant_method&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mxfp4&quot;</span>
</span><span id="ServerArgs-2258"><a href="#ServerArgs-2258"><span class="linenos">2258</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-2259"><a href="#ServerArgs-2259"><span class="linenos">2259</span></a>
</span><span id="ServerArgs-2260"><a href="#ServerArgs-2260"><span class="linenos">2260</span></a>            <span class="k">if</span> <span class="n">is_sm100_supported</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_mxfp4_quant_format</span><span class="p">:</span>
</span><span id="ServerArgs-2261"><a href="#ServerArgs-2261"><span class="linenos">2261</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_mxfp4&quot;</span>
</span><span id="ServerArgs-2262"><a href="#ServerArgs-2262"><span class="linenos">2262</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-2263"><a href="#ServerArgs-2263"><span class="linenos">2263</span></a>                    <span class="s2">&quot;Detected SM100 and MXFP4 quantization format for GPT-OSS model, enabling FlashInfer MXFP4 MOE kernel.&quot;</span>
</span><span id="ServerArgs-2264"><a href="#ServerArgs-2264"><span class="linenos">2264</span></a>                <span class="p">)</span>
</span><span id="ServerArgs-2265"><a href="#ServerArgs-2265"><span class="linenos">2265</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs-2266"><a href="#ServerArgs-2266"><span class="linenos">2266</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;triton_kernel&quot;</span><span class="p">:</span>
</span><span id="ServerArgs-2267"><a href="#ServerArgs-2267"><span class="linenos">2267</span></a>                    <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs-2268"><a href="#ServerArgs-2268"><span class="linenos">2268</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="ServerArgs-2269"><a href="#ServerArgs-2269"><span class="linenos">2269</span></a>                    <span class="p">),</span> <span class="s2">&quot;Triton kernel MoE is only supported when ep_size == 1&quot;</span>
</span><span id="ServerArgs-2270"><a href="#ServerArgs-2270"><span class="linenos">2270</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs-2271"><a href="#ServerArgs-2271"><span class="linenos">2271</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs-2272"><a href="#ServerArgs-2272"><span class="linenos">2272</span></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="ServerArgs-2273"><a href="#ServerArgs-2273"><span class="linenos">2273</span></a>                    <span class="ow">and</span> <span class="n">is_triton_kernels_available</span><span class="p">()</span>
</span><span id="ServerArgs-2274"><a href="#ServerArgs-2274"><span class="linenos">2274</span></a>                <span class="p">):</span>
</span><span id="ServerArgs-2275"><a href="#ServerArgs-2275"><span class="linenos">2275</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;triton_kernel&quot;</span>
</span><span id="ServerArgs-2276"><a href="#ServerArgs-2276"><span class="linenos">2276</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-2277"><a href="#ServerArgs-2277"><span class="linenos">2277</span></a>                        <span class="s2">&quot;Detected GPT-OSS model, enabling triton_kernels MOE kernel.&quot;</span>
</span><span id="ServerArgs-2278"><a href="#ServerArgs-2278"><span class="linenos">2278</span></a>                    <span class="p">)</span>
</span><span id="ServerArgs-2279"><a href="#ServerArgs-2279"><span class="linenos">2279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_hybrid_swa_memory</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-2280"><a href="#ServerArgs-2280"><span class="linenos">2280</span></a>            <span class="k">if</span> <span class="n">is_mxfp4_quant_format</span><span class="p">:</span>
</span><span id="ServerArgs-2281"><a href="#ServerArgs-2281"><span class="linenos">2281</span></a>                <span class="c1"># use bf16 for mxfp4 triton kernels</span>
</span><span id="ServerArgs-2282"><a href="#ServerArgs-2282"><span class="linenos">2282</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;bfloat16&quot;</span>
</span><span id="ServerArgs-2283"><a href="#ServerArgs-2283"><span class="linenos">2283</span></a>
</span><span id="ServerArgs-2284"><a href="#ServerArgs-2284"><span class="linenos">2284</span></a>        <span class="k">elif</span> <span class="s2">&quot;Llama4&quot;</span> <span class="ow">in</span> <span class="n">model_arch</span><span class="p">:</span>
</span><span id="ServerArgs-2285"><a href="#ServerArgs-2285"><span class="linenos">2285</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">in</span> <span class="p">{</span>
</span><span id="ServerArgs-2286"><a href="#ServerArgs-2286"><span class="linenos">2286</span></a>                <span class="s2">&quot;fa3&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2287"><a href="#ServerArgs-2287"><span class="linenos">2287</span></a>                <span class="s2">&quot;aiter&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2288"><a href="#ServerArgs-2288"><span class="linenos">2288</span></a>            <span class="p">},</span> <span class="s2">&quot;fa3 or aiter is required for Llama4 model&quot;</span>
</span><span id="ServerArgs-2289"><a href="#ServerArgs-2289"><span class="linenos">2289</span></a>        <span class="k">elif</span> <span class="n">model_arch</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="ServerArgs-2290"><a href="#ServerArgs-2290"><span class="linenos">2290</span></a>            <span class="s2">&quot;Gemma2ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2291"><a href="#ServerArgs-2291"><span class="linenos">2291</span></a>            <span class="s2">&quot;Gemma3ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2292"><a href="#ServerArgs-2292"><span class="linenos">2292</span></a>            <span class="s2">&quot;Gemma3ForConditionalGeneration&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2293"><a href="#ServerArgs-2293"><span class="linenos">2293</span></a>            <span class="s2">&quot;Gemma3nForCausalLM&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2294"><a href="#ServerArgs-2294"><span class="linenos">2294</span></a>            <span class="s2">&quot;Gemma3nForConditionalGeneration&quot;</span><span class="p">,</span>
</span><span id="ServerArgs-2295"><a href="#ServerArgs-2295"><span class="linenos">2295</span></a>        <span class="p">]:</span>
</span><span id="ServerArgs-2296"><a href="#ServerArgs-2296"><span class="linenos">2296</span></a>            <span class="c1"># FIXME: https://github.com/sgl-project/sglang/pull/7367 is not compatible with gemma2 model.</span>
</span><span id="ServerArgs-2297"><a href="#ServerArgs-2297"><span class="linenos">2297</span></a>            <span class="c1"># It failed at this test: https://github.com/sgl-project/sglang/actions/runs/16255155597/job/45890331952#step:4:736</span>
</span><span id="ServerArgs-2298"><a href="#ServerArgs-2298"><span class="linenos">2298</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs-2299"><a href="#ServerArgs-2299"><span class="linenos">2299</span></a>                <span class="sa">f</span><span class="s2">&quot;Disable hybrid SWA memory for </span><span class="si">{</span><span class="n">model_arch</span><span class="si">}</span><span class="s2"> as it is not yet supported.&quot;</span>
</span><span id="ServerArgs-2300"><a href="#ServerArgs-2300"><span class="linenos">2300</span></a>            <span class="p">)</span>
</span><span id="ServerArgs-2301"><a href="#ServerArgs-2301"><span class="linenos">2301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_hybrid_swa_memory</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs-2302"><a href="#ServerArgs-2302"><span class="linenos">2302</span></a>
</span><span id="ServerArgs-2303"><a href="#ServerArgs-2303"><span class="linenos">2303</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_mem_fraction_for_vlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_config</span><span class="p">):</span>
</span><span id="ServerArgs-2304"><a href="#ServerArgs-2304"><span class="linenos">2304</span></a>        <span class="n">vision_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">hf_config</span><span class="p">,</span> <span class="s2">&quot;vision_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ServerArgs-2305"><a href="#ServerArgs-2305"><span class="linenos">2305</span></a>        <span class="k">if</span> <span class="n">vision_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs-2306"><a href="#ServerArgs-2306"><span class="linenos">2306</span></a>            <span class="k">return</span>
</span><span id="ServerArgs-2307"><a href="#ServerArgs-2307"><span class="linenos">2307</span></a>
</span><span id="ServerArgs-2308"><a href="#ServerArgs-2308"><span class="linenos">2308</span></a>        <span class="c1"># roughly reduce the mem_fraction_static base on params of Vit</span>
</span><span id="ServerArgs-2309"><a href="#ServerArgs-2309"><span class="linenos">2309</span></a>        <span class="n">original_server_arg_mem_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span>
</span><span id="ServerArgs-2310"><a href="#ServerArgs-2310"><span class="linenos">2310</span></a>        <span class="c1"># a base mem_fraction_static factor for regular Vit</span>
</span><span id="ServerArgs-2311"><a href="#ServerArgs-2311"><span class="linenos">2311</span></a>        <span class="n">base_mem_fraction_reduction_ratio</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="ServerArgs-2312"><a href="#ServerArgs-2312"><span class="linenos">2312</span></a>
</span><span id="ServerArgs-2313"><a href="#ServerArgs-2313"><span class="linenos">2313</span></a>        <span class="n">vit_num_layers</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vision_config</span><span class="p">,</span> <span class="s2">&quot;num_hidden_layers&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
</span><span id="ServerArgs-2314"><a href="#ServerArgs-2314"><span class="linenos">2314</span></a>        <span class="n">vit_hidden_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vision_config</span><span class="p">,</span> <span class="s2">&quot;hidden_size&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span><span id="ServerArgs-2315"><a href="#ServerArgs-2315"><span class="linenos">2315</span></a>
</span><span id="ServerArgs-2316"><a href="#ServerArgs-2316"><span class="linenos">2316</span></a>        <span class="c1"># baseline ViT params (ViT-L/14)</span>
</span><span id="ServerArgs-2317"><a href="#ServerArgs-2317"><span class="linenos">2317</span></a>        <span class="n">baseline_vit_layers</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="ServerArgs-2318"><a href="#ServerArgs-2318"><span class="linenos">2318</span></a>        <span class="n">baseline_vit_hidden_size</span> <span class="o">=</span> <span class="mi">1024</span>
</span><span id="ServerArgs-2319"><a href="#ServerArgs-2319"><span class="linenos">2319</span></a>
</span><span id="ServerArgs-2320"><a href="#ServerArgs-2320"><span class="linenos">2320</span></a>        <span class="c1"># weight params count</span>
</span><span id="ServerArgs-2321"><a href="#ServerArgs-2321"><span class="linenos">2321</span></a>        <span class="n">current_complexity_score</span> <span class="o">=</span> <span class="n">vit_num_layers</span> <span class="o">*</span> <span class="p">(</span><span class="n">vit_hidden_size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ServerArgs-2322"><a href="#ServerArgs-2322"><span class="linenos">2322</span></a>        <span class="n">baseline_complexity_score</span> <span class="o">=</span> <span class="n">baseline_vit_layers</span> <span class="o">*</span> <span class="p">(</span><span class="n">baseline_vit_hidden_size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ServerArgs-2323"><a href="#ServerArgs-2323"><span class="linenos">2323</span></a>        <span class="n">complexity_ratio</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs-2324"><a href="#ServerArgs-2324"><span class="linenos">2324</span></a>            <span class="n">current_complexity_score</span> <span class="o">/</span> <span class="n">baseline_complexity_score</span>
</span><span id="ServerArgs-2325"><a href="#ServerArgs-2325"><span class="linenos">2325</span></a>            <span class="k">if</span> <span class="n">baseline_complexity_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="ServerArgs-2326"><a href="#ServerArgs-2326"><span class="linenos">2326</span></a>            <span class="k">else</span> <span class="mf">1.0</span>
</span><span id="ServerArgs-2327"><a href="#ServerArgs-2327"><span class="linenos">2327</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2328"><a href="#ServerArgs-2328"><span class="linenos">2328</span></a>
</span><span id="ServerArgs-2329"><a href="#ServerArgs-2329"><span class="linenos">2329</span></a>        <span class="c1"># every time the complexity grows 100%, adjust final factor for 10%</span>
</span><span id="ServerArgs-2330"><a href="#ServerArgs-2330"><span class="linenos">2330</span></a>        <span class="n">sensitivity_scale</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="ServerArgs-2331"><a href="#ServerArgs-2331"><span class="linenos">2331</span></a>        <span class="n">dynamic_adjustment_factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">sensitivity_scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">complexity_ratio</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="ServerArgs-2332"><a href="#ServerArgs-2332"><span class="linenos">2332</span></a>        <span class="n">dynamic_adjustment_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">dynamic_adjustment_factor</span><span class="p">))</span>
</span><span id="ServerArgs-2333"><a href="#ServerArgs-2333"><span class="linenos">2333</span></a>
</span><span id="ServerArgs-2334"><a href="#ServerArgs-2334"><span class="linenos">2334</span></a>        <span class="n">final_overall_factor</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs-2335"><a href="#ServerArgs-2335"><span class="linenos">2335</span></a>            <span class="n">base_mem_fraction_reduction_ratio</span> <span class="o">*</span> <span class="n">dynamic_adjustment_factor</span>
</span><span id="ServerArgs-2336"><a href="#ServerArgs-2336"><span class="linenos">2336</span></a>        <span class="p">)</span>
</span><span id="ServerArgs-2337"><a href="#ServerArgs-2337"><span class="linenos">2337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs-2338"><a href="#ServerArgs-2338"><span class="linenos">2338</span></a>            <span class="n">original_server_arg_mem_fraction</span> <span class="o">*</span> <span class="n">final_overall_factor</span>
</span><span id="ServerArgs-2339"><a href="#ServerArgs-2339"><span class="linenos">2339</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            <div id="ServerArgs.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ServerArgs</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">tokenizer_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tokenizer_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">skip_tokenizer_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">load_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">model_loader_extra_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>,</span><span class="param">	<span class="n">trust_remote_code</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">context_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">is_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_multimodal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">model_impl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>,</span><span class="param">	<span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30000</span>,</span><span class="param">	<span class="n">skip_server_warmup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">warmups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nccl_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">quantization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">quantization_param_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">kv_cache_dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">mem_fraction_static</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_running_requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_queued_requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9223372036854775807</span>,</span><span class="param">	<span class="n">max_total_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">chunked_prefill_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_prefill_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16384</span>,</span><span class="param">	<span class="n">schedule_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;fcfs&#39;</span>,</span><span class="param">	<span class="n">schedule_conservativeness</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">page_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">hybrid_kvcache_ratio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">swa_full_tokens_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>,</span><span class="param">	<span class="n">disable_hybrid_swa_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">pp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">max_micro_batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">stream_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">stream_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">constrained_json_whitespace_pattern</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">watchdog_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">300</span>,</span><span class="param">	<span class="n">dist_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">download_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">base_gpu_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">gpu_id_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">sleep_on_idle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span>,</span><span class="param">	<span class="n">log_level_http</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">log_requests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">log_requests_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>,</span><span class="param">	<span class="n">crash_dump_folder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">show_time_cost</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_metrics_for_all_schedulers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">bucket_time_to_first_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">bucket_inter_token_latency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">bucket_e2e_request_latency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">collect_tokens_histogram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">decode_log_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>,</span><span class="param">	<span class="n">enable_request_time_stats_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">kv_events_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">gc_warning_threshold_secs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">served_model_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">weight_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>,</span><span class="param">	<span class="n">chat_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">completion_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">file_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;sglang_storage&#39;</span>,</span><span class="param">	<span class="n">enable_cache_report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">reasoning_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tool_call_parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tool_server</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dp_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">load_balance_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;round_robin&#39;</span>,</span><span class="param">	<span class="n">dist_init_addr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nnodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">node_rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">json_model_override_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>,</span><span class="param">	<span class="n">preferred_sampling_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">enable_lora</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_lora_rank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">lora_target_modules</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">lora_paths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">sglang</span><span class="o">.</span><span class="n">srt</span><span class="o">.</span><span class="n">lora</span><span class="o">.</span><span class="n">lora_registry</span><span class="o">.</span><span class="n">LoRARef</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_loaded_loras</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_loras_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>,</span><span class="param">	<span class="n">lora_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;triton&#39;</span>,</span><span class="param">	<span class="n">attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">decode_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">prefill_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">sampling_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">grammar_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">mm_attention_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">speculative_algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">speculative_draft_model_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">speculative_num_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">speculative_eagle_topk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">speculative_num_draft_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">speculative_accept_threshold_single</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">speculative_accept_threshold_acc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">speculative_token_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">ep_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">moe_a2a_backend</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;deepep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>,</span><span class="param">	<span class="n">moe_runner_backend</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;triton&#39;</span><span class="p">,</span> <span class="s1">&#39;triton_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;flashinfer_trtllm&#39;</span><span class="p">,</span> <span class="s1">&#39;flashinfer_cutlass&#39;</span><span class="p">,</span> <span class="s1">&#39;flashinfer_mxfp4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">flashinfer_mxfp4_moe_precision</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;bf16&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>,</span><span class="param">	<span class="n">enable_flashinfer_allreduce_fusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">deepep_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;low_latency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">ep_num_redundant_experts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">ep_dispatch_algorithm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">init_expert_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;trivial&#39;</span>,</span><span class="param">	<span class="n">enable_eplb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">eplb_algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">eplb_rebalance_num_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>,</span><span class="param">	<span class="n">eplb_rebalance_layers_per_chunk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">expert_distribution_recorder_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="s1">&#39;stat_approx&#39;</span><span class="p">,</span> <span class="s1">&#39;per_pass&#39;</span><span class="p">,</span> <span class="s1">&#39;per_token&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">expert_distribution_recorder_buffer_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">enable_expert_distribution_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">deepep_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">moe_dense_tp_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">enable_hierarchical_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">hicache_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>,</span><span class="param">	<span class="n">hicache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">hicache_write_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;write_through_selective&#39;</span>,</span><span class="param">	<span class="n">hicache_io_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kernel&#39;</span>,</span><span class="param">	<span class="n">hicache_mem_layout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;layer_first&#39;</span>,</span><span class="param">	<span class="n">hicache_storage_backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">hicache_storage_prefetch_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;best_effort&#39;</span>,</span><span class="param">	<span class="n">hicache_storage_backend_extra_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">enable_double_sparsity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">ds_channel_config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">ds_heavy_channel_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>,</span><span class="param">	<span class="n">ds_heavy_token_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span>,</span><span class="param">	<span class="n">ds_heavy_channel_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;qk&#39;</span>,</span><span class="param">	<span class="n">ds_sparse_decode_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span>,</span><span class="param">	<span class="n">cpu_offload_gb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">offload_group_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>,</span><span class="param">	<span class="n">offload_num_in_group</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">offload_prefetch_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">offload_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>,</span><span class="param">	<span class="n">disable_radix_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">cuda_graph_max_bs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">cuda_graph_bs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">disable_cuda_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disable_cuda_graph_padding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_profile_cuda_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_cudagraph_gc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_nccl_nvls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_symm_mem</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disable_flashinfer_cutlass_moe_fp4_allgather</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_tokenizer_batch_encode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disable_outlines_disk_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disable_custom_all_reduce</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_mscclpp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disable_overlap_schedule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_mixed_chunk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_dp_attention</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_dp_lm_head</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_two_batch_overlap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">tbo_token_distribution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.48</span>,</span><span class="param">	<span class="n">enable_torch_compile</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">torch_compile_max_bs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>,</span><span class="param">	<span class="n">torchao_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">enable_nan_detection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_p2p_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">triton_attention_reduce_in_fp32</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">triton_attention_num_kv_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>,</span><span class="param">	<span class="n">num_continuous_decode_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">delete_ckpt_after_loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_memory_saver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">allow_auto_truncate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_custom_logit_processor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">flashinfer_mla_disable_ragged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disable_shared_experts_fusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disable_chunked_prefix_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disable_fast_image_processor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_return_hidden_states</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">scheduler_recv_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">debug_tensor_dump_output_folder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">debug_tensor_dump_input_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">debug_tensor_dump_inject</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">debug_tensor_dump_prefill_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disaggregation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span>,</span><span class="param">	<span class="n">disaggregation_transfer_backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mooncake&#39;</span>,</span><span class="param">	<span class="n">disaggregation_bootstrap_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8998</span>,</span><span class="param">	<span class="n">disaggregation_decode_tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">disaggregation_decode_dp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">disaggregation_prefill_pp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">disaggregation_ib_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">num_reserved_decode_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>,</span><span class="param">	<span class="n">pdlb_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">custom_weight_loader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">weight_loader_disable_mmap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_pdmux</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">sm_group_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">enable_ep_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_deepep_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_flashinfer_cutlass_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_flashinfer_trtllm_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_triton_kernel_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">enable_flashinfer_mxfp4_moe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.__init__"></a>
    
    

                            </div>
                            <div id="ServerArgs.model_path" class="classattr">
                                <div class="attr variable">
            <span class="name">model_path</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.model_path"></a>
    
    

                            </div>
                            <div id="ServerArgs.tokenizer_path" class="classattr">
                                <div class="attr variable">
            <span class="name">tokenizer_path</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.tokenizer_path"></a>
    
    

                            </div>
                            <div id="ServerArgs.tokenizer_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">tokenizer_mode</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;auto&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.tokenizer_mode"></a>
    
    

                            </div>
                            <div id="ServerArgs.skip_tokenizer_init" class="classattr">
                                <div class="attr variable">
            <span class="name">skip_tokenizer_init</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.skip_tokenizer_init"></a>
    
    

                            </div>
                            <div id="ServerArgs.load_format" class="classattr">
                                <div class="attr variable">
            <span class="name">load_format</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;auto&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.load_format"></a>
    
    

                            </div>
                            <div id="ServerArgs.model_loader_extra_config" class="classattr">
                                <div class="attr variable">
            <span class="name">model_loader_extra_config</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;{}&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.model_loader_extra_config"></a>
    
    

                            </div>
                            <div id="ServerArgs.trust_remote_code" class="classattr">
                                <div class="attr variable">
            <span class="name">trust_remote_code</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.trust_remote_code"></a>
    
    

                            </div>
                            <div id="ServerArgs.context_length" class="classattr">
                                <div class="attr variable">
            <span class="name">context_length</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.context_length"></a>
    
    

                            </div>
                            <div id="ServerArgs.is_embedding" class="classattr">
                                <div class="attr variable">
            <span class="name">is_embedding</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.is_embedding"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_multimodal" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_multimodal</span><span class="annotation">: Optional[bool]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_multimodal"></a>
    
    

                            </div>
                            <div id="ServerArgs.revision" class="classattr">
                                <div class="attr variable">
            <span class="name">revision</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.revision"></a>
    
    

                            </div>
                            <div id="ServerArgs.model_impl" class="classattr">
                                <div class="attr variable">
            <span class="name">model_impl</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;auto&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.model_impl"></a>
    
    

                            </div>
                            <div id="ServerArgs.host" class="classattr">
                                <div class="attr variable">
            <span class="name">host</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;127.0.0.1&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.host"></a>
    
    

                            </div>
                            <div id="ServerArgs.port" class="classattr">
                                <div class="attr variable">
            <span class="name">port</span><span class="annotation">: int</span>        =
<span class="default_value">30000</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.port"></a>
    
    

                            </div>
                            <div id="ServerArgs.skip_server_warmup" class="classattr">
                                <div class="attr variable">
            <span class="name">skip_server_warmup</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.skip_server_warmup"></a>
    
    

                            </div>
                            <div id="ServerArgs.warmups" class="classattr">
                                <div class="attr variable">
            <span class="name">warmups</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.warmups"></a>
    
    

                            </div>
                            <div id="ServerArgs.nccl_port" class="classattr">
                                <div class="attr variable">
            <span class="name">nccl_port</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.nccl_port"></a>
    
    

                            </div>
                            <div id="ServerArgs.dtype" class="classattr">
                                <div class="attr variable">
            <span class="name">dtype</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;auto&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.dtype"></a>
    
    

                            </div>
                            <div id="ServerArgs.quantization" class="classattr">
                                <div class="attr variable">
            <span class="name">quantization</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.quantization"></a>
    
    

                            </div>
                            <div id="ServerArgs.quantization_param_path" class="classattr">
                                <div class="attr variable">
            <span class="name">quantization_param_path</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.quantization_param_path"></a>
    
    

                            </div>
                            <div id="ServerArgs.kv_cache_dtype" class="classattr">
                                <div class="attr variable">
            <span class="name">kv_cache_dtype</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;auto&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.kv_cache_dtype"></a>
    
    

                            </div>
                            <div id="ServerArgs.mem_fraction_static" class="classattr">
                                <div class="attr variable">
            <span class="name">mem_fraction_static</span><span class="annotation">: Optional[float]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.mem_fraction_static"></a>
    
    

                            </div>
                            <div id="ServerArgs.max_running_requests" class="classattr">
                                <div class="attr variable">
            <span class="name">max_running_requests</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.max_running_requests"></a>
    
    

                            </div>
                            <div id="ServerArgs.max_queued_requests" class="classattr">
                                <div class="attr variable">
            <span class="name">max_queued_requests</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">9223372036854775807</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.max_queued_requests"></a>
    
    

                            </div>
                            <div id="ServerArgs.max_total_tokens" class="classattr">
                                <div class="attr variable">
            <span class="name">max_total_tokens</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.max_total_tokens"></a>
    
    

                            </div>
                            <div id="ServerArgs.chunked_prefill_size" class="classattr">
                                <div class="attr variable">
            <span class="name">chunked_prefill_size</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.chunked_prefill_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.max_prefill_tokens" class="classattr">
                                <div class="attr variable">
            <span class="name">max_prefill_tokens</span><span class="annotation">: int</span>        =
<span class="default_value">16384</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.max_prefill_tokens"></a>
    
    

                            </div>
                            <div id="ServerArgs.schedule_policy" class="classattr">
                                <div class="attr variable">
            <span class="name">schedule_policy</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;fcfs&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.schedule_policy"></a>
    
    

                            </div>
                            <div id="ServerArgs.schedule_conservativeness" class="classattr">
                                <div class="attr variable">
            <span class="name">schedule_conservativeness</span><span class="annotation">: float</span>        =
<span class="default_value">1.0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.schedule_conservativeness"></a>
    
    

                            </div>
                            <div id="ServerArgs.page_size" class="classattr">
                                <div class="attr variable">
            <span class="name">page_size</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.page_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.hybrid_kvcache_ratio" class="classattr">
                                <div class="attr variable">
            <span class="name">hybrid_kvcache_ratio</span><span class="annotation">: Optional[float]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hybrid_kvcache_ratio"></a>
    
    

                            </div>
                            <div id="ServerArgs.swa_full_tokens_ratio" class="classattr">
                                <div class="attr variable">
            <span class="name">swa_full_tokens_ratio</span><span class="annotation">: float</span>        =
<span class="default_value">0.8</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.swa_full_tokens_ratio"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_hybrid_swa_memory" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_hybrid_swa_memory</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_hybrid_swa_memory"></a>
    
    

                            </div>
                            <div id="ServerArgs.device" class="classattr">
                                <div class="attr variable">
            <span class="name">device</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.device"></a>
    
    

                            </div>
                            <div id="ServerArgs.tp_size" class="classattr">
                                <div class="attr variable">
            <span class="name">tp_size</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.tp_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.pp_size" class="classattr">
                                <div class="attr variable">
            <span class="name">pp_size</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.pp_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.max_micro_batch_size" class="classattr">
                                <div class="attr variable">
            <span class="name">max_micro_batch_size</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.max_micro_batch_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.stream_interval" class="classattr">
                                <div class="attr variable">
            <span class="name">stream_interval</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.stream_interval"></a>
    
    

                            </div>
                            <div id="ServerArgs.stream_output" class="classattr">
                                <div class="attr variable">
            <span class="name">stream_output</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.stream_output"></a>
    
    

                            </div>
                            <div id="ServerArgs.random_seed" class="classattr">
                                <div class="attr variable">
            <span class="name">random_seed</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.random_seed"></a>
    
    

                            </div>
                            <div id="ServerArgs.constrained_json_whitespace_pattern" class="classattr">
                                <div class="attr variable">
            <span class="name">constrained_json_whitespace_pattern</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.constrained_json_whitespace_pattern"></a>
    
    

                            </div>
                            <div id="ServerArgs.watchdog_timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">watchdog_timeout</span><span class="annotation">: float</span>        =
<span class="default_value">300</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.watchdog_timeout"></a>
    
    

                            </div>
                            <div id="ServerArgs.dist_timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">dist_timeout</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.dist_timeout"></a>
    
    

                            </div>
                            <div id="ServerArgs.download_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">download_dir</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.download_dir"></a>
    
    

                            </div>
                            <div id="ServerArgs.base_gpu_id" class="classattr">
                                <div class="attr variable">
            <span class="name">base_gpu_id</span><span class="annotation">: int</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.base_gpu_id"></a>
    
    

                            </div>
                            <div id="ServerArgs.gpu_id_step" class="classattr">
                                <div class="attr variable">
            <span class="name">gpu_id_step</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.gpu_id_step"></a>
    
    

                            </div>
                            <div id="ServerArgs.sleep_on_idle" class="classattr">
                                <div class="attr variable">
            <span class="name">sleep_on_idle</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.sleep_on_idle"></a>
    
    

                            </div>
                            <div id="ServerArgs.log_level" class="classattr">
                                <div class="attr variable">
            <span class="name">log_level</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;info&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.log_level"></a>
    
    

                            </div>
                            <div id="ServerArgs.log_level_http" class="classattr">
                                <div class="attr variable">
            <span class="name">log_level_http</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.log_level_http"></a>
    
    

                            </div>
                            <div id="ServerArgs.log_requests" class="classattr">
                                <div class="attr variable">
            <span class="name">log_requests</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.log_requests"></a>
    
    

                            </div>
                            <div id="ServerArgs.log_requests_level" class="classattr">
                                <div class="attr variable">
            <span class="name">log_requests_level</span><span class="annotation">: int</span>        =
<span class="default_value">2</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.log_requests_level"></a>
    
    

                            </div>
                            <div id="ServerArgs.crash_dump_folder" class="classattr">
                                <div class="attr variable">
            <span class="name">crash_dump_folder</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.crash_dump_folder"></a>
    
    

                            </div>
                            <div id="ServerArgs.show_time_cost" class="classattr">
                                <div class="attr variable">
            <span class="name">show_time_cost</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.show_time_cost"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_metrics" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_metrics</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_metrics"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_metrics_for_all_schedulers" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_metrics_for_all_schedulers</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_metrics_for_all_schedulers"></a>
    
    

                            </div>
                            <div id="ServerArgs.bucket_time_to_first_token" class="classattr">
                                <div class="attr variable">
            <span class="name">bucket_time_to_first_token</span><span class="annotation">: Optional[List[float]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.bucket_time_to_first_token"></a>
    
    

                            </div>
                            <div id="ServerArgs.bucket_inter_token_latency" class="classattr">
                                <div class="attr variable">
            <span class="name">bucket_inter_token_latency</span><span class="annotation">: Optional[List[float]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.bucket_inter_token_latency"></a>
    
    

                            </div>
                            <div id="ServerArgs.bucket_e2e_request_latency" class="classattr">
                                <div class="attr variable">
            <span class="name">bucket_e2e_request_latency</span><span class="annotation">: Optional[List[float]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.bucket_e2e_request_latency"></a>
    
    

                            </div>
                            <div id="ServerArgs.collect_tokens_histogram" class="classattr">
                                <div class="attr variable">
            <span class="name">collect_tokens_histogram</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.collect_tokens_histogram"></a>
    
    

                            </div>
                            <div id="ServerArgs.decode_log_interval" class="classattr">
                                <div class="attr variable">
            <span class="name">decode_log_interval</span><span class="annotation">: int</span>        =
<span class="default_value">40</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.decode_log_interval"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_request_time_stats_logging" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_request_time_stats_logging</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_request_time_stats_logging"></a>
    
    

                            </div>
                            <div id="ServerArgs.kv_events_config" class="classattr">
                                <div class="attr variable">
            <span class="name">kv_events_config</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.kv_events_config"></a>
    
    

                            </div>
                            <div id="ServerArgs.gc_warning_threshold_secs" class="classattr">
                                <div class="attr variable">
            <span class="name">gc_warning_threshold_secs</span><span class="annotation">: float</span>        =
<span class="default_value">0.0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.gc_warning_threshold_secs"></a>
    
    

                            </div>
                            <div id="ServerArgs.api_key" class="classattr">
                                <div class="attr variable">
            <span class="name">api_key</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.api_key"></a>
    
    

                            </div>
                            <div id="ServerArgs.served_model_name" class="classattr">
                                <div class="attr variable">
            <span class="name">served_model_name</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.served_model_name"></a>
    
    

                            </div>
                            <div id="ServerArgs.weight_version" class="classattr">
                                <div class="attr variable">
            <span class="name">weight_version</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;default&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.weight_version"></a>
    
    

                            </div>
                            <div id="ServerArgs.chat_template" class="classattr">
                                <div class="attr variable">
            <span class="name">chat_template</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.chat_template"></a>
    
    

                            </div>
                            <div id="ServerArgs.completion_template" class="classattr">
                                <div class="attr variable">
            <span class="name">completion_template</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.completion_template"></a>
    
    

                            </div>
                            <div id="ServerArgs.file_storage_path" class="classattr">
                                <div class="attr variable">
            <span class="name">file_storage_path</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;sglang_storage&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.file_storage_path"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_cache_report" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_cache_report</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_cache_report"></a>
    
    

                            </div>
                            <div id="ServerArgs.reasoning_parser" class="classattr">
                                <div class="attr variable">
            <span class="name">reasoning_parser</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.reasoning_parser"></a>
    
    

                            </div>
                            <div id="ServerArgs.tool_call_parser" class="classattr">
                                <div class="attr variable">
            <span class="name">tool_call_parser</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.tool_call_parser"></a>
    
    

                            </div>
                            <div id="ServerArgs.tool_server" class="classattr">
                                <div class="attr variable">
            <span class="name">tool_server</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.tool_server"></a>
    
    

                            </div>
                            <div id="ServerArgs.dp_size" class="classattr">
                                <div class="attr variable">
            <span class="name">dp_size</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.dp_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.load_balance_method" class="classattr">
                                <div class="attr variable">
            <span class="name">load_balance_method</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;round_robin&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.load_balance_method"></a>
    
    

                            </div>
                            <div id="ServerArgs.dist_init_addr" class="classattr">
                                <div class="attr variable">
            <span class="name">dist_init_addr</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.dist_init_addr"></a>
    
    

                            </div>
                            <div id="ServerArgs.nnodes" class="classattr">
                                <div class="attr variable">
            <span class="name">nnodes</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.nnodes"></a>
    
    

                            </div>
                            <div id="ServerArgs.node_rank" class="classattr">
                                <div class="attr variable">
            <span class="name">node_rank</span><span class="annotation">: int</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.node_rank"></a>
    
    

                            </div>
                            <div id="ServerArgs.json_model_override_args" class="classattr">
                                <div class="attr variable">
            <span class="name">json_model_override_args</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;{}&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.json_model_override_args"></a>
    
    

                            </div>
                            <div id="ServerArgs.preferred_sampling_params" class="classattr">
                                <div class="attr variable">
            <span class="name">preferred_sampling_params</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.preferred_sampling_params"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_lora" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_lora</span><span class="annotation">: Optional[bool]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_lora"></a>
    
    

                            </div>
                            <div id="ServerArgs.max_lora_rank" class="classattr">
                                <div class="attr variable">
            <span class="name">max_lora_rank</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.max_lora_rank"></a>
    
    

                            </div>
                            <div id="ServerArgs.lora_target_modules" class="classattr">
                                <div class="attr variable">
            <span class="name">lora_target_modules</span><span class="annotation">: Union[set[str], List[str], NoneType]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.lora_target_modules"></a>
    
    

                            </div>
                            <div id="ServerArgs.lora_paths" class="classattr">
                                <div class="attr variable">
            <span class="name">lora_paths</span><span class="annotation">: Union[dict[str, str], List[dict[str, str]], List[str], List[sglang.srt.lora.lora_registry.LoRARef], NoneType]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.lora_paths"></a>
    
    

                            </div>
                            <div id="ServerArgs.max_loaded_loras" class="classattr">
                                <div class="attr variable">
            <span class="name">max_loaded_loras</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.max_loaded_loras"></a>
    
    

                            </div>
                            <div id="ServerArgs.max_loras_per_batch" class="classattr">
                                <div class="attr variable">
            <span class="name">max_loras_per_batch</span><span class="annotation">: int</span>        =
<span class="default_value">8</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.max_loras_per_batch"></a>
    
    

                            </div>
                            <div id="ServerArgs.lora_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">lora_backend</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;triton&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.lora_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.attention_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">attention_backend</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.attention_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.decode_attention_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">decode_attention_backend</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.decode_attention_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.prefill_attention_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">prefill_attention_backend</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.prefill_attention_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.sampling_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">sampling_backend</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.sampling_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.grammar_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">grammar_backend</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.grammar_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.mm_attention_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">mm_attention_backend</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.mm_attention_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.speculative_algorithm" class="classattr">
                                <div class="attr variable">
            <span class="name">speculative_algorithm</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.speculative_algorithm"></a>
    
    

                            </div>
                            <div id="ServerArgs.speculative_draft_model_path" class="classattr">
                                <div class="attr variable">
            <span class="name">speculative_draft_model_path</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.speculative_draft_model_path"></a>
    
    

                            </div>
                            <div id="ServerArgs.speculative_num_steps" class="classattr">
                                <div class="attr variable">
            <span class="name">speculative_num_steps</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.speculative_num_steps"></a>
    
    

                            </div>
                            <div id="ServerArgs.speculative_eagle_topk" class="classattr">
                                <div class="attr variable">
            <span class="name">speculative_eagle_topk</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.speculative_eagle_topk"></a>
    
    

                            </div>
                            <div id="ServerArgs.speculative_num_draft_tokens" class="classattr">
                                <div class="attr variable">
            <span class="name">speculative_num_draft_tokens</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.speculative_num_draft_tokens"></a>
    
    

                            </div>
                            <div id="ServerArgs.speculative_accept_threshold_single" class="classattr">
                                <div class="attr variable">
            <span class="name">speculative_accept_threshold_single</span><span class="annotation">: float</span>        =
<span class="default_value">1.0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.speculative_accept_threshold_single"></a>
    
    

                            </div>
                            <div id="ServerArgs.speculative_accept_threshold_acc" class="classattr">
                                <div class="attr variable">
            <span class="name">speculative_accept_threshold_acc</span><span class="annotation">: float</span>        =
<span class="default_value">1.0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.speculative_accept_threshold_acc"></a>
    
    

                            </div>
                            <div id="ServerArgs.speculative_token_map" class="classattr">
                                <div class="attr variable">
            <span class="name">speculative_token_map</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.speculative_token_map"></a>
    
    

                            </div>
                            <div id="ServerArgs.ep_size" class="classattr">
                                <div class="attr variable">
            <span class="name">ep_size</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.ep_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.moe_a2a_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">moe_a2a_backend</span><span class="annotation">: Literal[&#39;none&#39;, &#39;deepep&#39;]</span>        =
<span class="default_value">&#39;none&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.moe_a2a_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.moe_runner_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">moe_runner_backend</span><span class="annotation">: Literal[&#39;auto&#39;, &#39;triton&#39;, &#39;triton_kernel&#39;, &#39;flashinfer_trtllm&#39;, &#39;flashinfer_cutlass&#39;, &#39;flashinfer_mxfp4&#39;]</span>        =
<span class="default_value">&#39;auto&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.moe_runner_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.flashinfer_mxfp4_moe_precision" class="classattr">
                                <div class="attr variable">
            <span class="name">flashinfer_mxfp4_moe_precision</span><span class="annotation">: Literal[&#39;default&#39;, &#39;bf16&#39;]</span>        =
<span class="default_value">&#39;default&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.flashinfer_mxfp4_moe_precision"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_flashinfer_allreduce_fusion" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_flashinfer_allreduce_fusion</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_flashinfer_allreduce_fusion"></a>
    
    

                            </div>
                            <div id="ServerArgs.deepep_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">deepep_mode</span><span class="annotation">: Literal[&#39;auto&#39;, &#39;normal&#39;, &#39;low_latency&#39;]</span>        =
<span class="default_value">&#39;auto&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.deepep_mode"></a>
    
    

                            </div>
                            <div id="ServerArgs.ep_num_redundant_experts" class="classattr">
                                <div class="attr variable">
            <span class="name">ep_num_redundant_experts</span><span class="annotation">: int</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.ep_num_redundant_experts"></a>
    
    

                            </div>
                            <div id="ServerArgs.ep_dispatch_algorithm" class="classattr">
                                <div class="attr variable">
            <span class="name">ep_dispatch_algorithm</span><span class="annotation">: Optional[Literal[&#39;static&#39;, &#39;dynamic&#39;, &#39;fake&#39;]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.ep_dispatch_algorithm"></a>
    
    

                            </div>
                            <div id="ServerArgs.init_expert_location" class="classattr">
                                <div class="attr variable">
            <span class="name">init_expert_location</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;trivial&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.init_expert_location"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_eplb" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_eplb</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_eplb"></a>
    
    

                            </div>
                            <div id="ServerArgs.eplb_algorithm" class="classattr">
                                <div class="attr variable">
            <span class="name">eplb_algorithm</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;auto&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.eplb_algorithm"></a>
    
    

                            </div>
                            <div id="ServerArgs.eplb_rebalance_num_iterations" class="classattr">
                                <div class="attr variable">
            <span class="name">eplb_rebalance_num_iterations</span><span class="annotation">: int</span>        =
<span class="default_value">1000</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.eplb_rebalance_num_iterations"></a>
    
    

                            </div>
                            <div id="ServerArgs.eplb_rebalance_layers_per_chunk" class="classattr">
                                <div class="attr variable">
            <span class="name">eplb_rebalance_layers_per_chunk</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.eplb_rebalance_layers_per_chunk"></a>
    
    

                            </div>
                            <div id="ServerArgs.expert_distribution_recorder_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">expert_distribution_recorder_mode</span><span class="annotation">: Optional[Literal[&#39;stat&#39;, &#39;stat_approx&#39;, &#39;per_pass&#39;, &#39;per_token&#39;]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.expert_distribution_recorder_mode"></a>
    
    

                            </div>
                            <div id="ServerArgs.expert_distribution_recorder_buffer_size" class="classattr">
                                <div class="attr variable">
            <span class="name">expert_distribution_recorder_buffer_size</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.expert_distribution_recorder_buffer_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_expert_distribution_metrics" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_expert_distribution_metrics</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_expert_distribution_metrics"></a>
    
    

                            </div>
                            <div id="ServerArgs.deepep_config" class="classattr">
                                <div class="attr variable">
            <span class="name">deepep_config</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.deepep_config"></a>
    
    

                            </div>
                            <div id="ServerArgs.moe_dense_tp_size" class="classattr">
                                <div class="attr variable">
            <span class="name">moe_dense_tp_size</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.moe_dense_tp_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_hierarchical_cache" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_hierarchical_cache</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_hierarchical_cache"></a>
    
    

                            </div>
                            <div id="ServerArgs.hicache_ratio" class="classattr">
                                <div class="attr variable">
            <span class="name">hicache_ratio</span><span class="annotation">: float</span>        =
<span class="default_value">2.0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hicache_ratio"></a>
    
    

                            </div>
                            <div id="ServerArgs.hicache_size" class="classattr">
                                <div class="attr variable">
            <span class="name">hicache_size</span><span class="annotation">: int</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hicache_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.hicache_write_policy" class="classattr">
                                <div class="attr variable">
            <span class="name">hicache_write_policy</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;write_through_selective&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hicache_write_policy"></a>
    
    

                            </div>
                            <div id="ServerArgs.hicache_io_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">hicache_io_backend</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;kernel&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hicache_io_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.hicache_mem_layout" class="classattr">
                                <div class="attr variable">
            <span class="name">hicache_mem_layout</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;layer_first&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hicache_mem_layout"></a>
    
    

                            </div>
                            <div id="ServerArgs.hicache_storage_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">hicache_storage_backend</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hicache_storage_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.hicache_storage_prefetch_policy" class="classattr">
                                <div class="attr variable">
            <span class="name">hicache_storage_prefetch_policy</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;best_effort&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hicache_storage_prefetch_policy"></a>
    
    

                            </div>
                            <div id="ServerArgs.hicache_storage_backend_extra_config" class="classattr">
                                <div class="attr variable">
            <span class="name">hicache_storage_backend_extra_config</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.hicache_storage_backend_extra_config"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_double_sparsity" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_double_sparsity</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_double_sparsity"></a>
    
    

                            </div>
                            <div id="ServerArgs.ds_channel_config_path" class="classattr">
                                <div class="attr variable">
            <span class="name">ds_channel_config_path</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.ds_channel_config_path"></a>
    
    

                            </div>
                            <div id="ServerArgs.ds_heavy_channel_num" class="classattr">
                                <div class="attr variable">
            <span class="name">ds_heavy_channel_num</span><span class="annotation">: int</span>        =
<span class="default_value">32</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.ds_heavy_channel_num"></a>
    
    

                            </div>
                            <div id="ServerArgs.ds_heavy_token_num" class="classattr">
                                <div class="attr variable">
            <span class="name">ds_heavy_token_num</span><span class="annotation">: int</span>        =
<span class="default_value">256</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.ds_heavy_token_num"></a>
    
    

                            </div>
                            <div id="ServerArgs.ds_heavy_channel_type" class="classattr">
                                <div class="attr variable">
            <span class="name">ds_heavy_channel_type</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;qk&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.ds_heavy_channel_type"></a>
    
    

                            </div>
                            <div id="ServerArgs.ds_sparse_decode_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">ds_sparse_decode_threshold</span><span class="annotation">: int</span>        =
<span class="default_value">4096</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.ds_sparse_decode_threshold"></a>
    
    

                            </div>
                            <div id="ServerArgs.cpu_offload_gb" class="classattr">
                                <div class="attr variable">
            <span class="name">cpu_offload_gb</span><span class="annotation">: int</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.cpu_offload_gb"></a>
    
    

                            </div>
                            <div id="ServerArgs.offload_group_size" class="classattr">
                                <div class="attr variable">
            <span class="name">offload_group_size</span><span class="annotation">: int</span>        =
<span class="default_value">-1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.offload_group_size"></a>
    
    

                            </div>
                            <div id="ServerArgs.offload_num_in_group" class="classattr">
                                <div class="attr variable">
            <span class="name">offload_num_in_group</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.offload_num_in_group"></a>
    
    

                            </div>
                            <div id="ServerArgs.offload_prefetch_step" class="classattr">
                                <div class="attr variable">
            <span class="name">offload_prefetch_step</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.offload_prefetch_step"></a>
    
    

                            </div>
                            <div id="ServerArgs.offload_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">offload_mode</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;cpu&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.offload_mode"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_radix_cache" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_radix_cache</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_radix_cache"></a>
    
    

                            </div>
                            <div id="ServerArgs.cuda_graph_max_bs" class="classattr">
                                <div class="attr variable">
            <span class="name">cuda_graph_max_bs</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.cuda_graph_max_bs"></a>
    
    

                            </div>
                            <div id="ServerArgs.cuda_graph_bs" class="classattr">
                                <div class="attr variable">
            <span class="name">cuda_graph_bs</span><span class="annotation">: Optional[List[int]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.cuda_graph_bs"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_cuda_graph" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_cuda_graph</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_cuda_graph"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_cuda_graph_padding" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_cuda_graph_padding</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_cuda_graph_padding"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_profile_cuda_graph" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_profile_cuda_graph</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_profile_cuda_graph"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_cudagraph_gc" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_cudagraph_gc</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_cudagraph_gc"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_nccl_nvls" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_nccl_nvls</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_nccl_nvls"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_symm_mem" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_symm_mem</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_symm_mem"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_flashinfer_cutlass_moe_fp4_allgather" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_flashinfer_cutlass_moe_fp4_allgather</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_flashinfer_cutlass_moe_fp4_allgather"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_tokenizer_batch_encode" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_tokenizer_batch_encode</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_tokenizer_batch_encode"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_outlines_disk_cache" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_outlines_disk_cache</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_outlines_disk_cache"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_custom_all_reduce" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_custom_all_reduce</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_custom_all_reduce"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_mscclpp" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_mscclpp</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_mscclpp"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_overlap_schedule" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_overlap_schedule</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_overlap_schedule"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_mixed_chunk" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_mixed_chunk</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_mixed_chunk"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_dp_attention" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_dp_attention</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_dp_attention"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_dp_lm_head" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_dp_lm_head</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_dp_lm_head"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_two_batch_overlap" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_two_batch_overlap</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_two_batch_overlap"></a>
    
    

                            </div>
                            <div id="ServerArgs.tbo_token_distribution_threshold" class="classattr">
                                <div class="attr variable">
            <span class="name">tbo_token_distribution_threshold</span><span class="annotation">: float</span>        =
<span class="default_value">0.48</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.tbo_token_distribution_threshold"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_torch_compile" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_torch_compile</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_torch_compile"></a>
    
    

                            </div>
                            <div id="ServerArgs.torch_compile_max_bs" class="classattr">
                                <div class="attr variable">
            <span class="name">torch_compile_max_bs</span><span class="annotation">: int</span>        =
<span class="default_value">32</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.torch_compile_max_bs"></a>
    
    

                            </div>
                            <div id="ServerArgs.torchao_config" class="classattr">
                                <div class="attr variable">
            <span class="name">torchao_config</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.torchao_config"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_nan_detection" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_nan_detection</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_nan_detection"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_p2p_check" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_p2p_check</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_p2p_check"></a>
    
    

                            </div>
                            <div id="ServerArgs.triton_attention_reduce_in_fp32" class="classattr">
                                <div class="attr variable">
            <span class="name">triton_attention_reduce_in_fp32</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.triton_attention_reduce_in_fp32"></a>
    
    

                            </div>
                            <div id="ServerArgs.triton_attention_num_kv_splits" class="classattr">
                                <div class="attr variable">
            <span class="name">triton_attention_num_kv_splits</span><span class="annotation">: int</span>        =
<span class="default_value">8</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.triton_attention_num_kv_splits"></a>
    
    

                            </div>
                            <div id="ServerArgs.num_continuous_decode_steps" class="classattr">
                                <div class="attr variable">
            <span class="name">num_continuous_decode_steps</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.num_continuous_decode_steps"></a>
    
    

                            </div>
                            <div id="ServerArgs.delete_ckpt_after_loading" class="classattr">
                                <div class="attr variable">
            <span class="name">delete_ckpt_after_loading</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.delete_ckpt_after_loading"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_memory_saver" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_memory_saver</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_memory_saver"></a>
    
    

                            </div>
                            <div id="ServerArgs.allow_auto_truncate" class="classattr">
                                <div class="attr variable">
            <span class="name">allow_auto_truncate</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.allow_auto_truncate"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_custom_logit_processor" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_custom_logit_processor</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_custom_logit_processor"></a>
    
    

                            </div>
                            <div id="ServerArgs.flashinfer_mla_disable_ragged" class="classattr">
                                <div class="attr variable">
            <span class="name">flashinfer_mla_disable_ragged</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.flashinfer_mla_disable_ragged"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_shared_experts_fusion" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_shared_experts_fusion</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_shared_experts_fusion"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_chunked_prefix_cache" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_chunked_prefix_cache</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_chunked_prefix_cache"></a>
    
    

                            </div>
                            <div id="ServerArgs.disable_fast_image_processor" class="classattr">
                                <div class="attr variable">
            <span class="name">disable_fast_image_processor</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disable_fast_image_processor"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_return_hidden_states" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_return_hidden_states</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_return_hidden_states"></a>
    
    

                            </div>
                            <div id="ServerArgs.scheduler_recv_interval" class="classattr">
                                <div class="attr variable">
            <span class="name">scheduler_recv_interval</span><span class="annotation">: int</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.scheduler_recv_interval"></a>
    
    

                            </div>
                            <div id="ServerArgs.debug_tensor_dump_output_folder" class="classattr">
                                <div class="attr variable">
            <span class="name">debug_tensor_dump_output_folder</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.debug_tensor_dump_output_folder"></a>
    
    

                            </div>
                            <div id="ServerArgs.debug_tensor_dump_input_file" class="classattr">
                                <div class="attr variable">
            <span class="name">debug_tensor_dump_input_file</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.debug_tensor_dump_input_file"></a>
    
    

                            </div>
                            <div id="ServerArgs.debug_tensor_dump_inject" class="classattr">
                                <div class="attr variable">
            <span class="name">debug_tensor_dump_inject</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.debug_tensor_dump_inject"></a>
    
    

                            </div>
                            <div id="ServerArgs.debug_tensor_dump_prefill_only" class="classattr">
                                <div class="attr variable">
            <span class="name">debug_tensor_dump_prefill_only</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.debug_tensor_dump_prefill_only"></a>
    
    

                            </div>
                            <div id="ServerArgs.disaggregation_mode" class="classattr">
                                <div class="attr variable">
            <span class="name">disaggregation_mode</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;null&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disaggregation_mode"></a>
    
    

                            </div>
                            <div id="ServerArgs.disaggregation_transfer_backend" class="classattr">
                                <div class="attr variable">
            <span class="name">disaggregation_transfer_backend</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;mooncake&#39;</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disaggregation_transfer_backend"></a>
    
    

                            </div>
                            <div id="ServerArgs.disaggregation_bootstrap_port" class="classattr">
                                <div class="attr variable">
            <span class="name">disaggregation_bootstrap_port</span><span class="annotation">: int</span>        =
<span class="default_value">8998</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disaggregation_bootstrap_port"></a>
    
    

                            </div>
                            <div id="ServerArgs.disaggregation_decode_tp" class="classattr">
                                <div class="attr variable">
            <span class="name">disaggregation_decode_tp</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disaggregation_decode_tp"></a>
    
    

                            </div>
                            <div id="ServerArgs.disaggregation_decode_dp" class="classattr">
                                <div class="attr variable">
            <span class="name">disaggregation_decode_dp</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disaggregation_decode_dp"></a>
    
    

                            </div>
                            <div id="ServerArgs.disaggregation_prefill_pp" class="classattr">
                                <div class="attr variable">
            <span class="name">disaggregation_prefill_pp</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disaggregation_prefill_pp"></a>
    
    

                            </div>
                            <div id="ServerArgs.disaggregation_ib_device" class="classattr">
                                <div class="attr variable">
            <span class="name">disaggregation_ib_device</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.disaggregation_ib_device"></a>
    
    

                            </div>
                            <div id="ServerArgs.num_reserved_decode_tokens" class="classattr">
                                <div class="attr variable">
            <span class="name">num_reserved_decode_tokens</span><span class="annotation">: int</span>        =
<span class="default_value">512</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.num_reserved_decode_tokens"></a>
    
    

                            </div>
                            <div id="ServerArgs.pdlb_url" class="classattr">
                                <div class="attr variable">
            <span class="name">pdlb_url</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.pdlb_url"></a>
    
    

                            </div>
                            <div id="ServerArgs.custom_weight_loader" class="classattr">
                                <div class="attr variable">
            <span class="name">custom_weight_loader</span><span class="annotation">: Optional[List[str]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.custom_weight_loader"></a>
    
    

                            </div>
                            <div id="ServerArgs.weight_loader_disable_mmap" class="classattr">
                                <div class="attr variable">
            <span class="name">weight_loader_disable_mmap</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.weight_loader_disable_mmap"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_pdmux" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_pdmux</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_pdmux"></a>
    
    

                            </div>
                            <div id="ServerArgs.sm_group_num" class="classattr">
                                <div class="attr variable">
            <span class="name">sm_group_num</span><span class="annotation">: int</span>        =
<span class="default_value">3</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.sm_group_num"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_ep_moe" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_ep_moe</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_ep_moe"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_deepep_moe" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_deepep_moe</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_deepep_moe"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_flashinfer_cutlass_moe" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_flashinfer_cutlass_moe</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_flashinfer_cutlass_moe"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_flashinfer_trtllm_moe" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_flashinfer_trtllm_moe</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_flashinfer_trtllm_moe"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_triton_kernel_moe" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_triton_kernel_moe</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_triton_kernel_moe"></a>
    
    

                            </div>
                            <div id="ServerArgs.enable_flashinfer_mxfp4_moe" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_flashinfer_mxfp4_moe</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ServerArgs.enable_flashinfer_mxfp4_moe"></a>
    
    

                            </div>
                            <div id="ServerArgs.add_cli_args" class="classattr">
                                        <input id="ServerArgs.add_cli_args-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">add_cli_args</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.add_cli_args-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.add_cli_args"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.add_cli_args-731"><a href="#ServerArgs.add_cli_args-731"><span class="linenos"> 731</span></a>    <span class="nd">@staticmethod</span>
</span><span id="ServerArgs.add_cli_args-732"><a href="#ServerArgs.add_cli_args-732"><span class="linenos"> 732</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_cli_args</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">):</span>
</span><span id="ServerArgs.add_cli_args-733"><a href="#ServerArgs.add_cli_args-733"><span class="linenos"> 733</span></a>        <span class="c1"># Model and tokenizer</span>
</span><span id="ServerArgs.add_cli_args-734"><a href="#ServerArgs.add_cli_args-734"><span class="linenos"> 734</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-735"><a href="#ServerArgs.add_cli_args-735"><span class="linenos"> 735</span></a>            <span class="s2">&quot;--model-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-736"><a href="#ServerArgs.add_cli_args-736"><span class="linenos"> 736</span></a>            <span class="s2">&quot;--model&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-737"><a href="#ServerArgs.add_cli_args-737"><span class="linenos"> 737</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-738"><a href="#ServerArgs.add_cli_args-738"><span class="linenos"> 738</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the model weights. This can be a local folder or a Hugging Face repo ID.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-739"><a href="#ServerArgs.add_cli_args-739"><span class="linenos"> 739</span></a>            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-740"><a href="#ServerArgs.add_cli_args-740"><span class="linenos"> 740</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-741"><a href="#ServerArgs.add_cli_args-741"><span class="linenos"> 741</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-742"><a href="#ServerArgs.add_cli_args-742"><span class="linenos"> 742</span></a>            <span class="s2">&quot;--tokenizer-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-743"><a href="#ServerArgs.add_cli_args-743"><span class="linenos"> 743</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-744"><a href="#ServerArgs.add_cli_args-744"><span class="linenos"> 744</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tokenizer_path</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-745"><a href="#ServerArgs.add_cli_args-745"><span class="linenos"> 745</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the tokenizer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-746"><a href="#ServerArgs.add_cli_args-746"><span class="linenos"> 746</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-747"><a href="#ServerArgs.add_cli_args-747"><span class="linenos"> 747</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-748"><a href="#ServerArgs.add_cli_args-748"><span class="linenos"> 748</span></a>            <span class="s2">&quot;--tokenizer-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-749"><a href="#ServerArgs.add_cli_args-749"><span class="linenos"> 749</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-750"><a href="#ServerArgs.add_cli_args-750"><span class="linenos"> 750</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tokenizer_mode</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-751"><a href="#ServerArgs.add_cli_args-751"><span class="linenos"> 751</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;slow&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-752"><a href="#ServerArgs.add_cli_args-752"><span class="linenos"> 752</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tokenizer mode. &#39;auto&#39; will use the fast &quot;</span>
</span><span id="ServerArgs.add_cli_args-753"><a href="#ServerArgs.add_cli_args-753"><span class="linenos"> 753</span></a>            <span class="s2">&quot;tokenizer if available, and &#39;slow&#39; will &quot;</span>
</span><span id="ServerArgs.add_cli_args-754"><a href="#ServerArgs.add_cli_args-754"><span class="linenos"> 754</span></a>            <span class="s2">&quot;always use the slow tokenizer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-755"><a href="#ServerArgs.add_cli_args-755"><span class="linenos"> 755</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-756"><a href="#ServerArgs.add_cli_args-756"><span class="linenos"> 756</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-757"><a href="#ServerArgs.add_cli_args-757"><span class="linenos"> 757</span></a>            <span class="s2">&quot;--skip-tokenizer-init&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-758"><a href="#ServerArgs.add_cli_args-758"><span class="linenos"> 758</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-759"><a href="#ServerArgs.add_cli_args-759"><span class="linenos"> 759</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, skip init tokenizer and pass input_ids in generate request.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-760"><a href="#ServerArgs.add_cli_args-760"><span class="linenos"> 760</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-761"><a href="#ServerArgs.add_cli_args-761"><span class="linenos"> 761</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-762"><a href="#ServerArgs.add_cli_args-762"><span class="linenos"> 762</span></a>            <span class="s2">&quot;--load-format&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-763"><a href="#ServerArgs.add_cli_args-763"><span class="linenos"> 763</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-764"><a href="#ServerArgs.add_cli_args-764"><span class="linenos"> 764</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">load_format</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-765"><a href="#ServerArgs.add_cli_args-765"><span class="linenos"> 765</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="ServerArgs.add_cli_args-766"><a href="#ServerArgs.add_cli_args-766"><span class="linenos"> 766</span></a>                <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-767"><a href="#ServerArgs.add_cli_args-767"><span class="linenos"> 767</span></a>                <span class="s2">&quot;pt&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-768"><a href="#ServerArgs.add_cli_args-768"><span class="linenos"> 768</span></a>                <span class="s2">&quot;safetensors&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-769"><a href="#ServerArgs.add_cli_args-769"><span class="linenos"> 769</span></a>                <span class="s2">&quot;npcache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-770"><a href="#ServerArgs.add_cli_args-770"><span class="linenos"> 770</span></a>                <span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-771"><a href="#ServerArgs.add_cli_args-771"><span class="linenos"> 771</span></a>                <span class="s2">&quot;sharded_state&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-772"><a href="#ServerArgs.add_cli_args-772"><span class="linenos"> 772</span></a>                <span class="s2">&quot;gguf&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-773"><a href="#ServerArgs.add_cli_args-773"><span class="linenos"> 773</span></a>                <span class="s2">&quot;bitsandbytes&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-774"><a href="#ServerArgs.add_cli_args-774"><span class="linenos"> 774</span></a>                <span class="s2">&quot;layered&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-775"><a href="#ServerArgs.add_cli_args-775"><span class="linenos"> 775</span></a>                <span class="s2">&quot;remote&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-776"><a href="#ServerArgs.add_cli_args-776"><span class="linenos"> 776</span></a>            <span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-777"><a href="#ServerArgs.add_cli_args-777"><span class="linenos"> 777</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The format of the model weights to load. &quot;</span>
</span><span id="ServerArgs.add_cli_args-778"><a href="#ServerArgs.add_cli_args-778"><span class="linenos"> 778</span></a>            <span class="s1">&#39;&quot;auto&quot; will try to load the weights in the safetensors format &#39;</span>
</span><span id="ServerArgs.add_cli_args-779"><a href="#ServerArgs.add_cli_args-779"><span class="linenos"> 779</span></a>            <span class="s2">&quot;and fall back to the pytorch bin format if safetensors format &quot;</span>
</span><span id="ServerArgs.add_cli_args-780"><a href="#ServerArgs.add_cli_args-780"><span class="linenos"> 780</span></a>            <span class="s2">&quot;is not available. &quot;</span>
</span><span id="ServerArgs.add_cli_args-781"><a href="#ServerArgs.add_cli_args-781"><span class="linenos"> 781</span></a>            <span class="s1">&#39;&quot;pt&quot; will load the weights in the pytorch bin format. &#39;</span>
</span><span id="ServerArgs.add_cli_args-782"><a href="#ServerArgs.add_cli_args-782"><span class="linenos"> 782</span></a>            <span class="s1">&#39;&quot;safetensors&quot; will load the weights in the safetensors format. &#39;</span>
</span><span id="ServerArgs.add_cli_args-783"><a href="#ServerArgs.add_cli_args-783"><span class="linenos"> 783</span></a>            <span class="s1">&#39;&quot;npcache&quot; will load the weights in pytorch format and store &#39;</span>
</span><span id="ServerArgs.add_cli_args-784"><a href="#ServerArgs.add_cli_args-784"><span class="linenos"> 784</span></a>            <span class="s2">&quot;a numpy cache to speed up the loading. &quot;</span>
</span><span id="ServerArgs.add_cli_args-785"><a href="#ServerArgs.add_cli_args-785"><span class="linenos"> 785</span></a>            <span class="s1">&#39;&quot;dummy&quot; will initialize the weights with random values, &#39;</span>
</span><span id="ServerArgs.add_cli_args-786"><a href="#ServerArgs.add_cli_args-786"><span class="linenos"> 786</span></a>            <span class="s2">&quot;which is mainly for profiling.&quot;</span>
</span><span id="ServerArgs.add_cli_args-787"><a href="#ServerArgs.add_cli_args-787"><span class="linenos"> 787</span></a>            <span class="s1">&#39;&quot;gguf&quot; will load the weights in the gguf format. &#39;</span>
</span><span id="ServerArgs.add_cli_args-788"><a href="#ServerArgs.add_cli_args-788"><span class="linenos"> 788</span></a>            <span class="s1">&#39;&quot;bitsandbytes&quot; will load the weights using bitsandbytes &#39;</span>
</span><span id="ServerArgs.add_cli_args-789"><a href="#ServerArgs.add_cli_args-789"><span class="linenos"> 789</span></a>            <span class="s2">&quot;quantization.&quot;</span>
</span><span id="ServerArgs.add_cli_args-790"><a href="#ServerArgs.add_cli_args-790"><span class="linenos"> 790</span></a>            <span class="s1">&#39;&quot;layered&quot; loads weights layer by layer so that one can quantize a &#39;</span>
</span><span id="ServerArgs.add_cli_args-791"><a href="#ServerArgs.add_cli_args-791"><span class="linenos"> 791</span></a>            <span class="s2">&quot;layer before loading another to make the peak memory envelope &quot;</span>
</span><span id="ServerArgs.add_cli_args-792"><a href="#ServerArgs.add_cli_args-792"><span class="linenos"> 792</span></a>            <span class="s2">&quot;smaller.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-793"><a href="#ServerArgs.add_cli_args-793"><span class="linenos"> 793</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-794"><a href="#ServerArgs.add_cli_args-794"><span class="linenos"> 794</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-795"><a href="#ServerArgs.add_cli_args-795"><span class="linenos"> 795</span></a>            <span class="s2">&quot;--model-loader-extra-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-796"><a href="#ServerArgs.add_cli_args-796"><span class="linenos"> 796</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-797"><a href="#ServerArgs.add_cli_args-797"><span class="linenos"> 797</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Extra config for model loader. &quot;</span>
</span><span id="ServerArgs.add_cli_args-798"><a href="#ServerArgs.add_cli_args-798"><span class="linenos"> 798</span></a>            <span class="s2">&quot;This will be passed to the model loader corresponding to the chosen load_format.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-799"><a href="#ServerArgs.add_cli_args-799"><span class="linenos"> 799</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">model_loader_extra_config</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-800"><a href="#ServerArgs.add_cli_args-800"><span class="linenos"> 800</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-801"><a href="#ServerArgs.add_cli_args-801"><span class="linenos"> 801</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-802"><a href="#ServerArgs.add_cli_args-802"><span class="linenos"> 802</span></a>            <span class="s2">&quot;--trust-remote-code&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-803"><a href="#ServerArgs.add_cli_args-803"><span class="linenos"> 803</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-804"><a href="#ServerArgs.add_cli_args-804"><span class="linenos"> 804</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether or not to allow for custom models defined on the Hub in their own modeling files.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-805"><a href="#ServerArgs.add_cli_args-805"><span class="linenos"> 805</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-806"><a href="#ServerArgs.add_cli_args-806"><span class="linenos"> 806</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-807"><a href="#ServerArgs.add_cli_args-807"><span class="linenos"> 807</span></a>            <span class="s2">&quot;--context-length&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-808"><a href="#ServerArgs.add_cli_args-808"><span class="linenos"> 808</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-809"><a href="#ServerArgs.add_cli_args-809"><span class="linenos"> 809</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">context_length</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-810"><a href="#ServerArgs.add_cli_args-810"><span class="linenos"> 810</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The model&#39;s maximum context length. Defaults to None (will use the value from the model&#39;s config.json instead).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-811"><a href="#ServerArgs.add_cli_args-811"><span class="linenos"> 811</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-812"><a href="#ServerArgs.add_cli_args-812"><span class="linenos"> 812</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-813"><a href="#ServerArgs.add_cli_args-813"><span class="linenos"> 813</span></a>            <span class="s2">&quot;--is-embedding&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-814"><a href="#ServerArgs.add_cli_args-814"><span class="linenos"> 814</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-815"><a href="#ServerArgs.add_cli_args-815"><span class="linenos"> 815</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use a CausalLM as an embedding model.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-816"><a href="#ServerArgs.add_cli_args-816"><span class="linenos"> 816</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-817"><a href="#ServerArgs.add_cli_args-817"><span class="linenos"> 817</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-818"><a href="#ServerArgs.add_cli_args-818"><span class="linenos"> 818</span></a>            <span class="s2">&quot;--enable-multimodal&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-819"><a href="#ServerArgs.add_cli_args-819"><span class="linenos"> 819</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_multimodal</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-820"><a href="#ServerArgs.add_cli_args-820"><span class="linenos"> 820</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-821"><a href="#ServerArgs.add_cli_args-821"><span class="linenos"> 821</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable the multimodal functionality for the served model. If the model being served is not multimodal, nothing will happen&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-822"><a href="#ServerArgs.add_cli_args-822"><span class="linenos"> 822</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-823"><a href="#ServerArgs.add_cli_args-823"><span class="linenos"> 823</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-824"><a href="#ServerArgs.add_cli_args-824"><span class="linenos"> 824</span></a>            <span class="s2">&quot;--revision&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-825"><a href="#ServerArgs.add_cli_args-825"><span class="linenos"> 825</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-826"><a href="#ServerArgs.add_cli_args-826"><span class="linenos"> 826</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-827"><a href="#ServerArgs.add_cli_args-827"><span class="linenos"> 827</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The specific model version to use. It can be a branch &quot;</span>
</span><span id="ServerArgs.add_cli_args-828"><a href="#ServerArgs.add_cli_args-828"><span class="linenos"> 828</span></a>            <span class="s2">&quot;name, a tag name, or a commit id. If unspecified, will use &quot;</span>
</span><span id="ServerArgs.add_cli_args-829"><a href="#ServerArgs.add_cli_args-829"><span class="linenos"> 829</span></a>            <span class="s2">&quot;the default version.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-830"><a href="#ServerArgs.add_cli_args-830"><span class="linenos"> 830</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-831"><a href="#ServerArgs.add_cli_args-831"><span class="linenos"> 831</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-832"><a href="#ServerArgs.add_cli_args-832"><span class="linenos"> 832</span></a>            <span class="s2">&quot;--model-impl&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-833"><a href="#ServerArgs.add_cli_args-833"><span class="linenos"> 833</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-834"><a href="#ServerArgs.add_cli_args-834"><span class="linenos"> 834</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">model_impl</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-835"><a href="#ServerArgs.add_cli_args-835"><span class="linenos"> 835</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which implementation of the model to use.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.add_cli_args-836"><a href="#ServerArgs.add_cli_args-836"><span class="linenos"> 836</span></a>            <span class="s1">&#39;* &quot;auto&quot; will try to use the SGLang implementation if it exists &#39;</span>
</span><span id="ServerArgs.add_cli_args-837"><a href="#ServerArgs.add_cli_args-837"><span class="linenos"> 837</span></a>            <span class="s2">&quot;and fall back to the Transformers implementation if no SGLang &quot;</span>
</span><span id="ServerArgs.add_cli_args-838"><a href="#ServerArgs.add_cli_args-838"><span class="linenos"> 838</span></a>            <span class="s2">&quot;implementation is available.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.add_cli_args-839"><a href="#ServerArgs.add_cli_args-839"><span class="linenos"> 839</span></a>            <span class="s1">&#39;* &quot;sglang&quot; will use the SGLang model implementation.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs.add_cli_args-840"><a href="#ServerArgs.add_cli_args-840"><span class="linenos"> 840</span></a>            <span class="s1">&#39;* &quot;transformers&quot; will use the Transformers model &#39;</span>
</span><span id="ServerArgs.add_cli_args-841"><a href="#ServerArgs.add_cli_args-841"><span class="linenos"> 841</span></a>            <span class="s2">&quot;implementation.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-842"><a href="#ServerArgs.add_cli_args-842"><span class="linenos"> 842</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-843"><a href="#ServerArgs.add_cli_args-843"><span class="linenos"> 843</span></a>
</span><span id="ServerArgs.add_cli_args-844"><a href="#ServerArgs.add_cli_args-844"><span class="linenos"> 844</span></a>        <span class="c1"># HTTP server</span>
</span><span id="ServerArgs.add_cli_args-845"><a href="#ServerArgs.add_cli_args-845"><span class="linenos"> 845</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-846"><a href="#ServerArgs.add_cli_args-846"><span class="linenos"> 846</span></a>            <span class="s2">&quot;--host&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-847"><a href="#ServerArgs.add_cli_args-847"><span class="linenos"> 847</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-848"><a href="#ServerArgs.add_cli_args-848"><span class="linenos"> 848</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-849"><a href="#ServerArgs.add_cli_args-849"><span class="linenos"> 849</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The host of the HTTP server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-850"><a href="#ServerArgs.add_cli_args-850"><span class="linenos"> 850</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-851"><a href="#ServerArgs.add_cli_args-851"><span class="linenos"> 851</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-852"><a href="#ServerArgs.add_cli_args-852"><span class="linenos"> 852</span></a>            <span class="s2">&quot;--port&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-853"><a href="#ServerArgs.add_cli_args-853"><span class="linenos"> 853</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-854"><a href="#ServerArgs.add_cli_args-854"><span class="linenos"> 854</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-855"><a href="#ServerArgs.add_cli_args-855"><span class="linenos"> 855</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The port of the HTTP server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-856"><a href="#ServerArgs.add_cli_args-856"><span class="linenos"> 856</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-857"><a href="#ServerArgs.add_cli_args-857"><span class="linenos"> 857</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-858"><a href="#ServerArgs.add_cli_args-858"><span class="linenos"> 858</span></a>            <span class="s2">&quot;--skip-server-warmup&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-859"><a href="#ServerArgs.add_cli_args-859"><span class="linenos"> 859</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-860"><a href="#ServerArgs.add_cli_args-860"><span class="linenos"> 860</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, skip warmup.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-861"><a href="#ServerArgs.add_cli_args-861"><span class="linenos"> 861</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-862"><a href="#ServerArgs.add_cli_args-862"><span class="linenos"> 862</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-863"><a href="#ServerArgs.add_cli_args-863"><span class="linenos"> 863</span></a>            <span class="s2">&quot;--warmups&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-864"><a href="#ServerArgs.add_cli_args-864"><span class="linenos"> 864</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-865"><a href="#ServerArgs.add_cli_args-865"><span class="linenos"> 865</span></a>            <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-866"><a href="#ServerArgs.add_cli_args-866"><span class="linenos"> 866</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify custom warmup functions (csv) to run before server starts eg. --warmups=warmup_name1,warmup_name2 &quot;</span>
</span><span id="ServerArgs.add_cli_args-867"><a href="#ServerArgs.add_cli_args-867"><span class="linenos"> 867</span></a>            <span class="s2">&quot;will run the functions `warmup_name1` and `warmup_name2` specified in warmup.py before the server starts listening for requests&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-868"><a href="#ServerArgs.add_cli_args-868"><span class="linenos"> 868</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-869"><a href="#ServerArgs.add_cli_args-869"><span class="linenos"> 869</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-870"><a href="#ServerArgs.add_cli_args-870"><span class="linenos"> 870</span></a>            <span class="s2">&quot;--nccl-port&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-871"><a href="#ServerArgs.add_cli_args-871"><span class="linenos"> 871</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-872"><a href="#ServerArgs.add_cli_args-872"><span class="linenos"> 872</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-873"><a href="#ServerArgs.add_cli_args-873"><span class="linenos"> 873</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The port for NCCL distributed environment setup. Defaults to a random port.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-874"><a href="#ServerArgs.add_cli_args-874"><span class="linenos"> 874</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-875"><a href="#ServerArgs.add_cli_args-875"><span class="linenos"> 875</span></a>
</span><span id="ServerArgs.add_cli_args-876"><a href="#ServerArgs.add_cli_args-876"><span class="linenos"> 876</span></a>        <span class="c1"># Quantization and data type</span>
</span><span id="ServerArgs.add_cli_args-877"><a href="#ServerArgs.add_cli_args-877"><span class="linenos"> 877</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-878"><a href="#ServerArgs.add_cli_args-878"><span class="linenos"> 878</span></a>            <span class="s2">&quot;--dtype&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-879"><a href="#ServerArgs.add_cli_args-879"><span class="linenos"> 879</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-880"><a href="#ServerArgs.add_cli_args-880"><span class="linenos"> 880</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-881"><a href="#ServerArgs.add_cli_args-881"><span class="linenos"> 881</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;half&quot;</span><span class="p">,</span> <span class="s2">&quot;float16&quot;</span><span class="p">,</span> <span class="s2">&quot;bfloat16&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-882"><a href="#ServerArgs.add_cli_args-882"><span class="linenos"> 882</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Data type for model weights and activations.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.add_cli_args-883"><a href="#ServerArgs.add_cli_args-883"><span class="linenos"> 883</span></a>            <span class="s1">&#39;* &quot;auto&quot; will use FP16 precision for FP32 and FP16 models, and &#39;</span>
</span><span id="ServerArgs.add_cli_args-884"><a href="#ServerArgs.add_cli_args-884"><span class="linenos"> 884</span></a>            <span class="s2">&quot;BF16 precision for BF16 models.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.add_cli_args-885"><a href="#ServerArgs.add_cli_args-885"><span class="linenos"> 885</span></a>            <span class="s1">&#39;* &quot;half&quot; for FP16. Recommended for AWQ quantization.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs.add_cli_args-886"><a href="#ServerArgs.add_cli_args-886"><span class="linenos"> 886</span></a>            <span class="s1">&#39;* &quot;float16&quot; is the same as &quot;half&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs.add_cli_args-887"><a href="#ServerArgs.add_cli_args-887"><span class="linenos"> 887</span></a>            <span class="s1">&#39;* &quot;bfloat16&quot; for a balance between precision and range.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs.add_cli_args-888"><a href="#ServerArgs.add_cli_args-888"><span class="linenos"> 888</span></a>            <span class="s1">&#39;* &quot;float&quot; is shorthand for FP32 precision.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="ServerArgs.add_cli_args-889"><a href="#ServerArgs.add_cli_args-889"><span class="linenos"> 889</span></a>            <span class="s1">&#39;* &quot;float32&quot; for FP32 precision.&#39;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-890"><a href="#ServerArgs.add_cli_args-890"><span class="linenos"> 890</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-891"><a href="#ServerArgs.add_cli_args-891"><span class="linenos"> 891</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-892"><a href="#ServerArgs.add_cli_args-892"><span class="linenos"> 892</span></a>            <span class="s2">&quot;--quantization&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-893"><a href="#ServerArgs.add_cli_args-893"><span class="linenos"> 893</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-894"><a href="#ServerArgs.add_cli_args-894"><span class="linenos"> 894</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">quantization</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-895"><a href="#ServerArgs.add_cli_args-895"><span class="linenos"> 895</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="ServerArgs.add_cli_args-896"><a href="#ServerArgs.add_cli_args-896"><span class="linenos"> 896</span></a>                <span class="s2">&quot;awq&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-897"><a href="#ServerArgs.add_cli_args-897"><span class="linenos"> 897</span></a>                <span class="s2">&quot;fp8&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-898"><a href="#ServerArgs.add_cli_args-898"><span class="linenos"> 898</span></a>                <span class="s2">&quot;gptq&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-899"><a href="#ServerArgs.add_cli_args-899"><span class="linenos"> 899</span></a>                <span class="s2">&quot;marlin&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-900"><a href="#ServerArgs.add_cli_args-900"><span class="linenos"> 900</span></a>                <span class="s2">&quot;gptq_marlin&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-901"><a href="#ServerArgs.add_cli_args-901"><span class="linenos"> 901</span></a>                <span class="s2">&quot;awq_marlin&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-902"><a href="#ServerArgs.add_cli_args-902"><span class="linenos"> 902</span></a>                <span class="s2">&quot;bitsandbytes&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-903"><a href="#ServerArgs.add_cli_args-903"><span class="linenos"> 903</span></a>                <span class="s2">&quot;gguf&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-904"><a href="#ServerArgs.add_cli_args-904"><span class="linenos"> 904</span></a>                <span class="s2">&quot;modelopt&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-905"><a href="#ServerArgs.add_cli_args-905"><span class="linenos"> 905</span></a>                <span class="s2">&quot;modelopt_fp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-906"><a href="#ServerArgs.add_cli_args-906"><span class="linenos"> 906</span></a>                <span class="s2">&quot;petit_nvfp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-907"><a href="#ServerArgs.add_cli_args-907"><span class="linenos"> 907</span></a>                <span class="s2">&quot;w8a8_int8&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-908"><a href="#ServerArgs.add_cli_args-908"><span class="linenos"> 908</span></a>                <span class="s2">&quot;w8a8_fp8&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-909"><a href="#ServerArgs.add_cli_args-909"><span class="linenos"> 909</span></a>                <span class="s2">&quot;moe_wna16&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-910"><a href="#ServerArgs.add_cli_args-910"><span class="linenos"> 910</span></a>                <span class="s2">&quot;qoq&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-911"><a href="#ServerArgs.add_cli_args-911"><span class="linenos"> 911</span></a>                <span class="s2">&quot;w4afp8&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-912"><a href="#ServerArgs.add_cli_args-912"><span class="linenos"> 912</span></a>                <span class="s2">&quot;mxfp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-913"><a href="#ServerArgs.add_cli_args-913"><span class="linenos"> 913</span></a>            <span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-914"><a href="#ServerArgs.add_cli_args-914"><span class="linenos"> 914</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The quantization method.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-915"><a href="#ServerArgs.add_cli_args-915"><span class="linenos"> 915</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-916"><a href="#ServerArgs.add_cli_args-916"><span class="linenos"> 916</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-917"><a href="#ServerArgs.add_cli_args-917"><span class="linenos"> 917</span></a>            <span class="s2">&quot;--quantization-param-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-918"><a href="#ServerArgs.add_cli_args-918"><span class="linenos"> 918</span></a>            <span class="nb">type</span><span class="o">=</span><span class="n">nullable_str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-919"><a href="#ServerArgs.add_cli_args-919"><span class="linenos"> 919</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-920"><a href="#ServerArgs.add_cli_args-920"><span class="linenos"> 920</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the JSON file containing the KV cache &quot;</span>
</span><span id="ServerArgs.add_cli_args-921"><a href="#ServerArgs.add_cli_args-921"><span class="linenos"> 921</span></a>            <span class="s2">&quot;scaling factors. This should generally be supplied, when &quot;</span>
</span><span id="ServerArgs.add_cli_args-922"><a href="#ServerArgs.add_cli_args-922"><span class="linenos"> 922</span></a>            <span class="s2">&quot;KV cache dtype is FP8. Otherwise, KV cache scaling factors &quot;</span>
</span><span id="ServerArgs.add_cli_args-923"><a href="#ServerArgs.add_cli_args-923"><span class="linenos"> 923</span></a>            <span class="s2">&quot;default to 1.0, which may cause accuracy issues. &quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-924"><a href="#ServerArgs.add_cli_args-924"><span class="linenos"> 924</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-925"><a href="#ServerArgs.add_cli_args-925"><span class="linenos"> 925</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-926"><a href="#ServerArgs.add_cli_args-926"><span class="linenos"> 926</span></a>            <span class="s2">&quot;--kv-cache-dtype&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-927"><a href="#ServerArgs.add_cli_args-927"><span class="linenos"> 927</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-928"><a href="#ServerArgs.add_cli_args-928"><span class="linenos"> 928</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">kv_cache_dtype</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-929"><a href="#ServerArgs.add_cli_args-929"><span class="linenos"> 929</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;fp8_e5m2&quot;</span><span class="p">,</span> <span class="s2">&quot;fp8_e4m3&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-930"><a href="#ServerArgs.add_cli_args-930"><span class="linenos"> 930</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data type for kv cache storage. &quot;auto&quot; will use model data type. &quot;fp8_e5m2&quot; and &quot;fp8_e4m3&quot; is supported for CUDA 11.8+.&#39;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-931"><a href="#ServerArgs.add_cli_args-931"><span class="linenos"> 931</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-932"><a href="#ServerArgs.add_cli_args-932"><span class="linenos"> 932</span></a>
</span><span id="ServerArgs.add_cli_args-933"><a href="#ServerArgs.add_cli_args-933"><span class="linenos"> 933</span></a>        <span class="c1"># Memory and scheduling</span>
</span><span id="ServerArgs.add_cli_args-934"><a href="#ServerArgs.add_cli_args-934"><span class="linenos"> 934</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-935"><a href="#ServerArgs.add_cli_args-935"><span class="linenos"> 935</span></a>            <span class="s2">&quot;--mem-fraction-static&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-936"><a href="#ServerArgs.add_cli_args-936"><span class="linenos"> 936</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-937"><a href="#ServerArgs.add_cli_args-937"><span class="linenos"> 937</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">mem_fraction_static</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-938"><a href="#ServerArgs.add_cli_args-938"><span class="linenos"> 938</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The fraction of the memory used for static allocation (model weights and KV cache memory pool). Use a smaller value if you see out-of-memory errors.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-939"><a href="#ServerArgs.add_cli_args-939"><span class="linenos"> 939</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-940"><a href="#ServerArgs.add_cli_args-940"><span class="linenos"> 940</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-941"><a href="#ServerArgs.add_cli_args-941"><span class="linenos"> 941</span></a>            <span class="s2">&quot;--max-running-requests&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-942"><a href="#ServerArgs.add_cli_args-942"><span class="linenos"> 942</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-943"><a href="#ServerArgs.add_cli_args-943"><span class="linenos"> 943</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_running_requests</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-944"><a href="#ServerArgs.add_cli_args-944"><span class="linenos"> 944</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of running requests.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-945"><a href="#ServerArgs.add_cli_args-945"><span class="linenos"> 945</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-946"><a href="#ServerArgs.add_cli_args-946"><span class="linenos"> 946</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-947"><a href="#ServerArgs.add_cli_args-947"><span class="linenos"> 947</span></a>            <span class="s2">&quot;--max-queued-requests&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-948"><a href="#ServerArgs.add_cli_args-948"><span class="linenos"> 948</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-949"><a href="#ServerArgs.add_cli_args-949"><span class="linenos"> 949</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_queued_requests</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-950"><a href="#ServerArgs.add_cli_args-950"><span class="linenos"> 950</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of queued requests. This option is ignored when using disaggregation-mode.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-951"><a href="#ServerArgs.add_cli_args-951"><span class="linenos"> 951</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-952"><a href="#ServerArgs.add_cli_args-952"><span class="linenos"> 952</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-953"><a href="#ServerArgs.add_cli_args-953"><span class="linenos"> 953</span></a>            <span class="s2">&quot;--max-total-tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-954"><a href="#ServerArgs.add_cli_args-954"><span class="linenos"> 954</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-955"><a href="#ServerArgs.add_cli_args-955"><span class="linenos"> 955</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_total_tokens</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-956"><a href="#ServerArgs.add_cli_args-956"><span class="linenos"> 956</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in the memory pool. If not specified, it will be automatically calculated based on the memory usage fraction. &quot;</span>
</span><span id="ServerArgs.add_cli_args-957"><a href="#ServerArgs.add_cli_args-957"><span class="linenos"> 957</span></a>            <span class="s2">&quot;This option is typically used for development and debugging purposes.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-958"><a href="#ServerArgs.add_cli_args-958"><span class="linenos"> 958</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-959"><a href="#ServerArgs.add_cli_args-959"><span class="linenos"> 959</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-960"><a href="#ServerArgs.add_cli_args-960"><span class="linenos"> 960</span></a>            <span class="s2">&quot;--chunked-prefill-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-961"><a href="#ServerArgs.add_cli_args-961"><span class="linenos"> 961</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-962"><a href="#ServerArgs.add_cli_args-962"><span class="linenos"> 962</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">chunked_prefill_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-963"><a href="#ServerArgs.add_cli_args-963"><span class="linenos"> 963</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in a chunk for the chunked prefill. Setting this to -1 means disabling chunked prefill.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-964"><a href="#ServerArgs.add_cli_args-964"><span class="linenos"> 964</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-965"><a href="#ServerArgs.add_cli_args-965"><span class="linenos"> 965</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-966"><a href="#ServerArgs.add_cli_args-966"><span class="linenos"> 966</span></a>            <span class="s2">&quot;--max-prefill-tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-967"><a href="#ServerArgs.add_cli_args-967"><span class="linenos"> 967</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-968"><a href="#ServerArgs.add_cli_args-968"><span class="linenos"> 968</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_prefill_tokens</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-969"><a href="#ServerArgs.add_cli_args-969"><span class="linenos"> 969</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of tokens in a prefill batch. The real bound will be the maximum of this value and the model&#39;s maximum context length.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-970"><a href="#ServerArgs.add_cli_args-970"><span class="linenos"> 970</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-971"><a href="#ServerArgs.add_cli_args-971"><span class="linenos"> 971</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-972"><a href="#ServerArgs.add_cli_args-972"><span class="linenos"> 972</span></a>            <span class="s2">&quot;--schedule-policy&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-973"><a href="#ServerArgs.add_cli_args-973"><span class="linenos"> 973</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-974"><a href="#ServerArgs.add_cli_args-974"><span class="linenos"> 974</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">schedule_policy</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-975"><a href="#ServerArgs.add_cli_args-975"><span class="linenos"> 975</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lpm&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;fcfs&quot;</span><span class="p">,</span> <span class="s2">&quot;dfs-weight&quot;</span><span class="p">,</span> <span class="s2">&quot;lof&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-976"><a href="#ServerArgs.add_cli_args-976"><span class="linenos"> 976</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The scheduling policy of the requests.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-977"><a href="#ServerArgs.add_cli_args-977"><span class="linenos"> 977</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-978"><a href="#ServerArgs.add_cli_args-978"><span class="linenos"> 978</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-979"><a href="#ServerArgs.add_cli_args-979"><span class="linenos"> 979</span></a>            <span class="s2">&quot;--schedule-conservativeness&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-980"><a href="#ServerArgs.add_cli_args-980"><span class="linenos"> 980</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-981"><a href="#ServerArgs.add_cli_args-981"><span class="linenos"> 981</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">schedule_conservativeness</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-982"><a href="#ServerArgs.add_cli_args-982"><span class="linenos"> 982</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How conservative the schedule policy is. A larger value means more conservative scheduling. Use a larger value if you see requests being retracted frequently.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-983"><a href="#ServerArgs.add_cli_args-983"><span class="linenos"> 983</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-984"><a href="#ServerArgs.add_cli_args-984"><span class="linenos"> 984</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-985"><a href="#ServerArgs.add_cli_args-985"><span class="linenos"> 985</span></a>            <span class="s2">&quot;--page-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-986"><a href="#ServerArgs.add_cli_args-986"><span class="linenos"> 986</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-987"><a href="#ServerArgs.add_cli_args-987"><span class="linenos"> 987</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">page_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-988"><a href="#ServerArgs.add_cli_args-988"><span class="linenos"> 988</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens in a page.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-989"><a href="#ServerArgs.add_cli_args-989"><span class="linenos"> 989</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-990"><a href="#ServerArgs.add_cli_args-990"><span class="linenos"> 990</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-991"><a href="#ServerArgs.add_cli_args-991"><span class="linenos"> 991</span></a>            <span class="s2">&quot;--hybrid-kvcache-ratio&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-992"><a href="#ServerArgs.add_cli_args-992"><span class="linenos"> 992</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-993"><a href="#ServerArgs.add_cli_args-993"><span class="linenos"> 993</span></a>            <span class="n">const</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-994"><a href="#ServerArgs.add_cli_args-994"><span class="linenos"> 994</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-995"><a href="#ServerArgs.add_cli_args-995"><span class="linenos"> 995</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hybrid_kvcache_ratio</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-996"><a href="#ServerArgs.add_cli_args-996"><span class="linenos"> 996</span></a>            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-997"><a href="#ServerArgs.add_cli_args-997"><span class="linenos"> 997</span></a>                <span class="s2">&quot;Mix ratio in [0,1] between uniform and hybrid kv buffers &quot;</span>
</span><span id="ServerArgs.add_cli_args-998"><a href="#ServerArgs.add_cli_args-998"><span class="linenos"> 998</span></a>                <span class="s2">&quot;(0.0 = pure uniform: swa_size / full_size = 1)&quot;</span>
</span><span id="ServerArgs.add_cli_args-999"><a href="#ServerArgs.add_cli_args-999"><span class="linenos"> 999</span></a>                <span class="s2">&quot;(1.0 = pure hybrid: swa_size / full_size = local_attention_size / context_length)&quot;</span>
</span><span id="ServerArgs.add_cli_args-1000"><a href="#ServerArgs.add_cli_args-1000"><span class="linenos">1000</span></a>            <span class="p">),</span>
</span><span id="ServerArgs.add_cli_args-1001"><a href="#ServerArgs.add_cli_args-1001"><span class="linenos">1001</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1002"><a href="#ServerArgs.add_cli_args-1002"><span class="linenos">1002</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1003"><a href="#ServerArgs.add_cli_args-1003"><span class="linenos">1003</span></a>            <span class="s2">&quot;--swa-full-tokens-ratio&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1004"><a href="#ServerArgs.add_cli_args-1004"><span class="linenos">1004</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1005"><a href="#ServerArgs.add_cli_args-1005"><span class="linenos">1005</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">swa_full_tokens_ratio</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1006"><a href="#ServerArgs.add_cli_args-1006"><span class="linenos">1006</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The ratio of SWA layer KV tokens / full layer KV tokens, regardless of the number of swa:full layers. It should be between 0 and 1. &quot;</span>
</span><span id="ServerArgs.add_cli_args-1007"><a href="#ServerArgs.add_cli_args-1007"><span class="linenos">1007</span></a>            <span class="s2">&quot;E.g. 0.5 means if each swa layer has 50 tokens, then each full layer has 100 tokens.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1008"><a href="#ServerArgs.add_cli_args-1008"><span class="linenos">1008</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1009"><a href="#ServerArgs.add_cli_args-1009"><span class="linenos">1009</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1010"><a href="#ServerArgs.add_cli_args-1010"><span class="linenos">1010</span></a>            <span class="s2">&quot;--disable-hybrid-swa-memory&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1011"><a href="#ServerArgs.add_cli_args-1011"><span class="linenos">1011</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1012"><a href="#ServerArgs.add_cli_args-1012"><span class="linenos">1012</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the hybrid SWA memory.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1013"><a href="#ServerArgs.add_cli_args-1013"><span class="linenos">1013</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1014"><a href="#ServerArgs.add_cli_args-1014"><span class="linenos">1014</span></a>
</span><span id="ServerArgs.add_cli_args-1015"><a href="#ServerArgs.add_cli_args-1015"><span class="linenos">1015</span></a>        <span class="c1"># Runtime options</span>
</span><span id="ServerArgs.add_cli_args-1016"><a href="#ServerArgs.add_cli_args-1016"><span class="linenos">1016</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1017"><a href="#ServerArgs.add_cli_args-1017"><span class="linenos">1017</span></a>            <span class="s2">&quot;--device&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1018"><a href="#ServerArgs.add_cli_args-1018"><span class="linenos">1018</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1019"><a href="#ServerArgs.add_cli_args-1019"><span class="linenos">1019</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1020"><a href="#ServerArgs.add_cli_args-1020"><span class="linenos">1020</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The device to use (&#39;cuda&#39;, &#39;xpu&#39;, &#39;hpu&#39;, &#39;npu&#39;, &#39;cpu&#39;). Defaults to auto-detection if not specified.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1021"><a href="#ServerArgs.add_cli_args-1021"><span class="linenos">1021</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1022"><a href="#ServerArgs.add_cli_args-1022"><span class="linenos">1022</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1023"><a href="#ServerArgs.add_cli_args-1023"><span class="linenos">1023</span></a>            <span class="s2">&quot;--tensor-parallel-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1024"><a href="#ServerArgs.add_cli_args-1024"><span class="linenos">1024</span></a>            <span class="s2">&quot;--tp-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1025"><a href="#ServerArgs.add_cli_args-1025"><span class="linenos">1025</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1026"><a href="#ServerArgs.add_cli_args-1026"><span class="linenos">1026</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tp_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1027"><a href="#ServerArgs.add_cli_args-1027"><span class="linenos">1027</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The tensor parallelism size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1028"><a href="#ServerArgs.add_cli_args-1028"><span class="linenos">1028</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1029"><a href="#ServerArgs.add_cli_args-1029"><span class="linenos">1029</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1030"><a href="#ServerArgs.add_cli_args-1030"><span class="linenos">1030</span></a>            <span class="s2">&quot;--pipeline-parallel-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1031"><a href="#ServerArgs.add_cli_args-1031"><span class="linenos">1031</span></a>            <span class="s2">&quot;--pp-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1032"><a href="#ServerArgs.add_cli_args-1032"><span class="linenos">1032</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1033"><a href="#ServerArgs.add_cli_args-1033"><span class="linenos">1033</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">pp_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1034"><a href="#ServerArgs.add_cli_args-1034"><span class="linenos">1034</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The pipeline parallelism size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1035"><a href="#ServerArgs.add_cli_args-1035"><span class="linenos">1035</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1036"><a href="#ServerArgs.add_cli_args-1036"><span class="linenos">1036</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1037"><a href="#ServerArgs.add_cli_args-1037"><span class="linenos">1037</span></a>            <span class="s2">&quot;--max-micro-batch-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1038"><a href="#ServerArgs.add_cli_args-1038"><span class="linenos">1038</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1039"><a href="#ServerArgs.add_cli_args-1039"><span class="linenos">1039</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_micro_batch_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1040"><a href="#ServerArgs.add_cli_args-1040"><span class="linenos">1040</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum micro batch size in pipeline parallelism.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1041"><a href="#ServerArgs.add_cli_args-1041"><span class="linenos">1041</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1042"><a href="#ServerArgs.add_cli_args-1042"><span class="linenos">1042</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1043"><a href="#ServerArgs.add_cli_args-1043"><span class="linenos">1043</span></a>            <span class="s2">&quot;--stream-interval&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1044"><a href="#ServerArgs.add_cli_args-1044"><span class="linenos">1044</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1045"><a href="#ServerArgs.add_cli_args-1045"><span class="linenos">1045</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">stream_interval</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1046"><a href="#ServerArgs.add_cli_args-1046"><span class="linenos">1046</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The interval (or buffer size) for streaming in terms of the token length. A smaller value makes streaming smoother, while a larger value makes the throughput higher&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1047"><a href="#ServerArgs.add_cli_args-1047"><span class="linenos">1047</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1048"><a href="#ServerArgs.add_cli_args-1048"><span class="linenos">1048</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1049"><a href="#ServerArgs.add_cli_args-1049"><span class="linenos">1049</span></a>            <span class="s2">&quot;--stream-output&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1050"><a href="#ServerArgs.add_cli_args-1050"><span class="linenos">1050</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1051"><a href="#ServerArgs.add_cli_args-1051"><span class="linenos">1051</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to output as a sequence of disjoint segments.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1052"><a href="#ServerArgs.add_cli_args-1052"><span class="linenos">1052</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1053"><a href="#ServerArgs.add_cli_args-1053"><span class="linenos">1053</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1054"><a href="#ServerArgs.add_cli_args-1054"><span class="linenos">1054</span></a>            <span class="s2">&quot;--random-seed&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1055"><a href="#ServerArgs.add_cli_args-1055"><span class="linenos">1055</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1056"><a href="#ServerArgs.add_cli_args-1056"><span class="linenos">1056</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1057"><a href="#ServerArgs.add_cli_args-1057"><span class="linenos">1057</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The random seed.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1058"><a href="#ServerArgs.add_cli_args-1058"><span class="linenos">1058</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1059"><a href="#ServerArgs.add_cli_args-1059"><span class="linenos">1059</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1060"><a href="#ServerArgs.add_cli_args-1060"><span class="linenos">1060</span></a>            <span class="s2">&quot;--constrained-json-whitespace-pattern&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1061"><a href="#ServerArgs.add_cli_args-1061"><span class="linenos">1061</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1062"><a href="#ServerArgs.add_cli_args-1062"><span class="linenos">1062</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">constrained_json_whitespace_pattern</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1063"><a href="#ServerArgs.add_cli_args-1063"><span class="linenos">1063</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(outlines backend only) Regex pattern for syntactic whitespaces allowed in JSON constrained output. For example, to allow the model generate consecutive whitespaces, set the pattern to [</span><span class="se">\n\t</span><span class="s2"> ]*&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1064"><a href="#ServerArgs.add_cli_args-1064"><span class="linenos">1064</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1065"><a href="#ServerArgs.add_cli_args-1065"><span class="linenos">1065</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1066"><a href="#ServerArgs.add_cli_args-1066"><span class="linenos">1066</span></a>            <span class="s2">&quot;--watchdog-timeout&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1067"><a href="#ServerArgs.add_cli_args-1067"><span class="linenos">1067</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1068"><a href="#ServerArgs.add_cli_args-1068"><span class="linenos">1068</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">watchdog_timeout</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1069"><a href="#ServerArgs.add_cli_args-1069"><span class="linenos">1069</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set watchdog timeout in seconds. If a forward batch takes longer than this, the server will crash to prevent hanging.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1070"><a href="#ServerArgs.add_cli_args-1070"><span class="linenos">1070</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1071"><a href="#ServerArgs.add_cli_args-1071"><span class="linenos">1071</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1072"><a href="#ServerArgs.add_cli_args-1072"><span class="linenos">1072</span></a>            <span class="s2">&quot;--dist-timeout&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1073"><a href="#ServerArgs.add_cli_args-1073"><span class="linenos">1073</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1074"><a href="#ServerArgs.add_cli_args-1074"><span class="linenos">1074</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dist_timeout</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1075"><a href="#ServerArgs.add_cli_args-1075"><span class="linenos">1075</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set timeout for torch.distributed initialization.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1076"><a href="#ServerArgs.add_cli_args-1076"><span class="linenos">1076</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1077"><a href="#ServerArgs.add_cli_args-1077"><span class="linenos">1077</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1078"><a href="#ServerArgs.add_cli_args-1078"><span class="linenos">1078</span></a>            <span class="s2">&quot;--download-dir&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1079"><a href="#ServerArgs.add_cli_args-1079"><span class="linenos">1079</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1080"><a href="#ServerArgs.add_cli_args-1080"><span class="linenos">1080</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">download_dir</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1081"><a href="#ServerArgs.add_cli_args-1081"><span class="linenos">1081</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model download directory for huggingface.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1082"><a href="#ServerArgs.add_cli_args-1082"><span class="linenos">1082</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1083"><a href="#ServerArgs.add_cli_args-1083"><span class="linenos">1083</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1084"><a href="#ServerArgs.add_cli_args-1084"><span class="linenos">1084</span></a>            <span class="s2">&quot;--base-gpu-id&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1085"><a href="#ServerArgs.add_cli_args-1085"><span class="linenos">1085</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1086"><a href="#ServerArgs.add_cli_args-1086"><span class="linenos">1086</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">base_gpu_id</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1087"><a href="#ServerArgs.add_cli_args-1087"><span class="linenos">1087</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The base GPU ID to start allocating GPUs from. Useful when running multiple instances on the same machine.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1088"><a href="#ServerArgs.add_cli_args-1088"><span class="linenos">1088</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1089"><a href="#ServerArgs.add_cli_args-1089"><span class="linenos">1089</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1090"><a href="#ServerArgs.add_cli_args-1090"><span class="linenos">1090</span></a>            <span class="s2">&quot;--gpu-id-step&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1091"><a href="#ServerArgs.add_cli_args-1091"><span class="linenos">1091</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1092"><a href="#ServerArgs.add_cli_args-1092"><span class="linenos">1092</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">gpu_id_step</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1093"><a href="#ServerArgs.add_cli_args-1093"><span class="linenos">1093</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The delta between consecutive GPU IDs that are used. For example, setting it to 2 will use GPU 0,2,4,...&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1094"><a href="#ServerArgs.add_cli_args-1094"><span class="linenos">1094</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1095"><a href="#ServerArgs.add_cli_args-1095"><span class="linenos">1095</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1096"><a href="#ServerArgs.add_cli_args-1096"><span class="linenos">1096</span></a>            <span class="s2">&quot;--sleep-on-idle&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1097"><a href="#ServerArgs.add_cli_args-1097"><span class="linenos">1097</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1098"><a href="#ServerArgs.add_cli_args-1098"><span class="linenos">1098</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Reduce CPU usage when sglang is idle.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1099"><a href="#ServerArgs.add_cli_args-1099"><span class="linenos">1099</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1100"><a href="#ServerArgs.add_cli_args-1100"><span class="linenos">1100</span></a>
</span><span id="ServerArgs.add_cli_args-1101"><a href="#ServerArgs.add_cli_args-1101"><span class="linenos">1101</span></a>        <span class="c1"># Logging</span>
</span><span id="ServerArgs.add_cli_args-1102"><a href="#ServerArgs.add_cli_args-1102"><span class="linenos">1102</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1103"><a href="#ServerArgs.add_cli_args-1103"><span class="linenos">1103</span></a>            <span class="s2">&quot;--log-level&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1104"><a href="#ServerArgs.add_cli_args-1104"><span class="linenos">1104</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1105"><a href="#ServerArgs.add_cli_args-1105"><span class="linenos">1105</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_level</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1106"><a href="#ServerArgs.add_cli_args-1106"><span class="linenos">1106</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The logging level of all loggers.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1107"><a href="#ServerArgs.add_cli_args-1107"><span class="linenos">1107</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1108"><a href="#ServerArgs.add_cli_args-1108"><span class="linenos">1108</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1109"><a href="#ServerArgs.add_cli_args-1109"><span class="linenos">1109</span></a>            <span class="s2">&quot;--log-level-http&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1110"><a href="#ServerArgs.add_cli_args-1110"><span class="linenos">1110</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1111"><a href="#ServerArgs.add_cli_args-1111"><span class="linenos">1111</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_level_http</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1112"><a href="#ServerArgs.add_cli_args-1112"><span class="linenos">1112</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The logging level of HTTP server. If not set, reuse --log-level by default.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1113"><a href="#ServerArgs.add_cli_args-1113"><span class="linenos">1113</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1114"><a href="#ServerArgs.add_cli_args-1114"><span class="linenos">1114</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1115"><a href="#ServerArgs.add_cli_args-1115"><span class="linenos">1115</span></a>            <span class="s2">&quot;--log-requests&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1116"><a href="#ServerArgs.add_cli_args-1116"><span class="linenos">1116</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1117"><a href="#ServerArgs.add_cli_args-1117"><span class="linenos">1117</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Log metadata, inputs, outputs of all requests. The verbosity is decided by --log-requests-level&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1118"><a href="#ServerArgs.add_cli_args-1118"><span class="linenos">1118</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1119"><a href="#ServerArgs.add_cli_args-1119"><span class="linenos">1119</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1120"><a href="#ServerArgs.add_cli_args-1120"><span class="linenos">1120</span></a>            <span class="s2">&quot;--log-requests-level&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1121"><a href="#ServerArgs.add_cli_args-1121"><span class="linenos">1121</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1122"><a href="#ServerArgs.add_cli_args-1122"><span class="linenos">1122</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">log_requests_level</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1123"><a href="#ServerArgs.add_cli_args-1123"><span class="linenos">1123</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;0: Log metadata (no sampling parameters). 1: Log metadata and sampling parameters. 2: Log metadata, sampling parameters and partial input/output. 3: Log every input/output.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1124"><a href="#ServerArgs.add_cli_args-1124"><span class="linenos">1124</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1125"><a href="#ServerArgs.add_cli_args-1125"><span class="linenos">1125</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1126"><a href="#ServerArgs.add_cli_args-1126"><span class="linenos">1126</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1127"><a href="#ServerArgs.add_cli_args-1127"><span class="linenos">1127</span></a>            <span class="s2">&quot;--crash-dump-folder&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1128"><a href="#ServerArgs.add_cli_args-1128"><span class="linenos">1128</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1129"><a href="#ServerArgs.add_cli_args-1129"><span class="linenos">1129</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">crash_dump_folder</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1130"><a href="#ServerArgs.add_cli_args-1130"><span class="linenos">1130</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Folder path to dump requests from the last 5 min before a crash (if any). If not specified, crash dumping is disabled.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1131"><a href="#ServerArgs.add_cli_args-1131"><span class="linenos">1131</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1132"><a href="#ServerArgs.add_cli_args-1132"><span class="linenos">1132</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1133"><a href="#ServerArgs.add_cli_args-1133"><span class="linenos">1133</span></a>            <span class="s2">&quot;--show-time-cost&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1134"><a href="#ServerArgs.add_cli_args-1134"><span class="linenos">1134</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1135"><a href="#ServerArgs.add_cli_args-1135"><span class="linenos">1135</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show time cost of custom marks.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1136"><a href="#ServerArgs.add_cli_args-1136"><span class="linenos">1136</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1137"><a href="#ServerArgs.add_cli_args-1137"><span class="linenos">1137</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1138"><a href="#ServerArgs.add_cli_args-1138"><span class="linenos">1138</span></a>            <span class="s2">&quot;--enable-metrics&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1139"><a href="#ServerArgs.add_cli_args-1139"><span class="linenos">1139</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1140"><a href="#ServerArgs.add_cli_args-1140"><span class="linenos">1140</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable log prometheus metrics.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1141"><a href="#ServerArgs.add_cli_args-1141"><span class="linenos">1141</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1142"><a href="#ServerArgs.add_cli_args-1142"><span class="linenos">1142</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1143"><a href="#ServerArgs.add_cli_args-1143"><span class="linenos">1143</span></a>            <span class="s2">&quot;--enable-metrics-for-all-schedulers&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1144"><a href="#ServerArgs.add_cli_args-1144"><span class="linenos">1144</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1145"><a href="#ServerArgs.add_cli_args-1145"><span class="linenos">1145</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable --enable-metrics-for-all-schedulers when you want schedulers on all TP ranks (not just TP 0) &quot;</span>
</span><span id="ServerArgs.add_cli_args-1146"><a href="#ServerArgs.add_cli_args-1146"><span class="linenos">1146</span></a>            <span class="s2">&quot;to record request metrics separately. This is especially useful when dp_attention is enabled, as &quot;</span>
</span><span id="ServerArgs.add_cli_args-1147"><a href="#ServerArgs.add_cli_args-1147"><span class="linenos">1147</span></a>            <span class="s2">&quot;otherwise all metrics appear to come from TP 0.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1148"><a href="#ServerArgs.add_cli_args-1148"><span class="linenos">1148</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1149"><a href="#ServerArgs.add_cli_args-1149"><span class="linenos">1149</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1150"><a href="#ServerArgs.add_cli_args-1150"><span class="linenos">1150</span></a>            <span class="s2">&quot;--bucket-time-to-first-token&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1151"><a href="#ServerArgs.add_cli_args-1151"><span class="linenos">1151</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1152"><a href="#ServerArgs.add_cli_args-1152"><span class="linenos">1152</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1153"><a href="#ServerArgs.add_cli_args-1153"><span class="linenos">1153</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_time_to_first_token</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1154"><a href="#ServerArgs.add_cli_args-1154"><span class="linenos">1154</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of time to first token, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1155"><a href="#ServerArgs.add_cli_args-1155"><span class="linenos">1155</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1156"><a href="#ServerArgs.add_cli_args-1156"><span class="linenos">1156</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1157"><a href="#ServerArgs.add_cli_args-1157"><span class="linenos">1157</span></a>            <span class="s2">&quot;--bucket-inter-token-latency&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1158"><a href="#ServerArgs.add_cli_args-1158"><span class="linenos">1158</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1159"><a href="#ServerArgs.add_cli_args-1159"><span class="linenos">1159</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1160"><a href="#ServerArgs.add_cli_args-1160"><span class="linenos">1160</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_inter_token_latency</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1161"><a href="#ServerArgs.add_cli_args-1161"><span class="linenos">1161</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of inter-token latency, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1162"><a href="#ServerArgs.add_cli_args-1162"><span class="linenos">1162</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1163"><a href="#ServerArgs.add_cli_args-1163"><span class="linenos">1163</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1164"><a href="#ServerArgs.add_cli_args-1164"><span class="linenos">1164</span></a>            <span class="s2">&quot;--bucket-e2e-request-latency&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1165"><a href="#ServerArgs.add_cli_args-1165"><span class="linenos">1165</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1166"><a href="#ServerArgs.add_cli_args-1166"><span class="linenos">1166</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1167"><a href="#ServerArgs.add_cli_args-1167"><span class="linenos">1167</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">bucket_e2e_request_latency</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1168"><a href="#ServerArgs.add_cli_args-1168"><span class="linenos">1168</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buckets of end-to-end request latency, specified as a list of floats.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1169"><a href="#ServerArgs.add_cli_args-1169"><span class="linenos">1169</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1170"><a href="#ServerArgs.add_cli_args-1170"><span class="linenos">1170</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1171"><a href="#ServerArgs.add_cli_args-1171"><span class="linenos">1171</span></a>            <span class="s2">&quot;--collect-tokens-histogram&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1172"><a href="#ServerArgs.add_cli_args-1172"><span class="linenos">1172</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1173"><a href="#ServerArgs.add_cli_args-1173"><span class="linenos">1173</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">collect_tokens_histogram</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1174"><a href="#ServerArgs.add_cli_args-1174"><span class="linenos">1174</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Collect prompt/generation tokens histogram.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1175"><a href="#ServerArgs.add_cli_args-1175"><span class="linenos">1175</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1176"><a href="#ServerArgs.add_cli_args-1176"><span class="linenos">1176</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1177"><a href="#ServerArgs.add_cli_args-1177"><span class="linenos">1177</span></a>            <span class="s2">&quot;--gc-warning-threshold-secs&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1178"><a href="#ServerArgs.add_cli_args-1178"><span class="linenos">1178</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1179"><a href="#ServerArgs.add_cli_args-1179"><span class="linenos">1179</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">gc_warning_threshold_secs</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1180"><a href="#ServerArgs.add_cli_args-1180"><span class="linenos">1180</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The threshold for long GC warning. If a GC takes longer than this, a warning will be logged. Set to 0 to disable.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1181"><a href="#ServerArgs.add_cli_args-1181"><span class="linenos">1181</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1182"><a href="#ServerArgs.add_cli_args-1182"><span class="linenos">1182</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1183"><a href="#ServerArgs.add_cli_args-1183"><span class="linenos">1183</span></a>            <span class="s2">&quot;--decode-log-interval&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1184"><a href="#ServerArgs.add_cli_args-1184"><span class="linenos">1184</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1185"><a href="#ServerArgs.add_cli_args-1185"><span class="linenos">1185</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">decode_log_interval</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1186"><a href="#ServerArgs.add_cli_args-1186"><span class="linenos">1186</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The log interval of decode batch.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1187"><a href="#ServerArgs.add_cli_args-1187"><span class="linenos">1187</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1188"><a href="#ServerArgs.add_cli_args-1188"><span class="linenos">1188</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1189"><a href="#ServerArgs.add_cli_args-1189"><span class="linenos">1189</span></a>            <span class="s2">&quot;--enable-request-time-stats-logging&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1190"><a href="#ServerArgs.add_cli_args-1190"><span class="linenos">1190</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1191"><a href="#ServerArgs.add_cli_args-1191"><span class="linenos">1191</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_request_time_stats_logging</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1192"><a href="#ServerArgs.add_cli_args-1192"><span class="linenos">1192</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable per request time stats logging&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1193"><a href="#ServerArgs.add_cli_args-1193"><span class="linenos">1193</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1194"><a href="#ServerArgs.add_cli_args-1194"><span class="linenos">1194</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1195"><a href="#ServerArgs.add_cli_args-1195"><span class="linenos">1195</span></a>            <span class="s2">&quot;--kv-events-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1196"><a href="#ServerArgs.add_cli_args-1196"><span class="linenos">1196</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1197"><a href="#ServerArgs.add_cli_args-1197"><span class="linenos">1197</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1198"><a href="#ServerArgs.add_cli_args-1198"><span class="linenos">1198</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Config in json format for NVIDIA dynamo KV event publishing. Publishing will be enabled if this flag is used.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1199"><a href="#ServerArgs.add_cli_args-1199"><span class="linenos">1199</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1200"><a href="#ServerArgs.add_cli_args-1200"><span class="linenos">1200</span></a>
</span><span id="ServerArgs.add_cli_args-1201"><a href="#ServerArgs.add_cli_args-1201"><span class="linenos">1201</span></a>        <span class="c1"># API related</span>
</span><span id="ServerArgs.add_cli_args-1202"><a href="#ServerArgs.add_cli_args-1202"><span class="linenos">1202</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1203"><a href="#ServerArgs.add_cli_args-1203"><span class="linenos">1203</span></a>            <span class="s2">&quot;--api-key&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1204"><a href="#ServerArgs.add_cli_args-1204"><span class="linenos">1204</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1205"><a href="#ServerArgs.add_cli_args-1205"><span class="linenos">1205</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1206"><a href="#ServerArgs.add_cli_args-1206"><span class="linenos">1206</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set API key of the server. It is also used in the OpenAI API compatible server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1207"><a href="#ServerArgs.add_cli_args-1207"><span class="linenos">1207</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1208"><a href="#ServerArgs.add_cli_args-1208"><span class="linenos">1208</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1209"><a href="#ServerArgs.add_cli_args-1209"><span class="linenos">1209</span></a>            <span class="s2">&quot;--served-model-name&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1210"><a href="#ServerArgs.add_cli_args-1210"><span class="linenos">1210</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1211"><a href="#ServerArgs.add_cli_args-1211"><span class="linenos">1211</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">served_model_name</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1212"><a href="#ServerArgs.add_cli_args-1212"><span class="linenos">1212</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Override the model name returned by the v1/models endpoint in OpenAI API server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1213"><a href="#ServerArgs.add_cli_args-1213"><span class="linenos">1213</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1214"><a href="#ServerArgs.add_cli_args-1214"><span class="linenos">1214</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1215"><a href="#ServerArgs.add_cli_args-1215"><span class="linenos">1215</span></a>            <span class="s2">&quot;--weight-version&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1216"><a href="#ServerArgs.add_cli_args-1216"><span class="linenos">1216</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1217"><a href="#ServerArgs.add_cli_args-1217"><span class="linenos">1217</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">weight_version</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1218"><a href="#ServerArgs.add_cli_args-1218"><span class="linenos">1218</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Version identifier for the model weights. Defaults to &#39;default&#39; if not specified.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1219"><a href="#ServerArgs.add_cli_args-1219"><span class="linenos">1219</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1220"><a href="#ServerArgs.add_cli_args-1220"><span class="linenos">1220</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1221"><a href="#ServerArgs.add_cli_args-1221"><span class="linenos">1221</span></a>            <span class="s2">&quot;--chat-template&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1222"><a href="#ServerArgs.add_cli_args-1222"><span class="linenos">1222</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1223"><a href="#ServerArgs.add_cli_args-1223"><span class="linenos">1223</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">chat_template</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1224"><a href="#ServerArgs.add_cli_args-1224"><span class="linenos">1224</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buliltin chat template name or the path of the chat template file. This is only used for OpenAI-compatible API server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1225"><a href="#ServerArgs.add_cli_args-1225"><span class="linenos">1225</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1226"><a href="#ServerArgs.add_cli_args-1226"><span class="linenos">1226</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1227"><a href="#ServerArgs.add_cli_args-1227"><span class="linenos">1227</span></a>            <span class="s2">&quot;--completion-template&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1228"><a href="#ServerArgs.add_cli_args-1228"><span class="linenos">1228</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1229"><a href="#ServerArgs.add_cli_args-1229"><span class="linenos">1229</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">completion_template</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1230"><a href="#ServerArgs.add_cli_args-1230"><span class="linenos">1230</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The buliltin completion template name or the path of the completion template file. This is only used for OpenAI-compatible API server. only for code completion currently.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1231"><a href="#ServerArgs.add_cli_args-1231"><span class="linenos">1231</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1232"><a href="#ServerArgs.add_cli_args-1232"><span class="linenos">1232</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1233"><a href="#ServerArgs.add_cli_args-1233"><span class="linenos">1233</span></a>            <span class="s2">&quot;--file-storage-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1234"><a href="#ServerArgs.add_cli_args-1234"><span class="linenos">1234</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1235"><a href="#ServerArgs.add_cli_args-1235"><span class="linenos">1235</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">file_storage_path</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1236"><a href="#ServerArgs.add_cli_args-1236"><span class="linenos">1236</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the file storage in backend.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1237"><a href="#ServerArgs.add_cli_args-1237"><span class="linenos">1237</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1238"><a href="#ServerArgs.add_cli_args-1238"><span class="linenos">1238</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1239"><a href="#ServerArgs.add_cli_args-1239"><span class="linenos">1239</span></a>            <span class="s2">&quot;--enable-cache-report&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1240"><a href="#ServerArgs.add_cli_args-1240"><span class="linenos">1240</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1241"><a href="#ServerArgs.add_cli_args-1241"><span class="linenos">1241</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Return number of cached tokens in usage.prompt_tokens_details for each openai request.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1242"><a href="#ServerArgs.add_cli_args-1242"><span class="linenos">1242</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1243"><a href="#ServerArgs.add_cli_args-1243"><span class="linenos">1243</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1244"><a href="#ServerArgs.add_cli_args-1244"><span class="linenos">1244</span></a>            <span class="s2">&quot;--reasoning-parser&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1245"><a href="#ServerArgs.add_cli_args-1245"><span class="linenos">1245</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1246"><a href="#ServerArgs.add_cli_args-1246"><span class="linenos">1246</span></a>            <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ReasoningParser</span><span class="o">.</span><span class="n">DetectorMap</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
</span><span id="ServerArgs.add_cli_args-1247"><a href="#ServerArgs.add_cli_args-1247"><span class="linenos">1247</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">reasoning_parser</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1248"><a href="#ServerArgs.add_cli_args-1248"><span class="linenos">1248</span></a>            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Specify the parser for reasoning models, supported parsers are: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ReasoningParser</span><span class="o">.</span><span class="n">DetectorMap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1249"><a href="#ServerArgs.add_cli_args-1249"><span class="linenos">1249</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1250"><a href="#ServerArgs.add_cli_args-1250"><span class="linenos">1250</span></a>        <span class="n">tool_call_parser_choices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FunctionCallParser</span><span class="o">.</span><span class="n">ToolCallParserEnum</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="ServerArgs.add_cli_args-1251"><a href="#ServerArgs.add_cli_args-1251"><span class="linenos">1251</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1252"><a href="#ServerArgs.add_cli_args-1252"><span class="linenos">1252</span></a>            <span class="s2">&quot;--tool-call-parser&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1253"><a href="#ServerArgs.add_cli_args-1253"><span class="linenos">1253</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1254"><a href="#ServerArgs.add_cli_args-1254"><span class="linenos">1254</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">tool_call_parser_choices</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1255"><a href="#ServerArgs.add_cli_args-1255"><span class="linenos">1255</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tool_call_parser</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1256"><a href="#ServerArgs.add_cli_args-1256"><span class="linenos">1256</span></a>            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Specify the parser for handling tool-call interactions. Options include: </span><span class="si">{</span><span class="n">tool_call_parser_choices</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1257"><a href="#ServerArgs.add_cli_args-1257"><span class="linenos">1257</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1258"><a href="#ServerArgs.add_cli_args-1258"><span class="linenos">1258</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1259"><a href="#ServerArgs.add_cli_args-1259"><span class="linenos">1259</span></a>            <span class="s2">&quot;--tool-server&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1260"><a href="#ServerArgs.add_cli_args-1260"><span class="linenos">1260</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1261"><a href="#ServerArgs.add_cli_args-1261"><span class="linenos">1261</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1262"><a href="#ServerArgs.add_cli_args-1262"><span class="linenos">1262</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Either &#39;demo&#39; or a comma-separated list of tool server urls to use for the model. If not specified, no tool server will be used.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1263"><a href="#ServerArgs.add_cli_args-1263"><span class="linenos">1263</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1264"><a href="#ServerArgs.add_cli_args-1264"><span class="linenos">1264</span></a>
</span><span id="ServerArgs.add_cli_args-1265"><a href="#ServerArgs.add_cli_args-1265"><span class="linenos">1265</span></a>        <span class="c1"># Data parallelism</span>
</span><span id="ServerArgs.add_cli_args-1266"><a href="#ServerArgs.add_cli_args-1266"><span class="linenos">1266</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1267"><a href="#ServerArgs.add_cli_args-1267"><span class="linenos">1267</span></a>            <span class="s2">&quot;--data-parallel-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1268"><a href="#ServerArgs.add_cli_args-1268"><span class="linenos">1268</span></a>            <span class="s2">&quot;--dp-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1269"><a href="#ServerArgs.add_cli_args-1269"><span class="linenos">1269</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1270"><a href="#ServerArgs.add_cli_args-1270"><span class="linenos">1270</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">dp_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1271"><a href="#ServerArgs.add_cli_args-1271"><span class="linenos">1271</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The data parallelism size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1272"><a href="#ServerArgs.add_cli_args-1272"><span class="linenos">1272</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1273"><a href="#ServerArgs.add_cli_args-1273"><span class="linenos">1273</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1274"><a href="#ServerArgs.add_cli_args-1274"><span class="linenos">1274</span></a>            <span class="s2">&quot;--load-balance-method&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1275"><a href="#ServerArgs.add_cli_args-1275"><span class="linenos">1275</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1276"><a href="#ServerArgs.add_cli_args-1276"><span class="linenos">1276</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">load_balance_method</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1277"><a href="#ServerArgs.add_cli_args-1277"><span class="linenos">1277</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The load balancing strategy for data parallelism.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1278"><a href="#ServerArgs.add_cli_args-1278"><span class="linenos">1278</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="ServerArgs.add_cli_args-1279"><a href="#ServerArgs.add_cli_args-1279"><span class="linenos">1279</span></a>                <span class="s2">&quot;round_robin&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1280"><a href="#ServerArgs.add_cli_args-1280"><span class="linenos">1280</span></a>                <span class="s2">&quot;shortest_queue&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1281"><a href="#ServerArgs.add_cli_args-1281"><span class="linenos">1281</span></a>                <span class="s2">&quot;minimum_tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1282"><a href="#ServerArgs.add_cli_args-1282"><span class="linenos">1282</span></a>            <span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1283"><a href="#ServerArgs.add_cli_args-1283"><span class="linenos">1283</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1284"><a href="#ServerArgs.add_cli_args-1284"><span class="linenos">1284</span></a>
</span><span id="ServerArgs.add_cli_args-1285"><a href="#ServerArgs.add_cli_args-1285"><span class="linenos">1285</span></a>        <span class="c1"># Multi-node distributed serving</span>
</span><span id="ServerArgs.add_cli_args-1286"><a href="#ServerArgs.add_cli_args-1286"><span class="linenos">1286</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1287"><a href="#ServerArgs.add_cli_args-1287"><span class="linenos">1287</span></a>            <span class="s2">&quot;--dist-init-addr&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1288"><a href="#ServerArgs.add_cli_args-1288"><span class="linenos">1288</span></a>            <span class="s2">&quot;--nccl-init-addr&quot;</span><span class="p">,</span>  <span class="c1"># For backward compatibility. This will be removed in the future.</span>
</span><span id="ServerArgs.add_cli_args-1289"><a href="#ServerArgs.add_cli_args-1289"><span class="linenos">1289</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1290"><a href="#ServerArgs.add_cli_args-1290"><span class="linenos">1290</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The host address for initializing distributed backend (e.g., `192.168.0.2:25000`).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1291"><a href="#ServerArgs.add_cli_args-1291"><span class="linenos">1291</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1292"><a href="#ServerArgs.add_cli_args-1292"><span class="linenos">1292</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1293"><a href="#ServerArgs.add_cli_args-1293"><span class="linenos">1293</span></a>            <span class="s2">&quot;--nnodes&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">nnodes</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of nodes.&quot;</span>
</span><span id="ServerArgs.add_cli_args-1294"><a href="#ServerArgs.add_cli_args-1294"><span class="linenos">1294</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1295"><a href="#ServerArgs.add_cli_args-1295"><span class="linenos">1295</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1296"><a href="#ServerArgs.add_cli_args-1296"><span class="linenos">1296</span></a>            <span class="s2">&quot;--node-rank&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">node_rank</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The node rank.&quot;</span>
</span><span id="ServerArgs.add_cli_args-1297"><a href="#ServerArgs.add_cli_args-1297"><span class="linenos">1297</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1298"><a href="#ServerArgs.add_cli_args-1298"><span class="linenos">1298</span></a>
</span><span id="ServerArgs.add_cli_args-1299"><a href="#ServerArgs.add_cli_args-1299"><span class="linenos">1299</span></a>        <span class="c1"># Model override args</span>
</span><span id="ServerArgs.add_cli_args-1300"><a href="#ServerArgs.add_cli_args-1300"><span class="linenos">1300</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1301"><a href="#ServerArgs.add_cli_args-1301"><span class="linenos">1301</span></a>            <span class="s2">&quot;--json-model-override-args&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1302"><a href="#ServerArgs.add_cli_args-1302"><span class="linenos">1302</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1303"><a href="#ServerArgs.add_cli_args-1303"><span class="linenos">1303</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A dictionary in JSON string format used to override default model configurations.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1304"><a href="#ServerArgs.add_cli_args-1304"><span class="linenos">1304</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">json_model_override_args</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1305"><a href="#ServerArgs.add_cli_args-1305"><span class="linenos">1305</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1306"><a href="#ServerArgs.add_cli_args-1306"><span class="linenos">1306</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1307"><a href="#ServerArgs.add_cli_args-1307"><span class="linenos">1307</span></a>            <span class="s2">&quot;--preferred-sampling-params&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1308"><a href="#ServerArgs.add_cli_args-1308"><span class="linenos">1308</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1309"><a href="#ServerArgs.add_cli_args-1309"><span class="linenos">1309</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;json-formatted sampling settings that will be returned in /get_model_info&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1310"><a href="#ServerArgs.add_cli_args-1310"><span class="linenos">1310</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1311"><a href="#ServerArgs.add_cli_args-1311"><span class="linenos">1311</span></a>
</span><span id="ServerArgs.add_cli_args-1312"><a href="#ServerArgs.add_cli_args-1312"><span class="linenos">1312</span></a>        <span class="c1"># LoRA</span>
</span><span id="ServerArgs.add_cli_args-1313"><a href="#ServerArgs.add_cli_args-1313"><span class="linenos">1313</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1314"><a href="#ServerArgs.add_cli_args-1314"><span class="linenos">1314</span></a>            <span class="s2">&quot;--enable-lora&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1315"><a href="#ServerArgs.add_cli_args-1315"><span class="linenos">1315</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">enable_lora</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1316"><a href="#ServerArgs.add_cli_args-1316"><span class="linenos">1316</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1317"><a href="#ServerArgs.add_cli_args-1317"><span class="linenos">1317</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable LoRA support for the model. This argument is automatically set to True if `--lora-paths` is provided for backward compatibility.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1318"><a href="#ServerArgs.add_cli_args-1318"><span class="linenos">1318</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1319"><a href="#ServerArgs.add_cli_args-1319"><span class="linenos">1319</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1320"><a href="#ServerArgs.add_cli_args-1320"><span class="linenos">1320</span></a>            <span class="s2">&quot;--max-lora-rank&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1321"><a href="#ServerArgs.add_cli_args-1321"><span class="linenos">1321</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_lora_rank</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1322"><a href="#ServerArgs.add_cli_args-1322"><span class="linenos">1322</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1323"><a href="#ServerArgs.add_cli_args-1323"><span class="linenos">1323</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum rank of LoRA adapters. If not specified, it will be automatically inferred from the adapters provided in --lora-paths.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1324"><a href="#ServerArgs.add_cli_args-1324"><span class="linenos">1324</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1325"><a href="#ServerArgs.add_cli_args-1325"><span class="linenos">1325</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1326"><a href="#ServerArgs.add_cli_args-1326"><span class="linenos">1326</span></a>            <span class="s2">&quot;--lora-target-modules&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1327"><a href="#ServerArgs.add_cli_args-1327"><span class="linenos">1327</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1328"><a href="#ServerArgs.add_cli_args-1328"><span class="linenos">1328</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">SUPPORTED_LORA_TARGET_MODULES</span> <span class="o">+</span> <span class="p">[</span><span class="n">LORA_TARGET_ALL_MODULES</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1329"><a href="#ServerArgs.add_cli_args-1329"><span class="linenos">1329</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1330"><a href="#ServerArgs.add_cli_args-1330"><span class="linenos">1330</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1331"><a href="#ServerArgs.add_cli_args-1331"><span class="linenos">1331</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The union set of all target modules where LoRA should be applied. If not specified, &quot;</span>
</span><span id="ServerArgs.add_cli_args-1332"><a href="#ServerArgs.add_cli_args-1332"><span class="linenos">1332</span></a>            <span class="s2">&quot;it will be automatically inferred from the adapters provided in --lora-paths. If &#39;all&#39; is specified, &quot;</span>
</span><span id="ServerArgs.add_cli_args-1333"><a href="#ServerArgs.add_cli_args-1333"><span class="linenos">1333</span></a>            <span class="s2">&quot;all supported modules will be targeted.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1334"><a href="#ServerArgs.add_cli_args-1334"><span class="linenos">1334</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1335"><a href="#ServerArgs.add_cli_args-1335"><span class="linenos">1335</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1336"><a href="#ServerArgs.add_cli_args-1336"><span class="linenos">1336</span></a>            <span class="s2">&quot;--lora-paths&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1337"><a href="#ServerArgs.add_cli_args-1337"><span class="linenos">1337</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1338"><a href="#ServerArgs.add_cli_args-1338"><span class="linenos">1338</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1339"><a href="#ServerArgs.add_cli_args-1339"><span class="linenos">1339</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1340"><a href="#ServerArgs.add_cli_args-1340"><span class="linenos">1340</span></a>            <span class="n">action</span><span class="o">=</span><span class="n">LoRAPathAction</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1341"><a href="#ServerArgs.add_cli_args-1341"><span class="linenos">1341</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The list of LoRA adapters to load. Each adapter must be specified in one of the following formats: &lt;PATH&gt; | &lt;NAME&gt;=&lt;PATH&gt; | JSON with schema {&quot;lora_name&quot;:str,&quot;lora_path&quot;:str,&quot;pinned&quot;:bool}&#39;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1342"><a href="#ServerArgs.add_cli_args-1342"><span class="linenos">1342</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1343"><a href="#ServerArgs.add_cli_args-1343"><span class="linenos">1343</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1344"><a href="#ServerArgs.add_cli_args-1344"><span class="linenos">1344</span></a>            <span class="s2">&quot;--max-loras-per-batch&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1345"><a href="#ServerArgs.add_cli_args-1345"><span class="linenos">1345</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1346"><a href="#ServerArgs.add_cli_args-1346"><span class="linenos">1346</span></a>            <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1347"><a href="#ServerArgs.add_cli_args-1347"><span class="linenos">1347</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum number of adapters for a running batch, include base-only request.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1348"><a href="#ServerArgs.add_cli_args-1348"><span class="linenos">1348</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1349"><a href="#ServerArgs.add_cli_args-1349"><span class="linenos">1349</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1350"><a href="#ServerArgs.add_cli_args-1350"><span class="linenos">1350</span></a>            <span class="s2">&quot;--max-loaded-loras&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1351"><a href="#ServerArgs.add_cli_args-1351"><span class="linenos">1351</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1352"><a href="#ServerArgs.add_cli_args-1352"><span class="linenos">1352</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1353"><a href="#ServerArgs.add_cli_args-1353"><span class="linenos">1353</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If specified, it limits the maximum number of LoRA adapters loaded in CPU memory at a time. The value must be greater than or equal to `--max-loras-per-batch`.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1354"><a href="#ServerArgs.add_cli_args-1354"><span class="linenos">1354</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1355"><a href="#ServerArgs.add_cli_args-1355"><span class="linenos">1355</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1356"><a href="#ServerArgs.add_cli_args-1356"><span class="linenos">1356</span></a>            <span class="s2">&quot;--lora-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1357"><a href="#ServerArgs.add_cli_args-1357"><span class="linenos">1357</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1358"><a href="#ServerArgs.add_cli_args-1358"><span class="linenos">1358</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1359"><a href="#ServerArgs.add_cli_args-1359"><span class="linenos">1359</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernel backend for multi-LoRA serving.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1360"><a href="#ServerArgs.add_cli_args-1360"><span class="linenos">1360</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1361"><a href="#ServerArgs.add_cli_args-1361"><span class="linenos">1361</span></a>
</span><span id="ServerArgs.add_cli_args-1362"><a href="#ServerArgs.add_cli_args-1362"><span class="linenos">1362</span></a>        <span class="c1"># Kernel backend</span>
</span><span id="ServerArgs.add_cli_args-1363"><a href="#ServerArgs.add_cli_args-1363"><span class="linenos">1363</span></a>        <span class="n">ATTN_BACKENDS</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ServerArgs.add_cli_args-1364"><a href="#ServerArgs.add_cli_args-1364"><span class="linenos">1364</span></a>            <span class="c1"># Common</span>
</span><span id="ServerArgs.add_cli_args-1365"><a href="#ServerArgs.add_cli_args-1365"><span class="linenos">1365</span></a>            <span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1366"><a href="#ServerArgs.add_cli_args-1366"><span class="linenos">1366</span></a>            <span class="s2">&quot;torch_native&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1367"><a href="#ServerArgs.add_cli_args-1367"><span class="linenos">1367</span></a>            <span class="c1"># NVIDIA specific</span>
</span><span id="ServerArgs.add_cli_args-1368"><a href="#ServerArgs.add_cli_args-1368"><span class="linenos">1368</span></a>            <span class="s2">&quot;cutlass_mla&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1369"><a href="#ServerArgs.add_cli_args-1369"><span class="linenos">1369</span></a>            <span class="s2">&quot;fa3&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1370"><a href="#ServerArgs.add_cli_args-1370"><span class="linenos">1370</span></a>            <span class="s2">&quot;flashinfer&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1371"><a href="#ServerArgs.add_cli_args-1371"><span class="linenos">1371</span></a>            <span class="s2">&quot;flashmla&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1372"><a href="#ServerArgs.add_cli_args-1372"><span class="linenos">1372</span></a>            <span class="s2">&quot;trtllm_mla&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1373"><a href="#ServerArgs.add_cli_args-1373"><span class="linenos">1373</span></a>            <span class="s2">&quot;trtllm_mha&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1374"><a href="#ServerArgs.add_cli_args-1374"><span class="linenos">1374</span></a>            <span class="s2">&quot;dual_chunk_flash_attn&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1375"><a href="#ServerArgs.add_cli_args-1375"><span class="linenos">1375</span></a>            <span class="c1"># AMD specific</span>
</span><span id="ServerArgs.add_cli_args-1376"><a href="#ServerArgs.add_cli_args-1376"><span class="linenos">1376</span></a>            <span class="s2">&quot;aiter&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1377"><a href="#ServerArgs.add_cli_args-1377"><span class="linenos">1377</span></a>            <span class="s2">&quot;wave&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1378"><a href="#ServerArgs.add_cli_args-1378"><span class="linenos">1378</span></a>            <span class="c1"># Other platforms</span>
</span><span id="ServerArgs.add_cli_args-1379"><a href="#ServerArgs.add_cli_args-1379"><span class="linenos">1379</span></a>            <span class="s2">&quot;intel_amx&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1380"><a href="#ServerArgs.add_cli_args-1380"><span class="linenos">1380</span></a>            <span class="s2">&quot;ascend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1381"><a href="#ServerArgs.add_cli_args-1381"><span class="linenos">1381</span></a>        <span class="p">]</span>
</span><span id="ServerArgs.add_cli_args-1382"><a href="#ServerArgs.add_cli_args-1382"><span class="linenos">1382</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1383"><a href="#ServerArgs.add_cli_args-1383"><span class="linenos">1383</span></a>            <span class="s2">&quot;--attention-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1384"><a href="#ServerArgs.add_cli_args-1384"><span class="linenos">1384</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1385"><a href="#ServerArgs.add_cli_args-1385"><span class="linenos">1385</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1386"><a href="#ServerArgs.add_cli_args-1386"><span class="linenos">1386</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">attention_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1387"><a href="#ServerArgs.add_cli_args-1387"><span class="linenos">1387</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for attention layers.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1388"><a href="#ServerArgs.add_cli_args-1388"><span class="linenos">1388</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1389"><a href="#ServerArgs.add_cli_args-1389"><span class="linenos">1389</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1390"><a href="#ServerArgs.add_cli_args-1390"><span class="linenos">1390</span></a>            <span class="s2">&quot;--prefill-attention-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1391"><a href="#ServerArgs.add_cli_args-1391"><span class="linenos">1391</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1392"><a href="#ServerArgs.add_cli_args-1392"><span class="linenos">1392</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1393"><a href="#ServerArgs.add_cli_args-1393"><span class="linenos">1393</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">prefill_attention_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1394"><a href="#ServerArgs.add_cli_args-1394"><span class="linenos">1394</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for prefill attention layers (have priority over --attention-backend).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1395"><a href="#ServerArgs.add_cli_args-1395"><span class="linenos">1395</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1396"><a href="#ServerArgs.add_cli_args-1396"><span class="linenos">1396</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1397"><a href="#ServerArgs.add_cli_args-1397"><span class="linenos">1397</span></a>            <span class="s2">&quot;--decode-attention-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1398"><a href="#ServerArgs.add_cli_args-1398"><span class="linenos">1398</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1399"><a href="#ServerArgs.add_cli_args-1399"><span class="linenos">1399</span></a>            <span class="n">choices</span><span class="o">=</span><span class="n">ATTN_BACKENDS</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1400"><a href="#ServerArgs.add_cli_args-1400"><span class="linenos">1400</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">decode_attention_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1401"><a href="#ServerArgs.add_cli_args-1401"><span class="linenos">1401</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for decode attention layers (have priority over --attention-backend).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1402"><a href="#ServerArgs.add_cli_args-1402"><span class="linenos">1402</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1403"><a href="#ServerArgs.add_cli_args-1403"><span class="linenos">1403</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1404"><a href="#ServerArgs.add_cli_args-1404"><span class="linenos">1404</span></a>            <span class="s2">&quot;--sampling-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1405"><a href="#ServerArgs.add_cli_args-1405"><span class="linenos">1405</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1406"><a href="#ServerArgs.add_cli_args-1406"><span class="linenos">1406</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flashinfer&quot;</span><span class="p">,</span> <span class="s2">&quot;pytorch&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1407"><a href="#ServerArgs.add_cli_args-1407"><span class="linenos">1407</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">sampling_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1408"><a href="#ServerArgs.add_cli_args-1408"><span class="linenos">1408</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the kernels for sampling layers.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1409"><a href="#ServerArgs.add_cli_args-1409"><span class="linenos">1409</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1410"><a href="#ServerArgs.add_cli_args-1410"><span class="linenos">1410</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1411"><a href="#ServerArgs.add_cli_args-1411"><span class="linenos">1411</span></a>            <span class="s2">&quot;--grammar-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1412"><a href="#ServerArgs.add_cli_args-1412"><span class="linenos">1412</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1413"><a href="#ServerArgs.add_cli_args-1413"><span class="linenos">1413</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xgrammar&quot;</span><span class="p">,</span> <span class="s2">&quot;outlines&quot;</span><span class="p">,</span> <span class="s2">&quot;llguidance&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1414"><a href="#ServerArgs.add_cli_args-1414"><span class="linenos">1414</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">grammar_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1415"><a href="#ServerArgs.add_cli_args-1415"><span class="linenos">1415</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the backend for grammar-guided decoding.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1416"><a href="#ServerArgs.add_cli_args-1416"><span class="linenos">1416</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1417"><a href="#ServerArgs.add_cli_args-1417"><span class="linenos">1417</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1418"><a href="#ServerArgs.add_cli_args-1418"><span class="linenos">1418</span></a>            <span class="s2">&quot;--mm-attention-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1419"><a href="#ServerArgs.add_cli_args-1419"><span class="linenos">1419</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1420"><a href="#ServerArgs.add_cli_args-1420"><span class="linenos">1420</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sdpa&quot;</span><span class="p">,</span> <span class="s2">&quot;fa3&quot;</span><span class="p">,</span> <span class="s2">&quot;triton_attn&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1421"><a href="#ServerArgs.add_cli_args-1421"><span class="linenos">1421</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">mm_attention_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1422"><a href="#ServerArgs.add_cli_args-1422"><span class="linenos">1422</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set multimodal attention backend.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1423"><a href="#ServerArgs.add_cli_args-1423"><span class="linenos">1423</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1424"><a href="#ServerArgs.add_cli_args-1424"><span class="linenos">1424</span></a>
</span><span id="ServerArgs.add_cli_args-1425"><a href="#ServerArgs.add_cli_args-1425"><span class="linenos">1425</span></a>        <span class="c1"># Speculative decoding</span>
</span><span id="ServerArgs.add_cli_args-1426"><a href="#ServerArgs.add_cli_args-1426"><span class="linenos">1426</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1427"><a href="#ServerArgs.add_cli_args-1427"><span class="linenos">1427</span></a>            <span class="s2">&quot;--speculative-algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1428"><a href="#ServerArgs.add_cli_args-1428"><span class="linenos">1428</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1429"><a href="#ServerArgs.add_cli_args-1429"><span class="linenos">1429</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EAGLE&quot;</span><span class="p">,</span> <span class="s2">&quot;EAGLE3&quot;</span><span class="p">,</span> <span class="s2">&quot;NEXTN&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1430"><a href="#ServerArgs.add_cli_args-1430"><span class="linenos">1430</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Speculative algorithm.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1431"><a href="#ServerArgs.add_cli_args-1431"><span class="linenos">1431</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1432"><a href="#ServerArgs.add_cli_args-1432"><span class="linenos">1432</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1433"><a href="#ServerArgs.add_cli_args-1433"><span class="linenos">1433</span></a>            <span class="s2">&quot;--speculative-draft-model-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1434"><a href="#ServerArgs.add_cli_args-1434"><span class="linenos">1434</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1435"><a href="#ServerArgs.add_cli_args-1435"><span class="linenos">1435</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the draft model weights. This can be a local folder or a Hugging Face repo ID.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1436"><a href="#ServerArgs.add_cli_args-1436"><span class="linenos">1436</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1437"><a href="#ServerArgs.add_cli_args-1437"><span class="linenos">1437</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1438"><a href="#ServerArgs.add_cli_args-1438"><span class="linenos">1438</span></a>            <span class="s2">&quot;--speculative-num-steps&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1439"><a href="#ServerArgs.add_cli_args-1439"><span class="linenos">1439</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1440"><a href="#ServerArgs.add_cli_args-1440"><span class="linenos">1440</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of steps sampled from draft model in Speculative Decoding.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1441"><a href="#ServerArgs.add_cli_args-1441"><span class="linenos">1441</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_num_steps</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1442"><a href="#ServerArgs.add_cli_args-1442"><span class="linenos">1442</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1443"><a href="#ServerArgs.add_cli_args-1443"><span class="linenos">1443</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1444"><a href="#ServerArgs.add_cli_args-1444"><span class="linenos">1444</span></a>            <span class="s2">&quot;--speculative-eagle-topk&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1445"><a href="#ServerArgs.add_cli_args-1445"><span class="linenos">1445</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1446"><a href="#ServerArgs.add_cli_args-1446"><span class="linenos">1446</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens sampled from the draft model in eagle2 each step.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1447"><a href="#ServerArgs.add_cli_args-1447"><span class="linenos">1447</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_eagle_topk</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1448"><a href="#ServerArgs.add_cli_args-1448"><span class="linenos">1448</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1449"><a href="#ServerArgs.add_cli_args-1449"><span class="linenos">1449</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1450"><a href="#ServerArgs.add_cli_args-1450"><span class="linenos">1450</span></a>            <span class="s2">&quot;--speculative-num-draft-tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1451"><a href="#ServerArgs.add_cli_args-1451"><span class="linenos">1451</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1452"><a href="#ServerArgs.add_cli_args-1452"><span class="linenos">1452</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of tokens sampled from the draft model in Speculative Decoding.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1453"><a href="#ServerArgs.add_cli_args-1453"><span class="linenos">1453</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_num_draft_tokens</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1454"><a href="#ServerArgs.add_cli_args-1454"><span class="linenos">1454</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1455"><a href="#ServerArgs.add_cli_args-1455"><span class="linenos">1455</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1456"><a href="#ServerArgs.add_cli_args-1456"><span class="linenos">1456</span></a>            <span class="s2">&quot;--speculative-accept-threshold-single&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1457"><a href="#ServerArgs.add_cli_args-1457"><span class="linenos">1457</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1458"><a href="#ServerArgs.add_cli_args-1458"><span class="linenos">1458</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Accept a draft token if its probability in the target model is greater than this threshold.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1459"><a href="#ServerArgs.add_cli_args-1459"><span class="linenos">1459</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_accept_threshold_single</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1460"><a href="#ServerArgs.add_cli_args-1460"><span class="linenos">1460</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1461"><a href="#ServerArgs.add_cli_args-1461"><span class="linenos">1461</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1462"><a href="#ServerArgs.add_cli_args-1462"><span class="linenos">1462</span></a>            <span class="s2">&quot;--speculative-accept-threshold-acc&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1463"><a href="#ServerArgs.add_cli_args-1463"><span class="linenos">1463</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1464"><a href="#ServerArgs.add_cli_args-1464"><span class="linenos">1464</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The accept probability of a draft token is raised from its target probability p to min(1, p / threshold_acc).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1465"><a href="#ServerArgs.add_cli_args-1465"><span class="linenos">1465</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_accept_threshold_acc</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1466"><a href="#ServerArgs.add_cli_args-1466"><span class="linenos">1466</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1467"><a href="#ServerArgs.add_cli_args-1467"><span class="linenos">1467</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1468"><a href="#ServerArgs.add_cli_args-1468"><span class="linenos">1468</span></a>            <span class="s2">&quot;--speculative-token-map&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1469"><a href="#ServerArgs.add_cli_args-1469"><span class="linenos">1469</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1470"><a href="#ServerArgs.add_cli_args-1470"><span class="linenos">1470</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the draft model&#39;s small vocab table.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1471"><a href="#ServerArgs.add_cli_args-1471"><span class="linenos">1471</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">speculative_token_map</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1472"><a href="#ServerArgs.add_cli_args-1472"><span class="linenos">1472</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1473"><a href="#ServerArgs.add_cli_args-1473"><span class="linenos">1473</span></a>
</span><span id="ServerArgs.add_cli_args-1474"><a href="#ServerArgs.add_cli_args-1474"><span class="linenos">1474</span></a>        <span class="c1"># Expert parallelism</span>
</span><span id="ServerArgs.add_cli_args-1475"><a href="#ServerArgs.add_cli_args-1475"><span class="linenos">1475</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1476"><a href="#ServerArgs.add_cli_args-1476"><span class="linenos">1476</span></a>            <span class="s2">&quot;--expert-parallel-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1477"><a href="#ServerArgs.add_cli_args-1477"><span class="linenos">1477</span></a>            <span class="s2">&quot;--ep-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1478"><a href="#ServerArgs.add_cli_args-1478"><span class="linenos">1478</span></a>            <span class="s2">&quot;--ep&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1479"><a href="#ServerArgs.add_cli_args-1479"><span class="linenos">1479</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1480"><a href="#ServerArgs.add_cli_args-1480"><span class="linenos">1480</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1481"><a href="#ServerArgs.add_cli_args-1481"><span class="linenos">1481</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The expert parallelism size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1482"><a href="#ServerArgs.add_cli_args-1482"><span class="linenos">1482</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1483"><a href="#ServerArgs.add_cli_args-1483"><span class="linenos">1483</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1484"><a href="#ServerArgs.add_cli_args-1484"><span class="linenos">1484</span></a>            <span class="s2">&quot;--moe-a2a-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1485"><a href="#ServerArgs.add_cli_args-1485"><span class="linenos">1485</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1486"><a href="#ServerArgs.add_cli_args-1486"><span class="linenos">1486</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;deepep&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1487"><a href="#ServerArgs.add_cli_args-1487"><span class="linenos">1487</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_a2a_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1488"><a href="#ServerArgs.add_cli_args-1488"><span class="linenos">1488</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the backend for MoE A2A.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1489"><a href="#ServerArgs.add_cli_args-1489"><span class="linenos">1489</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1490"><a href="#ServerArgs.add_cli_args-1490"><span class="linenos">1490</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1491"><a href="#ServerArgs.add_cli_args-1491"><span class="linenos">1491</span></a>            <span class="s2">&quot;--moe-runner-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1492"><a href="#ServerArgs.add_cli_args-1492"><span class="linenos">1492</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1493"><a href="#ServerArgs.add_cli_args-1493"><span class="linenos">1493</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span>
</span><span id="ServerArgs.add_cli_args-1494"><a href="#ServerArgs.add_cli_args-1494"><span class="linenos">1494</span></a>                <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1495"><a href="#ServerArgs.add_cli_args-1495"><span class="linenos">1495</span></a>                <span class="s2">&quot;triton&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1496"><a href="#ServerArgs.add_cli_args-1496"><span class="linenos">1496</span></a>                <span class="s2">&quot;triton_kernel&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1497"><a href="#ServerArgs.add_cli_args-1497"><span class="linenos">1497</span></a>                <span class="s2">&quot;flashinfer_trtllm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1498"><a href="#ServerArgs.add_cli_args-1498"><span class="linenos">1498</span></a>                <span class="s2">&quot;flashinfer_cutlass&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1499"><a href="#ServerArgs.add_cli_args-1499"><span class="linenos">1499</span></a>                <span class="s2">&quot;flashinfer_mxfp4&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1500"><a href="#ServerArgs.add_cli_args-1500"><span class="linenos">1500</span></a>            <span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1501"><a href="#ServerArgs.add_cli_args-1501"><span class="linenos">1501</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_runner_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1502"><a href="#ServerArgs.add_cli_args-1502"><span class="linenos">1502</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the runner backend for MoE.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1503"><a href="#ServerArgs.add_cli_args-1503"><span class="linenos">1503</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1504"><a href="#ServerArgs.add_cli_args-1504"><span class="linenos">1504</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1505"><a href="#ServerArgs.add_cli_args-1505"><span class="linenos">1505</span></a>            <span class="s2">&quot;--flashinfer-mxfp4-moe-precision&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1506"><a href="#ServerArgs.add_cli_args-1506"><span class="linenos">1506</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1507"><a href="#ServerArgs.add_cli_args-1507"><span class="linenos">1507</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mxfp4&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1508"><a href="#ServerArgs.add_cli_args-1508"><span class="linenos">1508</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">flashinfer_mxfp4_moe_precision</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1509"><a href="#ServerArgs.add_cli_args-1509"><span class="linenos">1509</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the computation precision of flashinfer mxfp4 moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1510"><a href="#ServerArgs.add_cli_args-1510"><span class="linenos">1510</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1511"><a href="#ServerArgs.add_cli_args-1511"><span class="linenos">1511</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1512"><a href="#ServerArgs.add_cli_args-1512"><span class="linenos">1512</span></a>            <span class="s2">&quot;--enable-flashinfer-allreduce-fusion&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1513"><a href="#ServerArgs.add_cli_args-1513"><span class="linenos">1513</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1514"><a href="#ServerArgs.add_cli_args-1514"><span class="linenos">1514</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable FlashInfer allreduce fusion with Residual RMSNorm.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1515"><a href="#ServerArgs.add_cli_args-1515"><span class="linenos">1515</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1516"><a href="#ServerArgs.add_cli_args-1516"><span class="linenos">1516</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1517"><a href="#ServerArgs.add_cli_args-1517"><span class="linenos">1517</span></a>            <span class="s2">&quot;--deepep-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1518"><a href="#ServerArgs.add_cli_args-1518"><span class="linenos">1518</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1519"><a href="#ServerArgs.add_cli_args-1519"><span class="linenos">1519</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;low_latency&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1520"><a href="#ServerArgs.add_cli_args-1520"><span class="linenos">1520</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1521"><a href="#ServerArgs.add_cli_args-1521"><span class="linenos">1521</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Select the mode when enable DeepEP MoE, could be `normal`, `low_latency` or `auto`. Default is `auto`, which means `low_latency` for decode batch and `normal` for prefill batch.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1522"><a href="#ServerArgs.add_cli_args-1522"><span class="linenos">1522</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1523"><a href="#ServerArgs.add_cli_args-1523"><span class="linenos">1523</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1524"><a href="#ServerArgs.add_cli_args-1524"><span class="linenos">1524</span></a>            <span class="s2">&quot;--ep-num-redundant-experts&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1525"><a href="#ServerArgs.add_cli_args-1525"><span class="linenos">1525</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1526"><a href="#ServerArgs.add_cli_args-1526"><span class="linenos">1526</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_num_redundant_experts</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1527"><a href="#ServerArgs.add_cli_args-1527"><span class="linenos">1527</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allocate this number of redundant experts in expert parallel.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1528"><a href="#ServerArgs.add_cli_args-1528"><span class="linenos">1528</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1529"><a href="#ServerArgs.add_cli_args-1529"><span class="linenos">1529</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1530"><a href="#ServerArgs.add_cli_args-1530"><span class="linenos">1530</span></a>            <span class="s2">&quot;--ep-dispatch-algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1531"><a href="#ServerArgs.add_cli_args-1531"><span class="linenos">1531</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1532"><a href="#ServerArgs.add_cli_args-1532"><span class="linenos">1532</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ep_dispatch_algorithm</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1533"><a href="#ServerArgs.add_cli_args-1533"><span class="linenos">1533</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The algorithm to choose ranks for redundant experts in expert parallel.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1534"><a href="#ServerArgs.add_cli_args-1534"><span class="linenos">1534</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1535"><a href="#ServerArgs.add_cli_args-1535"><span class="linenos">1535</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1536"><a href="#ServerArgs.add_cli_args-1536"><span class="linenos">1536</span></a>            <span class="s2">&quot;--init-expert-location&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1537"><a href="#ServerArgs.add_cli_args-1537"><span class="linenos">1537</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1538"><a href="#ServerArgs.add_cli_args-1538"><span class="linenos">1538</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">init_expert_location</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1539"><a href="#ServerArgs.add_cli_args-1539"><span class="linenos">1539</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Initial location of EP experts.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1540"><a href="#ServerArgs.add_cli_args-1540"><span class="linenos">1540</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1541"><a href="#ServerArgs.add_cli_args-1541"><span class="linenos">1541</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1542"><a href="#ServerArgs.add_cli_args-1542"><span class="linenos">1542</span></a>            <span class="s2">&quot;--enable-eplb&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1543"><a href="#ServerArgs.add_cli_args-1543"><span class="linenos">1543</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1544"><a href="#ServerArgs.add_cli_args-1544"><span class="linenos">1544</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable EPLB algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1545"><a href="#ServerArgs.add_cli_args-1545"><span class="linenos">1545</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1546"><a href="#ServerArgs.add_cli_args-1546"><span class="linenos">1546</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1547"><a href="#ServerArgs.add_cli_args-1547"><span class="linenos">1547</span></a>            <span class="s2">&quot;--eplb-algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1548"><a href="#ServerArgs.add_cli_args-1548"><span class="linenos">1548</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1549"><a href="#ServerArgs.add_cli_args-1549"><span class="linenos">1549</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_algorithm</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1550"><a href="#ServerArgs.add_cli_args-1550"><span class="linenos">1550</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Chosen EPLB algorithm&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1551"><a href="#ServerArgs.add_cli_args-1551"><span class="linenos">1551</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1552"><a href="#ServerArgs.add_cli_args-1552"><span class="linenos">1552</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1553"><a href="#ServerArgs.add_cli_args-1553"><span class="linenos">1553</span></a>            <span class="s2">&quot;--eplb-rebalance-num-iterations&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1554"><a href="#ServerArgs.add_cli_args-1554"><span class="linenos">1554</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1555"><a href="#ServerArgs.add_cli_args-1555"><span class="linenos">1555</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_rebalance_num_iterations</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1556"><a href="#ServerArgs.add_cli_args-1556"><span class="linenos">1556</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of iterations to automatically trigger a EPLB re-balance.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1557"><a href="#ServerArgs.add_cli_args-1557"><span class="linenos">1557</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1558"><a href="#ServerArgs.add_cli_args-1558"><span class="linenos">1558</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1559"><a href="#ServerArgs.add_cli_args-1559"><span class="linenos">1559</span></a>            <span class="s2">&quot;--eplb-rebalance-layers-per-chunk&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1560"><a href="#ServerArgs.add_cli_args-1560"><span class="linenos">1560</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1561"><a href="#ServerArgs.add_cli_args-1561"><span class="linenos">1561</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">eplb_rebalance_layers_per_chunk</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1562"><a href="#ServerArgs.add_cli_args-1562"><span class="linenos">1562</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers to rebalance per forward pass.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1563"><a href="#ServerArgs.add_cli_args-1563"><span class="linenos">1563</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1564"><a href="#ServerArgs.add_cli_args-1564"><span class="linenos">1564</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1565"><a href="#ServerArgs.add_cli_args-1565"><span class="linenos">1565</span></a>            <span class="s2">&quot;--expert-distribution-recorder-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1566"><a href="#ServerArgs.add_cli_args-1566"><span class="linenos">1566</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1567"><a href="#ServerArgs.add_cli_args-1567"><span class="linenos">1567</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">expert_distribution_recorder_mode</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1568"><a href="#ServerArgs.add_cli_args-1568"><span class="linenos">1568</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mode of expert distribution recorder.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1569"><a href="#ServerArgs.add_cli_args-1569"><span class="linenos">1569</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1570"><a href="#ServerArgs.add_cli_args-1570"><span class="linenos">1570</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1571"><a href="#ServerArgs.add_cli_args-1571"><span class="linenos">1571</span></a>            <span class="s2">&quot;--expert-distribution-recorder-buffer-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1572"><a href="#ServerArgs.add_cli_args-1572"><span class="linenos">1572</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1573"><a href="#ServerArgs.add_cli_args-1573"><span class="linenos">1573</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">expert_distribution_recorder_buffer_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1574"><a href="#ServerArgs.add_cli_args-1574"><span class="linenos">1574</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Circular buffer size of expert distribution recorder. Set to -1 to denote infinite buffer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1575"><a href="#ServerArgs.add_cli_args-1575"><span class="linenos">1575</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1576"><a href="#ServerArgs.add_cli_args-1576"><span class="linenos">1576</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1577"><a href="#ServerArgs.add_cli_args-1577"><span class="linenos">1577</span></a>            <span class="s2">&quot;--enable-expert-distribution-metrics&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1578"><a href="#ServerArgs.add_cli_args-1578"><span class="linenos">1578</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1579"><a href="#ServerArgs.add_cli_args-1579"><span class="linenos">1579</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable logging metrics for expert balancedness&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1580"><a href="#ServerArgs.add_cli_args-1580"><span class="linenos">1580</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1581"><a href="#ServerArgs.add_cli_args-1581"><span class="linenos">1581</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1582"><a href="#ServerArgs.add_cli_args-1582"><span class="linenos">1582</span></a>            <span class="s2">&quot;--deepep-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1583"><a href="#ServerArgs.add_cli_args-1583"><span class="linenos">1583</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1584"><a href="#ServerArgs.add_cli_args-1584"><span class="linenos">1584</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">deepep_config</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1585"><a href="#ServerArgs.add_cli_args-1585"><span class="linenos">1585</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tuned DeepEP config suitable for your own cluster. It can be either a string with JSON content or a file path.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1586"><a href="#ServerArgs.add_cli_args-1586"><span class="linenos">1586</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1587"><a href="#ServerArgs.add_cli_args-1587"><span class="linenos">1587</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1588"><a href="#ServerArgs.add_cli_args-1588"><span class="linenos">1588</span></a>            <span class="s2">&quot;--moe-dense-tp-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1589"><a href="#ServerArgs.add_cli_args-1589"><span class="linenos">1589</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1590"><a href="#ServerArgs.add_cli_args-1590"><span class="linenos">1590</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">moe_dense_tp_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1591"><a href="#ServerArgs.add_cli_args-1591"><span class="linenos">1591</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;TP size for MoE dense MLP layers. This flag is useful when, with large TP size, there are errors caused by weights in MLP layers having dimension smaller than the min dimension GEMM supports.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1592"><a href="#ServerArgs.add_cli_args-1592"><span class="linenos">1592</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1593"><a href="#ServerArgs.add_cli_args-1593"><span class="linenos">1593</span></a>
</span><span id="ServerArgs.add_cli_args-1594"><a href="#ServerArgs.add_cli_args-1594"><span class="linenos">1594</span></a>        <span class="c1"># Hierarchical cache</span>
</span><span id="ServerArgs.add_cli_args-1595"><a href="#ServerArgs.add_cli_args-1595"><span class="linenos">1595</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1596"><a href="#ServerArgs.add_cli_args-1596"><span class="linenos">1596</span></a>            <span class="s2">&quot;--enable-hierarchical-cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1597"><a href="#ServerArgs.add_cli_args-1597"><span class="linenos">1597</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1598"><a href="#ServerArgs.add_cli_args-1598"><span class="linenos">1598</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable hierarchical cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1599"><a href="#ServerArgs.add_cli_args-1599"><span class="linenos">1599</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1600"><a href="#ServerArgs.add_cli_args-1600"><span class="linenos">1600</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1601"><a href="#ServerArgs.add_cli_args-1601"><span class="linenos">1601</span></a>            <span class="s2">&quot;--hicache-ratio&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1602"><a href="#ServerArgs.add_cli_args-1602"><span class="linenos">1602</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1603"><a href="#ServerArgs.add_cli_args-1603"><span class="linenos">1603</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_ratio</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1604"><a href="#ServerArgs.add_cli_args-1604"><span class="linenos">1604</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The ratio of the size of host KV cache memory pool to the size of device pool.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1605"><a href="#ServerArgs.add_cli_args-1605"><span class="linenos">1605</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1606"><a href="#ServerArgs.add_cli_args-1606"><span class="linenos">1606</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1607"><a href="#ServerArgs.add_cli_args-1607"><span class="linenos">1607</span></a>            <span class="s2">&quot;--hicache-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1608"><a href="#ServerArgs.add_cli_args-1608"><span class="linenos">1608</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1609"><a href="#ServerArgs.add_cli_args-1609"><span class="linenos">1609</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1610"><a href="#ServerArgs.add_cli_args-1610"><span class="linenos">1610</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The size of host KV cache memory pool in gigabytes, which will override the hicache_ratio if set.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1611"><a href="#ServerArgs.add_cli_args-1611"><span class="linenos">1611</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1612"><a href="#ServerArgs.add_cli_args-1612"><span class="linenos">1612</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1613"><a href="#ServerArgs.add_cli_args-1613"><span class="linenos">1613</span></a>            <span class="s2">&quot;--hicache-write-policy&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1614"><a href="#ServerArgs.add_cli_args-1614"><span class="linenos">1614</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1615"><a href="#ServerArgs.add_cli_args-1615"><span class="linenos">1615</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;write_back&quot;</span><span class="p">,</span> <span class="s2">&quot;write_through&quot;</span><span class="p">,</span> <span class="s2">&quot;write_through_selective&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1616"><a href="#ServerArgs.add_cli_args-1616"><span class="linenos">1616</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_write_policy</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1617"><a href="#ServerArgs.add_cli_args-1617"><span class="linenos">1617</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The write policy of hierarchical cache.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1618"><a href="#ServerArgs.add_cli_args-1618"><span class="linenos">1618</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1619"><a href="#ServerArgs.add_cli_args-1619"><span class="linenos">1619</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1620"><a href="#ServerArgs.add_cli_args-1620"><span class="linenos">1620</span></a>            <span class="s2">&quot;--hicache-io-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1621"><a href="#ServerArgs.add_cli_args-1621"><span class="linenos">1621</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1622"><a href="#ServerArgs.add_cli_args-1622"><span class="linenos">1622</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1623"><a href="#ServerArgs.add_cli_args-1623"><span class="linenos">1623</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_io_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1624"><a href="#ServerArgs.add_cli_args-1624"><span class="linenos">1624</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The IO backend for KV cache transfer between CPU and GPU&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1625"><a href="#ServerArgs.add_cli_args-1625"><span class="linenos">1625</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1626"><a href="#ServerArgs.add_cli_args-1626"><span class="linenos">1626</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1627"><a href="#ServerArgs.add_cli_args-1627"><span class="linenos">1627</span></a>            <span class="s2">&quot;--hicache-mem-layout&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1628"><a href="#ServerArgs.add_cli_args-1628"><span class="linenos">1628</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1629"><a href="#ServerArgs.add_cli_args-1629"><span class="linenos">1629</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layer_first&quot;</span><span class="p">,</span> <span class="s2">&quot;page_first&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1630"><a href="#ServerArgs.add_cli_args-1630"><span class="linenos">1630</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_mem_layout</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1631"><a href="#ServerArgs.add_cli_args-1631"><span class="linenos">1631</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The layout of host memory pool for hierarchical cache.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1632"><a href="#ServerArgs.add_cli_args-1632"><span class="linenos">1632</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1633"><a href="#ServerArgs.add_cli_args-1633"><span class="linenos">1633</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1634"><a href="#ServerArgs.add_cli_args-1634"><span class="linenos">1634</span></a>            <span class="s2">&quot;--hicache-storage-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1635"><a href="#ServerArgs.add_cli_args-1635"><span class="linenos">1635</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1636"><a href="#ServerArgs.add_cli_args-1636"><span class="linenos">1636</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;mooncake&quot;</span><span class="p">,</span> <span class="s2">&quot;hf3fs&quot;</span><span class="p">,</span> <span class="s2">&quot;nixl&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1637"><a href="#ServerArgs.add_cli_args-1637"><span class="linenos">1637</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1638"><a href="#ServerArgs.add_cli_args-1638"><span class="linenos">1638</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The storage backend for hierarchical KV cache.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1639"><a href="#ServerArgs.add_cli_args-1639"><span class="linenos">1639</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1640"><a href="#ServerArgs.add_cli_args-1640"><span class="linenos">1640</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1641"><a href="#ServerArgs.add_cli_args-1641"><span class="linenos">1641</span></a>            <span class="s2">&quot;--hicache-storage-prefetch-policy&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1642"><a href="#ServerArgs.add_cli_args-1642"><span class="linenos">1642</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1643"><a href="#ServerArgs.add_cli_args-1643"><span class="linenos">1643</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;best_effort&quot;</span><span class="p">,</span> <span class="s2">&quot;wait_complete&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1644"><a href="#ServerArgs.add_cli_args-1644"><span class="linenos">1644</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_prefetch_policy</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1645"><a href="#ServerArgs.add_cli_args-1645"><span class="linenos">1645</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Control when prefetching from the storage backend should stop.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1646"><a href="#ServerArgs.add_cli_args-1646"><span class="linenos">1646</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1647"><a href="#ServerArgs.add_cli_args-1647"><span class="linenos">1647</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1648"><a href="#ServerArgs.add_cli_args-1648"><span class="linenos">1648</span></a>            <span class="s2">&quot;--hicache-storage-backend-extra-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1649"><a href="#ServerArgs.add_cli_args-1649"><span class="linenos">1649</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1650"><a href="#ServerArgs.add_cli_args-1650"><span class="linenos">1650</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">hicache_storage_backend_extra_config</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1651"><a href="#ServerArgs.add_cli_args-1651"><span class="linenos">1651</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A dictionary in JSON string format containing extra configuration for the storage backend.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1652"><a href="#ServerArgs.add_cli_args-1652"><span class="linenos">1652</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1653"><a href="#ServerArgs.add_cli_args-1653"><span class="linenos">1653</span></a>
</span><span id="ServerArgs.add_cli_args-1654"><a href="#ServerArgs.add_cli_args-1654"><span class="linenos">1654</span></a>        <span class="c1"># Double Sparsity</span>
</span><span id="ServerArgs.add_cli_args-1655"><a href="#ServerArgs.add_cli_args-1655"><span class="linenos">1655</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1656"><a href="#ServerArgs.add_cli_args-1656"><span class="linenos">1656</span></a>            <span class="s2">&quot;--enable-double-sparsity&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1657"><a href="#ServerArgs.add_cli_args-1657"><span class="linenos">1657</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1658"><a href="#ServerArgs.add_cli_args-1658"><span class="linenos">1658</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1659"><a href="#ServerArgs.add_cli_args-1659"><span class="linenos">1659</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1660"><a href="#ServerArgs.add_cli_args-1660"><span class="linenos">1660</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1661"><a href="#ServerArgs.add_cli_args-1661"><span class="linenos">1661</span></a>            <span class="s2">&quot;--ds-channel-config-path&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1662"><a href="#ServerArgs.add_cli_args-1662"><span class="linenos">1662</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1663"><a href="#ServerArgs.add_cli_args-1663"><span class="linenos">1663</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_channel_config_path</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1664"><a href="#ServerArgs.add_cli_args-1664"><span class="linenos">1664</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of the double sparsity channel config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1665"><a href="#ServerArgs.add_cli_args-1665"><span class="linenos">1665</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1666"><a href="#ServerArgs.add_cli_args-1666"><span class="linenos">1666</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1667"><a href="#ServerArgs.add_cli_args-1667"><span class="linenos">1667</span></a>            <span class="s2">&quot;--ds-heavy-channel-num&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1668"><a href="#ServerArgs.add_cli_args-1668"><span class="linenos">1668</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1669"><a href="#ServerArgs.add_cli_args-1669"><span class="linenos">1669</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_channel_num</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1670"><a href="#ServerArgs.add_cli_args-1670"><span class="linenos">1670</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1671"><a href="#ServerArgs.add_cli_args-1671"><span class="linenos">1671</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1672"><a href="#ServerArgs.add_cli_args-1672"><span class="linenos">1672</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1673"><a href="#ServerArgs.add_cli_args-1673"><span class="linenos">1673</span></a>            <span class="s2">&quot;--ds-heavy-token-num&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1674"><a href="#ServerArgs.add_cli_args-1674"><span class="linenos">1674</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1675"><a href="#ServerArgs.add_cli_args-1675"><span class="linenos">1675</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_token_num</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1676"><a href="#ServerArgs.add_cli_args-1676"><span class="linenos">1676</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of heavy tokens in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1677"><a href="#ServerArgs.add_cli_args-1677"><span class="linenos">1677</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1678"><a href="#ServerArgs.add_cli_args-1678"><span class="linenos">1678</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1679"><a href="#ServerArgs.add_cli_args-1679"><span class="linenos">1679</span></a>            <span class="s2">&quot;--ds-heavy-channel-type&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1680"><a href="#ServerArgs.add_cli_args-1680"><span class="linenos">1680</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1681"><a href="#ServerArgs.add_cli_args-1681"><span class="linenos">1681</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_heavy_channel_type</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1682"><a href="#ServerArgs.add_cli_args-1682"><span class="linenos">1682</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The type of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1683"><a href="#ServerArgs.add_cli_args-1683"><span class="linenos">1683</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1684"><a href="#ServerArgs.add_cli_args-1684"><span class="linenos">1684</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1685"><a href="#ServerArgs.add_cli_args-1685"><span class="linenos">1685</span></a>            <span class="s2">&quot;--ds-sparse-decode-threshold&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1686"><a href="#ServerArgs.add_cli_args-1686"><span class="linenos">1686</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1687"><a href="#ServerArgs.add_cli_args-1687"><span class="linenos">1687</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">ds_sparse_decode_threshold</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1688"><a href="#ServerArgs.add_cli_args-1688"><span class="linenos">1688</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The type of heavy channels in double sparsity attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1689"><a href="#ServerArgs.add_cli_args-1689"><span class="linenos">1689</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1690"><a href="#ServerArgs.add_cli_args-1690"><span class="linenos">1690</span></a>
</span><span id="ServerArgs.add_cli_args-1691"><a href="#ServerArgs.add_cli_args-1691"><span class="linenos">1691</span></a>        <span class="c1"># Offloading</span>
</span><span id="ServerArgs.add_cli_args-1692"><a href="#ServerArgs.add_cli_args-1692"><span class="linenos">1692</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1693"><a href="#ServerArgs.add_cli_args-1693"><span class="linenos">1693</span></a>            <span class="s2">&quot;--cpu-offload-gb&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1694"><a href="#ServerArgs.add_cli_args-1694"><span class="linenos">1694</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1695"><a href="#ServerArgs.add_cli_args-1695"><span class="linenos">1695</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">cpu_offload_gb</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1696"><a href="#ServerArgs.add_cli_args-1696"><span class="linenos">1696</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How many GBs of RAM to reserve for CPU offloading.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1697"><a href="#ServerArgs.add_cli_args-1697"><span class="linenos">1697</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1698"><a href="#ServerArgs.add_cli_args-1698"><span class="linenos">1698</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1699"><a href="#ServerArgs.add_cli_args-1699"><span class="linenos">1699</span></a>            <span class="s2">&quot;--offload-group-size&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1700"><a href="#ServerArgs.add_cli_args-1700"><span class="linenos">1700</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1701"><a href="#ServerArgs.add_cli_args-1701"><span class="linenos">1701</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_group_size</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1702"><a href="#ServerArgs.add_cli_args-1702"><span class="linenos">1702</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers per group in offloading.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1703"><a href="#ServerArgs.add_cli_args-1703"><span class="linenos">1703</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1704"><a href="#ServerArgs.add_cli_args-1704"><span class="linenos">1704</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1705"><a href="#ServerArgs.add_cli_args-1705"><span class="linenos">1705</span></a>            <span class="s2">&quot;--offload-num-in-group&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1706"><a href="#ServerArgs.add_cli_args-1706"><span class="linenos">1706</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1707"><a href="#ServerArgs.add_cli_args-1707"><span class="linenos">1707</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_num_in_group</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1708"><a href="#ServerArgs.add_cli_args-1708"><span class="linenos">1708</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of layers to be offloaded within a group.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1709"><a href="#ServerArgs.add_cli_args-1709"><span class="linenos">1709</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1710"><a href="#ServerArgs.add_cli_args-1710"><span class="linenos">1710</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1711"><a href="#ServerArgs.add_cli_args-1711"><span class="linenos">1711</span></a>            <span class="s2">&quot;--offload-prefetch-step&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1712"><a href="#ServerArgs.add_cli_args-1712"><span class="linenos">1712</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1713"><a href="#ServerArgs.add_cli_args-1713"><span class="linenos">1713</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_prefetch_step</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1714"><a href="#ServerArgs.add_cli_args-1714"><span class="linenos">1714</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Steps to prefetch in offloading.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1715"><a href="#ServerArgs.add_cli_args-1715"><span class="linenos">1715</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1716"><a href="#ServerArgs.add_cli_args-1716"><span class="linenos">1716</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1717"><a href="#ServerArgs.add_cli_args-1717"><span class="linenos">1717</span></a>            <span class="s2">&quot;--offload-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1718"><a href="#ServerArgs.add_cli_args-1718"><span class="linenos">1718</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1719"><a href="#ServerArgs.add_cli_args-1719"><span class="linenos">1719</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">offload_mode</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1720"><a href="#ServerArgs.add_cli_args-1720"><span class="linenos">1720</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mode of offloading.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1721"><a href="#ServerArgs.add_cli_args-1721"><span class="linenos">1721</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1722"><a href="#ServerArgs.add_cli_args-1722"><span class="linenos">1722</span></a>
</span><span id="ServerArgs.add_cli_args-1723"><a href="#ServerArgs.add_cli_args-1723"><span class="linenos">1723</span></a>        <span class="c1"># Optimization/debug options</span>
</span><span id="ServerArgs.add_cli_args-1724"><a href="#ServerArgs.add_cli_args-1724"><span class="linenos">1724</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1725"><a href="#ServerArgs.add_cli_args-1725"><span class="linenos">1725</span></a>            <span class="s2">&quot;--disable-radix-cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1726"><a href="#ServerArgs.add_cli_args-1726"><span class="linenos">1726</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1727"><a href="#ServerArgs.add_cli_args-1727"><span class="linenos">1727</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable RadixAttention for prefix caching.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1728"><a href="#ServerArgs.add_cli_args-1728"><span class="linenos">1728</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1729"><a href="#ServerArgs.add_cli_args-1729"><span class="linenos">1729</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1730"><a href="#ServerArgs.add_cli_args-1730"><span class="linenos">1730</span></a>            <span class="s2">&quot;--cuda-graph-max-bs&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1731"><a href="#ServerArgs.add_cli_args-1731"><span class="linenos">1731</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1732"><a href="#ServerArgs.add_cli_args-1732"><span class="linenos">1732</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">cuda_graph_max_bs</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1733"><a href="#ServerArgs.add_cli_args-1733"><span class="linenos">1733</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum batch size for cuda graph. It will extend the cuda graph capture batch size to this value.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1734"><a href="#ServerArgs.add_cli_args-1734"><span class="linenos">1734</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1735"><a href="#ServerArgs.add_cli_args-1735"><span class="linenos">1735</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1736"><a href="#ServerArgs.add_cli_args-1736"><span class="linenos">1736</span></a>            <span class="s2">&quot;--cuda-graph-bs&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1737"><a href="#ServerArgs.add_cli_args-1737"><span class="linenos">1737</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1738"><a href="#ServerArgs.add_cli_args-1738"><span class="linenos">1738</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1739"><a href="#ServerArgs.add_cli_args-1739"><span class="linenos">1739</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the list of batch sizes for cuda graph.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1740"><a href="#ServerArgs.add_cli_args-1740"><span class="linenos">1740</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1741"><a href="#ServerArgs.add_cli_args-1741"><span class="linenos">1741</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1742"><a href="#ServerArgs.add_cli_args-1742"><span class="linenos">1742</span></a>            <span class="s2">&quot;--disable-cuda-graph&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1743"><a href="#ServerArgs.add_cli_args-1743"><span class="linenos">1743</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1744"><a href="#ServerArgs.add_cli_args-1744"><span class="linenos">1744</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable cuda graph.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1745"><a href="#ServerArgs.add_cli_args-1745"><span class="linenos">1745</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1746"><a href="#ServerArgs.add_cli_args-1746"><span class="linenos">1746</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1747"><a href="#ServerArgs.add_cli_args-1747"><span class="linenos">1747</span></a>            <span class="s2">&quot;--disable-cuda-graph-padding&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1748"><a href="#ServerArgs.add_cli_args-1748"><span class="linenos">1748</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1749"><a href="#ServerArgs.add_cli_args-1749"><span class="linenos">1749</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable cuda graph when padding is needed. Still uses cuda graph when padding is not needed.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1750"><a href="#ServerArgs.add_cli_args-1750"><span class="linenos">1750</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1751"><a href="#ServerArgs.add_cli_args-1751"><span class="linenos">1751</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1752"><a href="#ServerArgs.add_cli_args-1752"><span class="linenos">1752</span></a>            <span class="s2">&quot;--enable-profile-cuda-graph&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1753"><a href="#ServerArgs.add_cli_args-1753"><span class="linenos">1753</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1754"><a href="#ServerArgs.add_cli_args-1754"><span class="linenos">1754</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable profiling of cuda graph capture.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1755"><a href="#ServerArgs.add_cli_args-1755"><span class="linenos">1755</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1756"><a href="#ServerArgs.add_cli_args-1756"><span class="linenos">1756</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1757"><a href="#ServerArgs.add_cli_args-1757"><span class="linenos">1757</span></a>            <span class="s2">&quot;--enable-cudagraph-gc&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1758"><a href="#ServerArgs.add_cli_args-1758"><span class="linenos">1758</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1759"><a href="#ServerArgs.add_cli_args-1759"><span class="linenos">1759</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable garbage collection during CUDA graph capture. If disabled (default), GC is frozen during capture to speed up the process.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1760"><a href="#ServerArgs.add_cli_args-1760"><span class="linenos">1760</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1761"><a href="#ServerArgs.add_cli_args-1761"><span class="linenos">1761</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1762"><a href="#ServerArgs.add_cli_args-1762"><span class="linenos">1762</span></a>            <span class="s2">&quot;--enable-nccl-nvls&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1763"><a href="#ServerArgs.add_cli_args-1763"><span class="linenos">1763</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1764"><a href="#ServerArgs.add_cli_args-1764"><span class="linenos">1764</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable NCCL NVLS for prefill heavy requests when available.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1765"><a href="#ServerArgs.add_cli_args-1765"><span class="linenos">1765</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1766"><a href="#ServerArgs.add_cli_args-1766"><span class="linenos">1766</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1767"><a href="#ServerArgs.add_cli_args-1767"><span class="linenos">1767</span></a>            <span class="s2">&quot;--enable-symm-mem&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1768"><a href="#ServerArgs.add_cli_args-1768"><span class="linenos">1768</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1769"><a href="#ServerArgs.add_cli_args-1769"><span class="linenos">1769</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable NCCL symmetric memory for fast collectives.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1770"><a href="#ServerArgs.add_cli_args-1770"><span class="linenos">1770</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1771"><a href="#ServerArgs.add_cli_args-1771"><span class="linenos">1771</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1772"><a href="#ServerArgs.add_cli_args-1772"><span class="linenos">1772</span></a>            <span class="s2">&quot;--disable-flashinfer-cutlass-moe-fp4-allgather&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1773"><a href="#ServerArgs.add_cli_args-1773"><span class="linenos">1773</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1774"><a href="#ServerArgs.add_cli_args-1774"><span class="linenos">1774</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disables quantize before all-gather for flashinfer cutlass moe.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1775"><a href="#ServerArgs.add_cli_args-1775"><span class="linenos">1775</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1776"><a href="#ServerArgs.add_cli_args-1776"><span class="linenos">1776</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1777"><a href="#ServerArgs.add_cli_args-1777"><span class="linenos">1777</span></a>            <span class="s2">&quot;--enable-tokenizer-batch-encode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1778"><a href="#ServerArgs.add_cli_args-1778"><span class="linenos">1778</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1779"><a href="#ServerArgs.add_cli_args-1779"><span class="linenos">1779</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable batch tokenization for improved performance when processing multiple text inputs. Do not use with image inputs, pre-tokenized input_ids, or input_embeds.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1780"><a href="#ServerArgs.add_cli_args-1780"><span class="linenos">1780</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1781"><a href="#ServerArgs.add_cli_args-1781"><span class="linenos">1781</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1782"><a href="#ServerArgs.add_cli_args-1782"><span class="linenos">1782</span></a>            <span class="s2">&quot;--disable-outlines-disk-cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1783"><a href="#ServerArgs.add_cli_args-1783"><span class="linenos">1783</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1784"><a href="#ServerArgs.add_cli_args-1784"><span class="linenos">1784</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable disk cache of outlines to avoid possible crashes related to file system or high concurrency.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1785"><a href="#ServerArgs.add_cli_args-1785"><span class="linenos">1785</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1786"><a href="#ServerArgs.add_cli_args-1786"><span class="linenos">1786</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1787"><a href="#ServerArgs.add_cli_args-1787"><span class="linenos">1787</span></a>            <span class="s2">&quot;--disable-custom-all-reduce&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1788"><a href="#ServerArgs.add_cli_args-1788"><span class="linenos">1788</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1789"><a href="#ServerArgs.add_cli_args-1789"><span class="linenos">1789</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the custom all-reduce kernel and fall back to NCCL.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1790"><a href="#ServerArgs.add_cli_args-1790"><span class="linenos">1790</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1791"><a href="#ServerArgs.add_cli_args-1791"><span class="linenos">1791</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1792"><a href="#ServerArgs.add_cli_args-1792"><span class="linenos">1792</span></a>            <span class="s2">&quot;--enable-mscclpp&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1793"><a href="#ServerArgs.add_cli_args-1793"><span class="linenos">1793</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1794"><a href="#ServerArgs.add_cli_args-1794"><span class="linenos">1794</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable using mscclpp for small messages for all-reduce kernel and fall back to NCCL.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1795"><a href="#ServerArgs.add_cli_args-1795"><span class="linenos">1795</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1796"><a href="#ServerArgs.add_cli_args-1796"><span class="linenos">1796</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1797"><a href="#ServerArgs.add_cli_args-1797"><span class="linenos">1797</span></a>            <span class="s2">&quot;--disable-overlap-schedule&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1798"><a href="#ServerArgs.add_cli_args-1798"><span class="linenos">1798</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1799"><a href="#ServerArgs.add_cli_args-1799"><span class="linenos">1799</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable the overlap scheduler, which overlaps the CPU scheduler with GPU model worker.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1800"><a href="#ServerArgs.add_cli_args-1800"><span class="linenos">1800</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1801"><a href="#ServerArgs.add_cli_args-1801"><span class="linenos">1801</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1802"><a href="#ServerArgs.add_cli_args-1802"><span class="linenos">1802</span></a>            <span class="s2">&quot;--enable-mixed-chunk&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1803"><a href="#ServerArgs.add_cli_args-1803"><span class="linenos">1803</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1804"><a href="#ServerArgs.add_cli_args-1804"><span class="linenos">1804</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling mixing prefill and decode in a batch when using chunked prefill.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1805"><a href="#ServerArgs.add_cli_args-1805"><span class="linenos">1805</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1806"><a href="#ServerArgs.add_cli_args-1806"><span class="linenos">1806</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1807"><a href="#ServerArgs.add_cli_args-1807"><span class="linenos">1807</span></a>            <span class="s2">&quot;--enable-dp-attention&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1808"><a href="#ServerArgs.add_cli_args-1808"><span class="linenos">1808</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1809"><a href="#ServerArgs.add_cli_args-1809"><span class="linenos">1809</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling data parallelism for attention and tensor parallelism for FFN. The dp size should be equal to the tp size. Currently DeepSeek-V2 and Qwen 2/3 MoE models are supported.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1810"><a href="#ServerArgs.add_cli_args-1810"><span class="linenos">1810</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1811"><a href="#ServerArgs.add_cli_args-1811"><span class="linenos">1811</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1812"><a href="#ServerArgs.add_cli_args-1812"><span class="linenos">1812</span></a>            <span class="s2">&quot;--enable-dp-lm-head&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1813"><a href="#ServerArgs.add_cli_args-1813"><span class="linenos">1813</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1814"><a href="#ServerArgs.add_cli_args-1814"><span class="linenos">1814</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable vocabulary parallel across the attention TP group to avoid all-gather across DP groups, optimizing performance under DP attention.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1815"><a href="#ServerArgs.add_cli_args-1815"><span class="linenos">1815</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1816"><a href="#ServerArgs.add_cli_args-1816"><span class="linenos">1816</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1817"><a href="#ServerArgs.add_cli_args-1817"><span class="linenos">1817</span></a>            <span class="s2">&quot;--enable-two-batch-overlap&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1818"><a href="#ServerArgs.add_cli_args-1818"><span class="linenos">1818</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1819"><a href="#ServerArgs.add_cli_args-1819"><span class="linenos">1819</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enabling two micro batches to overlap.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1820"><a href="#ServerArgs.add_cli_args-1820"><span class="linenos">1820</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1821"><a href="#ServerArgs.add_cli_args-1821"><span class="linenos">1821</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1822"><a href="#ServerArgs.add_cli_args-1822"><span class="linenos">1822</span></a>            <span class="s2">&quot;--tbo-token-distribution-threshold&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1823"><a href="#ServerArgs.add_cli_args-1823"><span class="linenos">1823</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1824"><a href="#ServerArgs.add_cli_args-1824"><span class="linenos">1824</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">tbo_token_distribution_threshold</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1825"><a href="#ServerArgs.add_cli_args-1825"><span class="linenos">1825</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The threshold of token distribution between two batches in micro-batch-overlap, determines whether to two-batch-overlap or two-chunk-overlap. Set to 0 denote disable two-chunk-overlap.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1826"><a href="#ServerArgs.add_cli_args-1826"><span class="linenos">1826</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1827"><a href="#ServerArgs.add_cli_args-1827"><span class="linenos">1827</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1828"><a href="#ServerArgs.add_cli_args-1828"><span class="linenos">1828</span></a>            <span class="s2">&quot;--enable-torch-compile&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1829"><a href="#ServerArgs.add_cli_args-1829"><span class="linenos">1829</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1830"><a href="#ServerArgs.add_cli_args-1830"><span class="linenos">1830</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optimize the model with torch.compile. Experimental feature.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1831"><a href="#ServerArgs.add_cli_args-1831"><span class="linenos">1831</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1832"><a href="#ServerArgs.add_cli_args-1832"><span class="linenos">1832</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1833"><a href="#ServerArgs.add_cli_args-1833"><span class="linenos">1833</span></a>            <span class="s2">&quot;--torch-compile-max-bs&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1834"><a href="#ServerArgs.add_cli_args-1834"><span class="linenos">1834</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1835"><a href="#ServerArgs.add_cli_args-1835"><span class="linenos">1835</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">torch_compile_max_bs</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1836"><a href="#ServerArgs.add_cli_args-1836"><span class="linenos">1836</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum batch size when using torch compile.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1837"><a href="#ServerArgs.add_cli_args-1837"><span class="linenos">1837</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1838"><a href="#ServerArgs.add_cli_args-1838"><span class="linenos">1838</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1839"><a href="#ServerArgs.add_cli_args-1839"><span class="linenos">1839</span></a>            <span class="s2">&quot;--torchao-config&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1840"><a href="#ServerArgs.add_cli_args-1840"><span class="linenos">1840</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1841"><a href="#ServerArgs.add_cli_args-1841"><span class="linenos">1841</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">torchao_config</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1842"><a href="#ServerArgs.add_cli_args-1842"><span class="linenos">1842</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optimize the model with torchao. Experimental feature. Current choices are: int8dq, int8wo, int4wo-&lt;group_size&gt;, fp8wo, fp8dq-per_tensor, fp8dq-per_row&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1843"><a href="#ServerArgs.add_cli_args-1843"><span class="linenos">1843</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1844"><a href="#ServerArgs.add_cli_args-1844"><span class="linenos">1844</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1845"><a href="#ServerArgs.add_cli_args-1845"><span class="linenos">1845</span></a>            <span class="s2">&quot;--enable-nan-detection&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1846"><a href="#ServerArgs.add_cli_args-1846"><span class="linenos">1846</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1847"><a href="#ServerArgs.add_cli_args-1847"><span class="linenos">1847</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable the NaN detection for debugging purposes.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1848"><a href="#ServerArgs.add_cli_args-1848"><span class="linenos">1848</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1849"><a href="#ServerArgs.add_cli_args-1849"><span class="linenos">1849</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1850"><a href="#ServerArgs.add_cli_args-1850"><span class="linenos">1850</span></a>            <span class="s2">&quot;--enable-p2p-check&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1851"><a href="#ServerArgs.add_cli_args-1851"><span class="linenos">1851</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1852"><a href="#ServerArgs.add_cli_args-1852"><span class="linenos">1852</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable P2P check for GPU access, otherwise the p2p access is allowed by default.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1853"><a href="#ServerArgs.add_cli_args-1853"><span class="linenos">1853</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1854"><a href="#ServerArgs.add_cli_args-1854"><span class="linenos">1854</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1855"><a href="#ServerArgs.add_cli_args-1855"><span class="linenos">1855</span></a>            <span class="s2">&quot;--triton-attention-reduce-in-fp32&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1856"><a href="#ServerArgs.add_cli_args-1856"><span class="linenos">1856</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1857"><a href="#ServerArgs.add_cli_args-1857"><span class="linenos">1857</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cast the intermediate attention results to fp32 to avoid possible crashes related to fp16.&quot;</span>
</span><span id="ServerArgs.add_cli_args-1858"><a href="#ServerArgs.add_cli_args-1858"><span class="linenos">1858</span></a>            <span class="s2">&quot;This only affects Triton attention kernels.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1859"><a href="#ServerArgs.add_cli_args-1859"><span class="linenos">1859</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1860"><a href="#ServerArgs.add_cli_args-1860"><span class="linenos">1860</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1861"><a href="#ServerArgs.add_cli_args-1861"><span class="linenos">1861</span></a>            <span class="s2">&quot;--triton-attention-num-kv-splits&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1862"><a href="#ServerArgs.add_cli_args-1862"><span class="linenos">1862</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1863"><a href="#ServerArgs.add_cli_args-1863"><span class="linenos">1863</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">triton_attention_num_kv_splits</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1864"><a href="#ServerArgs.add_cli_args-1864"><span class="linenos">1864</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of KV splits in flash decoding Triton kernel. Larger value is better in longer context scenarios. The default value is 8.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1865"><a href="#ServerArgs.add_cli_args-1865"><span class="linenos">1865</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1866"><a href="#ServerArgs.add_cli_args-1866"><span class="linenos">1866</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1867"><a href="#ServerArgs.add_cli_args-1867"><span class="linenos">1867</span></a>            <span class="s2">&quot;--num-continuous-decode-steps&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1868"><a href="#ServerArgs.add_cli_args-1868"><span class="linenos">1868</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1869"><a href="#ServerArgs.add_cli_args-1869"><span class="linenos">1869</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">num_continuous_decode_steps</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1870"><a href="#ServerArgs.add_cli_args-1870"><span class="linenos">1870</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run multiple continuous decoding steps to reduce scheduling overhead. &quot;</span>
</span><span id="ServerArgs.add_cli_args-1871"><a href="#ServerArgs.add_cli_args-1871"><span class="linenos">1871</span></a>            <span class="s2">&quot;This can potentially increase throughput but may also increase time-to-first-token latency. &quot;</span>
</span><span id="ServerArgs.add_cli_args-1872"><a href="#ServerArgs.add_cli_args-1872"><span class="linenos">1872</span></a>            <span class="s2">&quot;The default value is 1, meaning only run one decoding step at a time.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1873"><a href="#ServerArgs.add_cli_args-1873"><span class="linenos">1873</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1874"><a href="#ServerArgs.add_cli_args-1874"><span class="linenos">1874</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1875"><a href="#ServerArgs.add_cli_args-1875"><span class="linenos">1875</span></a>            <span class="s2">&quot;--delete-ckpt-after-loading&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1876"><a href="#ServerArgs.add_cli_args-1876"><span class="linenos">1876</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1877"><a href="#ServerArgs.add_cli_args-1877"><span class="linenos">1877</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Delete the model checkpoint after loading the model.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1878"><a href="#ServerArgs.add_cli_args-1878"><span class="linenos">1878</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1879"><a href="#ServerArgs.add_cli_args-1879"><span class="linenos">1879</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1880"><a href="#ServerArgs.add_cli_args-1880"><span class="linenos">1880</span></a>            <span class="s2">&quot;--enable-memory-saver&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1881"><a href="#ServerArgs.add_cli_args-1881"><span class="linenos">1881</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1882"><a href="#ServerArgs.add_cli_args-1882"><span class="linenos">1882</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow saving memory using release_memory_occupation and resume_memory_occupation&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1883"><a href="#ServerArgs.add_cli_args-1883"><span class="linenos">1883</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1884"><a href="#ServerArgs.add_cli_args-1884"><span class="linenos">1884</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1885"><a href="#ServerArgs.add_cli_args-1885"><span class="linenos">1885</span></a>            <span class="s2">&quot;--allow-auto-truncate&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1886"><a href="#ServerArgs.add_cli_args-1886"><span class="linenos">1886</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1887"><a href="#ServerArgs.add_cli_args-1887"><span class="linenos">1887</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow automatically truncating requests that exceed the maximum input length instead of returning an error.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1888"><a href="#ServerArgs.add_cli_args-1888"><span class="linenos">1888</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1889"><a href="#ServerArgs.add_cli_args-1889"><span class="linenos">1889</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1890"><a href="#ServerArgs.add_cli_args-1890"><span class="linenos">1890</span></a>            <span class="s2">&quot;--enable-custom-logit-processor&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1891"><a href="#ServerArgs.add_cli_args-1891"><span class="linenos">1891</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1892"><a href="#ServerArgs.add_cli_args-1892"><span class="linenos">1892</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable users to pass custom logit processors to the server (disabled by default for security)&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1893"><a href="#ServerArgs.add_cli_args-1893"><span class="linenos">1893</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1894"><a href="#ServerArgs.add_cli_args-1894"><span class="linenos">1894</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1895"><a href="#ServerArgs.add_cli_args-1895"><span class="linenos">1895</span></a>            <span class="s2">&quot;--flashinfer-mla-disable-ragged&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1896"><a href="#ServerArgs.add_cli_args-1896"><span class="linenos">1896</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1897"><a href="#ServerArgs.add_cli_args-1897"><span class="linenos">1897</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Not using ragged prefill wrapper when running flashinfer mla&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1898"><a href="#ServerArgs.add_cli_args-1898"><span class="linenos">1898</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1899"><a href="#ServerArgs.add_cli_args-1899"><span class="linenos">1899</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1900"><a href="#ServerArgs.add_cli_args-1900"><span class="linenos">1900</span></a>            <span class="s2">&quot;--disable-shared-experts-fusion&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1901"><a href="#ServerArgs.add_cli_args-1901"><span class="linenos">1901</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1902"><a href="#ServerArgs.add_cli_args-1902"><span class="linenos">1902</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable shared experts fusion optimization for deepseek v3/r1.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1903"><a href="#ServerArgs.add_cli_args-1903"><span class="linenos">1903</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1904"><a href="#ServerArgs.add_cli_args-1904"><span class="linenos">1904</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1905"><a href="#ServerArgs.add_cli_args-1905"><span class="linenos">1905</span></a>            <span class="s2">&quot;--disable-chunked-prefix-cache&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1906"><a href="#ServerArgs.add_cli_args-1906"><span class="linenos">1906</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1907"><a href="#ServerArgs.add_cli_args-1907"><span class="linenos">1907</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable chunked prefix cache feature for deepseek, which should save overhead for short sequences.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1908"><a href="#ServerArgs.add_cli_args-1908"><span class="linenos">1908</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1909"><a href="#ServerArgs.add_cli_args-1909"><span class="linenos">1909</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1910"><a href="#ServerArgs.add_cli_args-1910"><span class="linenos">1910</span></a>            <span class="s2">&quot;--disable-fast-image-processor&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1911"><a href="#ServerArgs.add_cli_args-1911"><span class="linenos">1911</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1912"><a href="#ServerArgs.add_cli_args-1912"><span class="linenos">1912</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Adopt base image processor instead of fast image processor.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1913"><a href="#ServerArgs.add_cli_args-1913"><span class="linenos">1913</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1914"><a href="#ServerArgs.add_cli_args-1914"><span class="linenos">1914</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1915"><a href="#ServerArgs.add_cli_args-1915"><span class="linenos">1915</span></a>            <span class="s2">&quot;--enable-return-hidden-states&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1916"><a href="#ServerArgs.add_cli_args-1916"><span class="linenos">1916</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1917"><a href="#ServerArgs.add_cli_args-1917"><span class="linenos">1917</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable returning hidden states with responses.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1918"><a href="#ServerArgs.add_cli_args-1918"><span class="linenos">1918</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1919"><a href="#ServerArgs.add_cli_args-1919"><span class="linenos">1919</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1920"><a href="#ServerArgs.add_cli_args-1920"><span class="linenos">1920</span></a>            <span class="s2">&quot;--scheduler-recv-interval&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1921"><a href="#ServerArgs.add_cli_args-1921"><span class="linenos">1921</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1922"><a href="#ServerArgs.add_cli_args-1922"><span class="linenos">1922</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">scheduler_recv_interval</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1923"><a href="#ServerArgs.add_cli_args-1923"><span class="linenos">1923</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The interval to poll requests in scheduler. Can be set to &gt;1 to reduce the overhead of this.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1924"><a href="#ServerArgs.add_cli_args-1924"><span class="linenos">1924</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1925"><a href="#ServerArgs.add_cli_args-1925"><span class="linenos">1925</span></a>
</span><span id="ServerArgs.add_cli_args-1926"><a href="#ServerArgs.add_cli_args-1926"><span class="linenos">1926</span></a>        <span class="c1"># Debug tensor dumps</span>
</span><span id="ServerArgs.add_cli_args-1927"><a href="#ServerArgs.add_cli_args-1927"><span class="linenos">1927</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1928"><a href="#ServerArgs.add_cli_args-1928"><span class="linenos">1928</span></a>            <span class="s2">&quot;--debug-tensor-dump-output-folder&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1929"><a href="#ServerArgs.add_cli_args-1929"><span class="linenos">1929</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1930"><a href="#ServerArgs.add_cli_args-1930"><span class="linenos">1930</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_output_folder</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1931"><a href="#ServerArgs.add_cli_args-1931"><span class="linenos">1931</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output folder for dumping tensors.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1932"><a href="#ServerArgs.add_cli_args-1932"><span class="linenos">1932</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1933"><a href="#ServerArgs.add_cli_args-1933"><span class="linenos">1933</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1934"><a href="#ServerArgs.add_cli_args-1934"><span class="linenos">1934</span></a>            <span class="s2">&quot;--debug-tensor-dump-input-file&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1935"><a href="#ServerArgs.add_cli_args-1935"><span class="linenos">1935</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1936"><a href="#ServerArgs.add_cli_args-1936"><span class="linenos">1936</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_input_file</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1937"><a href="#ServerArgs.add_cli_args-1937"><span class="linenos">1937</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The input filename for dumping tensors&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1938"><a href="#ServerArgs.add_cli_args-1938"><span class="linenos">1938</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1939"><a href="#ServerArgs.add_cli_args-1939"><span class="linenos">1939</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1940"><a href="#ServerArgs.add_cli_args-1940"><span class="linenos">1940</span></a>            <span class="s2">&quot;--debug-tensor-dump-inject&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1941"><a href="#ServerArgs.add_cli_args-1941"><span class="linenos">1941</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1942"><a href="#ServerArgs.add_cli_args-1942"><span class="linenos">1942</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">debug_tensor_dump_inject</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1943"><a href="#ServerArgs.add_cli_args-1943"><span class="linenos">1943</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Inject the outputs from jax as the input of every layer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1944"><a href="#ServerArgs.add_cli_args-1944"><span class="linenos">1944</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1945"><a href="#ServerArgs.add_cli_args-1945"><span class="linenos">1945</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1946"><a href="#ServerArgs.add_cli_args-1946"><span class="linenos">1946</span></a>            <span class="s2">&quot;--debug-tensor-dump-prefill-only&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1947"><a href="#ServerArgs.add_cli_args-1947"><span class="linenos">1947</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1948"><a href="#ServerArgs.add_cli_args-1948"><span class="linenos">1948</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only dump the tensors for prefill requests (i.e. batch size &gt; 1).&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1949"><a href="#ServerArgs.add_cli_args-1949"><span class="linenos">1949</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1950"><a href="#ServerArgs.add_cli_args-1950"><span class="linenos">1950</span></a>
</span><span id="ServerArgs.add_cli_args-1951"><a href="#ServerArgs.add_cli_args-1951"><span class="linenos">1951</span></a>        <span class="c1"># PD disaggregation</span>
</span><span id="ServerArgs.add_cli_args-1952"><a href="#ServerArgs.add_cli_args-1952"><span class="linenos">1952</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1953"><a href="#ServerArgs.add_cli_args-1953"><span class="linenos">1953</span></a>            <span class="s2">&quot;--disaggregation-mode&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1954"><a href="#ServerArgs.add_cli_args-1954"><span class="linenos">1954</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1955"><a href="#ServerArgs.add_cli_args-1955"><span class="linenos">1955</span></a>            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;null&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1956"><a href="#ServerArgs.add_cli_args-1956"><span class="linenos">1956</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;prefill&quot;</span><span class="p">,</span> <span class="s2">&quot;decode&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1957"><a href="#ServerArgs.add_cli_args-1957"><span class="linenos">1957</span></a>            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only used for PD disaggregation. &quot;prefill&quot; for prefill-only server, and &quot;decode&quot; for decode-only server. If not specified, it is not PD disaggregated&#39;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1958"><a href="#ServerArgs.add_cli_args-1958"><span class="linenos">1958</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1959"><a href="#ServerArgs.add_cli_args-1959"><span class="linenos">1959</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1960"><a href="#ServerArgs.add_cli_args-1960"><span class="linenos">1960</span></a>            <span class="s2">&quot;--disaggregation-transfer-backend&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1961"><a href="#ServerArgs.add_cli_args-1961"><span class="linenos">1961</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1962"><a href="#ServerArgs.add_cli_args-1962"><span class="linenos">1962</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_transfer_backend</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1963"><a href="#ServerArgs.add_cli_args-1963"><span class="linenos">1963</span></a>            <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mooncake&quot;</span><span class="p">,</span> <span class="s2">&quot;nixl&quot;</span><span class="p">,</span> <span class="s2">&quot;ascend&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.add_cli_args-1964"><a href="#ServerArgs.add_cli_args-1964"><span class="linenos">1964</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The backend for disaggregation transfer. Default is mooncake.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1965"><a href="#ServerArgs.add_cli_args-1965"><span class="linenos">1965</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1966"><a href="#ServerArgs.add_cli_args-1966"><span class="linenos">1966</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1967"><a href="#ServerArgs.add_cli_args-1967"><span class="linenos">1967</span></a>            <span class="s2">&quot;--disaggregation-bootstrap-port&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1968"><a href="#ServerArgs.add_cli_args-1968"><span class="linenos">1968</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1969"><a href="#ServerArgs.add_cli_args-1969"><span class="linenos">1969</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_bootstrap_port</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1970"><a href="#ServerArgs.add_cli_args-1970"><span class="linenos">1970</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Bootstrap server port on the prefill server. Default is 8998.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1971"><a href="#ServerArgs.add_cli_args-1971"><span class="linenos">1971</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1972"><a href="#ServerArgs.add_cli_args-1972"><span class="linenos">1972</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1973"><a href="#ServerArgs.add_cli_args-1973"><span class="linenos">1973</span></a>            <span class="s2">&quot;--disaggregation-decode-tp&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1974"><a href="#ServerArgs.add_cli_args-1974"><span class="linenos">1974</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1975"><a href="#ServerArgs.add_cli_args-1975"><span class="linenos">1975</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_decode_tp</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1976"><a href="#ServerArgs.add_cli_args-1976"><span class="linenos">1976</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Decode tp size. If not set, it matches the tp size of the current engine. This is only set on the prefill server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1977"><a href="#ServerArgs.add_cli_args-1977"><span class="linenos">1977</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1978"><a href="#ServerArgs.add_cli_args-1978"><span class="linenos">1978</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1979"><a href="#ServerArgs.add_cli_args-1979"><span class="linenos">1979</span></a>            <span class="s2">&quot;--disaggregation-decode-dp&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1980"><a href="#ServerArgs.add_cli_args-1980"><span class="linenos">1980</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1981"><a href="#ServerArgs.add_cli_args-1981"><span class="linenos">1981</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_decode_dp</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1982"><a href="#ServerArgs.add_cli_args-1982"><span class="linenos">1982</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Decode dp size. If not set, it matches the dp size of the current engine. This is only set on the prefill server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1983"><a href="#ServerArgs.add_cli_args-1983"><span class="linenos">1983</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1984"><a href="#ServerArgs.add_cli_args-1984"><span class="linenos">1984</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1985"><a href="#ServerArgs.add_cli_args-1985"><span class="linenos">1985</span></a>            <span class="s2">&quot;--disaggregation-prefill-pp&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1986"><a href="#ServerArgs.add_cli_args-1986"><span class="linenos">1986</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1987"><a href="#ServerArgs.add_cli_args-1987"><span class="linenos">1987</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_prefill_pp</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1988"><a href="#ServerArgs.add_cli_args-1988"><span class="linenos">1988</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Prefill pp size. If not set, it is default to 1. This is only set on the decode server.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1989"><a href="#ServerArgs.add_cli_args-1989"><span class="linenos">1989</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1990"><a href="#ServerArgs.add_cli_args-1990"><span class="linenos">1990</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1991"><a href="#ServerArgs.add_cli_args-1991"><span class="linenos">1991</span></a>            <span class="s2">&quot;--disaggregation-ib-device&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1992"><a href="#ServerArgs.add_cli_args-1992"><span class="linenos">1992</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1993"><a href="#ServerArgs.add_cli_args-1993"><span class="linenos">1993</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">disaggregation_ib_device</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1994"><a href="#ServerArgs.add_cli_args-1994"><span class="linenos">1994</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The InfiniBand devices for disaggregation transfer, accepts single device (e.g., --disaggregation-ib-device mlx5_0) &quot;</span>
</span><span id="ServerArgs.add_cli_args-1995"><a href="#ServerArgs.add_cli_args-1995"><span class="linenos">1995</span></a>            <span class="s2">&quot;or multiple comma-separated devices (e.g., --disaggregation-ib-device mlx5_0,mlx5_1). &quot;</span>
</span><span id="ServerArgs.add_cli_args-1996"><a href="#ServerArgs.add_cli_args-1996"><span class="linenos">1996</span></a>            <span class="s2">&quot;Default is None, which triggers automatic device detection when mooncake backend is enabled.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-1997"><a href="#ServerArgs.add_cli_args-1997"><span class="linenos">1997</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-1998"><a href="#ServerArgs.add_cli_args-1998"><span class="linenos">1998</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-1999"><a href="#ServerArgs.add_cli_args-1999"><span class="linenos">1999</span></a>            <span class="s2">&quot;--num-reserved-decode-tokens&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2000"><a href="#ServerArgs.add_cli_args-2000"><span class="linenos">2000</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2001"><a href="#ServerArgs.add_cli_args-2001"><span class="linenos">2001</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">num_reserved_decode_tokens</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2002"><a href="#ServerArgs.add_cli_args-2002"><span class="linenos">2002</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of decode tokens that will have memory reserved when adding new request to the running batch.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2003"><a href="#ServerArgs.add_cli_args-2003"><span class="linenos">2003</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2004"><a href="#ServerArgs.add_cli_args-2004"><span class="linenos">2004</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2005"><a href="#ServerArgs.add_cli_args-2005"><span class="linenos">2005</span></a>            <span class="s2">&quot;--pdlb-url&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2006"><a href="#ServerArgs.add_cli_args-2006"><span class="linenos">2006</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2007"><a href="#ServerArgs.add_cli_args-2007"><span class="linenos">2007</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2008"><a href="#ServerArgs.add_cli_args-2008"><span class="linenos">2008</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The URL of the PD disaggregation load balancer. If set, the prefill/decode server will register with the load balancer.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2009"><a href="#ServerArgs.add_cli_args-2009"><span class="linenos">2009</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2010"><a href="#ServerArgs.add_cli_args-2010"><span class="linenos">2010</span></a>
</span><span id="ServerArgs.add_cli_args-2011"><a href="#ServerArgs.add_cli_args-2011"><span class="linenos">2011</span></a>        <span class="c1"># Custom weight loader</span>
</span><span id="ServerArgs.add_cli_args-2012"><a href="#ServerArgs.add_cli_args-2012"><span class="linenos">2012</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2013"><a href="#ServerArgs.add_cli_args-2013"><span class="linenos">2013</span></a>            <span class="s2">&quot;--custom-weight-loader&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2014"><a href="#ServerArgs.add_cli_args-2014"><span class="linenos">2014</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2015"><a href="#ServerArgs.add_cli_args-2015"><span class="linenos">2015</span></a>            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2016"><a href="#ServerArgs.add_cli_args-2016"><span class="linenos">2016</span></a>            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2017"><a href="#ServerArgs.add_cli_args-2017"><span class="linenos">2017</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The custom dataloader which used to update the model. Should be set with a valid import path, such as my_package.weight_load_func&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2018"><a href="#ServerArgs.add_cli_args-2018"><span class="linenos">2018</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2019"><a href="#ServerArgs.add_cli_args-2019"><span class="linenos">2019</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2020"><a href="#ServerArgs.add_cli_args-2020"><span class="linenos">2020</span></a>            <span class="s2">&quot;--weight-loader-disable-mmap&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2021"><a href="#ServerArgs.add_cli_args-2021"><span class="linenos">2021</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2022"><a href="#ServerArgs.add_cli_args-2022"><span class="linenos">2022</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable mmap while loading weight using safetensors.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2023"><a href="#ServerArgs.add_cli_args-2023"><span class="linenos">2023</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2024"><a href="#ServerArgs.add_cli_args-2024"><span class="linenos">2024</span></a>
</span><span id="ServerArgs.add_cli_args-2025"><a href="#ServerArgs.add_cli_args-2025"><span class="linenos">2025</span></a>        <span class="c1"># For PD-Multiplexing</span>
</span><span id="ServerArgs.add_cli_args-2026"><a href="#ServerArgs.add_cli_args-2026"><span class="linenos">2026</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2027"><a href="#ServerArgs.add_cli_args-2027"><span class="linenos">2027</span></a>            <span class="s2">&quot;--enable-pdmux&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2028"><a href="#ServerArgs.add_cli_args-2028"><span class="linenos">2028</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2029"><a href="#ServerArgs.add_cli_args-2029"><span class="linenos">2029</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable PD-Multiplexing, PD running on greenctx stream.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2030"><a href="#ServerArgs.add_cli_args-2030"><span class="linenos">2030</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2031"><a href="#ServerArgs.add_cli_args-2031"><span class="linenos">2031</span></a>
</span><span id="ServerArgs.add_cli_args-2032"><a href="#ServerArgs.add_cli_args-2032"><span class="linenos">2032</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2033"><a href="#ServerArgs.add_cli_args-2033"><span class="linenos">2033</span></a>            <span class="s2">&quot;--sm-group-num&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2034"><a href="#ServerArgs.add_cli_args-2034"><span class="linenos">2034</span></a>            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2035"><a href="#ServerArgs.add_cli_args-2035"><span class="linenos">2035</span></a>            <span class="n">default</span><span class="o">=</span><span class="n">ServerArgs</span><span class="o">.</span><span class="n">sm_group_num</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2036"><a href="#ServerArgs.add_cli_args-2036"><span class="linenos">2036</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of sm partition groups.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2037"><a href="#ServerArgs.add_cli_args-2037"><span class="linenos">2037</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2038"><a href="#ServerArgs.add_cli_args-2038"><span class="linenos">2038</span></a>
</span><span id="ServerArgs.add_cli_args-2039"><a href="#ServerArgs.add_cli_args-2039"><span class="linenos">2039</span></a>        <span class="c1"># Deprecated arguments</span>
</span><span id="ServerArgs.add_cli_args-2040"><a href="#ServerArgs.add_cli_args-2040"><span class="linenos">2040</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2041"><a href="#ServerArgs.add_cli_args-2041"><span class="linenos">2041</span></a>            <span class="s2">&quot;--enable-ep-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2042"><a href="#ServerArgs.add_cli_args-2042"><span class="linenos">2042</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2043"><a href="#ServerArgs.add_cli_args-2043"><span class="linenos">2043</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enabling expert parallelism for moe. The ep size is equal to the tp size.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2044"><a href="#ServerArgs.add_cli_args-2044"><span class="linenos">2044</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2045"><a href="#ServerArgs.add_cli_args-2045"><span class="linenos">2045</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2046"><a href="#ServerArgs.add_cli_args-2046"><span class="linenos">2046</span></a>            <span class="s2">&quot;--enable-deepep-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2047"><a href="#ServerArgs.add_cli_args-2047"><span class="linenos">2047</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2048"><a href="#ServerArgs.add_cli_args-2048"><span class="linenos">2048</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enabling DeepEP MoE implementation for EP MoE.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2049"><a href="#ServerArgs.add_cli_args-2049"><span class="linenos">2049</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2050"><a href="#ServerArgs.add_cli_args-2050"><span class="linenos">2050</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2051"><a href="#ServerArgs.add_cli_args-2051"><span class="linenos">2051</span></a>            <span class="s2">&quot;--enable-flashinfer-cutlass-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2052"><a href="#ServerArgs.add_cli_args-2052"><span class="linenos">2052</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2053"><a href="#ServerArgs.add_cli_args-2053"><span class="linenos">2053</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer CUTLASS MoE backend for modelopt_fp4 quant on Blackwell. Supports MoE-EP&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2054"><a href="#ServerArgs.add_cli_args-2054"><span class="linenos">2054</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2055"><a href="#ServerArgs.add_cli_args-2055"><span class="linenos">2055</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2056"><a href="#ServerArgs.add_cli_args-2056"><span class="linenos">2056</span></a>            <span class="s2">&quot;--enable-flashinfer-trtllm-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2057"><a href="#ServerArgs.add_cli_args-2057"><span class="linenos">2057</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2058"><a href="#ServerArgs.add_cli_args-2058"><span class="linenos">2058</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer TRTLLM MoE backend on Blackwell. Supports BlockScale FP8 MoE-EP&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2059"><a href="#ServerArgs.add_cli_args-2059"><span class="linenos">2059</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2060"><a href="#ServerArgs.add_cli_args-2060"><span class="linenos">2060</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2061"><a href="#ServerArgs.add_cli_args-2061"><span class="linenos">2061</span></a>            <span class="s2">&quot;--enable-triton-kernel-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2062"><a href="#ServerArgs.add_cli_args-2062"><span class="linenos">2062</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2063"><a href="#ServerArgs.add_cli_args-2063"><span class="linenos">2063</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Use triton moe grouped gemm kernel.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2064"><a href="#ServerArgs.add_cli_args-2064"><span class="linenos">2064</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.add_cli_args-2065"><a href="#ServerArgs.add_cli_args-2065"><span class="linenos">2065</span></a>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="ServerArgs.add_cli_args-2066"><a href="#ServerArgs.add_cli_args-2066"><span class="linenos">2066</span></a>            <span class="s2">&quot;--enable-flashinfer-mxfp4-moe&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2067"><a href="#ServerArgs.add_cli_args-2067"><span class="linenos">2067</span></a>            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2068"><a href="#ServerArgs.add_cli_args-2068"><span class="linenos">2068</span></a>            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;(Deprecated) Enable FlashInfer MXFP4 MoE backend for modelopt_fp4 quant on Blackwell.&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.add_cli_args-2069"><a href="#ServerArgs.add_cli_args-2069"><span class="linenos">2069</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ServerArgs.from_cli_args" class="classattr">
                                        <input id="ServerArgs.from_cli_args-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_cli_args</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.from_cli_args-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.from_cli_args"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.from_cli_args-2071"><a href="#ServerArgs.from_cli_args-2071"><span class="linenos">2071</span></a>    <span class="nd">@classmethod</span>
</span><span id="ServerArgs.from_cli_args-2072"><a href="#ServerArgs.from_cli_args-2072"><span class="linenos">2072</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_cli_args</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>
</span><span id="ServerArgs.from_cli_args-2073"><a href="#ServerArgs.from_cli_args-2073"><span class="linenos">2073</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tensor_parallel_size</span>
</span><span id="ServerArgs.from_cli_args-2074"><a href="#ServerArgs.from_cli_args-2074"><span class="linenos">2074</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">pp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pipeline_parallel_size</span>
</span><span id="ServerArgs.from_cli_args-2075"><a href="#ServerArgs.from_cli_args-2075"><span class="linenos">2075</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">data_parallel_size</span>
</span><span id="ServerArgs.from_cli_args-2076"><a href="#ServerArgs.from_cli_args-2076"><span class="linenos">2076</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">expert_parallel_size</span>
</span><span id="ServerArgs.from_cli_args-2077"><a href="#ServerArgs.from_cli_args-2077"><span class="linenos">2077</span></a>        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)]</span>
</span><span id="ServerArgs.from_cli_args-2078"><a href="#ServerArgs.from_cli_args-2078"><span class="linenos">2078</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">})</span>
</span></pre></div>


    

                            </div>
                            <div id="ServerArgs.url" class="classattr">
                                        <input id="ServerArgs.url-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">url</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.url-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.url"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.url-2080"><a href="#ServerArgs.url-2080"><span class="linenos">2080</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs.url-2081"><a href="#ServerArgs.url-2081"><span class="linenos">2081</span></a>        <span class="k">if</span> <span class="n">is_valid_ipv6_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">):</span>
</span><span id="ServerArgs.url-2082"><a href="#ServerArgs.url-2082"><span class="linenos">2082</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;http://[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">]:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.url-2083"><a href="#ServerArgs.url-2083"><span class="linenos">2083</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs.url-2084"><a href="#ServerArgs.url-2084"><span class="linenos">2084</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


    

                            </div>
                            <div id="ServerArgs.get_hf_config" class="classattr">
                                        <input id="ServerArgs.get_hf_config-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_hf_config</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.get_hf_config-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.get_hf_config"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.get_hf_config-2086"><a href="#ServerArgs.get_hf_config-2086"><span class="linenos">2086</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_hf_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs.get_hf_config-2087"><a href="#ServerArgs.get_hf_config-2087"><span class="linenos">2087</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ServerArgs.get_hf_config-2088"><a href="#ServerArgs.get_hf_config-2088"><span class="linenos">2088</span></a>        <span class="n">hf_config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span>
</span><span id="ServerArgs.get_hf_config-2089"><a href="#ServerArgs.get_hf_config-2089"><span class="linenos">2089</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span>
</span><span id="ServerArgs.get_hf_config-2090"><a href="#ServerArgs.get_hf_config-2090"><span class="linenos">2090</span></a>            <span class="n">trust_remote_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
</span><span id="ServerArgs.get_hf_config-2091"><a href="#ServerArgs.get_hf_config-2091"><span class="linenos">2091</span></a>            <span class="n">revision</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span>
</span><span id="ServerArgs.get_hf_config-2092"><a href="#ServerArgs.get_hf_config-2092"><span class="linenos">2092</span></a>            <span class="n">model_override_args</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_model_override_args</span><span class="p">),</span>
</span><span id="ServerArgs.get_hf_config-2093"><a href="#ServerArgs.get_hf_config-2093"><span class="linenos">2093</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ServerArgs.get_hf_config-2094"><a href="#ServerArgs.get_hf_config-2094"><span class="linenos">2094</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.get_hf_config-2095"><a href="#ServerArgs.get_hf_config-2095"><span class="linenos">2095</span></a>        <span class="k">return</span> <span class="n">hf_config</span>
</span></pre></div>


    

                            </div>
                            <div id="ServerArgs.check_server_args" class="classattr">
                                        <input id="ServerArgs.check_server_args-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_server_args</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.check_server_args-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.check_server_args"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.check_server_args-2097"><a href="#ServerArgs.check_server_args-2097"><span class="linenos">2097</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_server_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs.check_server_args-2098"><a href="#ServerArgs.check_server_args-2098"><span class="linenos">2098</span></a>        <span class="c1"># Check parallel size constraints</span>
</span><span id="ServerArgs.check_server_args-2099"><a href="#ServerArgs.check_server_args-2099"><span class="linenos">2099</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs.check_server_args-2100"><a href="#ServerArgs.check_server_args-2100"><span class="linenos">2100</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tp_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span>
</span><span id="ServerArgs.check_server_args-2101"><a href="#ServerArgs.check_server_args-2101"><span class="linenos">2101</span></a>        <span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tp_size must be divisible by number of nodes&quot;</span>
</span><span id="ServerArgs.check_server_args-2102"><a href="#ServerArgs.check_server_args-2102"><span class="linenos">2102</span></a>
</span><span id="ServerArgs.check_server_args-2103"><a href="#ServerArgs.check_server_args-2103"><span class="linenos">2103</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ServerArgs.check_server_args-2104"><a href="#ServerArgs.check_server_args-2104"><span class="linenos">2104</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs.check_server_args-2105"><a href="#ServerArgs.check_server_args-2105"><span class="linenos">2105</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">disable_overlap_schedule</span>
</span><span id="ServerArgs.check_server_args-2106"><a href="#ServerArgs.check_server_args-2106"><span class="linenos">2106</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ServerArgs.check_server_args-2107"><a href="#ServerArgs.check_server_args-2107"><span class="linenos">2107</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span>
</span><span id="ServerArgs.check_server_args-2108"><a href="#ServerArgs.check_server_args-2108"><span class="linenos">2108</span></a>            <span class="p">),</span> <span class="s2">&quot;Pipeline parallelism is not compatible with overlap schedule, speculative decoding, mixed chunked prefill.&quot;</span>
</span><span id="ServerArgs.check_server_args-2109"><a href="#ServerArgs.check_server_args-2109"><span class="linenos">2109</span></a>
</span><span id="ServerArgs.check_server_args-2110"><a href="#ServerArgs.check_server_args-2110"><span class="linenos">2110</span></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="ServerArgs.check_server_args-2111"><a href="#ServerArgs.check_server_args-2111"><span class="linenos">2111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dp_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span>
</span><span id="ServerArgs.check_server_args-2112"><a href="#ServerArgs.check_server_args-2112"><span class="linenos">2112</span></a>        <span class="p">),</span> <span class="s2">&quot;multi-node data parallel is not supported unless dp attention!&quot;</span>
</span><span id="ServerArgs.check_server_args-2113"><a href="#ServerArgs.check_server_args-2113"><span class="linenos">2113</span></a>
</span><span id="ServerArgs.check_server_args-2114"><a href="#ServerArgs.check_server_args-2114"><span class="linenos">2114</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_gpu_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;base_gpu_id must be non-negative&quot;</span>
</span><span id="ServerArgs.check_server_args-2115"><a href="#ServerArgs.check_server_args-2115"><span class="linenos">2115</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_id_step</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;gpu_id_step must be positive&quot;</span>
</span><span id="ServerArgs.check_server_args-2116"><a href="#ServerArgs.check_server_args-2116"><span class="linenos">2116</span></a>
</span><span id="ServerArgs.check_server_args-2117"><a href="#ServerArgs.check_server_args-2117"><span class="linenos">2117</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_dense_tp_size</span> <span class="ow">in</span> <span class="p">{</span>
</span><span id="ServerArgs.check_server_args-2118"><a href="#ServerArgs.check_server_args-2118"><span class="linenos">2118</span></a>            <span class="mi">1</span><span class="p">,</span>
</span><span id="ServerArgs.check_server_args-2119"><a href="#ServerArgs.check_server_args-2119"><span class="linenos">2119</span></a>            <span class="kc">None</span><span class="p">,</span>
</span><span id="ServerArgs.check_server_args-2120"><a href="#ServerArgs.check_server_args-2120"><span class="linenos">2120</span></a>        <span class="p">},</span> <span class="s2">&quot;moe_dense_tp_size only support 1 and None currently&quot;</span>
</span><span id="ServerArgs.check_server_args-2121"><a href="#ServerArgs.check_server_args-2121"><span class="linenos">2121</span></a>
</span><span id="ServerArgs.check_server_args-2122"><a href="#ServerArgs.check_server_args-2122"><span class="linenos">2122</span></a>        <span class="c1"># Check LoRA</span>
</span><span id="ServerArgs.check_server_args-2123"><a href="#ServerArgs.check_server_args-2123"><span class="linenos">2123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_lora_server_args</span><span class="p">()</span>
</span><span id="ServerArgs.check_server_args-2124"><a href="#ServerArgs.check_server_args-2124"><span class="linenos">2124</span></a>
</span><span id="ServerArgs.check_server_args-2125"><a href="#ServerArgs.check_server_args-2125"><span class="linenos">2125</span></a>        <span class="c1"># Check speculative decoding</span>
</span><span id="ServerArgs.check_server_args-2126"><a href="#ServerArgs.check_server_args-2126"><span class="linenos">2126</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speculative_algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs.check_server_args-2127"><a href="#ServerArgs.check_server_args-2127"><span class="linenos">2127</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs.check_server_args-2128"><a href="#ServerArgs.check_server_args-2128"><span class="linenos">2128</span></a>                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_mixed_chunk</span>
</span><span id="ServerArgs.check_server_args-2129"><a href="#ServerArgs.check_server_args-2129"><span class="linenos">2129</span></a>            <span class="p">),</span> <span class="s2">&quot;enable_mixed_chunk is required for speculative decoding&quot;</span>
</span><span id="ServerArgs.check_server_args-2130"><a href="#ServerArgs.check_server_args-2130"><span class="linenos">2130</span></a>
</span><span id="ServerArgs.check_server_args-2131"><a href="#ServerArgs.check_server_args-2131"><span class="linenos">2131</span></a>        <span class="c1"># Check chunked prefill</span>
</span><span id="ServerArgs.check_server_args-2132"><a href="#ServerArgs.check_server_args-2132"><span class="linenos">2132</span></a>        <span class="c1"># Skip validation if chunked prefill is disabled (i.e., size &lt;= 0).</span>
</span><span id="ServerArgs.check_server_args-2133"><a href="#ServerArgs.check_server_args-2133"><span class="linenos">2133</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ServerArgs.check_server_args-2134"><a href="#ServerArgs.check_server_args-2134"><span class="linenos">2134</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs.check_server_args-2135"><a href="#ServerArgs.check_server_args-2135"><span class="linenos">2135</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chunked_prefill_size</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_size</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="ServerArgs.check_server_args-2136"><a href="#ServerArgs.check_server_args-2136"><span class="linenos">2136</span></a>            <span class="p">),</span> <span class="s2">&quot;chunked_prefill_size must be divisible by page_size&quot;</span>
</span></pre></div>


    

                            </div>
                            <div id="ServerArgs.check_lora_server_args" class="classattr">
                                        <input id="ServerArgs.check_lora_server_args-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_lora_server_args</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.check_lora_server_args-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.check_lora_server_args"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.check_lora_server_args-2138"><a href="#ServerArgs.check_lora_server_args-2138"><span class="linenos">2138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_lora_server_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs.check_lora_server_args-2139"><a href="#ServerArgs.check_lora_server_args-2139"><span class="linenos">2139</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max_loras_per_batch must be positive&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2140"><a href="#ServerArgs.check_lora_server_args-2140"><span class="linenos">2140</span></a>
</span><span id="ServerArgs.check_lora_server_args-2141"><a href="#ServerArgs.check_lora_server_args-2141"><span class="linenos">2141</span></a>        <span class="c1"># Enable LoRA if any LoRA paths are provided for backward compatibility.</span>
</span><span id="ServerArgs.check_lora_server_args-2142"><a href="#ServerArgs.check_lora_server_args-2142"><span class="linenos">2142</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2143"><a href="#ServerArgs.check_lora_server_args-2143"><span class="linenos">2143</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2144"><a href="#ServerArgs.check_lora_server_args-2144"><span class="linenos">2144</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs.check_lora_server_args-2145"><a href="#ServerArgs.check_lora_server_args-2145"><span class="linenos">2145</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2146"><a href="#ServerArgs.check_lora_server_args-2146"><span class="linenos">2146</span></a>                    <span class="s2">&quot;--enable-lora is set to True because --lora-paths is provided.&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2147"><a href="#ServerArgs.check_lora_server_args-2147"><span class="linenos">2147</span></a>                <span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2148"><a href="#ServerArgs.check_lora_server_args-2148"><span class="linenos">2148</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2149"><a href="#ServerArgs.check_lora_server_args-2149"><span class="linenos">2149</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2150"><a href="#ServerArgs.check_lora_server_args-2150"><span class="linenos">2150</span></a>                    <span class="s2">&quot;--enable-lora is set to False, any provided lora_paths will be ignored.&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2151"><a href="#ServerArgs.check_lora_server_args-2151"><span class="linenos">2151</span></a>                <span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2152"><a href="#ServerArgs.check_lora_server_args-2152"><span class="linenos">2152</span></a>
</span><span id="ServerArgs.check_lora_server_args-2153"><a href="#ServerArgs.check_lora_server_args-2153"><span class="linenos">2153</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lora</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2154"><a href="#ServerArgs.check_lora_server_args-2154"><span class="linenos">2154</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ServerArgs.check_lora_server_args-2155"><a href="#ServerArgs.check_lora_server_args-2155"><span class="linenos">2155</span></a>                <span class="n">lora_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span>
</span><span id="ServerArgs.check_lora_server_args-2156"><a href="#ServerArgs.check_lora_server_args-2156"><span class="linenos">2156</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ServerArgs.check_lora_server_args-2157"><a href="#ServerArgs.check_lora_server_args-2157"><span class="linenos">2157</span></a>                <span class="k">for</span> <span class="n">lora_path</span> <span class="ow">in</span> <span class="n">lora_paths</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2158"><a href="#ServerArgs.check_lora_server_args-2158"><span class="linenos">2158</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lora_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ServerArgs.check_lora_server_args-2159"><a href="#ServerArgs.check_lora_server_args-2159"><span class="linenos">2159</span></a>                        <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2160"><a href="#ServerArgs.check_lora_server_args-2160"><span class="linenos">2160</span></a>                            <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2161"><a href="#ServerArgs.check_lora_server_args-2161"><span class="linenos">2161</span></a>                            <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2162"><a href="#ServerArgs.check_lora_server_args-2162"><span class="linenos">2162</span></a>                                <span class="n">lora_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ServerArgs.check_lora_server_args-2163"><a href="#ServerArgs.check_lora_server_args-2163"><span class="linenos">2163</span></a>                            <span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2164"><a href="#ServerArgs.check_lora_server_args-2164"><span class="linenos">2164</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2165"><a href="#ServerArgs.check_lora_server_args-2165"><span class="linenos">2165</span></a>                            <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2166"><a href="#ServerArgs.check_lora_server_args-2166"><span class="linenos">2166</span></a>                                <span class="n">lora_name</span><span class="o">=</span><span class="n">lora_path</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">lora_path</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ServerArgs.check_lora_server_args-2167"><a href="#ServerArgs.check_lora_server_args-2167"><span class="linenos">2167</span></a>                            <span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2168"><a href="#ServerArgs.check_lora_server_args-2168"><span class="linenos">2168</span></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lora_path</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="ServerArgs.check_lora_server_args-2169"><a href="#ServerArgs.check_lora_server_args-2169"><span class="linenos">2169</span></a>                        <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2170"><a href="#ServerArgs.check_lora_server_args-2170"><span class="linenos">2170</span></a>                            <span class="s2">&quot;lora_name&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span> <span class="ow">and</span> <span class="s2">&quot;lora_path&quot;</span> <span class="ow">in</span> <span class="n">lora_path</span>
</span><span id="ServerArgs.check_lora_server_args-2171"><a href="#ServerArgs.check_lora_server_args-2171"><span class="linenos">2171</span></a>                        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;When providing LoRA paths as a list of dict, each dict should contain &#39;lora_name&#39; and &#39;lora_path&#39; keys. Got: </span><span class="si">{</span><span class="n">lora_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2172"><a href="#ServerArgs.check_lora_server_args-2172"><span class="linenos">2172</span></a>                        <span class="n">lora_ref</span> <span class="o">=</span> <span class="n">LoRARef</span><span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2173"><a href="#ServerArgs.check_lora_server_args-2173"><span class="linenos">2173</span></a>                            <span class="n">lora_name</span><span class="o">=</span><span class="n">lora_path</span><span class="p">[</span><span class="s2">&quot;lora_name&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.check_lora_server_args-2174"><a href="#ServerArgs.check_lora_server_args-2174"><span class="linenos">2174</span></a>                            <span class="n">lora_path</span><span class="o">=</span><span class="n">lora_path</span><span class="p">[</span><span class="s2">&quot;lora_path&quot;</span><span class="p">],</span>
</span><span id="ServerArgs.check_lora_server_args-2175"><a href="#ServerArgs.check_lora_server_args-2175"><span class="linenos">2175</span></a>                            <span class="n">pinned</span><span class="o">=</span><span class="n">lora_path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pinned&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="ServerArgs.check_lora_server_args-2176"><a href="#ServerArgs.check_lora_server_args-2176"><span class="linenos">2176</span></a>                        <span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2177"><a href="#ServerArgs.check_lora_server_args-2177"><span class="linenos">2177</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2178"><a href="#ServerArgs.check_lora_server_args-2178"><span class="linenos">2178</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2179"><a href="#ServerArgs.check_lora_server_args-2179"><span class="linenos">2179</span></a>                            <span class="sa">f</span><span class="s2">&quot;Invalid type for item in --lora-paths list: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2180"><a href="#ServerArgs.check_lora_server_args-2180"><span class="linenos">2180</span></a>                            <span class="s2">&quot;Expected a string or a dictionary.&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2181"><a href="#ServerArgs.check_lora_server_args-2181"><span class="linenos">2181</span></a>                        <span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2182"><a href="#ServerArgs.check_lora_server_args-2182"><span class="linenos">2182</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lora_ref</span><span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2183"><a href="#ServerArgs.check_lora_server_args-2183"><span class="linenos">2183</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="ServerArgs.check_lora_server_args-2184"><a href="#ServerArgs.check_lora_server_args-2184"><span class="linenos">2184</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ServerArgs.check_lora_server_args-2185"><a href="#ServerArgs.check_lora_server_args-2185"><span class="linenos">2185</span></a>                    <span class="n">LoRARef</span><span class="p">(</span><span class="n">lora_name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">lora_path</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">pinned</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2186"><a href="#ServerArgs.check_lora_server_args-2186"><span class="linenos">2186</span></a>                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="ServerArgs.check_lora_server_args-2187"><a href="#ServerArgs.check_lora_server_args-2187"><span class="linenos">2187</span></a>                <span class="p">]</span>
</span><span id="ServerArgs.check_lora_server_args-2188"><a href="#ServerArgs.check_lora_server_args-2188"><span class="linenos">2188</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2189"><a href="#ServerArgs.check_lora_server_args-2189"><span class="linenos">2189</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ServerArgs.check_lora_server_args-2190"><a href="#ServerArgs.check_lora_server_args-2190"><span class="linenos">2190</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2191"><a href="#ServerArgs.check_lora_server_args-2191"><span class="linenos">2191</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2192"><a href="#ServerArgs.check_lora_server_args-2192"><span class="linenos">2192</span></a>                    <span class="sa">f</span><span class="s2">&quot;Invalid type for --lora-paths: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2193"><a href="#ServerArgs.check_lora_server_args-2193"><span class="linenos">2193</span></a>                    <span class="s2">&quot;Expected a list or a dictionary.&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2194"><a href="#ServerArgs.check_lora_server_args-2194"><span class="linenos">2194</span></a>                <span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2195"><a href="#ServerArgs.check_lora_server_args-2195"><span class="linenos">2195</span></a>
</span><span id="ServerArgs.check_lora_server_args-2196"><a href="#ServerArgs.check_lora_server_args-2196"><span class="linenos">2196</span></a>            <span class="c1"># Expand target modules</span>
</span><span id="ServerArgs.check_lora_server_args-2197"><a href="#ServerArgs.check_lora_server_args-2197"><span class="linenos">2197</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2198"><a href="#ServerArgs.check_lora_server_args-2198"><span class="linenos">2198</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2199"><a href="#ServerArgs.check_lora_server_args-2199"><span class="linenos">2199</span></a>                <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2200"><a href="#ServerArgs.check_lora_server_args-2200"><span class="linenos">2200</span></a>                    <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2201"><a href="#ServerArgs.check_lora_server_args-2201"><span class="linenos">2201</span></a>                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="ServerArgs.check_lora_server_args-2202"><a href="#ServerArgs.check_lora_server_args-2202"><span class="linenos">2202</span></a>                    <span class="p">),</span> <span class="s2">&quot;If &#39;all&#39; is specified in --lora-target-modules, it should be the only module specified.&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2203"><a href="#ServerArgs.check_lora_server_args-2203"><span class="linenos">2203</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">SUPPORTED_LORA_TARGET_MODULES</span><span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2204"><a href="#ServerArgs.check_lora_server_args-2204"><span class="linenos">2204</span></a>
</span><span id="ServerArgs.check_lora_server_args-2205"><a href="#ServerArgs.check_lora_server_args-2205"><span class="linenos">2205</span></a>            <span class="c1"># Ensure sufficient information is provided for LoRA initialization.</span>
</span><span id="ServerArgs.check_lora_server_args-2206"><a href="#ServerArgs.check_lora_server_args-2206"><span class="linenos">2206</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2207"><a href="#ServerArgs.check_lora_server_args-2207"><span class="linenos">2207</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_lora_rank</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_target_modules</span>
</span><span id="ServerArgs.check_lora_server_args-2208"><a href="#ServerArgs.check_lora_server_args-2208"><span class="linenos">2208</span></a>            <span class="p">),</span> <span class="s2">&quot;When no initial --lora-paths is provided, you need to specify both --max-lora-rank and --lora-target-modules for LoRA initialization.&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2209"><a href="#ServerArgs.check_lora_server_args-2209"><span class="linenos">2209</span></a>
</span><span id="ServerArgs.check_lora_server_args-2210"><a href="#ServerArgs.check_lora_server_args-2210"><span class="linenos">2210</span></a>            <span class="c1"># Validate max_loaded_loras</span>
</span><span id="ServerArgs.check_lora_server_args-2211"><a href="#ServerArgs.check_lora_server_args-2211"><span class="linenos">2211</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs.check_lora_server_args-2212"><a href="#ServerArgs.check_lora_server_args-2212"><span class="linenos">2212</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span><span class="p">,</span> <span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2213"><a href="#ServerArgs.check_lora_server_args-2213"><span class="linenos">2213</span></a>                    <span class="s2">&quot;max_loaded_loras should be greater than or equal to max_loras_per_batch. &quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2214"><a href="#ServerArgs.check_lora_server_args-2214"><span class="linenos">2214</span></a>                    <span class="sa">f</span><span class="s2">&quot;max_loaded_loras=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="si">}</span><span class="s2">, max_loras_per_batch=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loras_per_batch</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2215"><a href="#ServerArgs.check_lora_server_args-2215"><span class="linenos">2215</span></a>                <span class="p">)</span>
</span><span id="ServerArgs.check_lora_server_args-2216"><a href="#ServerArgs.check_lora_server_args-2216"><span class="linenos">2216</span></a>                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="p">,</span> <span class="p">(</span>
</span><span id="ServerArgs.check_lora_server_args-2217"><a href="#ServerArgs.check_lora_server_args-2217"><span class="linenos">2217</span></a>                    <span class="s2">&quot;The number of LoRA paths should not exceed max_loaded_loras. &quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2218"><a href="#ServerArgs.check_lora_server_args-2218"><span class="linenos">2218</span></a>                    <span class="sa">f</span><span class="s2">&quot;max_loaded_loras=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loaded_loras</span><span class="si">}</span><span class="s2">, lora_paths=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.check_lora_server_args-2219"><a href="#ServerArgs.check_lora_server_args-2219"><span class="linenos">2219</span></a>                <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ServerArgs.validate_disagg_tp_size" class="classattr">
                                        <input id="ServerArgs.validate_disagg_tp_size-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validate_disagg_tp_size</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">prefill_tp</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">decode_tp</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.validate_disagg_tp_size-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.validate_disagg_tp_size"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.validate_disagg_tp_size-2221"><a href="#ServerArgs.validate_disagg_tp_size-2221"><span class="linenos">2221</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_disagg_tp_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">decode_tp</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="ServerArgs.validate_disagg_tp_size-2222"><a href="#ServerArgs.validate_disagg_tp_size-2222"><span class="linenos">2222</span></a>        <span class="n">larger_tp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">decode_tp</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">)</span>
</span><span id="ServerArgs.validate_disagg_tp_size-2223"><a href="#ServerArgs.validate_disagg_tp_size-2223"><span class="linenos">2223</span></a>        <span class="n">smaller_tp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">decode_tp</span><span class="p">,</span> <span class="n">prefill_tp</span><span class="p">)</span>
</span><span id="ServerArgs.validate_disagg_tp_size-2224"><a href="#ServerArgs.validate_disagg_tp_size-2224"><span class="linenos">2224</span></a>        <span class="k">assert</span> <span class="n">larger_tp</span> <span class="o">%</span> <span class="n">smaller_tp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
</span><span id="ServerArgs.validate_disagg_tp_size-2225"><a href="#ServerArgs.validate_disagg_tp_size-2225"><span class="linenos">2225</span></a>            <span class="s2">&quot;Different tp size is supported only when one tp is multiple of the other. &quot;</span>
</span><span id="ServerArgs.validate_disagg_tp_size-2226"><a href="#ServerArgs.validate_disagg_tp_size-2226"><span class="linenos">2226</span></a>            <span class="sa">f</span><span class="s2">&quot;decode_tp=</span><span class="si">{</span><span class="n">decode_tp</span><span class="si">}</span><span class="s2">, prefill_tp=</span><span class="si">{</span><span class="n">prefill_tp</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ServerArgs.validate_disagg_tp_size-2227"><a href="#ServerArgs.validate_disagg_tp_size-2227"><span class="linenos">2227</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ServerArgs.model_specific_adjustments" class="classattr">
                                        <input id="ServerArgs.model_specific_adjustments-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">model_specific_adjustments</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.model_specific_adjustments-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.model_specific_adjustments"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.model_specific_adjustments-2229"><a href="#ServerArgs.model_specific_adjustments-2229"><span class="linenos">2229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">model_specific_adjustments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ServerArgs.model_specific_adjustments-2230"><a href="#ServerArgs.model_specific_adjustments-2230"><span class="linenos">2230</span></a>        <span class="n">hf_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hf_config</span><span class="p">()</span>
</span><span id="ServerArgs.model_specific_adjustments-2231"><a href="#ServerArgs.model_specific_adjustments-2231"><span class="linenos">2231</span></a>        <span class="n">model_arch</span> <span class="o">=</span> <span class="n">hf_config</span><span class="o">.</span><span class="n">architectures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ServerArgs.model_specific_adjustments-2232"><a href="#ServerArgs.model_specific_adjustments-2232"><span class="linenos">2232</span></a>        <span class="k">if</span> <span class="n">model_arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GptOssForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="ServerArgs.model_specific_adjustments-2233"><a href="#ServerArgs.model_specific_adjustments-2233"><span class="linenos">2233</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs.model_specific_adjustments-2234"><a href="#ServerArgs.model_specific_adjustments-2234"><span class="linenos">2234</span></a>                <span class="k">if</span> <span class="n">is_cuda</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="ServerArgs.model_specific_adjustments-2235"><a href="#ServerArgs.model_specific_adjustments-2235"><span class="linenos">2235</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;trtllm_mha&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2236"><a href="#ServerArgs.model_specific_adjustments-2236"><span class="linenos">2236</span></a>                <span class="k">elif</span> <span class="n">is_cuda</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sm90_supported</span><span class="p">():</span>
</span><span id="ServerArgs.model_specific_adjustments-2237"><a href="#ServerArgs.model_specific_adjustments-2237"><span class="linenos">2237</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;fa3&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2238"><a href="#ServerArgs.model_specific_adjustments-2238"><span class="linenos">2238</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs.model_specific_adjustments-2239"><a href="#ServerArgs.model_specific_adjustments-2239"><span class="linenos">2239</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="o">=</span> <span class="s2">&quot;triton&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2240"><a href="#ServerArgs.model_specific_adjustments-2240"><span class="linenos">2240</span></a>            <span class="n">supported_backends</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;triton&quot;</span><span class="p">,</span> <span class="s2">&quot;trtllm_mha&quot;</span><span class="p">,</span> <span class="s2">&quot;fa3&quot;</span><span class="p">]</span>
</span><span id="ServerArgs.model_specific_adjustments-2241"><a href="#ServerArgs.model_specific_adjustments-2241"><span class="linenos">2241</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2242"><a href="#ServerArgs.model_specific_adjustments-2242"><span class="linenos">2242</span></a>                <span class="sa">f</span><span class="s2">&quot;Use </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span><span class="si">}</span><span class="s2"> as attention backend for GptOssForCausalLM&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2243"><a href="#ServerArgs.model_specific_adjustments-2243"><span class="linenos">2243</span></a>            <span class="p">)</span>
</span><span id="ServerArgs.model_specific_adjustments-2244"><a href="#ServerArgs.model_specific_adjustments-2244"><span class="linenos">2244</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2245"><a href="#ServerArgs.model_specific_adjustments-2245"><span class="linenos">2245</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">in</span> <span class="n">supported_backends</span>
</span><span id="ServerArgs.model_specific_adjustments-2246"><a href="#ServerArgs.model_specific_adjustments-2246"><span class="linenos">2246</span></a>            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;GptOssForCausalLM requires one of </span><span class="si">{</span><span class="n">supported_backends</span><span class="si">}</span><span class="s2"> attention backend, but got &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2247"><a href="#ServerArgs.model_specific_adjustments-2247"><span class="linenos">2247</span></a>
</span><span id="ServerArgs.model_specific_adjustments-2248"><a href="#ServerArgs.model_specific_adjustments-2248"><span class="linenos">2248</span></a>            <span class="k">if</span> <span class="n">is_sm100_supported</span><span class="p">():</span>
</span><span id="ServerArgs.model_specific_adjustments-2249"><a href="#ServerArgs.model_specific_adjustments-2249"><span class="linenos">2249</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="ServerArgs.model_specific_adjustments-2250"><a href="#ServerArgs.model_specific_adjustments-2250"><span class="linenos">2250</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">enable_flashinfer_allreduce_fusion</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs.model_specific_adjustments-2251"><a href="#ServerArgs.model_specific_adjustments-2251"><span class="linenos">2251</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2252"><a href="#ServerArgs.model_specific_adjustments-2252"><span class="linenos">2252</span></a>                        <span class="s2">&quot;Enable FlashInfer AllReduce Fusion on sm100 for GptOssForCausalLM&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2253"><a href="#ServerArgs.model_specific_adjustments-2253"><span class="linenos">2253</span></a>                    <span class="p">)</span>
</span><span id="ServerArgs.model_specific_adjustments-2254"><a href="#ServerArgs.model_specific_adjustments-2254"><span class="linenos">2254</span></a>            <span class="n">quantization_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hf_config</span><span class="p">,</span> <span class="s2">&quot;quantization_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ServerArgs.model_specific_adjustments-2255"><a href="#ServerArgs.model_specific_adjustments-2255"><span class="linenos">2255</span></a>            <span class="n">is_mxfp4_quant_format</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2256"><a href="#ServerArgs.model_specific_adjustments-2256"><span class="linenos">2256</span></a>                <span class="n">quantization_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="ServerArgs.model_specific_adjustments-2257"><a href="#ServerArgs.model_specific_adjustments-2257"><span class="linenos">2257</span></a>                <span class="ow">and</span> <span class="n">quantization_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quant_method&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mxfp4&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2258"><a href="#ServerArgs.model_specific_adjustments-2258"><span class="linenos">2258</span></a>            <span class="p">)</span>
</span><span id="ServerArgs.model_specific_adjustments-2259"><a href="#ServerArgs.model_specific_adjustments-2259"><span class="linenos">2259</span></a>
</span><span id="ServerArgs.model_specific_adjustments-2260"><a href="#ServerArgs.model_specific_adjustments-2260"><span class="linenos">2260</span></a>            <span class="k">if</span> <span class="n">is_sm100_supported</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_mxfp4_quant_format</span><span class="p">:</span>
</span><span id="ServerArgs.model_specific_adjustments-2261"><a href="#ServerArgs.model_specific_adjustments-2261"><span class="linenos">2261</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;flashinfer_mxfp4&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2262"><a href="#ServerArgs.model_specific_adjustments-2262"><span class="linenos">2262</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2263"><a href="#ServerArgs.model_specific_adjustments-2263"><span class="linenos">2263</span></a>                    <span class="s2">&quot;Detected SM100 and MXFP4 quantization format for GPT-OSS model, enabling FlashInfer MXFP4 MOE kernel.&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2264"><a href="#ServerArgs.model_specific_adjustments-2264"><span class="linenos">2264</span></a>                <span class="p">)</span>
</span><span id="ServerArgs.model_specific_adjustments-2265"><a href="#ServerArgs.model_specific_adjustments-2265"><span class="linenos">2265</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ServerArgs.model_specific_adjustments-2266"><a href="#ServerArgs.model_specific_adjustments-2266"><span class="linenos">2266</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;triton_kernel&quot;</span><span class="p">:</span>
</span><span id="ServerArgs.model_specific_adjustments-2267"><a href="#ServerArgs.model_specific_adjustments-2267"><span class="linenos">2267</span></a>                    <span class="k">assert</span> <span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2268"><a href="#ServerArgs.model_specific_adjustments-2268"><span class="linenos">2268</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="ServerArgs.model_specific_adjustments-2269"><a href="#ServerArgs.model_specific_adjustments-2269"><span class="linenos">2269</span></a>                    <span class="p">),</span> <span class="s2">&quot;Triton kernel MoE is only supported when ep_size == 1&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2270"><a href="#ServerArgs.model_specific_adjustments-2270"><span class="linenos">2270</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2271"><a href="#ServerArgs.model_specific_adjustments-2271"><span class="linenos">2271</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2272"><a href="#ServerArgs.model_specific_adjustments-2272"><span class="linenos">2272</span></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep_size</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="ServerArgs.model_specific_adjustments-2273"><a href="#ServerArgs.model_specific_adjustments-2273"><span class="linenos">2273</span></a>                    <span class="ow">and</span> <span class="n">is_triton_kernels_available</span><span class="p">()</span>
</span><span id="ServerArgs.model_specific_adjustments-2274"><a href="#ServerArgs.model_specific_adjustments-2274"><span class="linenos">2274</span></a>                <span class="p">):</span>
</span><span id="ServerArgs.model_specific_adjustments-2275"><a href="#ServerArgs.model_specific_adjustments-2275"><span class="linenos">2275</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">moe_runner_backend</span> <span class="o">=</span> <span class="s2">&quot;triton_kernel&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2276"><a href="#ServerArgs.model_specific_adjustments-2276"><span class="linenos">2276</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2277"><a href="#ServerArgs.model_specific_adjustments-2277"><span class="linenos">2277</span></a>                        <span class="s2">&quot;Detected GPT-OSS model, enabling triton_kernels MOE kernel.&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2278"><a href="#ServerArgs.model_specific_adjustments-2278"><span class="linenos">2278</span></a>                    <span class="p">)</span>
</span><span id="ServerArgs.model_specific_adjustments-2279"><a href="#ServerArgs.model_specific_adjustments-2279"><span class="linenos">2279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_hybrid_swa_memory</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ServerArgs.model_specific_adjustments-2280"><a href="#ServerArgs.model_specific_adjustments-2280"><span class="linenos">2280</span></a>            <span class="k">if</span> <span class="n">is_mxfp4_quant_format</span><span class="p">:</span>
</span><span id="ServerArgs.model_specific_adjustments-2281"><a href="#ServerArgs.model_specific_adjustments-2281"><span class="linenos">2281</span></a>                <span class="c1"># use bf16 for mxfp4 triton kernels</span>
</span><span id="ServerArgs.model_specific_adjustments-2282"><a href="#ServerArgs.model_specific_adjustments-2282"><span class="linenos">2282</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;bfloat16&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2283"><a href="#ServerArgs.model_specific_adjustments-2283"><span class="linenos">2283</span></a>
</span><span id="ServerArgs.model_specific_adjustments-2284"><a href="#ServerArgs.model_specific_adjustments-2284"><span class="linenos">2284</span></a>        <span class="k">elif</span> <span class="s2">&quot;Llama4&quot;</span> <span class="ow">in</span> <span class="n">model_arch</span><span class="p">:</span>
</span><span id="ServerArgs.model_specific_adjustments-2285"><a href="#ServerArgs.model_specific_adjustments-2285"><span class="linenos">2285</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_backend</span> <span class="ow">in</span> <span class="p">{</span>
</span><span id="ServerArgs.model_specific_adjustments-2286"><a href="#ServerArgs.model_specific_adjustments-2286"><span class="linenos">2286</span></a>                <span class="s2">&quot;fa3&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.model_specific_adjustments-2287"><a href="#ServerArgs.model_specific_adjustments-2287"><span class="linenos">2287</span></a>                <span class="s2">&quot;aiter&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.model_specific_adjustments-2288"><a href="#ServerArgs.model_specific_adjustments-2288"><span class="linenos">2288</span></a>            <span class="p">},</span> <span class="s2">&quot;fa3 or aiter is required for Llama4 model&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2289"><a href="#ServerArgs.model_specific_adjustments-2289"><span class="linenos">2289</span></a>        <span class="k">elif</span> <span class="n">model_arch</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="ServerArgs.model_specific_adjustments-2290"><a href="#ServerArgs.model_specific_adjustments-2290"><span class="linenos">2290</span></a>            <span class="s2">&quot;Gemma2ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.model_specific_adjustments-2291"><a href="#ServerArgs.model_specific_adjustments-2291"><span class="linenos">2291</span></a>            <span class="s2">&quot;Gemma3ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.model_specific_adjustments-2292"><a href="#ServerArgs.model_specific_adjustments-2292"><span class="linenos">2292</span></a>            <span class="s2">&quot;Gemma3ForConditionalGeneration&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.model_specific_adjustments-2293"><a href="#ServerArgs.model_specific_adjustments-2293"><span class="linenos">2293</span></a>            <span class="s2">&quot;Gemma3nForCausalLM&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.model_specific_adjustments-2294"><a href="#ServerArgs.model_specific_adjustments-2294"><span class="linenos">2294</span></a>            <span class="s2">&quot;Gemma3nForConditionalGeneration&quot;</span><span class="p">,</span>
</span><span id="ServerArgs.model_specific_adjustments-2295"><a href="#ServerArgs.model_specific_adjustments-2295"><span class="linenos">2295</span></a>        <span class="p">]:</span>
</span><span id="ServerArgs.model_specific_adjustments-2296"><a href="#ServerArgs.model_specific_adjustments-2296"><span class="linenos">2296</span></a>            <span class="c1"># FIXME: https://github.com/sgl-project/sglang/pull/7367 is not compatible with gemma2 model.</span>
</span><span id="ServerArgs.model_specific_adjustments-2297"><a href="#ServerArgs.model_specific_adjustments-2297"><span class="linenos">2297</span></a>            <span class="c1"># It failed at this test: https://github.com/sgl-project/sglang/actions/runs/16255155597/job/45890331952#step:4:736</span>
</span><span id="ServerArgs.model_specific_adjustments-2298"><a href="#ServerArgs.model_specific_adjustments-2298"><span class="linenos">2298</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ServerArgs.model_specific_adjustments-2299"><a href="#ServerArgs.model_specific_adjustments-2299"><span class="linenos">2299</span></a>                <span class="sa">f</span><span class="s2">&quot;Disable hybrid SWA memory for </span><span class="si">{</span><span class="n">model_arch</span><span class="si">}</span><span class="s2"> as it is not yet supported.&quot;</span>
</span><span id="ServerArgs.model_specific_adjustments-2300"><a href="#ServerArgs.model_specific_adjustments-2300"><span class="linenos">2300</span></a>            <span class="p">)</span>
</span><span id="ServerArgs.model_specific_adjustments-2301"><a href="#ServerArgs.model_specific_adjustments-2301"><span class="linenos">2301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">disable_hybrid_swa_memory</span> <span class="o">=</span> <span class="kc">True</span>
</span></pre></div>


    

                            </div>
                            <div id="ServerArgs.adjust_mem_fraction_for_vlm" class="classattr">
                                        <input id="ServerArgs.adjust_mem_fraction_for_vlm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">adjust_mem_fraction_for_vlm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">model_config</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ServerArgs.adjust_mem_fraction_for_vlm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ServerArgs.adjust_mem_fraction_for_vlm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2303"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2303"><span class="linenos">2303</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_mem_fraction_for_vlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_config</span><span class="p">):</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2304"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2304"><span class="linenos">2304</span></a>        <span class="n">vision_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">hf_config</span><span class="p">,</span> <span class="s2">&quot;vision_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2305"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2305"><span class="linenos">2305</span></a>        <span class="k">if</span> <span class="n">vision_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2306"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2306"><span class="linenos">2306</span></a>            <span class="k">return</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2307"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2307"><span class="linenos">2307</span></a>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2308"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2308"><span class="linenos">2308</span></a>        <span class="c1"># roughly reduce the mem_fraction_static base on params of Vit</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2309"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2309"><span class="linenos">2309</span></a>        <span class="n">original_server_arg_mem_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2310"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2310"><span class="linenos">2310</span></a>        <span class="c1"># a base mem_fraction_static factor for regular Vit</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2311"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2311"><span class="linenos">2311</span></a>        <span class="n">base_mem_fraction_reduction_ratio</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2312"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2312"><span class="linenos">2312</span></a>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2313"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2313"><span class="linenos">2313</span></a>        <span class="n">vit_num_layers</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vision_config</span><span class="p">,</span> <span class="s2">&quot;num_hidden_layers&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2314"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2314"><span class="linenos">2314</span></a>        <span class="n">vit_hidden_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vision_config</span><span class="p">,</span> <span class="s2">&quot;hidden_size&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2315"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2315"><span class="linenos">2315</span></a>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2316"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2316"><span class="linenos">2316</span></a>        <span class="c1"># baseline ViT params (ViT-L/14)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2317"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2317"><span class="linenos">2317</span></a>        <span class="n">baseline_vit_layers</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2318"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2318"><span class="linenos">2318</span></a>        <span class="n">baseline_vit_hidden_size</span> <span class="o">=</span> <span class="mi">1024</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2319"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2319"><span class="linenos">2319</span></a>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2320"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2320"><span class="linenos">2320</span></a>        <span class="c1"># weight params count</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2321"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2321"><span class="linenos">2321</span></a>        <span class="n">current_complexity_score</span> <span class="o">=</span> <span class="n">vit_num_layers</span> <span class="o">*</span> <span class="p">(</span><span class="n">vit_hidden_size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2322"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2322"><span class="linenos">2322</span></a>        <span class="n">baseline_complexity_score</span> <span class="o">=</span> <span class="n">baseline_vit_layers</span> <span class="o">*</span> <span class="p">(</span><span class="n">baseline_vit_hidden_size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2323"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2323"><span class="linenos">2323</span></a>        <span class="n">complexity_ratio</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2324"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2324"><span class="linenos">2324</span></a>            <span class="n">current_complexity_score</span> <span class="o">/</span> <span class="n">baseline_complexity_score</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2325"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2325"><span class="linenos">2325</span></a>            <span class="k">if</span> <span class="n">baseline_complexity_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2326"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2326"><span class="linenos">2326</span></a>            <span class="k">else</span> <span class="mf">1.0</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2327"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2327"><span class="linenos">2327</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2328"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2328"><span class="linenos">2328</span></a>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2329"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2329"><span class="linenos">2329</span></a>        <span class="c1"># every time the complexity grows 100%, adjust final factor for 10%</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2330"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2330"><span class="linenos">2330</span></a>        <span class="n">sensitivity_scale</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2331"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2331"><span class="linenos">2331</span></a>        <span class="n">dynamic_adjustment_factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">sensitivity_scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">complexity_ratio</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2332"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2332"><span class="linenos">2332</span></a>        <span class="n">dynamic_adjustment_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">dynamic_adjustment_factor</span><span class="p">))</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2333"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2333"><span class="linenos">2333</span></a>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2334"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2334"><span class="linenos">2334</span></a>        <span class="n">final_overall_factor</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2335"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2335"><span class="linenos">2335</span></a>            <span class="n">base_mem_fraction_reduction_ratio</span> <span class="o">*</span> <span class="n">dynamic_adjustment_factor</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2336"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2336"><span class="linenos">2336</span></a>        <span class="p">)</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2337"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2337"><span class="linenos">2337</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem_fraction_static</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2338"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2338"><span class="linenos">2338</span></a>            <span class="n">original_server_arg_mem_fraction</span> <span class="o">*</span> <span class="n">final_overall_factor</span>
</span><span id="ServerArgs.adjust_mem_fraction_for_vlm-2339"><a href="#ServerArgs.adjust_mem_fraction_for_vlm-2339"><span class="linenos">2339</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="prepare_server_args">
                            <input id="prepare_server_args-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prepare_server_args</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">argv</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#ServerArgs">ServerArgs</a></span>:</span></span>

                <label class="view-source-button" for="prepare_server_args-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#prepare_server_args"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="prepare_server_args-2342"><a href="#prepare_server_args-2342"><span class="linenos">2342</span></a><span class="k">def</span><span class="w"> </span><span class="nf">prepare_server_args</span><span class="p">(</span><span class="n">argv</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ServerArgs</span><span class="p">:</span>
</span><span id="prepare_server_args-2343"><a href="#prepare_server_args-2343"><span class="linenos">2343</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="prepare_server_args-2344"><a href="#prepare_server_args-2344"><span class="linenos">2344</span></a><span class="sd">    Prepare the server arguments from the command line arguments.</span>
</span><span id="prepare_server_args-2345"><a href="#prepare_server_args-2345"><span class="linenos">2345</span></a>
</span><span id="prepare_server_args-2346"><a href="#prepare_server_args-2346"><span class="linenos">2346</span></a><span class="sd">    Args:</span>
</span><span id="prepare_server_args-2347"><a href="#prepare_server_args-2347"><span class="linenos">2347</span></a><span class="sd">        args: The command line arguments. Typically, it should be `sys.argv[1:]`</span>
</span><span id="prepare_server_args-2348"><a href="#prepare_server_args-2348"><span class="linenos">2348</span></a><span class="sd">            to ensure compatibility with `parse_args` when no arguments are passed.</span>
</span><span id="prepare_server_args-2349"><a href="#prepare_server_args-2349"><span class="linenos">2349</span></a>
</span><span id="prepare_server_args-2350"><a href="#prepare_server_args-2350"><span class="linenos">2350</span></a><span class="sd">    Returns:</span>
</span><span id="prepare_server_args-2351"><a href="#prepare_server_args-2351"><span class="linenos">2351</span></a><span class="sd">        The server arguments.</span>
</span><span id="prepare_server_args-2352"><a href="#prepare_server_args-2352"><span class="linenos">2352</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="prepare_server_args-2353"><a href="#prepare_server_args-2353"><span class="linenos">2353</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span><span id="prepare_server_args-2354"><a href="#prepare_server_args-2354"><span class="linenos">2354</span></a>    <span class="n">ServerArgs</span><span class="o">.</span><span class="n">add_cli_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</span><span id="prepare_server_args-2355"><a href="#prepare_server_args-2355"><span class="linenos">2355</span></a>    <span class="n">raw_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
</span><span id="prepare_server_args-2356"><a href="#prepare_server_args-2356"><span class="linenos">2356</span></a>    <span class="n">server_args</span> <span class="o">=</span> <span class="n">ServerArgs</span><span class="o">.</span><span class="n">from_cli_args</span><span class="p">(</span><span class="n">raw_args</span><span class="p">)</span>
</span><span id="prepare_server_args-2357"><a href="#prepare_server_args-2357"><span class="linenos">2357</span></a>    <span class="k">return</span> <span class="n">server_args</span>
</span></pre></div>


            <div class="docstring"><p>Prepare the server arguments from the command line arguments.</p>

<p>Args:
    args: The command line arguments. Typically, it should be <code>sys.argv[1:]</code>
        to ensure compatibility with <code>parse_args</code> when no arguments are passed.</p>

<p>Returns:
    The server arguments.</p>
</div>


                </section>
                <section id="ZMQ_TCP_PORT_DELTA">
                    <div class="attr variable">
            <span class="name">ZMQ_TCP_PORT_DELTA</span>        =
<span class="default_value">233</span>

        
    </div>
    <a class="headerlink" href="#ZMQ_TCP_PORT_DELTA"></a>
    
    

                </section>
                <section id="PortArgs">
                            <input id="PortArgs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclasses.dataclass">@dataclasses.dataclass</div>

    <span class="def">class</span>
    <span class="name">PortArgs</span>:

                <label class="view-source-button" for="PortArgs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PortArgs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PortArgs-2363"><a href="#PortArgs-2363"><span class="linenos">2363</span></a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
</span><span id="PortArgs-2364"><a href="#PortArgs-2364"><span class="linenos">2364</span></a><span class="k">class</span><span class="w"> </span><span class="nc">PortArgs</span><span class="p">:</span>
</span><span id="PortArgs-2365"><a href="#PortArgs-2365"><span class="linenos">2365</span></a>    <span class="c1"># The ipc filename for tokenizer to receive inputs from detokenizer (zmq)</span>
</span><span id="PortArgs-2366"><a href="#PortArgs-2366"><span class="linenos">2366</span></a>    <span class="n">tokenizer_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="PortArgs-2367"><a href="#PortArgs-2367"><span class="linenos">2367</span></a>    <span class="c1"># The ipc filename for scheduler (rank 0) to receive inputs from tokenizer (zmq)</span>
</span><span id="PortArgs-2368"><a href="#PortArgs-2368"><span class="linenos">2368</span></a>    <span class="n">scheduler_input_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="PortArgs-2369"><a href="#PortArgs-2369"><span class="linenos">2369</span></a>    <span class="c1"># The ipc filename for detokenizer to receive inputs from scheduler (zmq)</span>
</span><span id="PortArgs-2370"><a href="#PortArgs-2370"><span class="linenos">2370</span></a>    <span class="n">detokenizer_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="PortArgs-2371"><a href="#PortArgs-2371"><span class="linenos">2371</span></a>
</span><span id="PortArgs-2372"><a href="#PortArgs-2372"><span class="linenos">2372</span></a>    <span class="c1"># The port for nccl initialization (torch.dist)</span>
</span><span id="PortArgs-2373"><a href="#PortArgs-2373"><span class="linenos">2373</span></a>    <span class="n">nccl_port</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="PortArgs-2374"><a href="#PortArgs-2374"><span class="linenos">2374</span></a>
</span><span id="PortArgs-2375"><a href="#PortArgs-2375"><span class="linenos">2375</span></a>    <span class="c1"># The ipc filename for rpc call between Engine and Scheduler</span>
</span><span id="PortArgs-2376"><a href="#PortArgs-2376"><span class="linenos">2376</span></a>    <span class="n">rpc_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="PortArgs-2377"><a href="#PortArgs-2377"><span class="linenos">2377</span></a>
</span><span id="PortArgs-2378"><a href="#PortArgs-2378"><span class="linenos">2378</span></a>    <span class="c1"># The ipc filename for Scheduler to send metrics</span>
</span><span id="PortArgs-2379"><a href="#PortArgs-2379"><span class="linenos">2379</span></a>    <span class="n">metrics_ipc_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="PortArgs-2380"><a href="#PortArgs-2380"><span class="linenos">2380</span></a>
</span><span id="PortArgs-2381"><a href="#PortArgs-2381"><span class="linenos">2381</span></a>    <span class="nd">@staticmethod</span>
</span><span id="PortArgs-2382"><a href="#PortArgs-2382"><span class="linenos">2382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_new</span><span class="p">(</span><span class="n">server_args</span><span class="p">,</span> <span class="n">dp_rank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PortArgs&quot;</span><span class="p">:</span>
</span><span id="PortArgs-2383"><a href="#PortArgs-2383"><span class="linenos">2383</span></a>        <span class="k">if</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nccl_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PortArgs-2384"><a href="#PortArgs-2384"><span class="linenos">2384</span></a>            <span class="n">nccl_port</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="PortArgs-2385"><a href="#PortArgs-2385"><span class="linenos">2385</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PortArgs-2386"><a href="#PortArgs-2386"><span class="linenos">2386</span></a>                <span class="k">if</span> <span class="n">is_port_available</span><span class="p">(</span><span class="n">nccl_port</span><span class="p">):</span>
</span><span id="PortArgs-2387"><a href="#PortArgs-2387"><span class="linenos">2387</span></a>                    <span class="k">break</span>
</span><span id="PortArgs-2388"><a href="#PortArgs-2388"><span class="linenos">2388</span></a>                <span class="k">if</span> <span class="n">nccl_port</span> <span class="o">&lt;</span> <span class="mi">60000</span><span class="p">:</span>
</span><span id="PortArgs-2389"><a href="#PortArgs-2389"><span class="linenos">2389</span></a>                    <span class="n">nccl_port</span> <span class="o">+=</span> <span class="mi">42</span>
</span><span id="PortArgs-2390"><a href="#PortArgs-2390"><span class="linenos">2390</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs-2391"><a href="#PortArgs-2391"><span class="linenos">2391</span></a>                    <span class="n">nccl_port</span> <span class="o">-=</span> <span class="mi">43</span>
</span><span id="PortArgs-2392"><a href="#PortArgs-2392"><span class="linenos">2392</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs-2393"><a href="#PortArgs-2393"><span class="linenos">2393</span></a>            <span class="n">nccl_port</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nccl_port</span>
</span><span id="PortArgs-2394"><a href="#PortArgs-2394"><span class="linenos">2394</span></a>
</span><span id="PortArgs-2395"><a href="#PortArgs-2395"><span class="linenos">2395</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_args</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="PortArgs-2396"><a href="#PortArgs-2396"><span class="linenos">2396</span></a>            <span class="c1"># Normal case, use IPC within a single node</span>
</span><span id="PortArgs-2397"><a href="#PortArgs-2397"><span class="linenos">2397</span></a>            <span class="k">return</span> <span class="n">PortArgs</span><span class="p">(</span>
</span><span id="PortArgs-2398"><a href="#PortArgs-2398"><span class="linenos">2398</span></a>                <span class="n">tokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2399"><a href="#PortArgs-2399"><span class="linenos">2399</span></a>                <span class="n">scheduler_input_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2400"><a href="#PortArgs-2400"><span class="linenos">2400</span></a>                <span class="n">detokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2401"><a href="#PortArgs-2401"><span class="linenos">2401</span></a>                <span class="n">nccl_port</span><span class="o">=</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="PortArgs-2402"><a href="#PortArgs-2402"><span class="linenos">2402</span></a>                <span class="n">rpc_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2403"><a href="#PortArgs-2403"><span class="linenos">2403</span></a>                <span class="n">metrics_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2404"><a href="#PortArgs-2404"><span class="linenos">2404</span></a>            <span class="p">)</span>
</span><span id="PortArgs-2405"><a href="#PortArgs-2405"><span class="linenos">2405</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs-2406"><a href="#PortArgs-2406"><span class="linenos">2406</span></a>            <span class="c1"># DP attention. Use TCP + port to handle both single-node and multi-node.</span>
</span><span id="PortArgs-2407"><a href="#PortArgs-2407"><span class="linenos">2407</span></a>            <span class="k">if</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PortArgs-2408"><a href="#PortArgs-2408"><span class="linenos">2408</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">server_args</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="n">ZMQ_TCP_PORT_DELTA</span><span class="p">)</span>
</span><span id="PortArgs-2409"><a href="#PortArgs-2409"><span class="linenos">2409</span></a>            <span class="k">elif</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>  <span class="c1"># ipv6 address</span>
</span><span id="PortArgs-2410"><a href="#PortArgs-2410"><span class="linenos">2410</span></a>                <span class="n">port_num</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="n">configure_ipv6</span><span class="p">(</span><span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="p">)</span>
</span><span id="PortArgs-2411"><a href="#PortArgs-2411"><span class="linenos">2411</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port_num</span><span class="p">))</span>
</span><span id="PortArgs-2412"><a href="#PortArgs-2412"><span class="linenos">2412</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs-2413"><a href="#PortArgs-2413"><span class="linenos">2413</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="PortArgs-2414"><a href="#PortArgs-2414"><span class="linenos">2414</span></a>
</span><span id="PortArgs-2415"><a href="#PortArgs-2415"><span class="linenos">2415</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="PortArgs-2416"><a href="#PortArgs-2416"><span class="linenos">2416</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">dist_init_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</span><span id="PortArgs-2417"><a href="#PortArgs-2417"><span class="linenos">2417</span></a>            <span class="p">),</span> <span class="s2">&quot;please provide --dist-init-addr as host:port of head node&quot;</span>
</span><span id="PortArgs-2418"><a href="#PortArgs-2418"><span class="linenos">2418</span></a>
</span><span id="PortArgs-2419"><a href="#PortArgs-2419"><span class="linenos">2419</span></a>            <span class="n">dist_init_host</span><span class="p">,</span> <span class="n">dist_init_port</span> <span class="o">=</span> <span class="n">dist_init_addr</span>
</span><span id="PortArgs-2420"><a href="#PortArgs-2420"><span class="linenos">2420</span></a>            <span class="n">port_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist_init_port</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="PortArgs-2421"><a href="#PortArgs-2421"><span class="linenos">2421</span></a>            <span class="n">detokenizer_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="PortArgs-2422"><a href="#PortArgs-2422"><span class="linenos">2422</span></a>            <span class="n">rpc_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="PortArgs-2423"><a href="#PortArgs-2423"><span class="linenos">2423</span></a>            <span class="n">metrics_ipc_name</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">3</span>
</span><span id="PortArgs-2424"><a href="#PortArgs-2424"><span class="linenos">2424</span></a>            <span class="k">if</span> <span class="n">dp_rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PortArgs-2425"><a href="#PortArgs-2425"><span class="linenos">2425</span></a>                <span class="c1"># TokenizerManager to DataParallelController</span>
</span><span id="PortArgs-2426"><a href="#PortArgs-2426"><span class="linenos">2426</span></a>                <span class="n">scheduler_input_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">4</span>
</span><span id="PortArgs-2427"><a href="#PortArgs-2427"><span class="linenos">2427</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs-2428"><a href="#PortArgs-2428"><span class="linenos">2428</span></a>                <span class="n">scheduler_input_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dp_rank</span>
</span><span id="PortArgs-2429"><a href="#PortArgs-2429"><span class="linenos">2429</span></a>
</span><span id="PortArgs-2430"><a href="#PortArgs-2430"><span class="linenos">2430</span></a>            <span class="k">return</span> <span class="n">PortArgs</span><span class="p">(</span>
</span><span id="PortArgs-2431"><a href="#PortArgs-2431"><span class="linenos">2431</span></a>                <span class="n">tokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2432"><a href="#PortArgs-2432"><span class="linenos">2432</span></a>                <span class="n">scheduler_input_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">scheduler_input_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2433"><a href="#PortArgs-2433"><span class="linenos">2433</span></a>                <span class="n">detokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">detokenizer_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2434"><a href="#PortArgs-2434"><span class="linenos">2434</span></a>                <span class="n">nccl_port</span><span class="o">=</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="PortArgs-2435"><a href="#PortArgs-2435"><span class="linenos">2435</span></a>                <span class="n">rpc_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">rpc_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2436"><a href="#PortArgs-2436"><span class="linenos">2436</span></a>                <span class="n">metrics_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">metrics_ipc_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs-2437"><a href="#PortArgs-2437"><span class="linenos">2437</span></a>            <span class="p">)</span>
</span></pre></div>


    

                            <div id="PortArgs.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">PortArgs</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tokenizer_ipc_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">scheduler_input_ipc_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">detokenizer_ipc_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">nccl_port</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">rpc_ipc_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">metrics_ipc_name</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#PortArgs.__init__"></a>
    
    

                            </div>
                            <div id="PortArgs.tokenizer_ipc_name" class="classattr">
                                <div class="attr variable">
            <span class="name">tokenizer_ipc_name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#PortArgs.tokenizer_ipc_name"></a>
    
    

                            </div>
                            <div id="PortArgs.scheduler_input_ipc_name" class="classattr">
                                <div class="attr variable">
            <span class="name">scheduler_input_ipc_name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#PortArgs.scheduler_input_ipc_name"></a>
    
    

                            </div>
                            <div id="PortArgs.detokenizer_ipc_name" class="classattr">
                                <div class="attr variable">
            <span class="name">detokenizer_ipc_name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#PortArgs.detokenizer_ipc_name"></a>
    
    

                            </div>
                            <div id="PortArgs.nccl_port" class="classattr">
                                <div class="attr variable">
            <span class="name">nccl_port</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#PortArgs.nccl_port"></a>
    
    

                            </div>
                            <div id="PortArgs.rpc_ipc_name" class="classattr">
                                <div class="attr variable">
            <span class="name">rpc_ipc_name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#PortArgs.rpc_ipc_name"></a>
    
    

                            </div>
                            <div id="PortArgs.metrics_ipc_name" class="classattr">
                                <div class="attr variable">
            <span class="name">metrics_ipc_name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#PortArgs.metrics_ipc_name"></a>
    
    

                            </div>
                            <div id="PortArgs.init_new" class="classattr">
                                        <input id="PortArgs.init_new-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">init_new</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">server_args</span>,</span><span class="param">	<span class="n">dp_rank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#PortArgs">PortArgs</a></span>:</span></span>

                <label class="view-source-button" for="PortArgs.init_new-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PortArgs.init_new"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PortArgs.init_new-2381"><a href="#PortArgs.init_new-2381"><span class="linenos">2381</span></a>    <span class="nd">@staticmethod</span>
</span><span id="PortArgs.init_new-2382"><a href="#PortArgs.init_new-2382"><span class="linenos">2382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_new</span><span class="p">(</span><span class="n">server_args</span><span class="p">,</span> <span class="n">dp_rank</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PortArgs&quot;</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2383"><a href="#PortArgs.init_new-2383"><span class="linenos">2383</span></a>        <span class="k">if</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nccl_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2384"><a href="#PortArgs.init_new-2384"><span class="linenos">2384</span></a>            <span class="n">nccl_port</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="PortArgs.init_new-2385"><a href="#PortArgs.init_new-2385"><span class="linenos">2385</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2386"><a href="#PortArgs.init_new-2386"><span class="linenos">2386</span></a>                <span class="k">if</span> <span class="n">is_port_available</span><span class="p">(</span><span class="n">nccl_port</span><span class="p">):</span>
</span><span id="PortArgs.init_new-2387"><a href="#PortArgs.init_new-2387"><span class="linenos">2387</span></a>                    <span class="k">break</span>
</span><span id="PortArgs.init_new-2388"><a href="#PortArgs.init_new-2388"><span class="linenos">2388</span></a>                <span class="k">if</span> <span class="n">nccl_port</span> <span class="o">&lt;</span> <span class="mi">60000</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2389"><a href="#PortArgs.init_new-2389"><span class="linenos">2389</span></a>                    <span class="n">nccl_port</span> <span class="o">+=</span> <span class="mi">42</span>
</span><span id="PortArgs.init_new-2390"><a href="#PortArgs.init_new-2390"><span class="linenos">2390</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2391"><a href="#PortArgs.init_new-2391"><span class="linenos">2391</span></a>                    <span class="n">nccl_port</span> <span class="o">-=</span> <span class="mi">43</span>
</span><span id="PortArgs.init_new-2392"><a href="#PortArgs.init_new-2392"><span class="linenos">2392</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2393"><a href="#PortArgs.init_new-2393"><span class="linenos">2393</span></a>            <span class="n">nccl_port</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nccl_port</span>
</span><span id="PortArgs.init_new-2394"><a href="#PortArgs.init_new-2394"><span class="linenos">2394</span></a>
</span><span id="PortArgs.init_new-2395"><a href="#PortArgs.init_new-2395"><span class="linenos">2395</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_args</span><span class="o">.</span><span class="n">enable_dp_attention</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2396"><a href="#PortArgs.init_new-2396"><span class="linenos">2396</span></a>            <span class="c1"># Normal case, use IPC within a single node</span>
</span><span id="PortArgs.init_new-2397"><a href="#PortArgs.init_new-2397"><span class="linenos">2397</span></a>            <span class="k">return</span> <span class="n">PortArgs</span><span class="p">(</span>
</span><span id="PortArgs.init_new-2398"><a href="#PortArgs.init_new-2398"><span class="linenos">2398</span></a>                <span class="n">tokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2399"><a href="#PortArgs.init_new-2399"><span class="linenos">2399</span></a>                <span class="n">scheduler_input_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2400"><a href="#PortArgs.init_new-2400"><span class="linenos">2400</span></a>                <span class="n">detokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2401"><a href="#PortArgs.init_new-2401"><span class="linenos">2401</span></a>                <span class="n">nccl_port</span><span class="o">=</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2402"><a href="#PortArgs.init_new-2402"><span class="linenos">2402</span></a>                <span class="n">rpc_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2403"><a href="#PortArgs.init_new-2403"><span class="linenos">2403</span></a>                <span class="n">metrics_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ipc://</span><span class="si">{</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2404"><a href="#PortArgs.init_new-2404"><span class="linenos">2404</span></a>            <span class="p">)</span>
</span><span id="PortArgs.init_new-2405"><a href="#PortArgs.init_new-2405"><span class="linenos">2405</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2406"><a href="#PortArgs.init_new-2406"><span class="linenos">2406</span></a>            <span class="c1"># DP attention. Use TCP + port to handle both single-node and multi-node.</span>
</span><span id="PortArgs.init_new-2407"><a href="#PortArgs.init_new-2407"><span class="linenos">2407</span></a>            <span class="k">if</span> <span class="n">server_args</span><span class="o">.</span><span class="n">nnodes</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2408"><a href="#PortArgs.init_new-2408"><span class="linenos">2408</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">server_args</span><span class="o">.</span><span class="n">port</span> <span class="o">+</span> <span class="n">ZMQ_TCP_PORT_DELTA</span><span class="p">)</span>
</span><span id="PortArgs.init_new-2409"><a href="#PortArgs.init_new-2409"><span class="linenos">2409</span></a>            <span class="k">elif</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>  <span class="c1"># ipv6 address</span>
</span><span id="PortArgs.init_new-2410"><a href="#PortArgs.init_new-2410"><span class="linenos">2410</span></a>                <span class="n">port_num</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="n">configure_ipv6</span><span class="p">(</span><span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="p">)</span>
</span><span id="PortArgs.init_new-2411"><a href="#PortArgs.init_new-2411"><span class="linenos">2411</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port_num</span><span class="p">))</span>
</span><span id="PortArgs.init_new-2412"><a href="#PortArgs.init_new-2412"><span class="linenos">2412</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2413"><a href="#PortArgs.init_new-2413"><span class="linenos">2413</span></a>                <span class="n">dist_init_addr</span> <span class="o">=</span> <span class="n">server_args</span><span class="o">.</span><span class="n">dist_init_addr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span id="PortArgs.init_new-2414"><a href="#PortArgs.init_new-2414"><span class="linenos">2414</span></a>
</span><span id="PortArgs.init_new-2415"><a href="#PortArgs.init_new-2415"><span class="linenos">2415</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="PortArgs.init_new-2416"><a href="#PortArgs.init_new-2416"><span class="linenos">2416</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">dist_init_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</span><span id="PortArgs.init_new-2417"><a href="#PortArgs.init_new-2417"><span class="linenos">2417</span></a>            <span class="p">),</span> <span class="s2">&quot;please provide --dist-init-addr as host:port of head node&quot;</span>
</span><span id="PortArgs.init_new-2418"><a href="#PortArgs.init_new-2418"><span class="linenos">2418</span></a>
</span><span id="PortArgs.init_new-2419"><a href="#PortArgs.init_new-2419"><span class="linenos">2419</span></a>            <span class="n">dist_init_host</span><span class="p">,</span> <span class="n">dist_init_port</span> <span class="o">=</span> <span class="n">dist_init_addr</span>
</span><span id="PortArgs.init_new-2420"><a href="#PortArgs.init_new-2420"><span class="linenos">2420</span></a>            <span class="n">port_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist_init_port</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="PortArgs.init_new-2421"><a href="#PortArgs.init_new-2421"><span class="linenos">2421</span></a>            <span class="n">detokenizer_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="PortArgs.init_new-2422"><a href="#PortArgs.init_new-2422"><span class="linenos">2422</span></a>            <span class="n">rpc_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="PortArgs.init_new-2423"><a href="#PortArgs.init_new-2423"><span class="linenos">2423</span></a>            <span class="n">metrics_ipc_name</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">3</span>
</span><span id="PortArgs.init_new-2424"><a href="#PortArgs.init_new-2424"><span class="linenos">2424</span></a>            <span class="k">if</span> <span class="n">dp_rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2425"><a href="#PortArgs.init_new-2425"><span class="linenos">2425</span></a>                <span class="c1"># TokenizerManager to DataParallelController</span>
</span><span id="PortArgs.init_new-2426"><a href="#PortArgs.init_new-2426"><span class="linenos">2426</span></a>                <span class="n">scheduler_input_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">4</span>
</span><span id="PortArgs.init_new-2427"><a href="#PortArgs.init_new-2427"><span class="linenos">2427</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PortArgs.init_new-2428"><a href="#PortArgs.init_new-2428"><span class="linenos">2428</span></a>                <span class="n">scheduler_input_port</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dp_rank</span>
</span><span id="PortArgs.init_new-2429"><a href="#PortArgs.init_new-2429"><span class="linenos">2429</span></a>
</span><span id="PortArgs.init_new-2430"><a href="#PortArgs.init_new-2430"><span class="linenos">2430</span></a>            <span class="k">return</span> <span class="n">PortArgs</span><span class="p">(</span>
</span><span id="PortArgs.init_new-2431"><a href="#PortArgs.init_new-2431"><span class="linenos">2431</span></a>                <span class="n">tokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2432"><a href="#PortArgs.init_new-2432"><span class="linenos">2432</span></a>                <span class="n">scheduler_input_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">scheduler_input_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2433"><a href="#PortArgs.init_new-2433"><span class="linenos">2433</span></a>                <span class="n">detokenizer_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">detokenizer_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2434"><a href="#PortArgs.init_new-2434"><span class="linenos">2434</span></a>                <span class="n">nccl_port</span><span class="o">=</span><span class="n">nccl_port</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2435"><a href="#PortArgs.init_new-2435"><span class="linenos">2435</span></a>                <span class="n">rpc_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">rpc_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2436"><a href="#PortArgs.init_new-2436"><span class="linenos">2436</span></a>                <span class="n">metrics_ipc_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="n">dist_init_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">metrics_ipc_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="PortArgs.init_new-2437"><a href="#PortArgs.init_new-2437"><span class="linenos">2437</span></a>            <span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="LoRAPathAction">
                            <input id="LoRAPathAction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LoRAPathAction</span><wbr>(<span class="base">argparse.Action</span>):

                <label class="view-source-button" for="LoRAPathAction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LoRAPathAction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LoRAPathAction-2440"><a href="#LoRAPathAction-2440"><span class="linenos">2440</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LoRAPathAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
</span><span id="LoRAPathAction-2441"><a href="#LoRAPathAction-2441"><span class="linenos">2441</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LoRAPathAction-2442"><a href="#LoRAPathAction-2442"><span class="linenos">2442</span></a>        <span class="n">lora_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LoRAPathAction-2443"><a href="#LoRAPathAction-2443"><span class="linenos">2443</span></a>        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
</span><span id="LoRAPathAction-2444"><a href="#LoRAPathAction-2444"><span class="linenos">2444</span></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;Expected a list of LoRA paths.&quot;</span>
</span><span id="LoRAPathAction-2445"><a href="#LoRAPathAction-2445"><span class="linenos">2445</span></a>            <span class="k">for</span> <span class="n">lora_path</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
</span><span id="LoRAPathAction-2446"><a href="#LoRAPathAction-2446"><span class="linenos">2446</span></a>                <span class="n">lora_path</span> <span class="o">=</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="LoRAPathAction-2447"><a href="#LoRAPathAction-2447"><span class="linenos">2447</span></a>                <span class="k">if</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lora_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
</span><span id="LoRAPathAction-2448"><a href="#LoRAPathAction-2448"><span class="linenos">2448</span></a>                    <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span>
</span><span id="LoRAPathAction-2449"><a href="#LoRAPathAction-2449"><span class="linenos">2449</span></a>                    <span class="k">assert</span> <span class="s2">&quot;lora_path&quot;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="s2">&quot;lora_name&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">,</span> <span class="p">(</span>
</span><span id="LoRAPathAction-2450"><a href="#LoRAPathAction-2450"><span class="linenos">2450</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> looks like a JSON str, &quot;</span>
</span><span id="LoRAPathAction-2451"><a href="#LoRAPathAction-2451"><span class="linenos">2451</span></a>                        <span class="s2">&quot;but it does not contain &#39;lora_name&#39; and &#39;lora_path&#39; keys.&quot;</span>
</span><span id="LoRAPathAction-2452"><a href="#LoRAPathAction-2452"><span class="linenos">2452</span></a>                    <span class="p">)</span>
</span><span id="LoRAPathAction-2453"><a href="#LoRAPathAction-2453"><span class="linenos">2453</span></a>                    <span class="n">lora_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="LoRAPathAction-2454"><a href="#LoRAPathAction-2454"><span class="linenos">2454</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LoRAPathAction-2455"><a href="#LoRAPathAction-2455"><span class="linenos">2455</span></a>                    <span class="n">lora_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lora_path</span><span class="p">)</span>
</span><span id="LoRAPathAction-2456"><a href="#LoRAPathAction-2456"><span class="linenos">2456</span></a>
</span><span id="LoRAPathAction-2457"><a href="#LoRAPathAction-2457"><span class="linenos">2457</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">lora_paths</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Information about how to convert command line strings to Python objects.</p>

<p>Action objects are used by an ArgumentParser to represent the information
needed to parse a single argument from one or more strings from the
command line. The keyword arguments to the Action constructor are also
all attributes of Action instances.</p>

<p>Keyword Arguments:</p>

<pre><code>- option_strings -- A list of command-line option strings which
    should be associated with this action.

- dest -- The name of the attribute to hold the created object(s)

- nargs -- The number of command-line arguments that should be
    consumed. By default, one argument will be consumed and a single
    value will be produced.  Other values include:
        - N (an integer) consumes N arguments (and produces a list)
        - '?' consumes zero or one arguments
        - '*' consumes zero or more arguments (and produces a list)
        - '+' consumes one or more arguments (and produces a list)
    Note that the difference between the default and nargs=1 is that
    with the default, a single value will be produced, while with
    nargs=1, a list containing a single value will be produced.

- const -- The value to be produced if the option is specified and the
    option uses an action that takes no values.

- default -- The value to be produced if the option is not specified.

- type -- A callable that accepts a single string argument, and
    returns the converted value.  The standard Python types str, int,
    float, and complex are useful examples of such callables.  If None,
    str is used.

- choices -- A container of values that should be allowed. If not None,
    after a command-line argument has been converted to the appropriate
    type, an exception will be raised if it is not a member of this
    collection.

- required -- True if the action must always be specified at the
    command line. This is only meaningful for optional command-line
    arguments.

- help -- The help string describing the argument.

- metavar -- The name to be used for the option's argument with the
    help string. If None, the 'dest' value will be used as the name.
</code></pre>
</div>


                </section>
                <section id="DeprecatedAction">
                            <input id="DeprecatedAction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DeprecatedAction</span><wbr>(<span class="base">argparse.Action</span>):

                <label class="view-source-button" for="DeprecatedAction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DeprecatedAction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DeprecatedAction-2460"><a href="#DeprecatedAction-2460"><span class="linenos">2460</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DeprecatedAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
</span><span id="DeprecatedAction-2461"><a href="#DeprecatedAction-2461"><span class="linenos">2461</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="DeprecatedAction-2462"><a href="#DeprecatedAction-2462"><span class="linenos">2462</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DeprecatedAction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="DeprecatedAction-2463"><a href="#DeprecatedAction-2463"><span class="linenos">2463</span></a>            <span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="DeprecatedAction-2464"><a href="#DeprecatedAction-2464"><span class="linenos">2464</span></a>        <span class="p">)</span>
</span><span id="DeprecatedAction-2465"><a href="#DeprecatedAction-2465"><span class="linenos">2465</span></a>
</span><span id="DeprecatedAction-2466"><a href="#DeprecatedAction-2466"><span class="linenos">2466</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="DeprecatedAction-2467"><a href="#DeprecatedAction-2467"><span class="linenos">2467</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Information about how to convert command line strings to Python objects.</p>

<p>Action objects are used by an ArgumentParser to represent the information
needed to parse a single argument from one or more strings from the
command line. The keyword arguments to the Action constructor are also
all attributes of Action instances.</p>

<p>Keyword Arguments:</p>

<pre><code>- option_strings -- A list of command-line option strings which
    should be associated with this action.

- dest -- The name of the attribute to hold the created object(s)

- nargs -- The number of command-line arguments that should be
    consumed. By default, one argument will be consumed and a single
    value will be produced.  Other values include:
        - N (an integer) consumes N arguments (and produces a list)
        - '?' consumes zero or one arguments
        - '*' consumes zero or more arguments (and produces a list)
        - '+' consumes one or more arguments (and produces a list)
    Note that the difference between the default and nargs=1 is that
    with the default, a single value will be produced, while with
    nargs=1, a list containing a single value will be produced.

- const -- The value to be produced if the option is specified and the
    option uses an action that takes no values.

- default -- The value to be produced if the option is not specified.

- type -- A callable that accepts a single string argument, and
    returns the converted value.  The standard Python types str, int,
    float, and complex are useful examples of such callables.  If None,
    str is used.

- choices -- A container of values that should be allowed. If not None,
    after a command-line argument has been converted to the appropriate
    type, an exception will be raised if it is not a member of this
    collection.

- required -- True if the action must always be specified at the
    command line. This is only meaningful for optional command-line
    arguments.

- help -- The help string describing the argument.

- metavar -- The name to be used for the option's argument with the
    help string. If None, the 'dest' value will be used as the name.
</code></pre>
</div>


                            <div id="DeprecatedAction.__init__" class="classattr">
                                        <input id="DeprecatedAction.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DeprecatedAction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">option_strings</span>, </span><span class="param"><span class="n">dest</span>, </span><span class="param"><span class="n">nargs</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="DeprecatedAction.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DeprecatedAction.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DeprecatedAction.__init__-2461"><a href="#DeprecatedAction.__init__-2461"><span class="linenos">2461</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="DeprecatedAction.__init__-2462"><a href="#DeprecatedAction.__init__-2462"><span class="linenos">2462</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DeprecatedAction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="DeprecatedAction.__init__-2463"><a href="#DeprecatedAction.__init__-2463"><span class="linenos">2463</span></a>            <span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="DeprecatedAction.__init__-2464"><a href="#DeprecatedAction.__init__-2464"><span class="linenos">2464</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="print_deprecated_warning">
                            <input id="print_deprecated_warning-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_deprecated_warning</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">message</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="print_deprecated_warning-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#print_deprecated_warning"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="print_deprecated_warning-2470"><a href="#print_deprecated_warning-2470"><span class="linenos">2470</span></a><span class="k">def</span><span class="w"> </span><span class="nf">print_deprecated_warning</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="print_deprecated_warning-2471"><a href="#print_deprecated_warning-2471"><span class="linenos">2471</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[33m</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="auto_choose_speculative_params">
                            <input id="auto_choose_speculative_params-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">auto_choose_speculative_params</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span><span class="p">:</span> <span class="n"><a href="#ServerArgs">ServerArgs</a></span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="auto_choose_speculative_params-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#auto_choose_speculative_params"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="auto_choose_speculative_params-2474"><a href="#auto_choose_speculative_params-2474"><span class="linenos">2474</span></a><span class="k">def</span><span class="w"> </span><span class="nf">auto_choose_speculative_params</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ServerArgs</span><span class="p">):</span>
</span><span id="auto_choose_speculative_params-2475"><a href="#auto_choose_speculative_params-2475"><span class="linenos">2475</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="auto_choose_speculative_params-2476"><a href="#auto_choose_speculative_params-2476"><span class="linenos">2476</span></a><span class="sd">    Automatically choose the parameters for speculative decoding.</span>
</span><span id="auto_choose_speculative_params-2477"><a href="#auto_choose_speculative_params-2477"><span class="linenos">2477</span></a>
</span><span id="auto_choose_speculative_params-2478"><a href="#auto_choose_speculative_params-2478"><span class="linenos">2478</span></a><span class="sd">    You can tune them on your own models and prompts with scripts/playground/bench_speculative.py</span>
</span><span id="auto_choose_speculative_params-2479"><a href="#auto_choose_speculative_params-2479"><span class="linenos">2479</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="auto_choose_speculative_params-2480"><a href="#auto_choose_speculative_params-2480"><span class="linenos">2480</span></a>    <span class="n">hf_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hf_config</span><span class="p">()</span>
</span><span id="auto_choose_speculative_params-2481"><a href="#auto_choose_speculative_params-2481"><span class="linenos">2481</span></a>    <span class="n">arch</span> <span class="o">=</span> <span class="n">hf_config</span><span class="o">.</span><span class="n">architectures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="auto_choose_speculative_params-2482"><a href="#auto_choose_speculative_params-2482"><span class="linenos">2482</span></a>
</span><span id="auto_choose_speculative_params-2483"><a href="#auto_choose_speculative_params-2483"><span class="linenos">2483</span></a>    <span class="k">if</span> <span class="n">arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LlamaForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="auto_choose_speculative_params-2484"><a href="#auto_choose_speculative_params-2484"><span class="linenos">2484</span></a>        <span class="c1"># The default value for llama</span>
</span><span id="auto_choose_speculative_params-2485"><a href="#auto_choose_speculative_params-2485"><span class="linenos">2485</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="auto_choose_speculative_params-2486"><a href="#auto_choose_speculative_params-2486"><span class="linenos">2486</span></a>    <span class="k">elif</span> <span class="n">arch</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="auto_choose_speculative_params-2487"><a href="#auto_choose_speculative_params-2487"><span class="linenos">2487</span></a>        <span class="s2">&quot;DeepseekV3ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="auto_choose_speculative_params-2488"><a href="#auto_choose_speculative_params-2488"><span class="linenos">2488</span></a>        <span class="s2">&quot;DeepseekV2ForCausalLM&quot;</span><span class="p">,</span>
</span><span id="auto_choose_speculative_params-2489"><a href="#auto_choose_speculative_params-2489"><span class="linenos">2489</span></a>        <span class="s2">&quot;GptOssForCausalLM&quot;</span><span class="p">,</span>
</span><span id="auto_choose_speculative_params-2490"><a href="#auto_choose_speculative_params-2490"><span class="linenos">2490</span></a>    <span class="p">]:</span>
</span><span id="auto_choose_speculative_params-2491"><a href="#auto_choose_speculative_params-2491"><span class="linenos">2491</span></a>        <span class="c1"># The default value for deepseek and gpt-oss</span>
</span><span id="auto_choose_speculative_params-2492"><a href="#auto_choose_speculative_params-2492"><span class="linenos">2492</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="auto_choose_speculative_params-2493"><a href="#auto_choose_speculative_params-2493"><span class="linenos">2493</span></a>    <span class="k">elif</span> <span class="n">arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Grok1ForCausalLM&quot;</span><span class="p">,</span> <span class="s2">&quot;Grok1VForCausalLM&quot;</span><span class="p">]:</span>
</span><span id="auto_choose_speculative_params-2494"><a href="#auto_choose_speculative_params-2494"><span class="linenos">2494</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="auto_choose_speculative_params-2495"><a href="#auto_choose_speculative_params-2495"><span class="linenos">2495</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="auto_choose_speculative_params-2496"><a href="#auto_choose_speculative_params-2496"><span class="linenos">2496</span></a>        <span class="c1"># The default value for all other models</span>
</span><span id="auto_choose_speculative_params-2497"><a href="#auto_choose_speculative_params-2497"><span class="linenos">2497</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Automatically choose the parameters for speculative decoding.</p>

<p>You can tune them on your own models and prompts with scripts/playground/bench_speculative.py</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>